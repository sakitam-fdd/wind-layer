/*!
 * ol3-echarts v1.3.1
 * LICENSE : MIT
 * (c) 2017-2018 https://sakitam-fdd.github.io/ol3Echarts
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("openlayers"),require("echarts")):"function"==typeof define&&define.amd?define(["openlayers","echarts"],e):t.ol3Echarts=e(t.ol,t.echarts)}(this,function(t,e){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=(function(){function t(t){this.value=t}function e(e){function n(i,r){try{var s=e[i](r),a=s.value;a instanceof t?Promise.resolve(a.value).then(function(t){n("next",t)},function(t){n("throw",t)}):o(s.done?"return":"normal",s.value)}catch(t){o("throw",t)}}function o(t,e){switch(t){case"return":i.resolve({value:e,done:!0});break;case"throw":i.reject(e);break;default:i.resolve({value:e,done:!1})}(i=i.next)?n(i.key,i.arg):r=null}var i,r;this._invoke=function(t,e){return new Promise(function(o,s){var a={key:t,arg:e,resolve:o,reject:s,next:null};r?r=r.next=a:(i=r=a,n(t,e))})},"function"!=typeof e.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)}}(),function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}),i=function(t){var e=void 0===t?"undefined":n(t);return null!==t&&("object"===e||"function"===e)},r=function t(e,n){for(var o in n)i(n[o])&&i(e[o])?t(e[o],n[o]):e[o]=n[o];return e},s=function(t){return function(){var e=void 0;return document&&/^#([\w-]+)$/.test(t)?(e=document.getElementById(RegExp.$1))?[e]:[]:Array.prototype.slice.call(/^\.([\w-]+)$/.test(t)?document.getElementsByClassName(RegExp.$1):/^[\w-]+$/.test(t)?document.getElementsByTagName(t):document.querySelectorAll(t))}()},a=function(t,e,n){if(t&&e){if(t.map&&t.map===Array.prototype.map)return t.map(e,n);for(var o=[],i=0,r=t.length;i<r;i++)o.push(e.call(n,t[i],i,t));return o}},h=function(t,e){var n=Array.prototype.slice.call(arguments,2);return function(){return t.apply(e,n.concat(Array.prototype.slice.call(arguments)))}},c=function(n){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=function(){this._mapOffset=[0,0],this.dimensions=["lng","lat"],this.projCode_=this._getProjectionCode()};return i.prototype.dimensions=["lng","lat"],i.dimensions=i.prototype.dimensions,i.prototype.setMapOffset=function(t){this._mapOffset=t},i.prototype.dataToPoint=function(e){e&&Array.isArray(e)&&e.length>0&&(e=e.map(function(t){return"string"==typeof t&&(t=Number(t)),t}));var i=o.source||"EPSG:4326",r=o.destination||this.projCode_,s=n.getPixelFromCoordinate(t.proj.transform(e,i,r)),a=this._mapOffset;return[s[0]-a[0],s[1]-a[1]]},i.prototype._getProjectionCode=function(){return n?n.getView()&&n.getView().getProjection().getCode():"EPSG:3857"},i.prototype.pointToData=function(t){var e=this._mapOffset;return n.getCoordinateFromPixel([t[0]+e[0],t[1]+e[1]])},i.prototype.getViewRect=function(){var t=n.getSize();return new e.graphic.BoundingRect(0,0,t[0],t[1])},i.prototype.getRoamTransform=function(){return e.matrix.create()},i.prototype.prepareCustoms=function(t){var e=this.getViewRect();return{coordSys:{type:"openlayers",x:e.x,y:e.y,width:e.width,height:e.height},api:{coord:h(this.dataToPoint,this),size:h(i.dataToCoordSize,this)}}},i.dataToCoordSize=function(t,e){return e=e||[0,0],a([0,1],function(n){var o=e[n],i=t[n]/2,r=[],s=[];return r[n]=o-i,s[n]=o+i,r[1-n]=s[1-n]=e[1-n],Math.abs(this.dataToPoint(r)[n]-this.dataToPoint(s)[n])},this)},i.create=function(t,e){t.eachSeries(function(t){"openlayers"===t.get("coordinateSystem")&&(t.coordinateSystem=new i(n))})},i},p=Object.freeze({pie:function(t,e,n){return e.center=n.dataToPoint(e.coordinates),e},bar:function(t,e,n){return i(t.grid)&&!Array.isArray(t.grid)?console.log(t):Array.isArray(t.grid)&&(t.grid=t.grid.map(function(e,o){var i=n.dataToPoint(t.series[o].coordinates);return e.left=i[0]-parseFloat(e.width)/2,e.top=i[1]-parseFloat(e.height)/2,e})),e}}),u={forcedRerender:!1,hideOnZooming:!1,hideOnMoving:!1,hideOnRotating:!1,convertTypes:["pie","line","bar"]},d=function(){function n(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments[2];o(this,n),this.$options=r(u,e),this.$chartOptions=t,this.$chart=null,this.$Map=null,this._isRegistered=!1,this._coordinateSystem=null,i&&this.appendTo(i)}return n.prototype.appendTo=function(e){if(!(e&&e instanceof t.Map))throw new Error("not map object");this.$Map=e,this.$Map.once("postrender",this.render,this),this.$Map.renderSync(),this._unRegisterEvents(),this._registerEvents()},n.prototype.getChartOptions=function(){return this.$chartOptions},n.prototype.setChartOptions=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.$chartOptions=t,this.$Map.once("postrender",this.render,this),this.$Map.renderSync(),this},n.prototype.getMap=function(){return this.$Map},n.prototype._isVisible=function(){return this.$container&&""===this.$container.style.display},n.prototype.show=function(){this.$container&&(this.$container.style.display="")},n.prototype.hide=function(){this.$container&&(this.$container.style.display="none")},n.prototype.remove=function(){this.$chart.clear(),this.$chart.dispose(),this._unRegisterEvents(),delete this.$chart,delete this.$Map,this.$container.parentNode.removeChild(this.$container)},n.prototype.clear=function(){this.$chart.clear()},n.prototype.showLoading=function(){this.$chart&&this.$chart.showLoading()},n.prototype.hideLoading=function(){this.$chart&&this.$chart.hideLoading()},n.prototype._createLayerContainer=function(t,e){var n=this.$container=document.createElement("div");n.style.position="absolute",n.style.top=0,n.style.left=0,n.style.right=0,n.style.bottom=0;var o=s(e.target);if(o&&o[0]&&o[0]instanceof Element)o[0].appendChild(n);else{var i=s(".ol-overlaycontainer");i&&i[0]&&i[0]instanceof Element?i[0].appendChild(n):t.getViewport().appendChild(n)}},n.prototype._resizeContainer=function(){var t=this.getMap().getSize();this.$container.style.height=t[1]+"px",this.$container.style.width=t[0]+"px"},n.prototype._clearAndRedraw=function(){!this.$chart||this.$container&&"none"===this.$container.style.display||(this.$options.forcedRerender&&this.$chart.clear(),this.$chart.resize(),this.$chartOptions&&(this._registerMap(),this.$chart.setOption(this.reConverData(this.$chartOptions),!1)))},n.prototype.onResize=function(){this._resizeContainer(),this._clearAndRedraw()},n.prototype.onZoomEnd=function(){this.$options.hideOnZooming?(this.show(),this._clearAndRedraw()):this._clearAndRedraw()},n.prototype.onDragRotateEnd=function(){this.$options.hideOnRotating?(this.show(),this._clearAndRedraw()):this._clearAndRedraw()},n.prototype.onMoveStart=function(){this.$options.hideOnMoving&&this.hide()},n.prototype.onMoveEnd=function(){this.$options.hideOnMoving?(this.show(),this._clearAndRedraw()):this._clearAndRedraw()},n.prototype.onCenterChange=function(t){this._clearAndRedraw()},n.prototype._registerEvents=function(){var t=this.$Map,e=t.getView();t.on("change:size",this.onResize,this),e.on("change:resolution",this.onZoomEnd,this),e.on("change:center",this.onCenterChange,this),e.on("change:rotation",this.onDragRotateEnd,this),t.on("movestart",this.onMoveStart,this),t.on("moveend",this.onMoveEnd,this)},n.prototype._unRegisterEvents=function(){var t=this.$Map,e=t.getView();t.un("change:size",this.onResize,this),e.un("change:resolution",this.onZoomEnd,this),e.un("change:center",this.onCenterChange,this),e.un("change:rotation",this.onDragRotateEnd,this),t.un("movestart",this.onMoveStart,this),t.un("moveend",this.onMoveEnd,this)},n.prototype._registerMap=function(){this._isRegistered||(e.registerCoordinateSystem("openlayers",c(this.getMap(),this.$options)),this._isRegistered=!0);var t=this.$chartOptions.series;if(t&&i(t))for(var n=t.length-1;n>=0;n--)this.$options.convertTypes.indexOf(t[n].type)>-1||(t[n].coordinateSystem="openlayers"),t[n].animation=!1},n.prototype.reConverData=function(t){var e=t.series;if(e&&e.length>0){if(!this._coordinateSystem){var n=c(this.getMap(),this.$options);this._coordinateSystem=new n}if(e&&i(e))for(var o=e.length-1;o>=0;o--)this.$options.convertTypes.indexOf(e[o].type)>-1&&e[o]&&e[o].hasOwnProperty("coordinates")&&(e[o]=p[e[o].type](t,e[o],this._coordinateSystem))}return t},n.prototype.render=function(){this.$container||(this._createLayerContainer(this.$Map,this.$options),this._resizeContainer()),this.$chart?this._isVisible()&&this.$chart.resize():(this.$chart=e.init(this.$container),this.$chartOptions&&(this._registerMap(),this.$chart.setOption(this.reConverData(this.$chartOptions),!1)))},n.prototype.reRender=function(){this._clearAndRedraw()},n}();return d.getTarget=s,d.merge=r,d.map=a,d.bind=h,d});