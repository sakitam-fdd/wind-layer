import{W as J,d as K,i as Q,f as tt,a as F,c as et}from"./wind-core.esm.CHEVv6qw.js";import{F as Zt}from"./wind-core.esm.CHEVv6qw.js";import{h as it,f as st,i as _,b as ot,S as nt,O as Z,B as at,L as C,c as M,r as rt,p as ht,M as g,P as ct,V as x,d as lt}from"./index.CGiPxbJQ.js";import{D as bt,I as Bt,e as Ot,R as It,a as jt,T as Wt,g as Dt,j as kt}from"./index.CGiPxbJQ.js";import{a as d}from"./leaflet-src.Blu32DaZ.js";import"./commonjsHelpers.Cpj98o6Y.js";class E extends d.Layer{constructor(t,e,i){super(t,e,i)}initialize(t,e,i){if(!t)throw Error("layer id must be specified");this._layerId=t,d.Util.setOptions(this,i),this.devicePixelRatio=this.options.devicePixelRatio||window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI}_createCanvas(t,e){const i=d.DomUtil.create("div","leaflet-canvas-layer"),s=et(this._width,this._height,this.devicePixelRatio);return s.id=String(t),s.style.position="absolute",s.style.top=String(0),s.style.left=String(0),s.style.zIndex=String(e),s.style.willChange="transform",s.style.width=this._width+"px",s.style.height=this._height+"px",i.appendChild(s),this._map.getPanes().overlayPane.appendChild(i),{layer:i,canvas:s}}_reset(){const t=this._map.containerPointToLayerPoint([0,0]);d.DomUtil.setPosition(this.canvas,t)}_onResize(t){this.canvas.style.width=t.newSize.x+"px",this.canvas.style.height=t.newSize.y+"px",this._width=t.newSize.x,this._height=t.newSize.y,this._resizeCanvas(this.devicePixelRatio)}_zoomStart(){this._moveStart()}_moveStart(){this._updating||(this._updating=!0)}_animateZoom(t){const e=this._map.getZoomScale(t.zoom),i=this._map._latLngToNewLayerPoint(this._map.getBounds().getNorthWest(),t.zoom,t.center);d.DomUtil.setTransform(this.canvas,i,e)}_resizeCanvas(t){this.canvas.width=this._width*t,this.canvas.height=this._height*t}_render(){}project(t){const e=this._map.latLngToContainerPoint(new d.LatLng(t[1],t[0]));return[e.x*this.devicePixelRatio,e.y*this.devicePixelRatio]}unproject(t){const e=this._map.containerPointToLatLng(new d.Point(t[0],t[1]));return[e.lng,e.lat]}intersectsCoordinate(t){return this._map.getBounds().contains(d.latLng(t[1],t[0]))}onAdd(t){this._map=t,this._width=t.getSize().x,this._height=t.getSize().y;const{layer:e,canvas:i}=this._createCanvas(this._layerId,this.options.zIndex||1);this.layer=e,this.canvas=i;const s=this._map.options.zoomAnimation&&d.Browser.any3d;return d.DomUtil.addClass(this.canvas,"leaflet-zoom-"+(s?"animated":"hide")),this._map.on(this.getEvents(),this),this._render(),this}onRemove(){return this._map.getPanes().overlayPane.removeChild(this.layer),this._map.off(this.getEvents(),this),this.canvas=null,this}getEvents(){const t={resize:this._onResize,viewreset:this._render,moveend:this._render,zoomstart:this._render,zoomend:this._render};return this._map.options.zoomAnimation&&d.Browser.any3d&&(t.zoomanim=this._animateZoom),t}}class Pt extends E{initialize(t,e,i){super.initialize(t,e,i),this.field=void 0,this.pickWindOptions(),e&&this.setData(e,i.fieldOptions)}_render(){this._reset();const t=this.getWindOptions();if(!this.wind&&this._map){const e=this.canvas.getContext("2d"),i=this.getData();this.wind=new J(e,t,i),this.wind.project=this.project.bind(this),this.wind.unproject=this.unproject.bind(this),this.wind.intersectsCoordinate=this.intersectsCoordinate.bind(this),this.wind.postrender=()=>{}}this.wind.prerender(),this.wind.render()}onRemove(){return this.wind&&(this.wind.stop(),this.wind=null),super.onRemove()}pickWindOptions(){Object.keys(K).forEach(t=>{t in this.options&&(this.options.windOptions===void 0&&(this.options.windOptions={}),this.options.windOptions[t]=this.options[t])})}getData(){return this.field}setData(t,e={}){var i;return t&&t.checkFields&&t.checkFields()?this.field=t:Q(t)?this.field=tt(t,e):console.error("Illegal data"),this.field&&((i=this==null?void 0:this.wind)==null||i.updateData(this.field)),this}setWindOptions(t){const e=this.options.windOptions||{};if(this.options=F(this.options,{windOptions:F(e,t||{})}),this.wind){const i=this.options.windOptions;this.wind.setOptions(i),this.wind.prerender()}}getWindOptions(){return this.options.windOptions||{}}}const{clamp:pt}=_,mt=63710088e-1,dt=2*Math.PI*mt;function ut(o){return dt*Math.cos(o*Math.PI/180)}function A(o){return(180+o)/360}function X(o){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+o*Math.PI/360)))/360}function B(o,t){return o/ut(t)}function R(o,t=0){return o*360-180+t*360}function b(o){const t=180-o*360;return 360/Math.PI*Math.atan(Math.exp(t*Math.PI/180))-90}const v=85.051129;function y(o,t=0){const e=pt(o.lat,-v,v);return{x:A(o.lng),y:X(e),z:B(t,e)}}function gt(o){let t=1/0,e=1/0,i=-1/0,s=-1/0;for(const c of o)t=Math.min(t,c.x),e=Math.min(e,c.y),i=Math.max(i,c.x),s=Math.max(s,c.y);const n=i-t,a=s-e,l=Math.max(n,a),r=Math.max(0,Math.floor(-Math.log(l)/Math.LN2)),h=Math.pow(2,r);return{z:r,x:Math.floor((t+i)/2*h),y:Math.floor((e+s)/2*h),extent:[t,e,i,s]}}const{degToRad:L,radToDeg:wt}=_;it(!0);st([]);class ft{constructor(t,e,i){this.worldMatrix=new g,this.mercatorMatrix=new g,this.labelPlaneMatrix=new g,this.glCoordMatrix=new g;const{width:s,height:n}=t,a=wt(Math.atan(3/4)),l=.1,r=1e21;this.viewState=t,this.scene=i,this.scene.matrixAutoUpdate=!1,this.scene.worldMatrixNeedsUpdate=!0,this.camera=e==="orthographic"?new Z(-s/2,s/2,n/2,-n/2,l,r):new ct(a,s/n,l,r),this.camera.matrixAutoUpdate=!1,this.camera.position.z=600,this.setup()}setup(){const{width:t,height:e,fov:i}=this.viewState,s=L(this.viewState.maxPitch);this.camera.aspect=t/e,this.halfFov=i/2,this.cameraToCenterDistance=.5/Math.tan(this.halfFov)*e,this.acuteAngle=Math.PI/2-s,this.update()}update(){const{width:t,height:e,elevation:i,_horizonShift:s,worldSize:n}=this.viewState,a=this.viewState.getCenter(),l=this.viewState.getPitch(),r=L(l),h=this.viewState.getBearing(),c=this.viewState.getFovRad(),p=this.viewState.getCameraPosition(),m=c/2,u=Math.cos(Math.PI/2-r),w=Math.PI/2+r;this.cameraToCenterDistance=.5/Math.tan(m)*e;const f=this.viewState.project(a),U=new g().fromRotationZ(Math.PI),N=new g().fromScale(new x(-n,n,n)),Y=new g().fromTranslation(new x(-f.x,f.y,0)),O=e/50,I=Math.max(O*u,O),j=c*(.5+this.viewState.centerOffset().y/e),W=B(1,a.lat)*n||1,V=i?i.getMinElevationBelowMSL()*W:0,T=(p[2]*n-V)/Math.cos(r),q=Math.sin(j)*T/Math.sin(_.clamp(Math.PI-w-j,.01,Math.PI-.01)),G=u*q+T,H=T*(1/s),D=Math.min(G*1.01,H);this.mercatorMatrix=new g().scale(new x(n,n,n/W));const $=new g().fromTranslation(new x(0,0,this.cameraToCenterDistance));this.labelPlaneMatrix=new g;const z=new g;z.scale(new x(1,-1,1)),z.translate(new x(-1,-1,0)),z.scale(new x(2/t,2/e,1)),this.glCoordMatrix=z,this.camera.aspect=t/e,this.cameraTranslateZ=this.cameraToCenterDistance,this.camera instanceof Z?this.camera.projectionMatrix.orthographic(-t/2,t/2,e/2,-e/2,I,D):this.camera.projectionMatrix.perspective(c,t/e,I,D);const k=new g().premultiply($).premultiply(new g().fromRotationX(r)).premultiply(new g().fromRotationZ(-L(h)));i&&(k.elements[14]=p[2]*n),this.camera.worldMatrix.copy(k),this.camera.updateMatrixWorld(),this.scene&&(this.scene.localMatrix=new lt().premultiply(U).premultiply(N).premultiply(Y))}}function S(o){const t=1<<o.z;return{left:o.wrapedX/t,top:o.wrapedY/t,right:(o.wrapedX+1)/t,bottom:(o.wrapedY+1)/t}}function P(o){const{z:t,x:e,y:i}=o,s=o.wrap,n=1<<t,a=R(e/n,s),l=R((e+1)/n,s),r=b(i/n),h=b((i+1)/n);return[a,h,l,r]}function xt(o){const t=o==null?void 0:o.getBounds(),e=t.getSouthWest(),i=t.getNorthEast(),[s,n,a,l]=[e.lng,e.lat,i.lng,i.lat],r=Math.max(n,v),h=Math.min(l,-v),c=y({lng:s,lat:h}),p=y({lng:a,lat:r});return[c.x,c.y,p.x,p.y]}function yt(o){const t=o.zoom;return o.minzoom!==void 0&&t<o.minzoom?o.minzoom:o.maxzoom!==void 0&&o.maxzoom<t?o.maxzoom:t}class _t{constructor(){this.tileSize=512,this.maxPitch=60,this._horizonShift=.1}get width(){return this._width}get height(){return this._height}get fov(){return this.getFovRad()/Math.PI*180}get worldSize(){const t=Math.pow(2,this.zoom-1);return this.tileSize*t}getCenter(){return this._center}getPitch(){return 0}getBearing(){return 0}getFovRad(){return .6435011087932844}getCameraPosition(){return[0,0,0]}centerOffset(){return{x:0,y:0}}project(t){const e=_.clamp(t.lat,-v,v),i=A(t.lng),s=X(e);return{x:i*this.worldSize,y:s*this.worldSize,z:0}}get pixelsPerMeter(){return B(1,this._center.lat)*this.worldSize}unproject(t){const e=R(t[0]),i=b(t[1]);return[e,i]}}class Tt extends E{initialize(t,e,i){super.initialize(t,e,i),this.viewState=new _t,this.source=e}_resizeCanvas(t){super._resizeCanvas(t),this.renderer.setSize(this._width,this._height),this.proxyLayer&&this.proxyLayer.resize(this._width,this._height),this._render()}get camera(){return this.sync.camera}_render(){var t,e;if(this._reset(),this._map&&this.viewState){this.viewState._center=this._map.getCenter(),this.viewState._width=this._width,this.viewState._height=this._height,this.viewState.zoom=this._map.getZoom(),this.calcTileZoom(this.viewState.zoom);const i=this._map,s=i.options.crs;this.wrapXNumber=[Math.floor(i.project([0,(t=s==null?void 0:s.wrapLng)==null?void 0:t[0]],this._tileZoom).x/this.source.tileSize),Math.ceil(i.project([0,(e=s==null?void 0:s.wrapLng)==null?void 0:e[1]],this._tileZoom).x/this.source.tileSize)]}this.gl||(this.gl=_.getContext(this.canvas,{preserveDrawingBuffer:!1,antialias:!0,stencil:!0},!0),this.renderer=new ot(this.gl,{autoClear:!1,extensions:["OES_texture_float","OES_texture_float_linear","WEBGL_color_buffer_float","EXT_color_buffer_float"]}),this.scene=new nt,this.sync=new ft(this.viewState,"perspective",this.scene),this.planeCamera=new Z(0,1,1,0,0,1),this.proxyLayer=new at(this.source,{renderer:this.renderer,scene:this.scene},{renderType:this.options.renderType,renderFrom:this.options.renderFrom,styleSpec:this.options.styleSpec,displayRange:this.options.displayRange,widthSegments:this.options.widthSegments,heightSegments:this.options.heightSegments,wireframe:this.options.wireframe,picking:this.options.picking,mask:this.processMask(),getZoom:()=>this.viewState.zoom,triggerRepaint:()=>{requestAnimationFrame(()=>this._render())},getTileProjSize:i=>{const s=1/Math.pow(2,i);return[s,s]},getPixelsToUnits:()=>{const s=this.canvas.clientHeight/2-.5,n=this.canvas.clientWidth/2-1/2,a=y(this.viewState.unproject([n,s])),l=y(this.viewState.unproject([n+1,s+1]));return[Math.abs(l.x-a.x),Math.abs(a.y-l.y)]},getPixelsToProjUnit:()=>[this.viewState.pixelsPerMeter,this.viewState.pixelsPerMeter],getViewTiles:(i,s)=>{var l;let{type:n}=i;if(n=n!==C.timeline?n:i.privateType,!this._map)return[];const a=[];if(n===C.image){const r=i.coordinates.map(c=>y({lng:c[0],lat:c[1]})),h=gt(r);if(!i.wrapX){const c=h.x,p=h.y,m=h.z,u=0;a.push(new M(m,u,m,c,p,{getTileBounds:()=>[i.coordinates[0][0],i.coordinates[2][1],i.coordinates[1][0],i.coordinates[0][1]],getTileProjBounds:()=>({left:h.extent[0]+u,top:h.extent[1],right:h.extent[2]+u,bottom:h.extent[3]})}))}}else if(n===C.tile){const r={tileSize:_.isNumber(this.source.tileSize)?i.tileSize:((l=i.tileSize)==null?void 0:l[0])||512,minzoom:i.minZoom,maxzoom:i.maxZoom,roundZoom:i.roundZoom,zoom:this.viewState.zoom,center:this.viewState.getCenter()},h=this.coveringTiles(r);for(let c=0;c<h.length;c++){const p=h[c],{x:m,y:u,z:w,wrap:f}=p;i.wrapX?a.push(new M(w,f,w,m,u,{getTileBounds:P,getTileProjBounds:S})):p.wrap===0&&a.push(new M(w,f,w,m,u,{getTileBounds:P,getTileProjBounds:S}))}}return a},getExtent:()=>xt(this._map),getGridTiles:i=>{const s=i.tileSize,n=i.wrapX;if(!this._map)return[];const a={tileSize:s??256,minzoom:this._map.getMinZoom(),maxzoom:this._map.getMaxZoom(),roundZoom:!1,zoom:this.viewState.zoom,center:this.viewState.getCenter()},l=this.coveringTiles(a),r=[];for(let h=0;h<l.length;h++){const c=l[h],{x:p,y:m,z:u,wrap:w}=c;n?r.push(new M(u,w,u,p,m,{getTileBounds:P,getTileProjBounds:S})):c.wrap===0&&r.push(new M(u,w,u,p,m,{getTileBounds:P,getTileProjBounds:S}))}return r}})),this.sync&&this.sync.update(),this.proxyLayer&&this.proxyLayer.update(),this.glPrerender(),this.glRender()}glPrerender(){var e;this.scene.worldMatrixNeedsUpdate=!0,this.scene.updateMatrixWorld(),this.camera.updateMatrixWorld();const t=this.calcWrappedWorlds();(e=this.proxyLayer)==null||e.prerender({worlds:t,camera:this.camera,planeCamera:this.planeCamera})}glRender(){var e;this.scene.worldMatrixNeedsUpdate=!0,this.scene.updateMatrixWorld(),this.camera.updateMatrixWorld();const t=this.calcWrappedWorlds();(e=this.proxyLayer)==null||e.render({worlds:t,camera:this.camera,planeCamera:this.planeCamera})}async picker(t){if(!this.options.picking)return console.warn("[Layer]: please enable picking options!"),null;if(!this.layer||!t||!this._map)return console.warn("[Layer]: layer not initialized!"),null;const e=this._map.project(t);return this.proxyLayer.picker([e.x,e.y])}calcWrappedWorlds(){return[0]}_setView(){}_tileCoordsToBounds(t){}_isValidTile(t){if(!this.options.bounds)return!0}_wrapCoords(t){const e=new d.Point(this.wrapXNumber?d.Util.wrapNum(t.x,this.wrapXNumber):t.x,t.y);return e.z=t.z,e}coveringTiles(t){const e=this._getTiledPixelBounds(t.center),i=this._pxBoundsToTileRange(e,t),s=i.getCenter(),n=[];if(!(isFinite(i.min.x)&&isFinite(i.min.y)&&isFinite(i.max.x)&&isFinite(i.max.y)))throw new Error("Attempted to load an infinite number of tiles");for(let a=i.min.y;a<=i.max.y;a++)for(let l=i.min.x;l<=i.max.x;l++){const r=new d.Point(l,a);r.z=this._tileZoom,this._isValidTile(r)&&n.push(this._wrapCoords(r))}return n.sort((a,l)=>a.distanceTo(s)-l.distanceTo(s)),n}calcTileZoom(t){const e=Math.round(t);this.options.maxZoom!==void 0&&e>this.options.maxZoom||this.options.minZoom!==void 0&&e<this.options.minZoom?this._tileZoom=void 0:this._tileZoom=yt({minzoom:this.source.minZoom,maxzoom:this.source.maxZoom,zoom:this.viewState.zoom})}_getTiledPixelBounds(t){const e=this._map,i=e._animatingZoom?Math.max(e._animateToZoom,e.getZoom()):e.getZoom(),s=e.getZoomScale(i,this._tileZoom),n=e.project(t,this._tileZoom).floor(),a=e.getSize().divideBy(s*2);return new d.Bounds(n.subtract(a),n.add(a))}_pxBoundsToTileRange(t,e){const i=new d.Point(e.tileSize,e.tileSize);return new d.Bounds(t.min.unscaleBy(i).floor(),t.max.unscaleBy(i).ceil().subtract([1,1]))}handleZoom(){this.proxyLayer&&this.proxyLayer.handleZoom(),this._render()}onMoveEnd(){this.proxyLayer&&this.proxyLayer.moveEnd(),this._render()}onMoveStart(){this.proxyLayer&&this.proxyLayer.moveStart(),this._render()}_animateZoom(t){super._animateZoom(t),this.handleZoom()}getEvents(){const t={resize:this._onResize,viewreset:this._render,moveend:this.onMoveEnd,movestart:this.onMoveStart,zoom:this.handleZoom,zoomend:this._render};return this._map.options.zoomAnimation&&d.Browser.any3d&&(t.zoomanim=this._animateZoom),t}updateOptions(t){this.options={...this.options,...t||{}},this.proxyLayer&&this.proxyLayer.updateOptions(t)}getMask(){return this.options.mask}processMask(){if(this.options.mask){const t=this.options.mask,e=t.data;rt(e,!0);const i=r=>{const h=[];for(let c=0;c<r.length;c++){const p=r[c],m=y(p);h.push([m.x,m.y])}return h},s=e.features,n=s.length;let a=0;const l=[];for(;a<n;a++){const r=s[a],h=r.geometry.coordinates,c=r.geometry.type;if(c==="Polygon")l.push({type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:r.geometry.coordinates.map(p=>i(p))}});else if(c==="MultiPolygon"){const p=[];for(let m=0;m<h.length;m++){const u=h[m],w=[];for(let f=0;f<u.length;f++)w.push(i(h[m][f]));p.push(w)}l.push({type:"Feature",properties:{},geometry:{type:"MultiPolygon",coordinates:p}})}}return{data:ht(l),type:t.type}}}setMask(t){this.options.mask=Object.assign({},this.options.mask,t),this.proxyLayer&&this.proxyLayer.setMask(this.processMask())}onRemove(){return this.proxyLayer&&(this.proxyLayer.destroy(),this.proxyLayer=null),this.gl=null,super.onRemove()}}export{bt as DecodeType,Zt as Field,Bt as ImageSource,C as LayerSourceType,Ot as MaskType,It as RenderFrom,jt as RenderType,M as TileID,Wt as TileSource,Dt as TimelineSource,Tt as WebglLayer,Pt as WindLayer,kt as configDeps};
