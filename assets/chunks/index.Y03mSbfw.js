var dl=Object.defineProperty;var pl=(t,i,e)=>i in t?dl(t,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[i]=e;var N=(t,i,e)=>(pl(t,typeof i!="symbol"?i+"":i,e),e),kn=(t,i,e)=>{if(!i.has(t))throw TypeError("Cannot "+e)};var o=(t,i,e)=>(kn(t,i,"read from private field"),e?e.call(t):i.get(t)),S=(t,i,e)=>{if(i.has(t))throw TypeError("Cannot add the same private member more than once");i instanceof WeakSet?i.add(t):i.set(t,e)},y=(t,i,e,s)=>(kn(t,i,"write to private field"),s?s.call(t,e):i.set(t,e),e);var Li=(t,i,e,s)=>({set _(r){y(t,i,r,e)},get _(){return o(t,i,s)}}),ls=(t,i,e)=>(kn(t,i,"access private method"),e);import{g as Yh}from"./commonjsHelpers.Cpj98o6Y.js";var K=1e-6,rt=typeof Float32Array<"u"?Float32Array:Array;function gl(t){rt=t}Math.hypot||(Math.hypot=function(){for(var t=0,i=arguments.length;i--;)t+=arguments[i]*arguments[i];return Math.sqrt(t)});function ml(){var t=new rt(9);return rt!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function vl(t,i){return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[4],t[4]=i[5],t[5]=i[6],t[6]=i[8],t[7]=i[9],t[8]=i[10],t}function xl(t,i){return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t}function yl(t,i,e,s,r,n,l,c,d,p){return t[0]=i,t[1]=e,t[2]=s,t[3]=r,t[4]=n,t[5]=l,t[6]=c,t[7]=d,t[8]=p,t}function bl(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function wl(t,i){if(t===i){var e=i[1],s=i[2],r=i[5];t[1]=i[3],t[2]=i[6],t[3]=e,t[5]=i[7],t[6]=s,t[7]=r}else t[0]=i[0],t[1]=i[3],t[2]=i[6],t[3]=i[1],t[4]=i[4],t[5]=i[7],t[6]=i[2],t[7]=i[5],t[8]=i[8];return t}function _l(t,i){var e=i[0],s=i[1],r=i[2],n=i[3],l=i[4],c=i[5],d=i[6],p=i[7],g=i[8],v=g*l-c*p,w=-g*n+c*d,_=p*n-l*d,T=e*v+s*w+r*_;return T?(T=1/T,t[0]=v*T,t[1]=(-g*s+r*p)*T,t[2]=(c*s-r*l)*T,t[3]=w*T,t[4]=(g*e-r*d)*T,t[5]=(-c*e+r*n)*T,t[6]=_*T,t[7]=(-p*e+s*d)*T,t[8]=(l*e-s*n)*T,t):null}function Tl(t,i){var e=i[0],s=i[1],r=i[2],n=i[3],l=i[4],c=i[5],d=i[6],p=i[7],g=i[8];return t[0]=l*g-c*p,t[1]=r*p-s*g,t[2]=s*c-r*l,t[3]=c*d-n*g,t[4]=e*g-r*d,t[5]=r*n-e*c,t[6]=n*p-l*d,t[7]=s*d-e*p,t[8]=e*l-s*n,t}function Ml(t){var i=t[0],e=t[1],s=t[2],r=t[3],n=t[4],l=t[5],c=t[6],d=t[7],p=t[8];return i*(p*n-l*d)+e*(-p*r+l*c)+s*(d*r-n*c)}function kr(t,i,e){var s=i[0],r=i[1],n=i[2],l=i[3],c=i[4],d=i[5],p=i[6],g=i[7],v=i[8],w=e[0],_=e[1],T=e[2],E=e[3],A=e[4],R=e[5],U=e[6],C=e[7],I=e[8];return t[0]=w*s+_*l+T*p,t[1]=w*r+_*c+T*g,t[2]=w*n+_*d+T*v,t[3]=E*s+A*l+R*p,t[4]=E*r+A*c+R*g,t[5]=E*n+A*d+R*v,t[6]=U*s+C*l+I*p,t[7]=U*r+C*c+I*g,t[8]=U*n+C*d+I*v,t}function Al(t,i,e){var s=i[0],r=i[1],n=i[2],l=i[3],c=i[4],d=i[5],p=i[6],g=i[7],v=i[8],w=e[0],_=e[1];return t[0]=s,t[1]=r,t[2]=n,t[3]=l,t[4]=c,t[5]=d,t[6]=w*s+_*l+p,t[7]=w*r+_*c+g,t[8]=w*n+_*d+v,t}function El(t,i,e){var s=i[0],r=i[1],n=i[2],l=i[3],c=i[4],d=i[5],p=i[6],g=i[7],v=i[8],w=Math.sin(e),_=Math.cos(e);return t[0]=_*s+w*l,t[1]=_*r+w*c,t[2]=_*n+w*d,t[3]=_*l-w*s,t[4]=_*c-w*r,t[5]=_*d-w*n,t[6]=p,t[7]=g,t[8]=v,t}function Sl(t,i,e){var s=e[0],r=e[1];return t[0]=s*i[0],t[1]=s*i[1],t[2]=s*i[2],t[3]=r*i[3],t[4]=r*i[4],t[5]=r*i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t}function Rl(t,i){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=i[0],t[7]=i[1],t[8]=1,t}function Cl(t,i){var e=Math.sin(i),s=Math.cos(i);return t[0]=s,t[1]=e,t[2]=0,t[3]=-e,t[4]=s,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Fl(t,i){return t[0]=i[0],t[1]=0,t[2]=0,t[3]=0,t[4]=i[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Pl(t,i){var e=i[0],s=i[1],r=i[2],n=i[3],l=e+e,c=s+s,d=r+r,p=e*l,g=s*l,v=s*c,w=r*l,_=r*c,T=r*d,E=n*l,A=n*c,R=n*d;return t[0]=1-v-T,t[3]=g-R,t[6]=w+A,t[1]=g+R,t[4]=1-p-T,t[7]=_-E,t[2]=w-A,t[5]=_+E,t[8]=1-p-v,t}function Xa(t,i){var e=i[0],s=i[1],r=i[2],n=i[3],l=i[4],c=i[5],d=i[6],p=i[7],g=i[8],v=i[9],w=i[10],_=i[11],T=i[12],E=i[13],A=i[14],R=i[15],U=e*c-s*l,C=e*d-r*l,I=e*p-n*l,O=s*d-r*c,V=s*p-n*c,Q=r*p-n*d,X=g*E-v*T,se=g*A-w*T,ie=g*R-_*T,W=v*A-w*E,oe=v*R-_*E,le=w*R-_*A,q=U*le-C*oe+I*W+O*ie-V*se+Q*X;return q?(q=1/q,t[0]=(c*le-d*oe+p*W)*q,t[1]=(d*ie-l*le-p*se)*q,t[2]=(l*oe-c*ie+p*X)*q,t[3]=(r*oe-s*le-n*W)*q,t[4]=(e*le-r*ie+n*se)*q,t[5]=(s*ie-e*oe-n*X)*q,t[6]=(E*Q-A*V+R*O)*q,t[7]=(A*I-T*Q-R*C)*q,t[8]=(T*V-E*I+R*U)*q,t):null}function Il(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])}function Qa(t,i,e){return t[0]=i[0]+e[0],t[1]=i[1]+e[1],t[2]=i[2]+e[2],t[3]=i[3]+e[3],t[4]=i[4]+e[4],t[5]=i[5]+e[5],t[6]=i[6]+e[6],t[7]=i[7]+e[7],t[8]=i[8]+e[8],t}function Ja(t,i,e){return t[0]=i[0]-e[0],t[1]=i[1]-e[1],t[2]=i[2]-e[2],t[3]=i[3]-e[3],t[4]=i[4]-e[4],t[5]=i[5]-e[5],t[6]=i[6]-e[6],t[7]=i[7]-e[7],t[8]=i[8]-e[8],t}function eh(t,i){var e=t[0],s=t[1],r=t[2],n=t[3],l=t[4],c=t[5],d=t[6],p=t[7],g=t[8],v=i[0],w=i[1],_=i[2],T=i[3],E=i[4],A=i[5],R=i[6],U=i[7],C=i[8];return Math.abs(e-v)<=K*Math.max(1,Math.abs(e),Math.abs(v))&&Math.abs(s-w)<=K*Math.max(1,Math.abs(s),Math.abs(w))&&Math.abs(r-_)<=K*Math.max(1,Math.abs(r),Math.abs(_))&&Math.abs(n-T)<=K*Math.max(1,Math.abs(n),Math.abs(T))&&Math.abs(l-E)<=K*Math.max(1,Math.abs(l),Math.abs(E))&&Math.abs(c-A)<=K*Math.max(1,Math.abs(c),Math.abs(A))&&Math.abs(d-R)<=K*Math.max(1,Math.abs(d),Math.abs(R))&&Math.abs(p-U)<=K*Math.max(1,Math.abs(p),Math.abs(U))&&Math.abs(g-C)<=K*Math.max(1,Math.abs(g),Math.abs(C))}function Ul(t,i){return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],t}function zl(t,i,e,s,r,n,l,c,d,p,g,v,w,_,T,E,A){return t[0]=i,t[1]=e,t[2]=s,t[3]=r,t[4]=n,t[5]=l,t[6]=c,t[7]=d,t[8]=p,t[9]=g,t[10]=v,t[11]=w,t[12]=_,t[13]=T,t[14]=E,t[15]=A,t}function Kh(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ll(t,i){if(t===i){var e=i[1],s=i[2],r=i[3],n=i[6],l=i[7],c=i[11];t[1]=i[4],t[2]=i[8],t[3]=i[12],t[4]=e,t[6]=i[9],t[7]=i[13],t[8]=s,t[9]=n,t[11]=i[14],t[12]=r,t[13]=l,t[14]=c}else t[0]=i[0],t[1]=i[4],t[2]=i[8],t[3]=i[12],t[4]=i[1],t[5]=i[5],t[6]=i[9],t[7]=i[13],t[8]=i[2],t[9]=i[6],t[10]=i[10],t[11]=i[14],t[12]=i[3],t[13]=i[7],t[14]=i[11],t[15]=i[15];return t}function kl(t,i){var e=i[0],s=i[1],r=i[2],n=i[3],l=i[4],c=i[5],d=i[6],p=i[7],g=i[8],v=i[9],w=i[10],_=i[11],T=i[12],E=i[13],A=i[14],R=i[15],U=e*c-s*l,C=e*d-r*l,I=e*p-n*l,O=s*d-r*c,V=s*p-n*c,Q=r*p-n*d,X=g*E-v*T,se=g*A-w*T,ie=g*R-_*T,W=v*A-w*E,oe=v*R-_*E,le=w*R-_*A,q=U*le-C*oe+I*W+O*ie-V*se+Q*X;return q?(q=1/q,t[0]=(c*le-d*oe+p*W)*q,t[1]=(r*oe-s*le-n*W)*q,t[2]=(E*Q-A*V+R*O)*q,t[3]=(w*V-v*Q-_*O)*q,t[4]=(d*ie-l*le-p*se)*q,t[5]=(e*le-r*ie+n*se)*q,t[6]=(A*I-T*Q-R*C)*q,t[7]=(g*Q-w*I+_*C)*q,t[8]=(l*oe-c*ie+p*X)*q,t[9]=(s*ie-e*oe-n*X)*q,t[10]=(T*V-E*I+R*U)*q,t[11]=(v*I-g*V-_*U)*q,t[12]=(c*se-l*W-d*X)*q,t[13]=(e*W-s*se+r*X)*q,t[14]=(E*C-T*O-A*U)*q,t[15]=(g*O-v*C+w*U)*q,t):null}function Ol(t,i){var e=i[0],s=i[1],r=i[2],n=i[3],l=i[4],c=i[5],d=i[6],p=i[7],g=i[8],v=i[9],w=i[10],_=i[11],T=i[12],E=i[13],A=i[14],R=i[15];return t[0]=c*(w*R-_*A)-v*(d*R-p*A)+E*(d*_-p*w),t[1]=-(s*(w*R-_*A)-v*(r*R-n*A)+E*(r*_-n*w)),t[2]=s*(d*R-p*A)-c*(r*R-n*A)+E*(r*p-n*d),t[3]=-(s*(d*_-p*w)-c*(r*_-n*w)+v*(r*p-n*d)),t[4]=-(l*(w*R-_*A)-g*(d*R-p*A)+T*(d*_-p*w)),t[5]=e*(w*R-_*A)-g*(r*R-n*A)+T*(r*_-n*w),t[6]=-(e*(d*R-p*A)-l*(r*R-n*A)+T*(r*p-n*d)),t[7]=e*(d*_-p*w)-l*(r*_-n*w)+g*(r*p-n*d),t[8]=l*(v*R-_*E)-g*(c*R-p*E)+T*(c*_-p*v),t[9]=-(e*(v*R-_*E)-g*(s*R-n*E)+T*(s*_-n*v)),t[10]=e*(c*R-p*E)-l*(s*R-n*E)+T*(s*p-n*c),t[11]=-(e*(c*_-p*v)-l*(s*_-n*v)+g*(s*p-n*c)),t[12]=-(l*(v*A-w*E)-g*(c*A-d*E)+T*(c*w-d*v)),t[13]=e*(v*A-w*E)-g*(s*A-r*E)+T*(s*w-r*v),t[14]=-(e*(c*A-d*E)-l*(s*A-r*E)+T*(s*d-r*c)),t[15]=e*(c*w-d*v)-l*(s*w-r*v)+g*(s*d-r*c),t}function Bl(t){var i=t[0],e=t[1],s=t[2],r=t[3],n=t[4],l=t[5],c=t[6],d=t[7],p=t[8],g=t[9],v=t[10],w=t[11],_=t[12],T=t[13],E=t[14],A=t[15],R=i*l-e*n,U=i*c-s*n,C=i*d-r*n,I=e*c-s*l,O=e*d-r*l,V=s*d-r*c,Q=p*T-g*_,X=p*E-v*_,se=p*A-w*_,ie=g*E-v*T,W=g*A-w*T,oe=v*A-w*E;return R*oe-U*W+C*ie+I*se-O*X+V*Q}function Or(t,i,e){var s=i[0],r=i[1],n=i[2],l=i[3],c=i[4],d=i[5],p=i[6],g=i[7],v=i[8],w=i[9],_=i[10],T=i[11],E=i[12],A=i[13],R=i[14],U=i[15],C=e[0],I=e[1],O=e[2],V=e[3];return t[0]=C*s+I*c+O*v+V*E,t[1]=C*r+I*d+O*w+V*A,t[2]=C*n+I*p+O*_+V*R,t[3]=C*l+I*g+O*T+V*U,C=e[4],I=e[5],O=e[6],V=e[7],t[4]=C*s+I*c+O*v+V*E,t[5]=C*r+I*d+O*w+V*A,t[6]=C*n+I*p+O*_+V*R,t[7]=C*l+I*g+O*T+V*U,C=e[8],I=e[9],O=e[10],V=e[11],t[8]=C*s+I*c+O*v+V*E,t[9]=C*r+I*d+O*w+V*A,t[10]=C*n+I*p+O*_+V*R,t[11]=C*l+I*g+O*T+V*U,C=e[12],I=e[13],O=e[14],V=e[15],t[12]=C*s+I*c+O*v+V*E,t[13]=C*r+I*d+O*w+V*A,t[14]=C*n+I*p+O*_+V*R,t[15]=C*l+I*g+O*T+V*U,t}function Nl(t,i,e){var s=e[0],r=e[1],n=e[2],l,c,d,p,g,v,w,_,T,E,A,R;return i===t?(t[12]=i[0]*s+i[4]*r+i[8]*n+i[12],t[13]=i[1]*s+i[5]*r+i[9]*n+i[13],t[14]=i[2]*s+i[6]*r+i[10]*n+i[14],t[15]=i[3]*s+i[7]*r+i[11]*n+i[15]):(l=i[0],c=i[1],d=i[2],p=i[3],g=i[4],v=i[5],w=i[6],_=i[7],T=i[8],E=i[9],A=i[10],R=i[11],t[0]=l,t[1]=c,t[2]=d,t[3]=p,t[4]=g,t[5]=v,t[6]=w,t[7]=_,t[8]=T,t[9]=E,t[10]=A,t[11]=R,t[12]=l*s+g*r+T*n+i[12],t[13]=c*s+v*r+E*n+i[13],t[14]=d*s+w*r+A*n+i[14],t[15]=p*s+_*r+R*n+i[15]),t}function th(t,i,e){var s=e[0],r=e[1],n=e[2];return t[0]=i[0]*s,t[1]=i[1]*s,t[2]=i[2]*s,t[3]=i[3]*s,t[4]=i[4]*r,t[5]=i[5]*r,t[6]=i[6]*r,t[7]=i[7]*r,t[8]=i[8]*n,t[9]=i[9]*n,t[10]=i[10]*n,t[11]=i[11]*n,t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],t}function Dl(t,i,e,s){var r=s[0],n=s[1],l=s[2],c=Math.hypot(r,n,l),d,p,g,v,w,_,T,E,A,R,U,C,I,O,V,Q,X,se,ie,W,oe,le,q,_e;return c<K?null:(c=1/c,r*=c,n*=c,l*=c,d=Math.sin(e),p=Math.cos(e),g=1-p,v=i[0],w=i[1],_=i[2],T=i[3],E=i[4],A=i[5],R=i[6],U=i[7],C=i[8],I=i[9],O=i[10],V=i[11],Q=r*r*g+p,X=n*r*g+l*d,se=l*r*g-n*d,ie=r*n*g-l*d,W=n*n*g+p,oe=l*n*g+r*d,le=r*l*g+n*d,q=n*l*g-r*d,_e=l*l*g+p,t[0]=v*Q+E*X+C*se,t[1]=w*Q+A*X+I*se,t[2]=_*Q+R*X+O*se,t[3]=T*Q+U*X+V*se,t[4]=v*ie+E*W+C*oe,t[5]=w*ie+A*W+I*oe,t[6]=_*ie+R*W+O*oe,t[7]=T*ie+U*W+V*oe,t[8]=v*le+E*q+C*_e,t[9]=w*le+A*q+I*_e,t[10]=_*le+R*q+O*_e,t[11]=T*le+U*q+V*_e,i!==t&&(t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t)}function Gl(t,i,e){var s=Math.sin(e),r=Math.cos(e),n=i[4],l=i[5],c=i[6],d=i[7],p=i[8],g=i[9],v=i[10],w=i[11];return i!==t&&(t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t[4]=n*r+p*s,t[5]=l*r+g*s,t[6]=c*r+v*s,t[7]=d*r+w*s,t[8]=p*r-n*s,t[9]=g*r-l*s,t[10]=v*r-c*s,t[11]=w*r-d*s,t}function $l(t,i,e){var s=Math.sin(e),r=Math.cos(e),n=i[0],l=i[1],c=i[2],d=i[3],p=i[8],g=i[9],v=i[10],w=i[11];return i!==t&&(t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t[0]=n*r-p*s,t[1]=l*r-g*s,t[2]=c*r-v*s,t[3]=d*r-w*s,t[8]=n*s+p*r,t[9]=l*s+g*r,t[10]=c*s+v*r,t[11]=d*s+w*r,t}function Vl(t,i,e){var s=Math.sin(e),r=Math.cos(e),n=i[0],l=i[1],c=i[2],d=i[3],p=i[4],g=i[5],v=i[6],w=i[7];return i!==t&&(t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t[0]=n*r+p*s,t[1]=l*r+g*s,t[2]=c*r+v*s,t[3]=d*r+w*s,t[4]=p*r-n*s,t[5]=g*r-l*s,t[6]=v*r-c*s,t[7]=w*r-d*s,t}function Hl(t,i){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function jl(t,i){return t[0]=i[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=i[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ql(t,i,e){var s=e[0],r=e[1],n=e[2],l=Math.hypot(s,r,n),c,d,p;return l<K?null:(l=1/l,s*=l,r*=l,n*=l,c=Math.sin(i),d=Math.cos(i),p=1-d,t[0]=s*s*p+d,t[1]=r*s*p+n*c,t[2]=n*s*p-r*c,t[3]=0,t[4]=s*r*p-n*c,t[5]=r*r*p+d,t[6]=n*r*p+s*c,t[7]=0,t[8]=s*n*p+r*c,t[9]=r*n*p-s*c,t[10]=n*n*p+d,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function Zl(t,i){var e=Math.sin(i),s=Math.cos(i);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=e,t[7]=0,t[8]=0,t[9]=-e,t[10]=s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Wl(t,i){var e=Math.sin(i),s=Math.cos(i);return t[0]=s,t[1]=0,t[2]=-e,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=e,t[9]=0,t[10]=s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Yl(t,i){var e=Math.sin(i),s=Math.cos(i);return t[0]=s,t[1]=e,t[2]=0,t[3]=0,t[4]=-e,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Kl(t,i,e){var s=i[0],r=i[1],n=i[2],l=i[3],c=s+s,d=r+r,p=n+n,g=s*c,v=s*d,w=s*p,_=r*d,T=r*p,E=n*p,A=l*c,R=l*d,U=l*p;return t[0]=1-(_+E),t[1]=v+U,t[2]=w-R,t[3]=0,t[4]=v-U,t[5]=1-(g+E),t[6]=T+A,t[7]=0,t[8]=w+R,t[9]=T-A,t[10]=1-(g+_),t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function Xl(t,i){return t[0]=i[12],t[1]=i[13],t[2]=i[14],t}function Xh(t,i){var e=i[0],s=i[1],r=i[2],n=i[4],l=i[5],c=i[6],d=i[8],p=i[9],g=i[10];return t[0]=Math.hypot(e,s,r),t[1]=Math.hypot(n,l,c),t[2]=Math.hypot(d,p,g),t}function Ql(t,i){var e=new rt(3);Xh(e,i);var s=1/e[0],r=1/e[1],n=1/e[2],l=i[0]*s,c=i[1]*r,d=i[2]*n,p=i[4]*s,g=i[5]*r,v=i[6]*n,w=i[8]*s,_=i[9]*r,T=i[10]*n,E=l+g+T,A=0;return E>0?(A=Math.sqrt(E+1)*2,t[3]=.25*A,t[0]=(v-_)/A,t[1]=(w-d)/A,t[2]=(c-p)/A):l>g&&l>T?(A=Math.sqrt(1+l-g-T)*2,t[3]=(v-_)/A,t[0]=.25*A,t[1]=(c+p)/A,t[2]=(w+d)/A):g>T?(A=Math.sqrt(1+g-l-T)*2,t[3]=(w-d)/A,t[0]=(c+p)/A,t[1]=.25*A,t[2]=(v+_)/A):(A=Math.sqrt(1+T-l-g)*2,t[3]=(c-p)/A,t[0]=(w+d)/A,t[1]=(v+_)/A,t[2]=.25*A),t}function Jl(t,i,e,s){var r=i[0],n=i[1],l=i[2],c=i[3],d=r+r,p=n+n,g=l+l,v=r*d,w=r*p,_=r*g,T=n*p,E=n*g,A=l*g,R=c*d,U=c*p,C=c*g,I=s[0],O=s[1],V=s[2];return t[0]=(1-(T+A))*I,t[1]=(w+C)*I,t[2]=(_-U)*I,t[3]=0,t[4]=(w-C)*O,t[5]=(1-(v+A))*O,t[6]=(E+R)*O,t[7]=0,t[8]=(_+U)*V,t[9]=(E-R)*V,t[10]=(1-(v+T))*V,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function ec(t,i){var e=i[0],s=i[1],r=i[2],n=i[3],l=e+e,c=s+s,d=r+r,p=e*l,g=s*l,v=s*c,w=r*l,_=r*c,T=r*d,E=n*l,A=n*c,R=n*d;return t[0]=1-v-T,t[1]=g+R,t[2]=w-A,t[3]=0,t[4]=g-R,t[5]=1-p-T,t[6]=_+E,t[7]=0,t[8]=w+A,t[9]=_-E,t[10]=1-p-v,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function tc(t,i,e,s,r,n,l){var c=1/(e-i),d=1/(r-s),p=1/(n-l);return t[0]=n*2*c,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n*2*d,t[6]=0,t[7]=0,t[8]=(e+i)*c,t[9]=(r+s)*d,t[10]=(l+n)*p,t[11]=-1,t[12]=0,t[13]=0,t[14]=l*n*2*p,t[15]=0,t}function ic(t,i,e,s,r){var n=1/Math.tan(i/2),l;return t[0]=n/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,r!=null&&r!==1/0?(l=1/(s-r),t[10]=(r+s)*l,t[14]=2*r*s*l):(t[10]=-1,t[14]=-2*s),t}var Qh=ic;function sc(t,i,e,s,r,n,l){var c=1/(i-e),d=1/(s-r),p=1/(n-l);return t[0]=-2*c,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*d,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*p,t[11]=0,t[12]=(i+e)*c,t[13]=(r+s)*d,t[14]=(l+n)*p,t[15]=1,t}var Jh=sc;function rc(t,i,e,s){var r,n,l,c,d,p,g,v,w,_,T=i[0],E=i[1],A=i[2],R=s[0],U=s[1],C=s[2],I=e[0],O=e[1],V=e[2];return Math.abs(T-I)<K&&Math.abs(E-O)<K&&Math.abs(A-V)<K?Kh(t):(g=T-I,v=E-O,w=A-V,_=1/Math.hypot(g,v,w),g*=_,v*=_,w*=_,r=U*w-C*v,n=C*g-R*w,l=R*v-U*g,_=Math.hypot(r,n,l),_?(_=1/_,r*=_,n*=_,l*=_):(r=0,n=0,l=0),c=v*l-w*n,d=w*r-g*l,p=g*n-v*r,_=Math.hypot(c,d,p),_?(_=1/_,c*=_,d*=_,p*=_):(c=0,d=0,p=0),t[0]=r,t[1]=c,t[2]=g,t[3]=0,t[4]=n,t[5]=d,t[6]=v,t[7]=0,t[8]=l,t[9]=p,t[10]=w,t[11]=0,t[12]=-(r*T+n*E+l*A),t[13]=-(c*T+d*E+p*A),t[14]=-(g*T+v*E+w*A),t[15]=1,t)}function ih(t,i,e){return t[0]=i[0]+e[0],t[1]=i[1]+e[1],t[2]=i[2]+e[2],t[3]=i[3]+e[3],t[4]=i[4]+e[4],t[5]=i[5]+e[5],t[6]=i[6]+e[6],t[7]=i[7]+e[7],t[8]=i[8]+e[8],t[9]=i[9]+e[9],t[10]=i[10]+e[10],t[11]=i[11]+e[11],t[12]=i[12]+e[12],t[13]=i[13]+e[13],t[14]=i[14]+e[14],t[15]=i[15]+e[15],t}function sh(t,i,e){return t[0]=i[0]-e[0],t[1]=i[1]-e[1],t[2]=i[2]-e[2],t[3]=i[3]-e[3],t[4]=i[4]-e[4],t[5]=i[5]-e[5],t[6]=i[6]-e[6],t[7]=i[7]-e[7],t[8]=i[8]-e[8],t[9]=i[9]-e[9],t[10]=i[10]-e[10],t[11]=i[11]-e[11],t[12]=i[12]-e[12],t[13]=i[13]-e[13],t[14]=i[14]-e[14],t[15]=i[15]-e[15],t}function nc(t,i,e){return t[0]=i[0]*e,t[1]=i[1]*e,t[2]=i[2]*e,t[3]=i[3]*e,t[4]=i[4]*e,t[5]=i[5]*e,t[6]=i[6]*e,t[7]=i[7]*e,t[8]=i[8]*e,t[9]=i[9]*e,t[10]=i[10]*e,t[11]=i[11]*e,t[12]=i[12]*e,t[13]=i[13]*e,t[14]=i[14]*e,t[15]=i[15]*e,t}function ac(t,i){var e=t[0],s=t[1],r=t[2],n=t[3],l=t[4],c=t[5],d=t[6],p=t[7],g=t[8],v=t[9],w=t[10],_=t[11],T=t[12],E=t[13],A=t[14],R=t[15],U=i[0],C=i[1],I=i[2],O=i[3],V=i[4],Q=i[5],X=i[6],se=i[7],ie=i[8],W=i[9],oe=i[10],le=i[11],q=i[12],_e=i[13],Y=i[14],me=i[15];return Math.abs(e-U)<=K*Math.max(1,Math.abs(e),Math.abs(U))&&Math.abs(s-C)<=K*Math.max(1,Math.abs(s),Math.abs(C))&&Math.abs(r-I)<=K*Math.max(1,Math.abs(r),Math.abs(I))&&Math.abs(n-O)<=K*Math.max(1,Math.abs(n),Math.abs(O))&&Math.abs(l-V)<=K*Math.max(1,Math.abs(l),Math.abs(V))&&Math.abs(c-Q)<=K*Math.max(1,Math.abs(c),Math.abs(Q))&&Math.abs(d-X)<=K*Math.max(1,Math.abs(d),Math.abs(X))&&Math.abs(p-se)<=K*Math.max(1,Math.abs(p),Math.abs(se))&&Math.abs(g-ie)<=K*Math.max(1,Math.abs(g),Math.abs(ie))&&Math.abs(v-W)<=K*Math.max(1,Math.abs(v),Math.abs(W))&&Math.abs(w-oe)<=K*Math.max(1,Math.abs(w),Math.abs(oe))&&Math.abs(_-le)<=K*Math.max(1,Math.abs(_),Math.abs(le))&&Math.abs(T-q)<=K*Math.max(1,Math.abs(T),Math.abs(q))&&Math.abs(E-_e)<=K*Math.max(1,Math.abs(E),Math.abs(_e))&&Math.abs(A-Y)<=K*Math.max(1,Math.abs(A),Math.abs(Y))&&Math.abs(R-me)<=K*Math.max(1,Math.abs(R),Math.abs(me))}function eo(){var t=new rt(3);return rt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function to(t){var i=t[0],e=t[1],s=t[2];return Math.hypot(i,e,s)}function rh(t,i,e){var s=new rt(3);return s[0]=t,s[1]=i,s[2]=e,s}function hc(t,i,e,s){return t[0]=i,t[1]=e,t[2]=s,t}function nh(t,i,e){return t[0]=i[0]+e[0],t[1]=i[1]+e[1],t[2]=i[2]+e[2],t}function On(t,i,e){return t[0]=i[0]-e[0],t[1]=i[1]-e[1],t[2]=i[2]-e[2],t}function ah(t,i,e){return t[0]=i[0]*e[0],t[1]=i[1]*e[1],t[2]=i[2]*e[2],t}function hh(t,i,e){return t[0]=i[0]/e[0],t[1]=i[1]/e[1],t[2]=i[2]/e[2],t}function oc(t,i,e){return t[0]=i[0]*e,t[1]=i[1]*e,t[2]=i[2]*e,t}function lc(t,i,e,s){return t[0]=i[0]+e[0]*s,t[1]=i[1]+e[1]*s,t[2]=i[2]+e[2]*s,t}function cc(t,i){var e=i[0]-t[0],s=i[1]-t[1],r=i[2]-t[2];return Math.hypot(e,s,r)}function uc(t,i){var e=i[0]-t[0],s=i[1]-t[1],r=i[2]-t[2];return e*e+s*s+r*r}function fc(t,i){return t[0]=-i[0],t[1]=-i[1],t[2]=-i[2],t}function dc(t,i){return t[0]=1/i[0],t[1]=1/i[1],t[2]=1/i[2],t}function io(t,i){var e=i[0],s=i[1],r=i[2],n=e*e+s*s+r*r;return n>0&&(n=1/Math.sqrt(n)),t[0]=i[0]*n,t[1]=i[1]*n,t[2]=i[2]*n,t}function ca(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]}function Kr(t,i,e){var s=i[0],r=i[1],n=i[2],l=e[0],c=e[1],d=e[2];return t[0]=r*d-n*c,t[1]=n*l-s*d,t[2]=s*c-r*l,t}function pc(t,i,e,s){var r=i[0],n=i[1],l=i[2];return t[0]=r+s*(e[0]-r),t[1]=n+s*(e[1]-n),t[2]=l+s*(e[2]-l),t}function gc(t,i,e){var s=i[0],r=i[1],n=i[2],l=e[3]*s+e[7]*r+e[11]*n+e[15];return l=l||1,t[0]=(e[0]*s+e[4]*r+e[8]*n+e[12])/l,t[1]=(e[1]*s+e[5]*r+e[9]*n+e[13])/l,t[2]=(e[2]*s+e[6]*r+e[10]*n+e[14])/l,t}function mc(t,i,e){var s=i[0],r=i[1],n=i[2];return t[0]=s*e[0]+r*e[3]+n*e[6],t[1]=s*e[1]+r*e[4]+n*e[7],t[2]=s*e[2]+r*e[5]+n*e[8],t}function vc(t,i,e){var s=e[0],r=e[1],n=e[2],l=e[3],c=i[0],d=i[1],p=i[2],g=r*p-n*d,v=n*c-s*p,w=s*d-r*c,_=r*w-n*v,T=n*g-s*w,E=s*v-r*g,A=l*2;return g*=A,v*=A,w*=A,_*=2,T*=2,E*=2,t[0]=c+g+_,t[1]=d+v+T,t[2]=p+w+E,t}function oh(t,i){var e=t[0],s=t[1],r=t[2],n=i[0],l=i[1],c=i[2],d=Math.sqrt(e*e+s*s+r*r),p=Math.sqrt(n*n+l*l+c*c),g=d*p,v=g&&ca(t,i)/g;return Math.acos(Math.min(Math.max(v,-1),1))}function xc(t,i){var e=t[0],s=t[1],r=t[2],n=i[0],l=i[1],c=i[2];return Math.abs(e-n)<=K*Math.max(1,Math.abs(e),Math.abs(n))&&Math.abs(s-l)<=K*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(r-c)<=K*Math.max(1,Math.abs(r),Math.abs(c))}var yc=to;(function(){var t=eo();return function(i,e,s,r,n,l){var c,d;for(e||(e=3),s||(s=0),r?d=Math.min(r*e+s,i.length):d=i.length,c=s;c<d;c+=e)t[0]=i[c],t[1]=i[c+1],t[2]=i[c+2],n(t,t,l),i[c]=t[0],i[c+1]=t[1],i[c+2]=t[2];return i}})();function bc(){var t=new rt(4);return rt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function wc(t,i){return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t}function so(t,i,e,s,r){return t[0]=i,t[1]=e,t[2]=s,t[3]=r,t}function lh(t,i,e){return t[0]=i[0]+e[0],t[1]=i[1]+e[1],t[2]=i[2]+e[2],t[3]=i[3]+e[3],t}function Bn(t,i,e){return t[0]=i[0]-e[0],t[1]=i[1]-e[1],t[2]=i[2]-e[2],t[3]=i[3]-e[3],t}function ch(t,i,e){return t[0]=i[0]*e[0],t[1]=i[1]*e[1],t[2]=i[2]*e[2],t[3]=i[3]*e[3],t}function uh(t,i,e){return t[0]=i[0]/e[0],t[1]=i[1]/e[1],t[2]=i[2]/e[2],t[3]=i[3]/e[3],t}function _c(t,i,e){return t[0]=i[0]*e,t[1]=i[1]*e,t[2]=i[2]*e,t[3]=i[3]*e,t}function Tc(t,i,e,s){return t[0]=i[0]+e[0]*s,t[1]=i[1]+e[1]*s,t[2]=i[2]+e[2]*s,t[3]=i[3]+e[3]*s,t}function Mc(t,i){var e=i[0]-t[0],s=i[1]-t[1],r=i[2]-t[2],n=i[3]-t[3];return Math.hypot(e,s,r,n)}function Ac(t,i){var e=i[0]-t[0],s=i[1]-t[1],r=i[2]-t[2],n=i[3]-t[3];return e*e+s*s+r*r+n*n}function ro(t){var i=t[0],e=t[1],s=t[2],r=t[3];return Math.hypot(i,e,s,r)}function Ec(t,i){return t[0]=-i[0],t[1]=-i[1],t[2]=-i[2],t[3]=-i[3],t}function Sc(t,i){return t[0]=1/i[0],t[1]=1/i[1],t[2]=1/i[2],t[3]=1/i[3],t}function no(t,i){var e=i[0],s=i[1],r=i[2],n=i[3],l=e*e+s*s+r*r+n*n;return l>0&&(l=1/Math.sqrt(l)),t[0]=e*l,t[1]=s*l,t[2]=r*l,t[3]=n*l,t}function ao(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]+t[3]*i[3]}function Rc(t,i,e,s){var r=e[0]*s[1]-e[1]*s[0],n=e[0]*s[2]-e[2]*s[0],l=e[0]*s[3]-e[3]*s[0],c=e[1]*s[2]-e[2]*s[1],d=e[1]*s[3]-e[3]*s[1],p=e[2]*s[3]-e[3]*s[2],g=i[0],v=i[1],w=i[2],_=i[3];return t[0]=v*p-w*d+_*c,t[1]=-(g*p)+w*l-_*n,t[2]=g*d-v*l+_*r,t[3]=-(g*c)+v*n-w*r,t}function Cc(t,i,e,s){var r=i[0],n=i[1],l=i[2],c=i[3];return t[0]=r+s*(e[0]-r),t[1]=n+s*(e[1]-n),t[2]=l+s*(e[2]-l),t[3]=c+s*(e[3]-c),t}function Fc(t,i,e){var s=i[0],r=i[1],n=i[2],l=i[3];return t[0]=e[0]*s+e[4]*r+e[8]*n+e[12]*l,t[1]=e[1]*s+e[5]*r+e[9]*n+e[13]*l,t[2]=e[2]*s+e[6]*r+e[10]*n+e[14]*l,t[3]=e[3]*s+e[7]*r+e[11]*n+e[15]*l,t}function Pc(t,i,e){var s=i[0],r=i[1],n=i[2],l=e[0],c=e[1],d=e[2],p=e[3],g=p*s+c*n-d*r,v=p*r+d*s-l*n,w=p*n+l*r-c*s,_=-l*s-c*r-d*n;return t[0]=g*p+_*-l+v*-d-w*-c,t[1]=v*p+_*-c+w*-l-g*-d,t[2]=w*p+_*-d+g*-c-v*-l,t[3]=i[3],t}function ho(t,i){var e=t[0],s=t[1],r=t[2],n=t[3],l=i[0],c=i[1],d=i[2],p=i[3];return Math.abs(e-l)<=K*Math.max(1,Math.abs(e),Math.abs(l))&&Math.abs(s-c)<=K*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(r-d)<=K*Math.max(1,Math.abs(r),Math.abs(d))&&Math.abs(n-p)<=K*Math.max(1,Math.abs(n),Math.abs(p))}(function(){var t=bc();return function(i,e,s,r,n,l){var c,d;for(e||(e=4),s||(s=0),r?d=Math.min(r*e+s,i.length):d=i.length,c=s;c<d;c+=e)t[0]=i[c],t[1]=i[c+1],t[2]=i[c+2],t[3]=i[c+3],n(t,t,l),i[c]=t[0],i[c+1]=t[1],i[c+2]=t[2],i[c+3]=t[3];return i}})();function fh(){var t=new rt(4);return rt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function oo(t,i,e){e=e*.5;var s=Math.sin(e);return t[0]=s*i[0],t[1]=s*i[1],t[2]=s*i[2],t[3]=Math.cos(e),t}function Ic(t,i){var e=Math.acos(i[3])*2,s=Math.sin(e/2);return s>K?(t[0]=i[0]/s,t[1]=i[1]/s,t[2]=i[2]/s):(t[0]=1,t[1]=0,t[2]=0),e}function Uc(t,i){var e=co(t,i);return Math.acos(2*e*e-1)}function dh(t,i,e){var s=i[0],r=i[1],n=i[2],l=i[3],c=e[0],d=e[1],p=e[2],g=e[3];return t[0]=s*g+l*c+r*p-n*d,t[1]=r*g+l*d+n*c-s*p,t[2]=n*g+l*p+s*d-r*c,t[3]=l*g-s*c-r*d-n*p,t}function Xr(t,i,e,s){var r=i[0],n=i[1],l=i[2],c=i[3],d=e[0],p=e[1],g=e[2],v=e[3],w,_,T,E,A;return _=r*d+n*p+l*g+c*v,_<0&&(_=-_,d=-d,p=-p,g=-g,v=-v),1-_>K?(w=Math.acos(_),T=Math.sin(w),E=Math.sin((1-s)*w)/T,A=Math.sin(s*w)/T):(E=1-s,A=s),t[0]=E*r+A*d,t[1]=E*n+A*p,t[2]=E*l+A*g,t[3]=E*c+A*v,t}function zc(t,i){var e=i[0],s=i[1],r=i[2],n=i[3],l=e*e+s*s+r*r+n*n,c=l?1/l:0;return t[0]=-e*c,t[1]=-s*c,t[2]=-r*c,t[3]=n*c,t}function Lc(t,i){return t[0]=-i[0],t[1]=-i[1],t[2]=-i[2],t[3]=i[3],t}function lo(t,i){var e=i[0]+i[4]+i[8],s;if(e>0)s=Math.sqrt(e+1),t[3]=.5*s,s=.5/s,t[0]=(i[5]-i[7])*s,t[1]=(i[6]-i[2])*s,t[2]=(i[1]-i[3])*s;else{var r=0;i[4]>i[0]&&(r=1),i[8]>i[r*3+r]&&(r=2);var n=(r+1)%3,l=(r+2)%3;s=Math.sqrt(i[r*3+r]-i[n*3+n]-i[l*3+l]+1),t[r]=.5*s,s=.5/s,t[3]=(i[n*3+l]-i[l*3+n])*s,t[n]=(i[n*3+r]+i[r*3+n])*s,t[l]=(i[l*3+r]+i[r*3+l])*s}return t}function kc(t,i,e,s){var r=.5*Math.PI/180;i*=r,e*=r,s*=r;var n=Math.sin(i),l=Math.cos(i),c=Math.sin(e),d=Math.cos(e),p=Math.sin(s),g=Math.cos(s);return t[0]=n*d*g-l*c*p,t[1]=l*c*g+n*d*p,t[2]=l*d*p-n*c*g,t[3]=l*d*g+n*c*p,t}var Oc=wc,Bc=so,co=ao,Nc=ro,ua=no;(function(){var t=eo(),i=rh(1,0,0),e=rh(0,1,0);return function(s,r,n){var l=ca(r,n);return l<-.999999?(Kr(t,i,r),yc(t)<1e-6&&Kr(t,e,r),io(t,t),oo(s,t,Math.PI),s):l>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(Kr(t,r,n),s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=1+l,ua(s,s))}})();(function(){var t=fh(),i=fh();return function(e,s,r,n,l,c){return Xr(t,s,l,c),Xr(i,r,n,c),Xr(e,t,i,2*c*(1-c)),e}})();(function(){var t=ml();return function(i,e,s,r){return t[0]=s[0],t[3]=s[1],t[6]=s[2],t[1]=r[0],t[4]=r[1],t[7]=r[2],t[2]=-e[0],t[5]=-e[1],t[8]=-e[2],ua(i,lo(i,t))}})();function Dc(){var t=new rt(2);return rt!=Float32Array&&(t[0]=0,t[1]=0),t}function ph(t,i,e){return t[0]=i[0]+e[0],t[1]=i[1]+e[1],t}function gh(t,i,e){return t[0]=i[0]-e[0],t[1]=i[1]-e[1],t}function mh(t,i,e){return t[0]=i[0]*e[0],t[1]=i[1]*e[1],t}function vh(t,i,e){return t[0]=i[0]/e[0],t[1]=i[1]/e[1],t}function Gc(t,i,e){return t[0]=i[0]*e,t[1]=i[1]*e,t}function $c(t,i){var e=i[0]-t[0],s=i[1]-t[1];return Math.hypot(e,s)}function Vc(t,i){var e=i[0]-t[0],s=i[1]-t[1];return e*e+s*s}function Hc(t){var i=t[0],e=t[1];return Math.hypot(i,e)}function jc(t,i){return t[0]=-i[0],t[1]=-i[1],t}function qc(t,i){return t[0]=1/i[0],t[1]=1/i[1],t}function Zc(t,i){var e=i[0],s=i[1],r=e*e+s*s;return r>0&&(r=1/Math.sqrt(r)),t[0]=i[0]*r,t[1]=i[1]*r,t}function Wc(t,i){return t[0]*i[0]+t[1]*i[1]}function Yc(t,i,e){var s=i[0]*e[1]-i[1]*e[0];return t[0]=t[1]=0,t[2]=s,t}function Kc(t,i,e,s){var r=i[0],n=i[1];return t[0]=r+s*(e[0]-r),t[1]=n+s*(e[1]-n),t}function Xc(t,i,e){var s=i[0],r=i[1];return t[0]=e[0]*s+e[3]*r+e[6],t[1]=e[1]*s+e[4]*r+e[7],t}function Qc(t,i,e){var s=i[0],r=i[1];return t[0]=e[0]*s+e[4]*r+e[12],t[1]=e[1]*s+e[5]*r+e[13],t}function xh(t,i){var e=t[0],s=t[1],r=i[0],n=i[1],l=Math.sqrt(e*e+s*s)*Math.sqrt(r*r+n*n),c=l&&(e*r+s*n)/l;return Math.acos(Math.min(Math.max(c,-1),1))}function Jc(t,i){var e=t[0],s=t[1],r=i[0],n=i[1];return Math.abs(e-r)<=K*Math.max(1,Math.abs(e),Math.abs(r))&&Math.abs(s-n)<=K*Math.max(1,Math.abs(s),Math.abs(n))}(function(){var t=Dc();return function(i,e,s,r,n,l){var c,d;for(e||(e=2),s||(s=0),r?d=Math.min(r*e+s,i.length):d=i.length,c=s;c<d;c+=e)t[0]=i[c],t[1]=i[c+1],n(t,t,l),i[c]=t[0],i[c+1]=t[1];return i}})();var eu={grad:.9,turn:360,rad:360/(2*Math.PI)},Gt=function(t){return typeof t=="string"?t.length>0:typeof t=="number"},Re=function(t,i,e){return i===void 0&&(i=0),e===void 0&&(e=Math.pow(10,i)),Math.round(e*t)/e+0},pt=function(t,i,e){return i===void 0&&(i=0),e===void 0&&(e=1),t>e?e:t>i?t:i},uo=function(t){return(t=isFinite(t)?t%360:0)>0?t:t+360},yh=function(t){return{r:pt(t.r,0,255),g:pt(t.g,0,255),b:pt(t.b,0,255),a:pt(t.a)}},Nn=function(t){return{r:Re(t.r),g:Re(t.g),b:Re(t.b),a:Re(t.a,3)}},tu=/^#([0-9a-f]{3,8})$/i,Br=function(t){var i=t.toString(16);return i.length<2?"0"+i:i},fo=function(t){var i=t.r,e=t.g,s=t.b,r=t.a,n=Math.max(i,e,s),l=n-Math.min(i,e,s),c=l?n===i?(e-s)/l:n===e?2+(s-i)/l:4+(i-e)/l:0;return{h:60*(c<0?c+6:c),s:n?l/n*100:0,v:n/255*100,a:r}},po=function(t){var i=t.h,e=t.s,s=t.v,r=t.a;i=i/360*6,e/=100,s/=100;var n=Math.floor(i),l=s*(1-e),c=s*(1-(i-n)*e),d=s*(1-(1-i+n)*e),p=n%6;return{r:255*[s,c,l,l,d,s][p],g:255*[d,s,s,c,l,l][p],b:255*[l,l,d,s,s,c][p],a:r}},bh=function(t){return{h:uo(t.h),s:pt(t.s,0,100),l:pt(t.l,0,100),a:pt(t.a)}},wh=function(t){return{h:Re(t.h),s:Re(t.s),l:Re(t.l),a:Re(t.a,3)}},_h=function(t){return po((e=(i=t).s,{h:i.h,s:(e*=((s=i.l)<50?s:100-s)/100)>0?2*e/(s+e)*100:0,v:s+e,a:i.a}));var i,e,s},Xs=function(t){return{h:(i=fo(t)).h,s:(r=(200-(e=i.s))*(s=i.v)/100)>0&&r<200?e*s/100/(r<=100?r:200-r)*100:0,l:r/2,a:i.a};var i,e,s,r},iu=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,su=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,ru=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,nu=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Wn={string:[[function(t){var i=tu.exec(t);return i?(t=i[1]).length<=4?{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:t.length===4?Re(parseInt(t[3]+t[3],16)/255,2):1}:t.length===6||t.length===8?{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16),a:t.length===8?Re(parseInt(t.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(t){var i=ru.exec(t)||nu.exec(t);return i?i[2]!==i[4]||i[4]!==i[6]?null:yh({r:Number(i[1])/(i[2]?100/255:1),g:Number(i[3])/(i[4]?100/255:1),b:Number(i[5])/(i[6]?100/255:1),a:i[7]===void 0?1:Number(i[7])/(i[8]?100:1)}):null},"rgb"],[function(t){var i=iu.exec(t)||su.exec(t);if(!i)return null;var e,s,r=bh({h:(e=i[1],s=i[2],s===void 0&&(s="deg"),Number(e)*(eu[s]||1)),s:Number(i[3]),l:Number(i[4]),a:i[5]===void 0?1:Number(i[5])/(i[6]?100:1)});return _h(r)},"hsl"]],object:[[function(t){var i=t.r,e=t.g,s=t.b,r=t.a,n=r===void 0?1:r;return Gt(i)&&Gt(e)&&Gt(s)?yh({r:Number(i),g:Number(e),b:Number(s),a:Number(n)}):null},"rgb"],[function(t){var i=t.h,e=t.s,s=t.l,r=t.a,n=r===void 0?1:r;if(!Gt(i)||!Gt(e)||!Gt(s))return null;var l=bh({h:Number(i),s:Number(e),l:Number(s),a:Number(n)});return _h(l)},"hsl"],[function(t){var i=t.h,e=t.s,s=t.v,r=t.a,n=r===void 0?1:r;if(!Gt(i)||!Gt(e)||!Gt(s))return null;var l=function(c){return{h:uo(c.h),s:pt(c.s,0,100),v:pt(c.v,0,100),a:pt(c.a)}}({h:Number(i),s:Number(e),v:Number(s),a:Number(n)});return po(l)},"hsv"]]},Th=function(t,i){for(var e=0;e<i.length;e++){var s=i[e][0](t);if(s)return[s,i[e][1]]}return[null,void 0]},au=function(t){return typeof t=="string"?Th(t.trim(),Wn.string):typeof t=="object"&&t!==null?Th(t,Wn.object):[null,void 0]},Dn=function(t,i){var e=Xs(t);return{h:e.h,s:pt(e.s+100*i,0,100),l:e.l,a:e.a}},Gn=function(t){return(299*t.r+587*t.g+114*t.b)/1e3/255},Mh=function(t,i){var e=Xs(t);return{h:e.h,s:e.s,l:pt(e.l+100*i,0,100),a:e.a}},Yn=function(){function t(i){this.parsed=au(i)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return t.prototype.isValid=function(){return this.parsed!==null},t.prototype.brightness=function(){return Re(Gn(this.rgba),2)},t.prototype.isDark=function(){return Gn(this.rgba)<.5},t.prototype.isLight=function(){return Gn(this.rgba)>=.5},t.prototype.toHex=function(){return i=Nn(this.rgba),e=i.r,s=i.g,r=i.b,l=(n=i.a)<1?Br(Re(255*n)):"","#"+Br(e)+Br(s)+Br(r)+l;var i,e,s,r,n,l},t.prototype.toRgb=function(){return Nn(this.rgba)},t.prototype.toRgbString=function(){return i=Nn(this.rgba),e=i.r,s=i.g,r=i.b,(n=i.a)<1?"rgba("+e+", "+s+", "+r+", "+n+")":"rgb("+e+", "+s+", "+r+")";var i,e,s,r,n},t.prototype.toHsl=function(){return wh(Xs(this.rgba))},t.prototype.toHslString=function(){return i=wh(Xs(this.rgba)),e=i.h,s=i.s,r=i.l,(n=i.a)<1?"hsla("+e+", "+s+"%, "+r+"%, "+n+")":"hsl("+e+", "+s+"%, "+r+"%)";var i,e,s,r,n},t.prototype.toHsv=function(){return i=fo(this.rgba),{h:Re(i.h),s:Re(i.s),v:Re(i.v),a:Re(i.a,3)};var i},t.prototype.invert=function(){return Oe({r:255-(i=this.rgba).r,g:255-i.g,b:255-i.b,a:i.a});var i},t.prototype.saturate=function(i){return i===void 0&&(i=.1),Oe(Dn(this.rgba,i))},t.prototype.desaturate=function(i){return i===void 0&&(i=.1),Oe(Dn(this.rgba,-i))},t.prototype.grayscale=function(){return Oe(Dn(this.rgba,-1))},t.prototype.lighten=function(i){return i===void 0&&(i=.1),Oe(Mh(this.rgba,i))},t.prototype.darken=function(i){return i===void 0&&(i=.1),Oe(Mh(this.rgba,-i))},t.prototype.rotate=function(i){return i===void 0&&(i=15),this.hue(this.hue()+i)},t.prototype.alpha=function(i){return typeof i=="number"?Oe({r:(e=this.rgba).r,g:e.g,b:e.b,a:i}):Re(this.rgba.a,3);var e},t.prototype.hue=function(i){var e=Xs(this.rgba);return typeof i=="number"?Oe({h:i,s:e.s,l:e.l,a:e.a}):Re(e.h)},t.prototype.isEqual=function(i){return this.toHex()===Oe(i).toHex()},t}(),Oe=function(t){return t instanceof Yn?t:new Yn(t)},Ah=[],hu=function(t){t.forEach(function(i){Ah.indexOf(i)<0&&(i(Yn,Wn),Ah.push(i))})};function Kn(t,i=[],e=[]){return t.replace(/#defines/,i.join(`
`)).replace(/#includes/,e.join(`
`))}function ou(t,i={}){return Object.keys(i).reduce((e,s)=>i[s]?`#define ${s} ${i[s]}
${e}`:e,t)}function Xn(t,i="unnamed"){const e=/#define\s*SHADER_NAME\s*([A-Za-z0-9_-]+)\s*/,s=t.match(e);return s?s[1]:i}function Qn(t,i,e,s){const r=new Set;if(s)for(let n=0,l=e;n<l;n+=3){const c=s[n],d=s[n+1],p=s[n+2],g=[c,d,d,p,p,c];for(let v=0;v<g.length;v+=2)Jn(g[v]*3,g[v+1]*3,t,r)&&i.push(g[v],g[v+1])}else for(let n=0,l=e;n<l;n+=3){const c=n,d=n+1,p=n+2,g=[c,d,d,p,p,c];for(let v=0;v<g.length;v+=2)Jn(g[v]*3,g[v+1]*3,t,r)&&i.push(g[v],g[v+1])}return i}function Jn(t,i,e,s){const r=`${e[t]},${e[t+1]},${e[t+2]}-${e[i]},${e[i+1]},${e[i+2]}`,n=`${e[i]},${e[i+1]},${e[i+2]}-${e[t]},${e[t+1]},${e[t+2]}`;return s.has(r)===!0||s.has(n)===!0?!1:(s.add(r),s.add(n),!0)}const go=Math.PI/180,mo=180/Math.PI;function vo(t){return t*go}function Qr(t){return t*mo}function Xt(t,i,e){return Math.min(Math.max(t,i),e)}function ea(t){return Math.log(t)/Math.LN2%1===0}let Jr=Float32Array;function lu(t,i=!0){t?Jr=Float64Array:Jr=Float32Array,i&&gl(Jr)}function Nt(){return Jr}function ta(t){return typeof WebGLRenderingContext<"u"&&t instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&t instanceof WebGL2RenderingContext||t!=null&&t.gl&&(t.gl instanceof WebGLRenderingContext||t.gl instanceof WebGL2RenderingContext)?!0:!!(t&&Number.isFinite(t._version))}function ia(t){return typeof WebGL2RenderingContext<"u"&&t instanceof WebGL2RenderingContext||t!=null&&t.gl&&t.gl instanceof WebGL2RenderingContext?!0:!!(t&&t._version===2)}function xo(t,i={},e=!1){var l,c;const s=["webgl2","webgl","experimental-webgl"];e||s.shift();let r=null;function n(d){console.error(d.statusMessage)}(l=t==null?void 0:t.addEventListener)==null||l.call(t,"webglcontextcreationerror",n,!1);for(let d=0;d<s.length;++d){try{r=t.getContext(s[d],i)}catch{}if(r)break}return(c=t==null?void 0:t.removeEventListener)==null||c.call(t,"webglcontextcreationerror",n,!1),r}const rn=()=>(typeof performance>"u"?Date:performance).now();function xr(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}function Qs(t){return xr(t)==="string"}function Ve(t){return xr(t)==="undefined"}function yo(t){return Qs(t)&&t.includes("%")}function Ds(t){return xr(t)==="number"}function bo(t){return xr(t)==="regexp"}function Ie(t){return t==null}function wo(t){const i=typeof t;return t!==null&&(i==="object"||i==="function")}function cu(t,i){return wo(t)?!Ie(t.value)&&(Ie(i)||t.value===i):!Ie(t)&&(Ie(i)||t===i)}const $n={};function $s(t="id"){$n[t]=$n[t]||1;const i=$n[t]++;return`${t}-${i}`}function un(t,i=[]){return Object.keys(t).filter(e=>i.indexOf(e)<0).reduce((e,s)=>Object.assign(e,{[s]:t[s]}),{})}function uu(t,i=[]){return Object.keys(t).filter(e=>i.indexOf(e)>-1).reduce((e,s)=>Object.assign(e,{[s]:t[s]}),{})}const ds=[],Eh=1e3/60;let Sh=performance.now();function _o(){const t=rn(),i=t-Sh;if(i>=Eh){Sh=t-i%Eh;const e=ds.slice();ds.length=0;for(let s=0;s<e.length;s++)e[s]&&e[s](t,i)}else setImmediate(_o)}function fu(t){return ds.push(t),ds.length===1&&setImmediate(_o),ds.length-1}function du(t){ds[t]=void 0}function To(t){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(t):fu(t)}function Mo(t){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(t):du(t)}var Me=Object.freeze({__proto__:null,DEG_TO_RAD:go,RAD_TO_DEG:mo,cancelAnimationFrame:Mo,clamp:Xt,defineShader:ou,degToRad:vo,getContext:xo,getFloatArrayConstructor:Nt,getShaderName:Xn,getWireframeIndex:Qn,hasValue:cu,highPrecision:lu,isHex:yo,isNull:Ie,isNumber:Ds,isObject:wo,isPowerOfTwo:ea,isRegexp:bo,isString:Qs,isUndef:Ve,isUniqueEdge:Jn,isWebGL:ta,isWebGL2:ia,now:rn,omit:un,parseShader:Kn,pick:uu,radToDeg:Qr,requestAnimationFrame:To,typeOf:xr,uid:$s}),ps,Ni,Qt;class pu{constructor(i=!0){S(this,ps,0);S(this,Ni,0);S(this,Qt,!1);N(this,"running");this.running=i}start(){o(this,Qt)||(this.reset(),y(this,Qt,!0))}stop(){this.getElapsedTime(),y(this,Qt,!1),this.running=!1}reset(){y(this,ps,rn()),y(this,Ni,0)}getElapsedTime(){return this.getDelta(),o(this,Ni)}getDelta(){let i=0;if(this.running&&!o(this,Qt))return this.start(),0;if(o(this,Qt)){const e=rn();i=(e-o(this,ps))/1e3,y(this,ps,e),y(this,Ni,o(this,Ni)+i)}return i}}ps=new WeakMap,Ni=new WeakMap,Qt=new WeakMap;const gu={autoStart:!0};var gs,Jt,ei,ti,sr;class Ao{constructor(i,e={}){N(this,"options");S(this,gs,void 0);S(this,Jt,void 0);S(this,ei,void 0);S(this,ti,void 0);S(this,sr,void 0);this.options={...e,...gu},y(this,ti,new pu),this.reset(),this.onVisibilityChange=this.onVisibilityChange.bind(this),y(this,sr,()=>{const s=o(this,ti).getElapsedTime();i&&i(s)}),this.options.autoStart&&this.start()}get visible(){return o(this,ei)}get animating(){return o(this,Jt)}reset(){y(this,Jt,!1),y(this,ei,!0),o(this,gs)!==void 0&&Mo(o(this,gs))}get elapsedTime(){return o(this,ti).getElapsedTime()}start(){o(this,Jt)||(y(this,Jt,!0),o(this,ti).start(),this.tick(),typeof window<"u"&&window.document&&window.document.addEventListener("visibilitychange",this.onVisibilityChange,!1))}stop(){o(this,ti).stop(),this.reset(),typeof window<"u"&&window.document&&window.document.removeEventListener("visibilitychange",this.onVisibilityChange,!1)}tick(){!o(this,Jt)||!o(this,ei)||(y(this,gs,To(()=>{this.tick()})),o(this,sr).call(this))}onVisibilityChange(){typeof window<"u"&&window.document&&y(this,ei,!window.document.hidden),o(this,ei)&&(this.reset(),this.start())}}gs=new WeakMap,Jt=new WeakMap,ei=new WeakMap,ti=new WeakMap,sr=new WeakMap;class Rh{constructor(i,e={}){N(this,"type");this.type=i,(Object.getOwnPropertyNames(e)||[]).forEach(s=>{this[s]=e[s]})}}class yr{constructor({validEventTypes:i=[/.*/]}={}){N(this,"fns");N(this,"validateEventTypes");this.fns=new Map,this.validateEventTypes=i}validateEventType(i){let e=this.validateEventTypes;Array.isArray(this.validateEventTypes)||(e=[this.validateEventTypes]);let s=!0;if(e.forEach(r=>{bo(r)&&!r.test(i)&&(s=!1)}),!s)throw new Error(`Invalid Event Type: '${i}'.
Event type should be any of: ${e}.`)}on(i,e,s){if(this.validateEventType(i),Qs(i)){const r=i.split(" ");if(r.length>1)return r.forEach(n=>{this.on(n,e,s)}),this}return this.has(i)||this.fns.set(i,[]),this.fns.get(i).push(e),this}once(i,e,s){if(this.validateEventType(i),Qs(i)){const n=i.split(" ");if(n.length>1)return n.forEach(l=>{this.once(l,e,s)}),this}const r=(...n)=>{this.off(i,r),e.call(s||this,...n)};return this.on(i,r,s)}off(i,e,s){if(this.validateEventType(i),Qs(i)){const n=i.split(" ");if(n.length>1)return n.forEach(l=>{this.off(l,e,s)}),this}const r=this.has(i);if(r)if(e){const n=r.filter(l=>l!==e);this.fns.set(i,n)}else this.fns.delete(i);return this}emit(i,e){const s=i instanceof Rh?i:new Rh(i,e);this.validateEventType(s.type);const r=this.has(s.type);if(r)return r.map(n=>n.call(this,s))}has(i){return this.fns.get(i)}clear(){return this.fns.clear(),this}}class Vs{constructor(){N(this,"elements",new(Nt())(2))}fromArray(i,e=0){let s=0;for(;s<this.elements.length;s++)this.elements[s]=i[e+s];return this}toArray(i=[],e=0){let s=0;for(;s<this.elements.length;s++)i[e+s]=this.elements[s];return i}}class st extends Vs{constructor(e=0,s=0){super();N(this,"elements",new(Nt())(2));const r=this.elements;r[0]=e,r[1]=s}get x(){return this.elements[0]}set x(e){this.elements[0]=e}get y(){return this.elements[1]}set y(e){this.elements[1]=e}fromObject(e){const{x:s,y:r}=e;return s!==void 0&&(this.x=s),r!==void 0&&(this.y=r),this}toObject(){return{x:this.x,y:this.y}}set(e,s){return this.x=e,this.y=s,this}setScalar(e){return this.set(e,e)}add(e){return ph(this.elements,this.elements,e.elements),this}addScalar(e){return ph(this.elements,this.elements,[e,e]),this}subtract(e){return gh(this.elements,this.elements,e.elements),this}subtractScalar(e){return gh(this.elements,this.elements,[e,e]),this}multiply(e){return mh(this.elements,this.elements,e.elements),this}multiplyScalar(e){return mh(this.elements,this.elements,[e,e]),this}divide(e){return vh(this.elements,this.elements,e.elements),this}divideScalar(e){return vh(this.elements,this.elements,[e,e]),this}scale(e){return Gc(this.elements,this.elements,e),this}distanceTo(e){return $c(this.elements,e.elements)}length(){return Hc(this.elements)}distanceToSquared(e){return Vc(e.elements,this.elements)}angle(){return xh(this.elements,[1,0])}angleTo(e){return xh(this.elements,e.elements)}dot(e){return Wc(this.elements,e.elements)}equals(e){return Jc(this.elements,e.elements)}cross(e){return Yc(this.elements,this.elements,e.elements),this}negate(){return jc(this.elements,this.elements),this}inverse(){return qc(this.elements,this.elements),this}lerp(e,s){return Kc(this.elements,this.elements,e.elements,s),this}normalize(){return Zc(this.elements,this.elements),this}applyMatrix3(e){return Xc(this.elements,this.elements,e.elements),this}applyMatrix4(e){return Qc(this.elements,this.elements,e.elements),this}copy(e){return this.x=e.x,this.y=e.y,this}clone(){return new st(this.x,this.y)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}const Nr=[];var ms;const va=class va extends Vs{constructor(e=0,s=0,r=0,n=0){super();N(this,"elements",new(Nt())(4));S(this,ms,[]);const l=this.elements;l[0]=e,l[1]=s,l[2]=r,l[3]=n}get x(){return this.elements[0]}set x(e){this.elements[0]=e,this.triggerChange()}get y(){return this.elements[1]}set y(e){this.elements[1]=e,this.triggerChange()}get z(){return this.elements[2]}set z(e){this.elements[2]=e,this.triggerChange()}get w(){return this.elements[3]}set w(e){this.elements[3]=e,this.triggerChange()}fromObject({x:e,y:s,z:r,w:n}){return e!==void 0&&(this.x=e),s!==void 0&&(this.y=s),r!==void 0&&(this.z=r),n!==void 0&&(this.w=n),this.triggerChange(),this}toObject(){return{x:this.x,y:this.y,z:this.z,w:this.w}}fromAxisAngle(e,s){return oo(this.elements,e.elements,s),this.triggerChange(),this}getAxisAngle(e=new xe){const s=Ic(Nr,this.elements);return e.set(Nr[0],Nr[1],Nr[2]),s}fromEuler(e){return kc(this.elements,Qr(e.x),Qr(e.y),Qr(e.z)),this.triggerChange(),this}fromMat3(e){return lo(this.elements,e),this}set(e,s,r,n){return Bc(this.elements,e,s,r,n),this.triggerChange(),this}length(){return Nc(this.elements)}multiply(e,s){return s?dh(this.elements,e.elements,s.elements):dh(this.elements,this.elements,e.elements),this.triggerChange(),this}slerp(e,s){return Xr(this.elements,this.elements,e.elements,s),this.triggerChange(),this}invert(){return zc(this.elements,this.elements),this.triggerChange(),this}conjugate(){return Lc(this.elements,this.elements),this.triggerChange(),this}normalize(){return ua(this.elements,this.elements),this.triggerChange(),this}dot(e){return co(this.elements,e.elements)}angleTo(e){return Uc(this.elements,e.elements)}clone(){return new va().copy(this)}copy(e){return Oc(this.elements,e.elements),this.triggerChange(),this}equals(e){return ho(this.elements,e.elements)}onChange(e){o(this,ms).includes(e)||o(this,ms).push(e)}triggerChange(){o(this,ms).forEach(e=>e())}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}};ms=new WeakMap;let Gs=va;class xe extends Vs{constructor(e=0,s=0,r=0){super();N(this,"elements",new(Nt())(3));const n=this.elements;n[0]=e,n[1]=s,n[2]=r}get x(){return this.elements[0]}set x(e){this.elements[0]=e}get y(){return this.elements[1]}set y(e){this.elements[1]=e}get z(){return this.elements[2]}set z(e){this.elements[2]=e}fromObject(e){const{x:s,y:r,z:n}=e;return s!==void 0&&(this.x=s),r!==void 0&&(this.y=r),n!==void 0&&(this.z=n),this}toObject(){return{x:this.x,y:this.y,z:this.z}}set(e,s,r){return hc(this.elements,e,s,r),this}setScalar(e){return this.set(e,e,e)}length(){return to(this.elements)}add(e){return nh(this.elements,this.elements,e.elements),this}addScalar(e){return nh(this.elements,this.elements,[e,e,e]),this}subtract(e){return On(this.elements,this.elements,e.elements),this}subtractScalar(e){return On(this.elements,this.elements,[e,e,e]),this}subVectors(e,s){return On(this.elements,e.elements,s.elements),this}multiply(e){return ah(this.elements,this.elements,e.elements),this}multiplyScalar(e){return ah(this.elements,this.elements,[e,e,e]),this}divide(e){return hh(this.elements,this.elements,e.elements),this}divideScalar(e){return hh(this.elements,this.elements,[e,e,e]),this}scale(e){return oc(this.elements,this.elements,e),this}scaleAndAdd(e,s){return lc(this.elements,this.elements,e.elements,s),this}distanceTo(e){return cc(this.elements,e.elements)}distanceToSquared(e){return uc(this.elements,e.elements)}angle(e){return oh(this.elements,[1,0,0])}angleTo(e){return oh(this.elements,e.elements)}dot(e){return ca(this.elements,e.elements)}equals(e){return xc(this.elements,e.elements)}cross(e){return Kr(this.elements,this.elements,e.elements),this}negate(){return fc(this.elements,this.elements),this}inverse(){return dc(this.elements,this.elements),this}lerp(e,s){return pc(this.elements,this.elements,e.elements,s),this}normalize(){return io(this.elements,this.elements),this}applyEuler(e){const s=new Gs().fromEuler(e);return this.applyQuaternion(s)}applyMatrix3(e){return mc(this.elements,this.elements,e.elements),this}applyMatrix4(e){return gc(this.elements,this.elements,e.elements),this}applyQuaternion(e){return vc(this.elements,this.elements,e.elements),this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}clone(){return new xe(this.x,this.y,this.z)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class br extends Vs{constructor(e=0,s=0,r=0,n=0){super();N(this,"elements",new(Nt())(4));const l=this.elements;l[0]=e,l[1]=s,l[2]=r,l[3]=n}get x(){return this.elements[0]}set x(e){this.elements[0]=e}get y(){return this.elements[1]}set y(e){this.elements[1]=e}get z(){return this.elements[2]}set z(e){this.elements[2]=e}get w(){return this.elements[3]}set w(e){this.elements[3]=e}fromObject(e){const{x:s,y:r,z:n,w:l}=e;return s!==void 0&&(this.x=s),r!==void 0&&(this.y=r),n!==void 0&&(this.z=n),l!==void 0&&(this.w=l),this}toObject(){return{x:this.x,y:this.y,z:this.z,w:this.w}}set(e,s,r,n){return so(this.elements,e,s,r,n),this}setScalar(e){return this.set(e,e,e,e)}add(e){return lh(this.elements,this.elements,e.elements),this}addScalar(e){return lh(this.elements,this.elements,[e,e,e,e]),this}subtract(e){return Bn(this.elements,this.elements,e.elements),this}subtractScalar(e){return Bn(this.elements,this.elements,[e,e,e,e]),this}subVectors(e,s){return Bn(this.elements,e.elements,s.elements),this}multiply(e){return ch(this.elements,this.elements,e.elements),this}multiplyScalar(e){return ch(this.elements,this.elements,[e,e,e,e]),this}divide(e){return uh(this.elements,this.elements,e.elements),this}divideScalar(e){return uh(this.elements,this.elements,[e,e,e,e]),this}scale(e){return _c(this.elements,this.elements,e),this}scaleAndAdd(e,s){return Tc(this.elements,this.elements,e.elements,s),this}distanceTo(e){return Mc(this.elements,e.elements)}distanceToSquared(e){return Ac(this.elements,e.elements)}length(){return ro(this.elements)}dot(e){return ao(this.elements,e.elements)}equals(e){return ho(this.elements,e.elements)}cross(e){return Rc(this.elements,this.elements,e.elements),this}negate(){return Ec(this.elements,this.elements),this}inverse(){return Sc(this.elements,this.elements),this}lerp(e,s){return Cc(this.elements,this.elements,e.elements,s),this}normalize(){return no(this.elements,this.elements),this}applyMatrix4(e){return Fc(this.elements,this.elements,e.elements),this}applyQuaternion(e){return Pc(this.elements,this.elements,e.elements),this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}clone(){return new br(this.x,this.y,this.z,this.w)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class fa{constructor(){N(this,"elements",new(Nt())(16))}fromArray(i,e=0){let s=0;for(;s<this.elements.length;s++)this.elements[s]=i[e+s];return this}toArray(i=[],e=0){let s=0;for(;s<this.elements.length;s++)i[e+s]=this.elements[s];return i}}class nn extends fa{constructor(e=1,s=0,r=0,n=0,l=1,c=0,d=0,p=0,g=1){super();N(this,"elements",new(Nt())(9));const v=this.elements;v[0]=e,v[1]=s,v[2]=r,v[3]=n,v[4]=l,v[5]=c,v[6]=d,v[7]=p,v[8]=g}get x(){return this.elements[2]}get y(){return this.elements[5]}get z(){return this.elements[8]}static get identity(){return new nn().fromArray(bl([]))}set(e,s,r,n,l,c,d,p,g){return yl(this.elements,e,s,r,n,l,c,d,p,g),this}transpose(){return wl(this.elements,this.elements),this}invert(e=this){return _l(this.elements,e.elements),this}adjoint(e=this){return Tl(this.elements,e.elements),this}determinant(){return Ml(this.elements)}multiply(e,s){return s?kr(this.elements,e.elements,s.elements):kr(this.elements,this.elements,e.elements),this}premultiply(e,s){return s?kr(this.elements,s.elements,e.elements):kr(this.elements,e.elements,this.elements),this}translate(e){return Al(this.elements,this.elements,e.elements),this}rotate(e){return El(this.elements,this.elements,e),this}scale(e){return Sl(this.elements,this.elements,e.elements),this}fromTranslation(e){return Rl(this.elements,e.elements),this}fromRotation(e){return Cl(this.elements,e),this}fromScaling(e){return Fl(this.elements,e.elements),this}fromQuat(e){return Pl(this.elements,e.elements),this}normalFromMat4(e){return Xa(this.elements,e.elements),this}fromMat4(e){return vl(this.elements,e.elements),this}frob(){return Il(this.elements)}add(e,s){return s?Qa(this.elements,e.elements,s.elements):Qa(this.elements,this.elements,e.elements),this}subtract(e,s){return s?Ja(this.elements,e.elements,s.elements):Ja(this.elements,this.elements,e.elements),this}equals(e,s){return s?eh(e.elements,s.elements):eh(this.elements,e.elements)}fromRotationTranslationScale(e,s,r,n,l){const c=Math.cos(e),d=Math.sin(e);return this.set(n*c,-l*d,0,n*d,l*c,0,s,r,1),this}getNormalMatrix(e){return Xa(this.elements,e.elements),this}copy(e){return xl(this.elements,e.elements),this}clone(){return new nn().copy(this)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}const Qe=[];class Ui extends fa{constructor(e=1,s=0,r=0,n=0,l=0,c=1,d=0,p=0,g=0,v=0,w=1,_=0,T=0,E=0,A=0,R=1){super();N(this,"elements",new(Nt())(16));const U=this.elements;U[0]=e,U[1]=s,U[2]=r,U[3]=n,U[4]=l,U[5]=c,U[6]=d,U[7]=p,U[8]=g,U[9]=v,U[10]=w,U[11]=_,U[12]=T,U[13]=E,U[14]=A,U[15]=R}get x(){return this.elements[12]}get y(){return this.elements[13]}get z(){return this.elements[14]}get w(){return this.elements[15]}static get identity(){return new Ui().fromArray(Kh([]))}set(e,s,r,n,l,c,d,p,g,v,w,_,T,E,A,R){return zl(this.elements,e,s,r,n,l,c,d,p,g,v,w,_,T,E,A,R),this}transpose(){return Ll(this.elements,this.elements),this}invert(e=this){return kl(this.elements,e.elements),this}adjoint(e=this){return Ol(this.elements,e.elements),this}determinant(){return Bl(this.elements)}add(e,s){return s?ih(this.elements,e.elements,s.elements):ih(this.elements,this.elements,e.elements),this}subtract(e,s){return s?sh(this.elements,e.elements,s.elements):sh(this.elements,this.elements,e.elements),this}multiply(e,s){return s?Or(this.elements,e.elements,s.elements):Or(this.elements,this.elements,e.elements),this}multiplyScalar(e=this,s){return nc(this.elements,e.elements,s),this}premultiply(e,s){return s?Or(this.elements,s.elements,e.elements):Or(this.elements,e.elements,this.elements),this}translate(e){return Nl(this.elements,this.elements,e.elements),this}rotate(e){return Dl(this.elements,this.elements,e),this}scale(e){return th(this.elements,this.elements,e.elements),this}scaleScalar(e){return th(this.elements,this.elements,[e,e,e]),this}fromTranslation(e){return Hl(this.elements,e.elements),this}fromRotation(e,s){return ql(this.elements,e,s),this}fromRotationX(e){return Zl(this.elements,e),this}fromRotationY(e){return Wl(this.elements,e),this}fromRotationZ(e){return Yl(this.elements,e),this}fromScale(e){return jl(this.elements,e.elements),this}fromRotationTranslation(e,s){return Kl(this.elements,e.elements,s.elements),this}fromPerspective(e,s,r,n){return Qh(this.elements,vo(e),s,r,n),this}fromOrthogonal(e,s,r,n,l,c){return Jh(this.elements,e,s,r,n,l,c),this}fromQuat(e){return ec(this.elements,e.elements),this}equals(e){return ac(this.elements,e.value)}getRotation(e=new Gs){return Ql(Qe,this.elements),e.set(Qe[0],Qe[1],Qe[2],Qe[3]),e}getScale(e=new xe){return Xh(Qe,this.elements),e.set(Qe[0],Qe[1],Qe[2]),e}getTranslation(e=new xe){return Xl(Qe,this.elements),e.set(Qe[0],Qe[1],Qe[2]),e}rotateX(e){return Gl(this.elements,this.elements,e),this}rotateY(e){return $l(this.elements,this.elements,e),this}rotateZ(e){return Vl(this.elements,this.elements,e),this}compose(e,s,r){return Jl(this.elements,s.elements,e.elements,r.elements),this}decompose(){return{rotation:this.getRotation(),scale:this.getScale(),translation:this.getTranslation()}}copy(e){return Ul(this.elements,e.elements),this}clone(){return new Ui().copy(this)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}var vs,ot;const on=class on extends Vs{constructor(e=0,s=0,r=0,n="xyz"){super();N(this,"elements",new(Nt())(3));S(this,vs,[]);S(this,ot,"xyz");const l=this.elements;l[0]=e,l[1]=s,l[2]=r,y(this,ot,n)}get x(){return this.elements[0]}set x(e){this.elements[0]=e,this.triggerChange()}get y(){return this.elements[1]}set y(e){this.elements[1]=e,this.triggerChange()}get z(){return this.elements[2]}set z(e){this.elements[2]=e,this.triggerChange()}get order(){return o(this,ot)}set order(e){y(this,ot,e),this.triggerChange()}get roll(){return this.x}set roll(e){this.x=e}get pitch(){return this.y}set pitch(e){this.y=e}get yaw(){return this.z}set yaw(e){this.z=e}fromObject({x:e,y:s,z:r,order:n}){return e!==void 0&&(this.x=e),s!==void 0&&(this.y=s),r!==void 0&&(this.z=r),n!==void 0&&(this.order=n),this.triggerChange(),this}toObject(){return{x:this.x,y:this.y,z:this.z,order:this.order}}fromRotationMatrix(e,s=o(this,ot),r=!0){const n=e.toArray(),l=n[0],c=n[4],d=n[8],p=n[1],g=n[5],v=n[9],w=n[2],_=n[6],T=n[10];switch(s){case"xyz":this.y=Math.asin(Xt(d,-1,1)),Math.abs(d)<.9999999?(this.x=Math.atan2(-v,T),this.z=Math.atan2(-c,l)):(this.x=Math.atan2(_,g),this.z=0);break;case"yxz":this.x=Math.asin(-Xt(v,-1,1)),Math.abs(v)<.9999999?(this.y=Math.atan2(d,T),this.z=Math.atan2(p,g)):(this.y=Math.atan2(-w,l),this.z=0);break;case"zxy":this.x=Math.asin(Xt(_,-1,1)),Math.abs(_)<.9999999?(this.y=Math.atan2(-w,T),this.z=Math.atan2(-c,g)):(this.y=0,this.z=Math.atan2(p,l));break;case"zyx":this.y=Math.asin(-Xt(w,-1,1)),Math.abs(w)<.9999999?(this.x=Math.atan2(_,T),this.z=Math.atan2(p,l)):(this.x=0,this.z=Math.atan2(-c,g));break;case"yzx":this.z=Math.asin(Xt(p,-1,1)),Math.abs(p)<.9999999?(this.x=Math.atan2(-v,g),this.y=Math.atan2(-w,l)):(this.x=0,this.y=Math.atan2(d,T));break;case"xzy":this.z=Math.asin(-Xt(c,-1,1)),Math.abs(c)<.9999999?(this.x=Math.atan2(_,g),this.y=Math.atan2(d,l)):(this.x=Math.atan2(-v,T),this.y=0);break;default:throw new Error("Unknown Euler angle order")}return y(this,ot,s),r&&this.triggerChange(),this}fromQuaternion(e){const[s,r,n,l]=e.elements,c=r*r,d=-2*(c+n*n)+1,p=2*(s*r+l*n);let g=-2*(s*n-l*r);const v=2*(r*n+l*s),w=-2*(s*s+c)+1;g=g>1?1:g,g=g<-1?-1:g;const _=Math.atan2(v,w),T=Math.asin(g),E=Math.atan2(p,d);return new on(_,T,E,"zyx")}fromVector3(e,s=o(this,ot)){return this.set(e.x,e.y,e.z,s)}toQuaternion(){const e=Math.cos(.5*this.yaw),s=Math.sin(.5*this.yaw),r=Math.cos(.5*this.roll),n=Math.sin(.5*this.roll),l=Math.cos(.5*this.pitch),c=Math.sin(.5*this.pitch);return new Gs(e*n*l-s*r*c,e*r*c+s*n*l,s*r*l-e*n*c,e*r*l+s*n*c)}toVector3(){return new xe(this.x,this.y,this.z)}set(e,s,r,n=o(this,ot)){return this.elements[0]=e,this.elements[1]=s,this.elements[2]=r,y(this,ot,n),this.triggerChange(),this}clone(){return new on().copy(this)}copy(e){let s=0;for(;s<this.elements.length;s++)this.elements[s]=e.elements[s];return y(this,ot,e.order),this.triggerChange(),this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.order===e.order}onChange(e){o(this,vs).includes(e)||o(this,vs).push(e)}triggerChange(){o(this,vs).forEach(e=>e())}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}};vs=new WeakMap,ot=new WeakMap;let sa=on;function mu(t,i){var e={white:"#ffffff",bisque:"#ffe4c4",blue:"#0000ff",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",antiquewhite:"#faebd7",aqua:"#00ffff",azure:"#f0ffff",whitesmoke:"#f5f5f5",papayawhip:"#ffefd5",plum:"#dda0dd",blanchedalmond:"#ffebcd",black:"#000000",gold:"#ffd700",goldenrod:"#daa520",gainsboro:"#dcdcdc",cornsilk:"#fff8dc",cornflowerblue:"#6495ed",burlywood:"#deb887",aquamarine:"#7fffd4",beige:"#f5f5dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkkhaki:"#bdb76b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",peachpuff:"#ffdab9",darkmagenta:"#8b008b",darkred:"#8b0000",darkorchid:"#9932cc",darkorange:"#ff8c00",darkslateblue:"#483d8b",gray:"#808080",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",deeppink:"#ff1493",deepskyblue:"#00bfff",wheat:"#f5deb3",firebrick:"#b22222",floralwhite:"#fffaf0",ghostwhite:"#f8f8ff",darkviolet:"#9400d3",magenta:"#ff00ff",green:"#008000",dodgerblue:"#1e90ff",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",blueviolet:"#8a2be2",forestgreen:"#228b22",lawngreen:"#7cfc00",indianred:"#cd5c5c",indigo:"#4b0082",fuchsia:"#ff00ff",brown:"#a52a2a",maroon:"#800000",mediumblue:"#0000cd",lightcoral:"#f08080",darkturquoise:"#00ced1",lightcyan:"#e0ffff",ivory:"#fffff0",lightyellow:"#ffffe0",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",linen:"#faf0e6",mediumaquamarine:"#66cdaa",lemonchiffon:"#fffacd",lime:"#00ff00",khaki:"#f0e68c",mediumseagreen:"#3cb371",limegreen:"#32cd32",mediumspringgreen:"#00fa9a",lightskyblue:"#87cefa",lightblue:"#add8e6",midnightblue:"#191970",lightpink:"#ffb6c1",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",mintcream:"#f5fffa",lightslategray:"#778899",lightslategrey:"#778899",navajowhite:"#ffdead",navy:"#000080",mediumvioletred:"#c71585",powderblue:"#b0e0e6",palegoldenrod:"#eee8aa",oldlace:"#fdf5e6",paleturquoise:"#afeeee",mediumturquoise:"#48d1cc",mediumorchid:"#ba55d3",rebeccapurple:"#663399",lightsteelblue:"#b0c4de",mediumslateblue:"#7b68ee",thistle:"#d8bfd8",tan:"#d2b48c",orchid:"#da70d6",mediumpurple:"#9370db",purple:"#800080",pink:"#ffc0cb",skyblue:"#87ceeb",springgreen:"#00ff7f",palegreen:"#98fb98",red:"#ff0000",yellow:"#ffff00",slateblue:"#6a5acd",lavenderblush:"#fff0f5",peru:"#cd853f",palevioletred:"#db7093",violet:"#ee82ee",teal:"#008080",slategray:"#708090",slategrey:"#708090",aliceblue:"#f0f8ff",darkseagreen:"#8fbc8f",darkolivegreen:"#556b2f",greenyellow:"#adff2f",seagreen:"#2e8b57",seashell:"#fff5ee",tomato:"#ff6347",silver:"#c0c0c0",sienna:"#a0522d",lavender:"#e6e6fa",lightgreen:"#90ee90",orange:"#ffa500",orangered:"#ff4500",steelblue:"#4682b4",royalblue:"#4169e1",turquoise:"#40e0d0",yellowgreen:"#9acd32",salmon:"#fa8072",saddlebrown:"#8b4513",sandybrown:"#f4a460",rosybrown:"#bc8f8f",darksalmon:"#e9967a",lightgoldenrodyellow:"#fafad2",snow:"#fffafa",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",dimgray:"#696969",dimgrey:"#696969",olivedrab:"#6b8e23",olive:"#808000"},s={};for(var r in e)s[e[r]]=r;var n={};t.prototype.toName=function(l){if(!(this.rgba.a||this.rgba.r||this.rgba.g||this.rgba.b))return"transparent";var c,d,p=s[this.toHex()];if(p)return p;if(l!=null&&l.closest){var g=this.toRgb(),v=1/0,w="black";if(!n.length)for(var _ in e)n[_]=new t(e[_]).toRgb();for(var T in e){var E=(c=g,d=n[T],Math.pow(c.r-d.r,2)+Math.pow(c.g-d.g,2)+Math.pow(c.b-d.b,2));E<v&&(v=E,w=T)}return w}},i.string.push([function(l){var c=l.toLowerCase(),d=c==="transparent"?"#0000":e[c];return d?new t(d).toRgb():null},"name"])}hu([mu]);const Dr=(t,i,e)=>{const s=yo(t),r=e-i;let n=Xt(Number.parseFloat(`${t}`),i,e);return s&&(n=Number.parseInt(""+t*e,10)/100),Math.abs(n-e)<1e-6?1:t%r/r};class ra{constructor(i=255,e,s,r=1,n=!1){N(this,"r");N(this,"g");N(this,"b");N(this,"a");if(this.r=1,this.g=1,this.b=1,this.a=1,Ve(e)&&Ve(s))if(Ds(i)&&i<=255)this.setRGBA(i,i,i,this.a,n);else{const l=Oe(i).toRgb();l?this.setRGBA(l.r,l.g,l.b,l.a):console.error("Unsupported color value {".concat(String(i),"} provided"))}else this.setRGBA(i,e,s,r)}fromColor(i){const e=Oe(i).toRgb();return this.setRGBA(e.r,e.g,e.b,e.a)}fromHSL(i,e,s,r=1){const n=Oe({h:i,s:e,l:s,a:r}).toRgb();return this.setRGBA(n.r,n.g,n.b,n.a)}fromHSV(i,e,s,r=1){const n=Oe({h:i,s:e,v:s,a:r}).toRgb();return this.setRGBA(n.r,n.g,n.b,n.a)}setRGB(i,e,s){return this.setRGBA(i,e,s,this.a),this}setRGBA(i,e,s,r,n){return this.r=n?i:Dr(i,0,255),this.g=n?e:Dr(e,0,255),this.b=n?s:Dr(s,0,255),this.setAlpha(r),this}setAlpha(i){return i>1?this.a=Dr(i,0,255):this.a=i,this}toHex(){return Oe(this.toObject()).toHex()}toHSL(){return Oe(this.toObject()).toHsl()}toHSV(){return Oe(this.toObject()).toHsv()}toObject(i=!1){const e=i?1:255;return{r:this.r*e,g:this.g*e,b:this.b*e,a:this.a}}toArray(){return[this.r,this.g,this.b,this.a]}toVector(){return new br().fromArray(this.toArray())}toVector3(){return new xe().fromArray(this.toArray())}toString(){return`${this.constructor.name}(${this.r}, ${this.g}, ${this.b}, ${this.a})`}}class an extends Ui{frustum(i,e,s,r,n,l,c){return tc(i.elements,e,s,n,r,l,c),this}orthographic(i,e,s,r,n,l){return Jh(this.elements,i,e,r,s,n,l),this}perspective(i,e,s,r){return Qh(this.elements,i,e,s,r),this}lookAt(i,e=new xe(0,0,0),s=new xe(0,1,0)){return rc(this.elements,i.elements,e.elements,s.elements),this}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class wr{constructor(){N(this,"visible");N(this,"localMatrix");N(this,"worldMatrix");N(this,"matrixAutoUpdate");N(this,"position");N(this,"scale");N(this,"rotation");N(this,"quaternion");N(this,"up");N(this,"children");N(this,"parent");N(this,"worldMatrixNeedsUpdate");this.visible=!0,this.localMatrix=new an,this.worldMatrix=new an,this.matrixAutoUpdate=!0,this.position=new xe,this.scale=new xe(1,1,1),this.rotation=new sa,this.quaternion=new Gs,this.up=new xe(0,1,0),this.parent=null,this.children=[],this.worldMatrixNeedsUpdate=!1,this.rotation.onChange(()=>{this.quaternion.fromEuler(this.rotation)}),this.quaternion.onChange(()=>{this.rotation.fromQuaternion(this.quaternion)})}add(i,e=!0){this.contains(i)||this.children.push(i),e&&i.setParent(this,!1)}remove(i,e=!0){this.contains(i)&&this.children.splice(this.children.indexOf(i),1),e&&i.setParent(null,!1)}contains(i){return this.children.includes(i)}setParent(i,e=!0){this.parent&&i!==this.parent&&this.parent.remove(this,!1),this.parent=i,e&&i&&i.add(this,!1)}traverse(i){if(!i(this))for(let e=0,s=this.children.length;e<s;e++)this.children[e].traverse(i)}lookAt(i,e){e?this.localMatrix.lookAt(this.position,i,this.up):this.localMatrix.lookAt(i,this.position,this.up),this.localMatrix.getRotation(this.quaternion),this.rotation.fromQuaternion(this.quaternion)}updateMatrixWorld(i){let e=i;this.matrixAutoUpdate&&this.updateMatrix(),(this.worldMatrixNeedsUpdate||e)&&(this.parent===null?this.worldMatrix.copy(this.localMatrix):this.worldMatrix.multiply(this.parent.worldMatrix,this.localMatrix),this.worldMatrixNeedsUpdate=!1,e=!0);for(let s=0,r=this.children.length;s<r;s++)this.children[s].updateMatrixWorld(e)}updateMatrix(){this.localMatrix.compose(this.position,this.quaternion,this.scale),this.worldMatrixNeedsUpdate=!0}decompose(){this.localMatrix.getTranslation(this.position),this.localMatrix.getRotation(this.quaternion),this.localMatrix.getScale(this.scale),this.rotation.fromQuaternion(this.quaternion)}clone(){return new wr().copy(this,!1)}copy(i,e){if(this.visible=i.visible,this.position.copy(i.position),this.scale.copy(i.scale),this.rotation.copy(i.rotation),this.quaternion.copy(i.quaternion),this.up.copy(i.up),this.localMatrix.copy(i.localMatrix),this.worldMatrix.copy(i.worldMatrix),this.matrixAutoUpdate=i.matrixAutoUpdate,e)for(let s=0,r=i.children.length;s<r;s++){const n=i.children[s];this.add(n.clone())}return this}}class da{constructor(i){N(this,"renderer");this.renderer=i}get gl(){return this.renderer.gl}get rendererState(){return this.renderer.state}}const vu=(t,i)=>{if(i instanceof Float32Array||i instanceof Float64Array)return t.FLOAT;if(i instanceof Uint16Array)return t.UNSIGNED_SHORT;if(i instanceof Uint8Array||i instanceof Uint8ClampedArray)return t.UNSIGNED_BYTE;if(i instanceof Uint32Array)return t.UNSIGNED_INT;if(i instanceof Int8Array)return t.BYTE;if(i instanceof Int16Array)return t.SHORT;if(i instanceof Int32Array)return t.INT};class It{constructor(i,e){N(this,"id");N(this,"data");N(this,"type");N(this,"size");N(this,"instanced");N(this,"stride");N(this,"offset");N(this,"divisor");N(this,"normalized");N(this,"needsUpdate");N(this,"count");N(this,"usage");N(this,"target");N(this,"buffer");const s=Object.assign({},{size:1,normalized:!0,stride:0,offset:0,divisor:0,usage:i.gl.STATIC_DRAW},e);if(this.id=$s("attribute"),this.needsUpdate=!1,!e.data||Array.isArray(e.data))throw new TypeError("BufferAttribute: data should be a typed array");this.data=s.data,this.size=s.size||1,this.type=s.type||vu(i.gl,s.data),this.normalized=s.normalized||!1,this.stride=s.stride||0,this.offset=s.offset||0,this.divisor=s.divisor||0,this.instanced=s.divisor>0,this.usage=s.usage||i.gl.STATIC_DRAW,s.target&&(this.target=s.target);let r=s.count;(s.count===void 0||s.count===null)&&(r=s.stride?s.data.byteLength/s.stride:s.data.length/s.size),this.count=r}}const Ch=new xe;var rr,$t,Vt,ue;const xa=class xa extends da{constructor(e,s={}){super(e);S(this,rr,void 0);S(this,$t,void 0);S(this,Vt,void 0);S(this,ue,void 0);N(this,"drawRange");N(this,"instancedCount");N(this,"isInstanced");N(this,"drawMode");this.drawRange={start:0,count:0},this.instancedCount=0,this.isInstanced=!1,y(this,$t,new Map),y(this,Vt,new Map),y(this,rr,$s("geometry")),this.drawMode=this.gl.TRIANGLES,e.bindVertexArray(null),e.state.setActiveGeometry(null);for(const r in s){const n=s[r];if(n instanceof It)r==="index"?this.setIndex(n):this.addAttribute(r,n);else if(n.data){const l=new It(this.renderer,n);r==="index"?this.setIndex(l):this.addAttribute(r,l)}}}get id(){return o(this,rr)}get attributes(){return o(this,$t)}get attributesData(){const e={},s=o(this,$t).entries();for(let r=0;r<o(this,$t).size;r++){const n=s.next().value;e[n[0]]=un(n[1],["id","buffer"])}return e}get index(){return this.attributes.get("index")}get bounds(){return o(this,ue)}set bounds(e){y(this,ue,e)}addAttribute(e,s){if(s.target||(s.target=e==="index"?this.gl.ELEMENT_ARRAY_BUFFER:this.gl.ARRAY_BUFFER),s.needsUpdate=!1,this.attributes.set(e,s),s.buffer||(s.buffer=this.gl.createBuffer(),this.updateAttribute(s)),s.divisor){if(this.isInstanced=!0,this.instancedCount&&this.instancedCount!==s.count*s.divisor)return this.instancedCount=Math.min(this.instancedCount,s.count*s.divisor),console.warn(`Geometry has multiple instanced buffers of different length - instancedCount: ${this.instancedCount}, count: ${s.count}, divisor: ${s.divisor}, attribute: ${e}`);this.instancedCount=s.count*s.divisor}else e==="index"?this.drawRange.count=s.count:this.index||(this.drawRange.count=Math.max(this.drawRange.count,s.count))}getAttribute(e){return this.attributes.get(e)}setAttributeData(e,s){const r=this.getAttribute(e);r&&(r.data=s,r.needsUpdate=!0)}updateAttribute(e){!e.buffer&&(e.buffer=this.gl.createBuffer()),this.rendererState.boundBuffer!==e.buffer&&(this.gl.bindBuffer(e.target,e.buffer),this.rendererState.boundBuffer=e.buffer),this.gl.bufferData(e.target,e.data,e.usage),e.needsUpdate=!1}removeAttribute(e){this.attributes.delete(e)}setIndex(e){var s;if(e instanceof It)e.size=1,this.addAttribute("index",e);else{const r=new It(this.renderer,{data:e.length>65535?new Uint32Array(e):new Uint16Array(e),size:1});this.addAttribute("index",r)}this.drawRange.count=(s=this.index)==null?void 0:s.count}setVertices(e){const s=[],r=e.length;for(let n=0;n<r;n++){const l=e[n];s.push(l[0],l[1],l[2])}this.addAttribute("position",new It(this.renderer,{data:new Float32Array(s),size:3}))}setNormals(e){this.addAttribute("normal",new It(this.renderer,{data:new Float32Array(e),size:2}))}setUVs(e){this.addAttribute("uv",new It(this.renderer,{data:new Float32Array(e),size:2}))}setColors(e){const s=[];for(let r=0;r<e.length;r++){let n=e[r];n&&(n instanceof xe||n instanceof br)&&(n=n.toArray()),s.push(n[0],n[1],n[2],n[3]||1)}this.addAttribute("color",new It(this.renderer,{data:new Float32Array(s),size:4}))}setDrawRange(e,s){this.drawRange.start=e,this.drawRange.count=s}setInstancedCount(e){this.instancedCount=e}createVAO(e){const{attributeOrder:s}=e,r=this.renderer.createVertexArray();this.renderer.bindVertexArray(r),o(this,Vt).set(s,r),this.bindAttributes(e)}bindAttributes(e){e.attributeLocations.forEach((r,{name:n,type:l})=>{const c=this.attributes.get(n);if(!c)return;this.gl.bindBuffer(c.target,c.buffer),this.rendererState.boundBuffer=c.buffer;let d=1;l===this.gl.FLOAT_MAT2&&(d=2),l===this.gl.FLOAT_MAT3&&(d=3),l===this.gl.FLOAT_MAT4&&(d=4);const p=c.size/d,g=d===1?0:d*d*d,v=d===1?0:d*d;for(let w=0;w<d;w++){const _=r+w;this.gl.vertexAttribPointer(_,p,c.type,c.normalized,c.stride+g,c.offset+v),this.gl.enableVertexAttribArray(_),this.renderer.vertexAttribDivisor(_,c.divisor)}});const s=this.attributes.get("index");s&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,s.buffer)}computeBoundingBox(e){const{data:s,offset:r=0,stride:n,size:l}=this.attributes.get("position");o(this,ue)||y(this,ue,{min:new xe,max:new xe,center:new xe,scale:new xe,radius:Number.POSITIVE_INFINITY}),o(this,ue).min.setScalar(+Number.POSITIVE_INFINITY),o(this,ue).max.setScalar(Number.NEGATIVE_INFINITY);const c=e||s,d=n||l;for(let p=r;p<c.length;p+=d){const g=c[p+0],v=c[p+1],w=c[p+2];o(this,ue).min.x=Math.min(g,o(this,ue).min.x),o(this,ue).min.y=Math.min(v,o(this,ue).min.y),o(this,ue).min.z=Math.min(w,o(this,ue).min.z),o(this,ue).max.x=Math.max(g,o(this,ue).max.x),o(this,ue).max.y=Math.max(v,o(this,ue).max.y),o(this,ue).max.z=Math.max(w,o(this,ue).max.z)}return o(this,ue).scale.subVectors(o(this,ue).max,o(this,ue).min),o(this,ue).center.add(o(this,ue).min).add(o(this,ue).max).divideScalar(2),o(this,ue)}computeBoundingSphere(e){const{data:s,offset:r=0,stride:n,size:l}=this.attributes.get("position");o(this,ue)||this.computeBoundingBox(e);const c=e||s;let d=0;const p=n||l,g=c.length;for(let v=r;v<g;v+=p)Ch.fromArray(c,v),d=Math.max(d,o(this,ue).center.distanceToSquared(Ch));o(this,ue).radius=Math.sqrt(d)}draw(e,s=this.drawMode){const{start:r,count:n}=this.drawRange,l=`${this.id}_${e.attributeOrder}`;if(this.rendererState.activeGeometryId!==l&&(o(this,Vt).get(e.attributeOrder)||this.createVAO(e),this.renderer.bindVertexArray(o(this,Vt).get(e.attributeOrder)),this.rendererState.activeGeometryId=l),e.attributeLocations.forEach((c,{name:d})=>{const p=this.getAttribute(d);p&&p.needsUpdate&&this.updateAttribute(p)}),this.isInstanced)if(this.index){const c=this.index.offset+2*r;this.renderer.drawElementsInstanced(s,n,this.index.type,c,this.instancedCount)}else this.renderer.drawArraysInstanced(s,r,n,this.instancedCount);else if(this.index){const c=this.index.offset+2*r;this.gl.drawElements(s,n,this.index.type,c)}else this.gl.drawArrays(s,r,n)}copy(e){const s=e.attributesData;for(const r in s){const n=s[r];if(n instanceof It)r==="index"?this.setIndex(n):this.addAttribute(r,n);else if(n.data){const l=new It(this.renderer,n);r==="index"?this.setIndex(l):this.addAttribute(r,l)}}return e.bounds&&(this.bounds={min:new xe().copy(e.bounds.min),max:new xe().copy(e.bounds.max),center:new xe().copy(e.bounds.center),scale:new xe().copy(e.bounds.scale),radius:e.bounds.radius}),this}clone(){const e=new xa(this.renderer,{}).copy(this);return e.drawMode=this.drawMode,e}destroy(){o(this,Vt).forEach(e=>{this.renderer.deleteVertexArray(e)}),o(this,Vt).clear(),o(this,$t).forEach(e=>{this.gl.deleteBuffer(e.buffer)}),o(this,$t).clear()}};rr=new WeakMap,$t=new WeakMap,Vt=new WeakMap,ue=new WeakMap;let Ye=xa;var nr,ar,Je,ii,vt,si;const ya=class ya extends wr{constructor(e,s={}){super();N(this,"gl");N(this,"modelViewMatrix");N(this,"normalMatrix");N(this,"renderOrder");N(this,"zDepth");N(this,"frustumCulled");N(this,"mode");N(this,"renderer");S(this,nr,void 0);S(this,ar,void 0);S(this,Je,void 0);S(this,ii,void 0);S(this,vt,void 0);S(this,si,void 0);const r=Object.assign({},{mode:e.gl.TRIANGLES,frustumCulled:!0,renderOrder:0},s);this.renderer=e,this.gl=this.renderer.gl,this.modelViewMatrix=new Ui,this.normalMatrix=new nn,this.renderOrder=r.renderOrder,this.frustumCulled=r.frustumCulled,this.zDepth=0,y(this,nr,r.id||$s("mesh")),y(this,Je,r.geometry),y(this,ii,r.program),y(this,vt,!!r.wireframe),this.mode=r.mode,y(this,ar,r.mode),o(this,vt)&&(this.mode=this.gl.LINES,this.updateWireframeGeometry(o(this,vt)))}get id(){return o(this,nr)}get geometry(){return o(this,vt)?o(this,si):o(this,Je)}get program(){return o(this,ii)}set wireframe(e){this.mode=e?this.gl.LINES:o(this,ar),y(this,vt,e),this.updateWireframeGeometry(o(this,vt))}get wireframe(){return o(this,vt)}draw(e={}){var l,c,d,p;const{camera:s,target:r}=e,n={};s?(Object.assign(n,{projectionMatrix:s.projectionMatrix,cameraPosition:s.worldPosition,viewMatrix:s.viewMatrix}),this.modelViewMatrix.multiply(s.viewMatrix,this.worldMatrix),this.normalMatrix.getNormalMatrix(this.modelViewMatrix)):this.modelViewMatrix.copy(this.worldMatrix),Object.assign(n,{resolution:new st(((c=(l=this.renderer.state)==null?void 0:l.viewport)==null?void 0:c.width)||1,((p=(d=this.renderer.state)==null?void 0:d.viewport)==null?void 0:p.height)||1),modelMatrix:this.worldMatrix,modelViewMatrix:this.modelViewMatrix,normalMatrix:this.normalMatrix}),Object.keys(n).forEach(g=>{Object.hasOwn(this.program.uniforms,g)||(this.program.uniforms[g]={value:null}),this.program.uniforms[g].value=n[g]}),r&&r.bind(),this.program.use(),this.geometry.draw(this.program,this.mode),r&&r.unbind()}updateWireframeGeometry(e,s=!1){var r,n;if(o(this,Je)&&(s||!o(this,si))){o(this,si)&&o(this,si).destroy();const c=(r=o(this,Je).attributes.get("position"))==null?void 0:r.data,d=(n=o(this,Je).index)==null?void 0:n.data,p=d?d.length:Math.floor(c.length/3),g=[];o(this,Je).index?d&&Qn(c,g,p,d):Qn(c,g,p);const v=g.length>65536?new Uint32Array(g):new Uint16Array(g);y(this,si,new Ye(this.renderer,{...o(this,Je).attributesData,index:{data:v}}))}}updateGeometry(e,s=!0){s&&o(this,Je)&&o(this,Je).destroy(),y(this,Je,e),this.updateWireframeGeometry(o(this,vt),!0)}updateProgram(e,s=!0){s&&o(this,ii)&&o(this,ii).destroy(),y(this,ii,e)}destroy(){this.program.destroy(),this.geometry.destroy()}clone(){return new ya(this.gl,{geometry:this.geometry,program:this.program,frustumCulled:this.frustumCulled,mode:this.mode,renderOrder:this.renderOrder}).copy(this)}copy(e,s=!0){return super.copy(e,s),this.modelViewMatrix.copy(e.modelViewMatrix),this.normalMatrix.copy(e.normalMatrix),this.mode=e.mode,this.renderOrder=e.renderOrder,this.zDepth=e.zDepth,this}};nr=new WeakMap,ar=new WeakMap,Je=new WeakMap,ii=new WeakMap,vt=new WeakMap,si=new WeakMap;let gt=ya;class Eo extends wr{clone(){return new Eo().copy(this,!1)}copy(i,e){return super.copy(i,e),this.matrixAutoUpdate=i.matrixAutoUpdate,this}}var Js=(t=>(t[t.NoBlending=0]="NoBlending",t[t.NormalBlending=1]="NormalBlending",t[t.AdditiveBlending=2]="AdditiveBlending",t[t.SubtractiveBlending=3]="SubtractiveBlending",t[t.MultiplyBlending=4]="MultiplyBlending",t[t.CustomBlending=5]="CustomBlending",t))(Js||{}),k;class xu extends da{constructor(e,s){super(e);S(this,k,void 0);const{gl:r}=e;y(this,k,{viewport:{x:0,y:0,width:0,height:0}}),this.apply(s||{frontFace:r.CCW,depthTest:!1,depthWrite:!0,depthMask:!0,depthFunc:r.LESS,blending:1,blendFunc:{src:r.ONE,dst:r.ZERO},blendEquation:{modeRGB:r.FUNC_ADD},premultiplyAlpha:!1,unpackAlignment:4,flipY:!1,framebuffer:null,textureUnits:[],activeTextureUnit:-1,activeGeometryId:-1,currentProgramId:-1,clearAlpha:1,clearColor:new ra(0),stencil:{func:{},opFront:{},opBack:{}}})}get state(){return o(this,k)}get viewport(){return o(this,k).viewport}get textureUnits(){return o(this,k).textureUnits}get activeTextureUnit(){return o(this,k).activeTextureUnit}set activeTextureUnit(e){o(this,k).activeTextureUnit=e}get currentProgramId(){return o(this,k).currentProgramId}set currentProgramId(e){o(this,k).currentProgramId=e}get activeGeometryId(){return o(this,k).activeGeometryId}set activeGeometryId(e){o(this,k).activeGeometryId=e}set flipY(e){o(this,k).flipY=e}get flipY(){return o(this,k).flipY}set unpackAlignment(e){o(this,k).unpackAlignment=e}get unpackAlignment(){return o(this,k).unpackAlignment}set premultiplyAlpha(e){o(this,k).premultiplyAlpha=e}get premultiplyAlpha(){return o(this,k).premultiplyAlpha}set boundBuffer(e){o(this,k).boundBuffer=e}get boundBuffer(){return o(this,k).boundBuffer}set anisotropy(e){o(this,k).anisotropy=e}get anisotropy(){return o(this,k).anisotropy}apply(e){if(e.blending!==void 0&&e.blending!==null)this.setBlending(e.blending,e);else{if(e.blendFunc){const{src:s,dst:r,srcAlpha:n,dstAlpha:l}=e.blendFunc;this.setBlendFunc(s,r,n,l),this.enable(this.gl.BLEND)}else this.disable(this.gl.BLEND);if(e.blendEquation){const{modeRGB:s,modeAlpha:r}=e.blendEquation;this.setBlendEquation(s,r)}}!Ve(e.cullFace)&&!Ie(e.cullFace)&&this.setCullFace(e.cullFace),!Ve(e.frontFace)&&!Ie(e.frontFace)&&this.setFrontFace(e.frontFace),e.depthTest?this.enable(this.gl.DEPTH_TEST):this.disable(this.gl.DEPTH_TEST),!Ve(e.depthMask)&&!Ie(e.depthMask)&&this.setDepthMask(e.depthMask),!Ve(e.depthWrite)&&!Ie(e.depthWrite)&&this.setDepthMask(e.depthWrite),!Ve(e.depthFunc)&&!Ie(e.depthFunc)&&this.setDepthFunc(e.depthFunc),!Ve(e.lineWidth)&&!Ie(e.lineWidth)&&this.setLineWidth(e.lineWidth),y(this,k,Object.assign(o(this,k),e))}enable(e){o(this,k)[e]!==!0&&(this.gl.enable(e),o(this,k)[e]=!0)}disable(e){o(this,k)[e]!==!1&&(this.gl.disable(e),o(this,k)[e]=!1)}setViewport(e,s,r=0,n=0){o(this,k).viewport.width===e&&o(this,k).viewport.height===s||(this.gl.viewport(r,n,e,s),o(this,k).viewport={width:e,height:s,x:r,y:n})}setMask(e){o(this,k).colorMask!==e&&(this.gl.colorMask(e,e,e,e),o(this,k).colorMask=e)}setBlending(e,s){if(o(this,k).blending=e,e===0){this.disable(this.gl.BLEND);return}else this.enable(this.gl.BLEND);if(e===2)o(this,k).premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ONE,this.gl.ONE,this.gl.ONE,this.gl.ONE)):(this.setBlendEquation(this.gl.FUNC_ADD),this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE));else if(e===3)o(this,k).premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR,this.gl.ONE_MINUS_SRC_ALPHA)):(this.setBlendEquation(this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR));else if(e===4)o(this,k).premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.SRC_COLOR,this.gl.ZERO,this.gl.SRC_ALPHA)):(this.setBlendEquation(this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.SRC_COLOR));else if(e===1)o(this,k).premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA)):(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));else if(e===5){if(s!=null&&s.blendFunc){const{src:r,dst:n,srcAlpha:l,dstAlpha:c}=s.blendFunc;this.setBlendFunc(r,n,l,c),this.enable(this.gl.BLEND)}if(s!=null&&s.blendEquation){const{modeRGB:r,modeAlpha:n}=s.blendEquation;this.setBlendEquation(r,n)}}else console.error("State: Invalid blending: ",e)}setBlendFunc(e,s,r,n){var l,c,d,p;(e!==((l=o(this,k).blendFunc)==null?void 0:l.src)||s!==((c=o(this,k).blendFunc)==null?void 0:c.dst)||r!==((d=o(this,k).blendFunc)==null?void 0:d.srcAlpha)||n!==((p=o(this,k).blendFunc)==null?void 0:p.dstAlpha))&&(o(this,k).blendFunc={src:e,dst:s,srcAlpha:r,dstAlpha:n},!Ve(r)&&!Ie(r)&&!Ve(n)&&!Ie(n)?this.gl.blendFuncSeparate(e,s,r,n):this.gl.blendFunc(e,s))}setBlendEquation(e,s){var r,n;(e!==((r=o(this,k).blendEquation)==null?void 0:r.modeRGB)||s!==((n=o(this,k).blendEquation)==null?void 0:n.modeAlpha))&&(o(this,k).blendEquation={modeRGB:e,modeAlpha:s},!Ve(s)&&!Ie(s)?this.gl.blendEquationSeparate(e,s):this.gl.blendEquation(e))}setClearAlpha(e){o(this,k).clearAlpha!==e&&(o(this,k).clearAlpha=e)}setClearColor(e,s){(o(this,k).clearAlpha!==s||o(this,k).clearColor!==e)&&(o(this,k).clearColor=e,!Ve(s)&&!Ie(s)?o(this,k).clearAlpha=s:o(this,k).clearAlpha=e.a,this.gl.clearColor(e.r,e.g,e.b,o(this,k).clearAlpha))}setCullFace(e){o(this,k).cullFace!==e&&(e?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),o(this,k).cullFace=e,this.gl.cullFace(e))}setFrontFace(e){o(this,k).frontFace!==e&&(o(this,k).frontFace=e,this.gl.frontFace(e))}setDepthMask(e){o(this,k).depthMask!==e&&(o(this,k).depthMask=e,this.gl.depthMask(e))}setDepthFunc(e){o(this,k).depthFunc!==e&&(o(this,k).depthFunc=e,this.gl.depthFunc(e))}setDepthTest(e){o(this,k).depthTest!==e&&(o(this,k).depthTest=e,e?this.enable(this.gl.DEPTH_TEST):this.disable(this.gl.DEPTH_TEST))}setStencilFunc(e,s,r,n){var l,c,d,p,g,v,w,_,T,E,A,R;(((d=(c=(l=o(this,k))==null?void 0:l.stencil)==null?void 0:c.func)==null?void 0:d.cmp)!==e||((v=(g=(p=o(this,k))==null?void 0:p.stencil)==null?void 0:g.func)==null?void 0:v.ref)!==s||((T=(_=(w=o(this,k))==null?void 0:w.stencil)==null?void 0:_.func)==null?void 0:T.mask)!==r)&&((E=o(this,k))!=null&&E.stencil||(o(this,k).stencil={}),(R=(A=o(this,k))==null?void 0:A.stencil)!=null&&R.func||(o(this,k).stencil.func={}),o(this,k).stencil.func={ref:s,mask:r,cmp:e},n?this.gl.stencilFuncSeparate(n,e,s,r):this.gl.stencilFunc(e,s,r))}setStencilOp(e,s,r,n){var l,c,d,p,g,v,w,_,T,E,A,R,U,C,I,O,V,Q,X,se,ie,W,oe,le,q;if((l=o(this,k))!=null&&l.stencil||(o(this,k).stencil={}),!n||n===this.gl.FRONT_AND_BACK)return((d=(c=o(this,k).stencil)==null?void 0:c.opFront)==null?void 0:d.fail)!==e||((g=(p=o(this,k).stencil)==null?void 0:p.opFront)==null?void 0:g.zFail)!==s||((w=(v=o(this,k).stencil)==null?void 0:v.opFront)==null?void 0:w.zPass)!==r||((T=(_=o(this,k).stencil)==null?void 0:_.opBack)==null?void 0:T.fail)!==e||((A=(E=o(this,k).stencil)==null?void 0:E.opBack)==null?void 0:A.zFail)!==s||((U=(R=o(this,k).stencil)==null?void 0:R.opBack)==null?void 0:U.zPass)!==r;if(n===this.gl.FRONT)return((I=(C=o(this,k).stencil)==null?void 0:C.opFront)==null?void 0:I.fail)!==e||((V=(O=o(this,k).stencil)==null?void 0:O.opFront)==null?void 0:V.zFail)!==s||((X=(Q=o(this,k).stencil)==null?void 0:Q.opFront)==null?void 0:X.zPass)!==r;if(n===this.gl.BACK)return((ie=(se=o(this,k).stencil)==null?void 0:se.opBack)==null?void 0:ie.fail)!==e||((oe=(W=o(this,k).stencil)==null?void 0:W.opBack)==null?void 0:oe.zFail)!==s||((q=(le=o(this,k).stencil)==null?void 0:le.opBack)==null?void 0:q.zPass)!==r}setStencilMask(e,s){var r;((r=o(this,k).stencil)==null?void 0:r.mask)!==e&&(o(this,k).stencil={...o(this,k).stencil,mask:e},s?this.gl.stencilMaskSeparate(s,e):this.gl.stencilMask(e))}setActiveTexture(e){o(this,k).activeTextureUnit!==e&&(o(this,k).activeTextureUnit=e,this.gl.activeTexture(this.gl.TEXTURE0+e))}setLineWidth(e){o(this,k).lineWidth!==e&&(o(this,k).lineWidth=e,this.gl.lineWidth(e))}setPolygonOffset(e,s,r){e?(this.enable(this.gl.POLYGON_OFFSET_FILL),(o(this,k).polygonOffsetFactor!==s||o(this,k).polygonOffsetUnits!==r)&&(this.gl.polygonOffset(s,r),o(this,k).polygonOffsetFactor=s,o(this,k).polygonOffsetUnits=r)):this.disable(this.gl.POLYGON_OFFSET_FILL)}bindFramebuffer(e={}){const{target:s=this.gl.FRAMEBUFFER,buffer:r=null}=e;o(this,k).framebuffer!==r&&(o(this,k).framebuffer=r,this.gl.bindFramebuffer(s,r))}setActiveGeometry(e){o(this,k).activeGeometryId=e}reset(e=!0){const s=Object.keys(o(this,k));e?(s.filter(r=>["viewport","premultiplyAlpha"].indexOf(r)<0).forEach(r=>{delete o(this,k)[r]}),this.bindFramebuffer({buffer:null}),this.apply({frontFace:this.gl.CCW,depthTest:!1,depthWrite:!0,depthMask:!0,depthFunc:this.gl.LESS,blending:1,blendFunc:{src:this.gl.ONE,dst:this.gl.ZERO},blendEquation:{modeRGB:this.gl.FUNC_ADD},premultiplyAlpha:!1,unpackAlignment:4,flipY:!1,framebuffer:null,textureUnits:[],activeTextureUnit:-1,activeGeometryId:-1,currentProgramId:-1,clearAlpha:1,clearColor:new ra(0),stencil:{func:{},opFront:{},opBack:{}}})):(s.filter(r=>["flipY","framebuffer","textureUnits","activeTextureUnit","activeGeometryId","currentProgramId"].indexOf(r)>-1).forEach(r=>{delete o(this,k)[r]}),this.bindFramebuffer({buffer:null}),o(this,k).flipY=!1,o(this,k).activeGeometryId=-1,o(this,k).activeTextureUnit=-1,o(this,k).currentProgramId=-1,o(this,k).textureUnits=[],o(this,k).boundBuffer=null)}}k=new WeakMap;const yu=["WEBGL_depth_texture","OES_texture_half_float","OES_texture_float","OES_standard_derivatives","OES_element_index_uint","EXT_frag_depth","EXT_blend_minmax","EXT_shader_texture_lod","WEBGL_draw_buffers","WEBGL_color_buffer_float"],bu=["EXT_color_buffer_float"],wu=["WEBGL_lose_context","OES_texture_half_float_linear","OES_texture_float_linear","EXT_color_buffer_half_float","WEBGL_debug_renderer_info","EXT_texture_filter_anisotropic"];var xt,He,Ne,xs,zt,Di,Ht,Gi,jt,$i,Vi,yt,ys;class Xf{constructor(i,e={}){S(this,xt,void 0);S(this,He,void 0);S(this,Ne,void 0);S(this,xs,void 0);S(this,zt,void 0);S(this,Di,void 0);S(this,Ht,void 0);S(this,Gi,void 0);S(this,jt,void 0);S(this,$i,void 0);S(this,Vi,void 0);S(this,yt,void 0);S(this,ys,void 0);N(this,"vertexAttribDivisor");N(this,"drawArraysInstanced");N(this,"drawElementsInstanced");N(this,"createVertexArray");N(this,"bindVertexArray");N(this,"deleteVertexArray");N(this,"width");N(this,"height");var c,d,p;const s=Object.assign({},{autoClear:!0,depth:!0,alpha:!1,stencil:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,requestWebGl2:!0,extensions:[]},e);y(this,xs,!!s.autoClear),y(this,zt,s.depth),y(this,Di,s.alpha),y(this,Ht,s.stencil),y(this,Gi,s.antialias),y(this,jt,s.premultipliedAlpha),y(this,$i,s.preserveDrawingBuffer),y(this,xt,ta(i)||ia(i)?i:xo(i,{alpha:o(this,Di),depth:o(this,zt),stencil:o(this,Ht),antialias:o(this,Gi),powerPreference:s.powerPreference,premultipliedAlpha:o(this,jt),preserveDrawingBuffer:o(this,$i)},s.requestWebGl2));const r=(c=o(this,xt))==null?void 0:c.getContextAttributes(),n=(d=o(this,xt))==null?void 0:d.getParameter(o(this,xt).VIEWPORT),l=(p=o(this,xt))==null?void 0:p.getParameter(o(this,xt).UNPACK_FLIP_Y_WEBGL);y(this,He,new xu(this)),r&&(y(this,zt,!!r.depth),y(this,Gi,!!r.antialias),y(this,Di,!!r.alpha),y(this,Ht,!!r.stencil),y(this,jt,!!r.premultipliedAlpha),y(this,$i,!!r.preserveDrawingBuffer)),o(this,He).flipY=!!l,o(this,He).setViewport(n[2],n[3],n[0],n[1]),o(this,He).premultiplyAlpha=o(this,jt),y(this,Vi,!0),y(this,yt,s.dpr||1),this.width=this.gl.canvas.width/o(this,yt),this.height=this.gl.canvas.height/o(this,yt),y(this,ys,!!s.frustumCull),y(this,Ne,{}),this.vertexAttribDivisor=this.getExtension("ANGLE_instanced_arrays","vertexAttribDivisor","vertexAttribDivisorANGLE"),this.drawArraysInstanced=this.getExtension("ANGLE_instanced_arrays","drawArraysInstanced","drawArraysInstancedANGLE"),this.drawElementsInstanced=this.getExtension("ANGLE_instanced_arrays","drawElementsInstanced","drawElementsInstancedANGLE"),this.createVertexArray=this.getExtension("OES_vertex_array_object","createVertexArray","createVertexArrayOES"),this.bindVertexArray=this.getExtension("OES_vertex_array_object","bindVertexArray","bindVertexArrayOES"),this.deleteVertexArray=this.getExtension("OES_vertex_array_object","deleteVertexArray","deleteVertexArrayOES"),s.extensions&&(s.extensions.filter(g=>yu.findIndex(v=>v===g)>-1).forEach(g=>{!o(this,Ne)[g]&&!this.isWebGL2&&(o(this,Ne)[g]=this.gl.getExtension(g))}),s.extensions.filter(g=>bu.findIndex(v=>v===g)>-1).forEach(g=>{!o(this,Ne)[g]&&this.isWebGL2&&(o(this,Ne)[g]=this.gl.getExtension(g))}),s.extensions.filter(g=>wu.findIndex(v=>v===g)>-1).forEach(g=>{o(this,Ne)[g]||(o(this,Ne)[g]=this.gl.getExtension(g))}))}get gl(){return o(this,xt)}get attributes(){return{dpr:o(this,yt),flipY:o(this,He).flipY,depth:o(this,zt),color:o(this,Vi),antialias:o(this,Gi),alpha:o(this,Di),stencil:o(this,Ht),autoClear:o(this,xs),frustumCull:o(this,ys),premultipliedAlpha:o(this,jt),preserveDrawingBuffer:o(this,$i)}}get canvas(){return o(this,xt).canvas}get isWebGL(){return ta(this.gl)}get isWebGL2(){return ia(this.gl)}get extensions(){return o(this,Ne)}extension(i){return o(this,Ne)[i]}get size(){return{width:"clientWidth"in this.canvas?this.canvas.clientWidth:this.canvas.width,height:"clientHeight"in this.canvas?this.canvas.clientHeight:this.canvas.height}}get state(){return o(this,He)}get premultipliedAlpha(){return o(this,jt)}setSize(i,e){this.width=i,this.height=e,this.gl.canvas.width=i*o(this,yt),this.gl.canvas.height=e*o(this,yt)}setViewport(i,e,s=0,r=0){o(this,He).setViewport(i,e,s,r)}getExtension(i,e,s){const r=this.gl[e];if(e&&r)return r.bind(this.gl);o(this,Ne)[i]||(o(this,Ne)[i]=this.gl.getExtension(i));const n=o(this,Ne)[i];return e?n?n[s].bind(n):null:n}getRenderList({scene:i,camera:e}){const s=[];return i.traverse(r=>{if(!r.visible)return!0;r.draw&&(o(this,ys)&&r.frustumCulled&&e&&!e.frustumIntersectsMesh(r)||s.push(r))}),s}render(i){const{scene:e,camera:s,target:r=null,update:n=!0,clear:l}=i;r===null?(o(this,He).bindFramebuffer({buffer:null}),this.setViewport(this.width*o(this,yt),this.height*o(this,yt))):(r.bind(),this.setViewport(r.width,r.height)),(l||o(this,xs)&&l!==!1)&&(o(this,zt)&&(!r||r.depth)&&(o(this,He).enable(this.gl.DEPTH_TEST),o(this,He).setDepthMask(!0)),this.clear(o(this,Vi),o(this,zt),o(this,Ht))),n&&e.updateMatrixWorld(),s&&s.updateMatrixWorld();const c=this.getRenderList({scene:e,camera:s});let d=0;const p=c.length;for(;d<p;d++)c[d].draw({camera:s});r&&r.unbind()}clear(i=o(this,Vi),e=o(this,zt),s=o(this,Ht)){let r=0;i&&(r|=this.gl.COLOR_BUFFER_BIT),e&&(r|=this.gl.DEPTH_BUFFER_BIT),s&&(r|=this.gl.STENCIL_BUFFER_BIT),this.gl.clear(r)}resetState(i=!0,e=null){o(this,He).reset(i),this.bindVertexArray(e)}}xt=new WeakMap,He=new WeakMap,Ne=new WeakMap,xs=new WeakMap,zt=new WeakMap,Di=new WeakMap,Ht=new WeakMap,Gi=new WeakMap,jt=new WeakMap,$i=new WeakMap,Vi=new WeakMap,yt=new WeakMap,ys=new WeakMap;const Gr="Resource subclass must define virtual methods";var bt,hr;class _r extends da{constructor(e,s={}){super(e);S(this,bt,void 0);S(this,hr,void 0);N(this,"id");N(this,"name");N(this,"userData");N(this,"byteLength");N(this,"options");this.id=(s==null?void 0:s.id)||$s(this.constructor.name),this.name=s==null?void 0:s.name,this.userData=s==null?void 0:s.userData,y(this,bt,s==null?void 0:s.handle),this.options=s,o(this,bt)===void 0&&y(this,bt,this.createHandle()),this.byteLength=0}get handle(){return o(this,bt)}swapHandle(e){y(this,hr,o(this,bt)),y(this,bt,e)}restoreHandle(){y(this,bt,o(this,hr))}destroy(){this.delete()}delete({deleteChildren:e=!1}={}){const s=this.handle&&this.deleteHandle(this.handle);return this.handle&&this.removeStats(),y(this,bt,null),s&&e&&s.filter(Boolean).forEach(r=>r.delete()),this}bind(e=this.handle){throw new Error(Gr)}unbind(){this.bind(null)}removeStats(){throw new Error(Gr)}createHandle(){throw new Error(Gr)}deleteHandle(){throw new Error(Gr)}toString(){return`${this.constructor.name}(${this.id})`}}bt=new WeakMap,hr=new WeakMap;var bs;class $r extends _r{constructor(e,s={}){super(e,{...s,format:s.format||e.gl.DEPTH_COMPONENT16});N(this,"width");N(this,"height");S(this,bs,void 0);y(this,bs,this.options.format),this.width=this.options.width,this.height=this.options.height,console.assert(this.width>0&&this.height>0,"Renderbuffer object requires valid width and height greater than zero"),this.bind(),e.gl.renderbufferStorage(e.gl.RENDERBUFFER,o(this,bs),this.width,this.height)}resize(e,s){e===this.width&&s===this.height||(this.width=e,this.height=s,this.bind(),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,o(this,bs),e,s),this.unbind())}bind(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.handle)}unbind(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null)}removeStats(){}destroy(){this.unbind(),this.deleteHandle()}createHandle(){return this.gl.createRenderbuffer()}deleteHandle(){this.handle&&this.gl.deleteRenderbuffer(this.handle)}}bs=new WeakMap;const Fh=new Uint8Array(4);var Ue;class ss extends _r{constructor(e,s={},r=!0){const{gl:n}=e,l={target:n.TEXTURE_2D,type:n.UNSIGNED_BYTE,format:n.RGBA,internalFormat:s.format||n.RGBA,wrapS:n.CLAMP_TO_EDGE,wrapT:n.CLAMP_TO_EDGE,generateMipmaps:!0,minFilter:n.LINEAR,magFilter:n.LINEAR,premultiplyAlpha:!1,unpackAlignment:4,anisotropy:0,flipY:!1,level:0},c=Object.assign({},l,s);super(e,c);N(this,"needsUpdate",!1);N(this,"textureUnit",0);N(this,"image");N(this,"width");N(this,"height");N(this,"target");S(this,Ue,{});this.textureUnit=0,this.image=this.options.image,this.width=this.options.width,this.height=this.options.height,this.target=this.options.target,o(this,Ue).version=-1,this.needsUpdate=!!r,this.needsUpdate&&this.update()}setData(e,s=this.width,r=this.height){this.image=e,this.width=s,this.height=r,this.needsUpdate=!0}setOptions(e){this.options=Object.assign(this.options,e),this.width=this.options.width,this.height=this.options.height,this.needsUpdate=!0}fromSrc(e){return new Promise((s,r)=>{const n=new Image;n.onload=()=>{this.setData(n,n.width,n.height),s(this)},n.onerror=l=>{r(l)},n.crossOrigin="*",n.src=e})}update(e=0){const s=!(this.image===o(this,Ue).image&&!this.needsUpdate);if((s||this.rendererState.textureUnits[e]!==this.id||this.rendererState.activeTextureUnit!==e)&&(this.rendererState.setActiveTexture(e),this.bind(e)),!!s){if(this.needsUpdate=!1,this.options.wrapS!==o(this,Ue).wrapS&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_S,this.options.wrapS),o(this,Ue).wrapS=this.options.wrapS),this.options.wrapT!==o(this,Ue).wrapT&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_T,this.options.wrapT),o(this,Ue).wrapT=this.options.wrapT),this.options.minFilter!==o(this,Ue).minFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MIN_FILTER,this.options.minFilter),o(this,Ue).minFilter=this.options.minFilter),this.options.magFilter!==o(this,Ue).magFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MAG_FILTER,this.options.magFilter),o(this,Ue).magFilter=this.options.magFilter),this.options.flipY!==this.rendererState.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.options.flipY),this.rendererState.flipY=this.options.flipY),this.options.premultiplyAlpha!==this.rendererState.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.options.premultiplyAlpha),this.rendererState.premultiplyAlpha=this.options.premultiplyAlpha),this.options.unpackAlignment!==this.rendererState.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.options.unpackAlignment),this.rendererState.unpackAlignment=this.options.unpackAlignment),this.options.anisotropy&&this.options.anisotropy!==this.rendererState.anisotropy){const n=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(n){const l=this.gl.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT);let c=this.options.anisotropy;this.options.anisotropy>l&&(c=l,console.warn(`[Texture]: Texture.anisotropy option exceeded the maximum allowed value ${l} of the device`)),this.gl.texParameterf(this.target,n.TEXTURE_MAX_ANISOTROPY_EXT,c)}this.rendererState.anisotropy=this.options.anisotropy}this.image?(this.image.width&&(this.width=this.image.width,this.height=this.image.height),this.renderer.isWebGL2&&Ds(this.options.offset)?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,this.image,this.options.offset):ArrayBuffer.isView(this.image)?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,this.image):this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.options.format,this.options.type,this.image),this.options.generateMipmaps&&(this.renderer.isWebGL2||ea(this.image.width)&&ea(this.image.height)?this.gl.generateMipmap(this.target):(this.options.generateMipmaps=!1,this.options.wrapS=this.gl.CLAMP_TO_EDGE,this.options.wrapT=this.options.wrapS,this.options.minFilter=this.gl.LINEAR))):this.renderer.isWebGL2&&Ds(this.options.offset)?this.width>0?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,this.options.offset):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Fh,this.options.offset):this.width>0?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,null):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Fh),o(this,Ue).image=this.image,o(this,Ue).version+=1}}bind(e=this.textureUnit){this.rendererState.textureUnits[this.rendererState.activeTextureUnit]!==this.id&&(this.textureUnit=e,this.rendererState.textureUnits[this.textureUnit]=this.id,this.gl.bindTexture(this.target,this.handle))}unbind(){this.gl.activeTexture(this.gl.TEXTURE0+this.textureUnit),this.gl.bindTexture(this.target,null),delete this.rendererState.textureUnits[this.textureUnit]}destroy(){this.unbind(),super.destroy()}removeStats(){y(this,Ue,{version:-1})}createHandle(){return this.gl.createTexture()}deleteHandle(){this.handle&&this.gl.deleteTexture(this.handle)}toString(){return`Texture(${this.id},${this.width}x${this.height})`}}Ue=new WeakMap;class So extends ss{constructor(e,s={}){super(e,{...s,image:s.data,premultiplyAlpha:!0,flipY:!1,unpackAlignment:1});N(this,"needsUpdate",!0)}}var Lt,ri,Hi,ni,ai;class St extends _r{constructor(e,s={}){super(e,{color:1,depth:!0,depthTexture:!1,stencil:!1,...s});S(this,Lt,void 0);S(this,ri,void 0);N(this,"depth");N(this,"width");N(this,"height");N(this,"viewport");N(this,"drawBuffersChanged");N(this,"drawBuffers");S(this,Hi,void 0);S(this,ni,void 0);S(this,ai,void 0);y(this,ri,new Map),y(this,Lt,new Map),this.depth=!!s.depth,this.drawBuffers=[],this.drawBuffersChanged=!1,this.width=this.options.width,this.height=this.options.height,this.viewport=new br(0,0,this.width,this.height),this.name=this.options.name;const r=this.options.attachments||[];if(r.length===0){for(let n=0;n<this.options.color;n++){const l={wrapS:this.gl.CLAMP_TO_EDGE,wrapT:this.gl.CLAMP_TO_EDGE,minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR,type:this.gl.UNSIGNED_BYTE,format:this.gl.RGBA,flipY:!1,generateMipmaps:!1,...s};let c;l.data?c=new So(e,l):c=new ss(e,un(l,["data","name","attachments","depthTexture"])),r.push([this.gl.COLOR_ATTACHMENT0+n,c])}if(s.depthTexture&&(e.isWebGL2||!e.isWebGL2&&e.gl.getExtension("WEBGL_depth_texture"))){const n=new ss(e,{width:this.width,height:this.height,minFilter:this.gl.NEAREST,magFilter:this.gl.NEAREST,format:this.gl.DEPTH_COMPONENT,internalFormat:e.isWebGL2?this.gl.DEPTH_COMPONENT16:this.gl.DEPTH_COMPONENT,type:this.gl.UNSIGNED_INT});r.push([this.gl.DEPTH_ATTACHMENT,n])}else{const{depth:n,stencil:l}=s;if(n&&!l){const c=new $r(e,{format:this.gl.DEPTH_COMPONENT16,width:this.width,height:this.height});r.push([this.gl.DEPTH_ATTACHMENT,c])}else if(l&&!n){const c=new $r(e,{format:this.gl.STENCIL_INDEX8,width:this.width,height:this.height});r.push([this.gl.STENCIL_ATTACHMENT,c])}else if(n&&l){const c=new $r(e,{format:this.gl.DEPTH_STENCIL,width:this.width,height:this.height});r.push([this.gl.DEPTH_STENCIL_ATTACHMENT,c])}}}this.create(r)}get texture(){return o(this,Lt).values().next().value}set clearColors(e){y(this,Hi,e)}get clearColors(){return o(this,Hi)}set clearDepth(e){y(this,ni,e)}get clearDepth(){return o(this,ni)}set clearStencil(e){y(this,ai,e)}get clearStencil(){return o(this,ai)}create(e){y(this,Hi,[]),y(this,ni,1),y(this,ai,0);for(const r of e){const n=r[0],l=r[1];l instanceof $r?o(this,ri).set(n,l):l instanceof ss&&(o(this,Lt).set(n,l),this.drawBuffers.push(n));const c=n-this.gl.COLOR_ATTACHMENT0;o(this,Hi)[c]=[0,0,0,0]}if(this.options.color>1)if(this.renderer.isWebGL2)this.gl.drawBuffers(this.drawBuffers);else{const r=this.renderer.extension("WEBGL_draw_buffers");if(r&&r.drawBuffersWEBGL)r.drawBuffersWEBGL(this.drawBuffers);else throw new Error("Please open the corresponding extension [WEBGL_draw_buffers](https://developer.mozilla.org/en-US/docs/Web/API/WEBGL_draw_buffers#browser_compatibility) and check whether the browser supports it")}this.drawBuffersChanged=!0,this.bind(),o(this,ri).forEach((r,n)=>{this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,n,this.gl.RENDERBUFFER,r.handle)}),o(this,Lt).forEach((r,n)=>{this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,n,this.gl.TEXTURE_2D,r.handle,0)}),this.unbind();const s=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);if(s!==this.gl.FRAMEBUFFER_COMPLETE)switch(s){case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case this.gl.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}return this.handle}clear(){this.bind();let e=0;if(this.clearColors[0]){const s=this.clearColors[0];this.gl.clearColor(s[0],s[1],s[2],s[3]),e|=this.gl.COLOR_BUFFER_BIT}Ds(o(this,ni))&&(this.gl.clearDepth(o(this,ni)),e|=this.gl.DEPTH_BUFFER_BIT),Ds(o(this,ai))&&(this.gl.clearStencil(o(this,ai)),e|=this.gl.STENCIL_BUFFER_BIT),this.gl.clear(e),this.unbind()}getTexture(e){return o(this,Lt).get(e)}resize(e,s){(this.width!==e||this.height!==s)&&(this.width=e,this.height=s,o(this,Lt).forEach(r=>{(r.width!==e||r.height!==s)&&(r.width=e,r.height=s,r.needsUpdate=!0,r.update())}),o(this,ri).forEach(r=>{r.resize(e,s)}),this.viewport.set(0,0,e,s))}bind(e=this.gl.FRAMEBUFFER){this.gl.bindFramebuffer(e,this.handle)}unbind(e=this.gl.FRAMEBUFFER){this.gl.bindFramebuffer(e,null)}removeStats(){}destroy(){o(this,Lt).forEach(e=>{e.destroy()}),o(this,ri).forEach(e=>{e.destroy()}),this.deleteHandle()}createHandle(){return this.gl.createFramebuffer()}deleteHandle(){this.handle&&this.gl.deleteFramebuffer(this.handle)}toString(){return`RenderTarget(${this.id},${this.width}x${this.height})`}}Lt=new WeakMap,ri=new WeakMap,Hi=new WeakMap,ni=new WeakMap,ai=new WeakMap;const _u="Shader: GLSL source code must be a JavaScript string",Vr={};function Ph(t="id"){Vr[t]=Vr[t]||1;const i=Vr[t];return Vr[t]+=1,"".concat(t,"-").concat(i)}const Ih=(t,i)=>{switch(i){case t.VERTEX_SHADER:return"vertex-shader";case t.FRAGMENT_SHADER:return"fragment-shader";default:return"unknown"}},Tu=(t,i)=>{switch(i){case"fragment":return t.FRAGMENT_SHADER;case"vertex":return t.VERTEX_SHADER;default:return}};function Mu(t){const i=t.split(`
`);for(let e=0;e<i.length;e++)i[e]=e+1+": "+i[e];return i.join(`
`)}var or,lr;class Ro extends _r{constructor(e,s,r,n={}){const l=Tu(e.gl,r);super(e,{name:Xn(s)||Ph(Ih(e,l))});S(this,or,void 0);S(this,lr,void 0);N(this,"sourceCode");console.assert(typeof s=="string",_u),y(this,lr,n),y(this,or,l),this.sourceCode=this.injectShaderModule(s,n||{}).replace(/\n\n+/gm,`

`),this.createShader(this.sourceCode)}injectShaderModule(e,s={}){const r=/^[\t ]*#glsl_include +<([\w.]+)>/gm,n=(l,c)=>{let d=s[c];if(d===void 0)throw new Error("Cannot resolve #include <".concat(c,">"));return d=d.replace(/#include </g,"#glsl_include <"),this.injectShaderModule(d,s)};return e.replace(r,n)}createShader(e=this.source){let s=e.replace(/#include </g,"#glsl_include <");if(s=this.injectShaderModule(s,o(this,lr)||{}).replace(/\n\n+/gm,`

`),this.gl.shaderSource(this.handle,s),this.gl.compileShader(this.handle),!this.gl.getShaderParameter(this.handle,this.gl.COMPILE_STATUS)){const r=this.gl.getShaderInfoLog(this.handle)||"";throw this.gl.deleteShader(this.handle),new Error(`${this.toString()}
${r}
${Mu(s)}`)}}get source(){return this.sourceCode}get shaderType(){return o(this,or)}getSource(){return this.gl.getShaderSource(this.handle)}setSource(e){const s=Xn(e);s&&(this.name=Ph(s)),this.createShader(e)}removeStats(){}deleteHandle(){this.gl.deleteShader(this.handle)}toString(){return`${Ih(this.gl,this.shaderType)}:${this.id}`}}or=new WeakMap,lr=new WeakMap;class Au extends Ro{constructor(i,e,s){super(i,e,"vertex",s)}createHandle(){return this.gl.createShader(this.gl.VERTEX_SHADER)}}class Eu extends Ro{constructor(i,e,s){super(i,e,"fragment",s)}createHandle(){return this.gl.createShader(this.gl.FRAGMENT_SHADER)}}const Su=t=>[].map(e=>"#define ".concat(e)),Uh={};function Ru(t){const i=t.length,e=t[0].length;if(e===void 0)return t;const s=i*e;let r=Uh[s];r||(Uh[s]=r=new Float32Array(s));for(let n=0;n<i;n++)r.set(t[n],n*e);return r}function Vn(t,i,e,s){s=s.length?Ru(s):s;const r=s.length;switch(i){case WebGLRenderingContext.FLOAT:return r?t.uniform1fv(e,s):t.uniform1f(e,s);case WebGLRenderingContext.FLOAT_VEC2:return t.uniform2fv(e,s);case WebGLRenderingContext.FLOAT_VEC3:return t.uniform3fv(e,s);case WebGLRenderingContext.FLOAT_VEC4:return t.uniform4fv(e,s);case WebGLRenderingContext.BOOL:case WebGLRenderingContext.INT:case WebGLRenderingContext.SAMPLER_2D:case WebGLRenderingContext.SAMPLER_CUBE:return r?t.uniform1iv(e,s):t.uniform1i(e,s);case WebGLRenderingContext.BOOL_VEC2:case WebGLRenderingContext.INT_VEC2:return t.uniform2iv(e,s);case WebGLRenderingContext.BOOL_VEC3:case WebGLRenderingContext.INT_VEC3:return t.uniform3iv(e,s);case WebGLRenderingContext.BOOL_VEC4:case WebGLRenderingContext.INT_VEC4:return t.uniform4iv(e,s);case WebGLRenderingContext.FLOAT_MAT2:return t.uniformMatrix2fv(e,!1,s);case WebGLRenderingContext.FLOAT_MAT3:return t.uniformMatrix3fv(e,!1,s);case WebGLRenderingContext.FLOAT_MAT4:return t.uniformMatrix4fv(e,!1,s)}}var ji,ws,_s,Ts,je,ln,Co,cn,Fo;class Rt extends _r{constructor(e,s={}){super(e,s);S(this,ln);S(this,cn);N(this,"attributeOrder");N(this,"uniforms");S(this,ji,void 0);S(this,ws,void 0);S(this,_s,void 0);S(this,Ts,void 0);S(this,je,void 0);const{id:r,vertexShader:n,fragmentShader:l,uniforms:c={},transparent:d=!1,defines:p=[],includes:g={},cullFace:v,frontFace:w=e.gl.CCW,depthTest:_=!0,depthWrite:T=!0,depthFunc:E=e.gl.LESS,blending:A=1,blendFunc:R,blendEquation:U}=s;this.id=r||$s("program");const C=[...Su({...s,...c}),...p].map(I=>I.startsWith("#define ")?I:"#define ".concat(I));if(!n||!l)throw new Error(`Program: ${this.id}：must provide vertexShader and fragmentShader`);if(y(this,_s,typeof n=="string"?new Au(e,Kn(n,C),g):n),y(this,Ts,typeof l=="string"?new Eu(e,Kn(l,C),g):l),this.gl.attachShader(this.handle,o(this,_s).handle),this.gl.attachShader(this.handle,o(this,Ts).handle),this.gl.linkProgram(this.handle),this.gl.validateProgram(this.handle),!this.gl.getProgramParameter(this.handle,this.gl.LINK_STATUS))throw new Error("Program:".concat(this.id,": Error linking ").concat(this.gl.getProgramInfoLog(this.handle)));this.uniforms=c,y(this,je,{blending:A,cullFace:v,frontFace:w,depthTest:_,depthWrite:T,depthFunc:E,blendFunc:R,blendEquation:U}),y(this,ji,new Map),y(this,ws,new Map),ls(this,ln,Co).call(this,c),ls(this,cn,Fo).call(this),d&&!(R!=null&&R.src)&&(this.renderer.premultipliedAlpha?o(this,je).blendFunc={...R,src:this.gl.ONE,dst:this.gl.ONE_MINUS_SRC_ALPHA}:o(this,je).blendFunc={...R,src:this.gl.SRC_ALPHA,dst:this.gl.ONE_MINUS_SRC_ALPHA})}get uniformLocations(){return o(this,ji)}get attributeLocations(){return o(this,ws)}get vertexShader(){return o(this,_s)}get fragmentShader(){return o(this,Ts)}use(){const e=this.rendererState.currentProgramId===this.id;let s=-1;e||(this.gl.useProgram(this.handle),this.rendererState.currentProgramId=this.id),o(this,ji).forEach((r,n)=>{const l=n.name,c=this.uniforms[l];if(!c){console.warn("Program:".concat(this.id,": Active uniform ").concat(l," has not been supplied"));return}if(c&&(Ve(c.value)||Ie(c.value))){console.warn("Program:".concat(this.id,": Uniform ").concat(l," is missing a value parameter"));return}let d=c==null?void 0:c.value;if(d instanceof ss)return s+=1,c.value.update(s),Vn(this.gl,n.type,r.location,s);if((d instanceof fa||d instanceof Vs||d instanceof ra)&&(d=c.value.toArray()),d&&d.length>0&&d[0]instanceof ss){const p=[];for(let g=0;g<c.value.length;g++){const v=d[g];s+=1,v.update(s),p.push(s)}return Vn(this.gl,n.type,r.location,p)}Vn(this.gl,n.type,r.location,d)}),this.applyState()}setStates(e,s=!0){s?(y(this,je,{...o(this,je),...un(e,["blendFunc","blendEquation"])}),e.blendFunc&&(o(this,je).blendFunc={...o(this,je).blendFunc,...e.blendFunc}),e.blendEquation&&(o(this,je).blendEquation={...o(this,je).blendEquation,...e.blendEquation})):y(this,je,e)}applyState(){this.rendererState.apply(o(this,je))}setUniform(e,s){this.uniforms[e]&&(this.uniforms[e].value=s)}bind(){this.gl.useProgram(this.handle)}unbind(){this.gl.useProgram(null)}createHandle(){return this.gl.createProgram()}deleteHandle(){this.gl.deleteProgram(this.handle)}destroy(){this.unbind(),this.deleteHandle()}}ji=new WeakMap,ws=new WeakMap,_s=new WeakMap,Ts=new WeakMap,je=new WeakMap,ln=new WeakSet,Co=function(e={}){var r;const s=this.gl.getProgramParameter(this.handle,this.gl.ACTIVE_UNIFORMS);for(let n=0;n<s;n++){const l=this.gl.getActiveUniform(this.handle,n);if(!l)break;const c=l.name,d=c.match(/(\w+)/g),p={location:this.gl.getUniformLocation(this.handle,c),type:l.type,name:d[0],isStruct:!1};d.length===3?(p.isStructArray=!0,p.structIndex=Number(d[1]),p.structProperty=d[2]):d.length===2&&isNaN(Number(d[1]))&&(p.isStruct=!0,p.structProperty=d[1]);const g=(r=e[c])==null?void 0:r.value;!Ve(g)&&!Ie(g)&&(p.value=e[c].value),this.uniforms[c]=p,o(this,ji).set(l,p)}},cn=new WeakSet,Fo=function(){const e=this.gl.getProgramParameter(this.handle,this.gl.ACTIVE_ATTRIBUTES),s=[];for(let r=0;r<e;r++){const n=this.gl.getActiveAttrib(this.handle,r);if(!n)break;const l=this.gl.getAttribLocation(this.handle,n.name);s[l]=n.name,o(this,ws).set(n,l)}this.attributeOrder=s.join("")};const Cu=new Ui,Fu=new xe,Pu=new xe,Iu="Camera subclass must define virtual methods";var hi,oi,qi,Zi,Ms,wt;class Po extends wr{constructor({near:e=.1,far:s=100,fov:r=45,aspect:n=1,bounds:l,zoom:c=1}={}){super();N(this,"cameraType");N(this,"projectionMatrix");N(this,"viewMatrix");N(this,"projectionViewMatrix");N(this,"worldPosition");S(this,hi,void 0);S(this,oi,void 0);S(this,qi,void 0);S(this,Zi,void 0);S(this,Ms,void 0);S(this,wt,void 0);N(this,"frustum");this.cameraType="perspective",this.projectionMatrix=new an,this.viewMatrix=new Ui,this.projectionViewMatrix=new an,this.worldPosition=new xe,this.frustum=new Ui,y(this,hi,e),y(this,oi,s),y(this,qi,r),y(this,Zi,n),y(this,wt,l),y(this,Ms,c);const{left:d,right:p,top:g,bottom:v}=l||{};this.cameraType=d||p?"orthographic":"perspective",this.cameraType==="orthographic"?this.orthographic(d,p,g,v,e,s,c):this.perspective(r,n,e,s)}get near(){return o(this,hi)}set near(e){y(this,hi,e),this.updateProjectionMatrix()}get far(){return o(this,oi)}set far(e){y(this,oi,e),this.updateProjectionMatrix()}get fov(){return o(this,qi)}set fov(e){y(this,qi,e),this.updateProjectionMatrix()}get aspect(){return o(this,Zi)}set aspect(e){y(this,Zi,e),this.updateProjectionMatrix()}get zoom(){return o(this,Ms)}set zoom(e){y(this,Ms,e),this.updateProjectionMatrix()}get bounds(){return o(this,wt)}set bounds(e){y(this,wt,e),this.updateProjectionMatrix()}perspective(e=this.fov,s=this.aspect,r=this.near,n=this.far){y(this,qi,e),y(this,Zi,s),y(this,hi,r),y(this,oi,n),this.projectionMatrix.fromPerspective(e,s,r,n),this.cameraType="perspective"}orthographic(e,s,r,n,l=this.near,c=this.far,d=1){y(this,wt,{left:e,right:s,top:r,bottom:n}),this.near=l,this.far=c,this.projectionMatrix.orthographic(e/d,s/d,r/d,n/d,l,c),this.cameraType="orthographic",this.projectionMatrix.frustum(this.frustum,o(this,wt).left,o(this,wt).right,o(this,wt).top,o(this,wt).bottom,o(this,hi),o(this,oi))}lookAt(e){return super.lookAt(e,!0),this}updateMatrixWorld(){return super.updateMatrixWorld(),this.viewMatrix.invert(this.worldMatrix),this.worldMatrix.getTranslation(this.worldPosition),this.projectionViewMatrix.multiply(this.projectionMatrix,this.viewMatrix),this}frustumIntersectsMesh(e,s=e.worldMatrix){if(!e.geometry.attributes.position||((!e.geometry.bounds||e.geometry.bounds.radius===1/0)&&e.geometry.computeBoundingSphere(),!e.geometry.bounds))return!0;const r=Fu;r.copy(e.geometry.bounds.center),r.applyMatrix4(s);const n=e.geometry.bounds.radius*s.getMaxScaleOnAxis();return this.frustumIntersectsSphere(r,n)}frustumIntersectsSphere(e,s){const r=Pu;for(let n=0;n<6;n++){const l=this.frustum[n];if(r.copy(l).dot(e)+l.constant<-s)return!1}return!0}project(e){return e.applyMatrix4(this.viewMatrix),e.applyMatrix4(this.projectionMatrix),this}unproject(e){return e.applyMatrix4(Cu.invert(this.projectionMatrix)),e.applyMatrix4(this.worldMatrix),this}updateProjectionMatrix(){throw new Error(Iu)}}hi=new WeakMap,oi=new WeakMap,qi=new WeakMap,Zi=new WeakMap,Ms=new WeakMap,wt=new WeakMap;class Qf extends Po{constructor(i,e,s,r){super({fov:i,aspect:e,near:s,far:r})}updateProjectionMatrix(){this.projectionMatrix.fromPerspective(this.fov,this.aspect,this.near,this.far)}}class Jf extends Po{constructor(i,e,s,r,n,l,c=1){super({bounds:{left:i,right:e,top:s,bottom:r},near:n,far:l,zoom:c})}updateProjectionMatrix(){const{left:i,right:e,top:s,bottom:r}=this.bounds,{zoom:n}=this;this.projectionMatrix.orthographic(i/n,e/n,s/n,r/n,this.near,this.far)}}var pa={exports:{}};pa.exports=fn;pa.exports.default=fn;function fn(t,i,e){e=e||2;var s=i&&i.length,r=s?i[0]*e:t.length,n=Io(t,0,r,e,!0),l=[];if(!n||n.next===n.prev)return l;var c,d,p,g,v,w,_;if(s&&(n=Ou(t,i,n,e)),t.length>80*e){c=p=t[0],d=g=t[1];for(var T=e;T<r;T+=e)v=t[T],w=t[T+1],v<c&&(c=v),w<d&&(d=w),v>p&&(p=v),w>g&&(g=w);_=Math.max(p-c,g-d),_=_!==0?32767/_:0}return er(n,l,e,c,d,_,0),l}function Io(t,i,e,s,r){var n,l;if(r===ha(t,i,e,s)>0)for(n=i;n<e;n+=s)l=zh(n,t[n],t[n+1],l);else for(n=e-s;n>=i;n-=s)l=zh(n,t[n],t[n+1],l);return l&&dn(l,l.next)&&(ir(l),l=l.next),l}function rs(t,i){if(!t)return t;i||(i=t);var e=t,s;do if(s=!1,!e.steiner&&(dn(e,e.next)||be(e.prev,e,e.next)===0)){if(ir(e),e=i=e.prev,e===e.next)break;s=!0}else e=e.next;while(s||e!==i);return i}function er(t,i,e,s,r,n,l){if(t){!l&&n&&$u(t,s,r,n);for(var c=t,d,p;t.prev!==t.next;){if(d=t.prev,p=t.next,n?zu(t,s,r,n):Uu(t)){i.push(d.i/e|0),i.push(t.i/e|0),i.push(p.i/e|0),ir(t),t=p.next,c=p.next;continue}if(t=p,t===c){l?l===1?(t=Lu(rs(t),i,e),er(t,i,e,s,r,n,2)):l===2&&ku(t,i,e,s,r,n):er(rs(t),i,e,s,r,n,1);break}}}}function Uu(t){var i=t.prev,e=t,s=t.next;if(be(i,e,s)>=0)return!1;for(var r=i.x,n=e.x,l=s.x,c=i.y,d=e.y,p=s.y,g=r<n?r<l?r:l:n<l?n:l,v=c<d?c<p?c:p:d<p?d:p,w=r>n?r>l?r:l:n>l?n:l,_=c>d?c>p?c:p:d>p?d:p,T=s.next;T!==i;){if(T.x>=g&&T.x<=w&&T.y>=v&&T.y<=_&&fs(r,c,n,d,l,p,T.x,T.y)&&be(T.prev,T,T.next)>=0)return!1;T=T.next}return!0}function zu(t,i,e,s){var r=t.prev,n=t,l=t.next;if(be(r,n,l)>=0)return!1;for(var c=r.x,d=n.x,p=l.x,g=r.y,v=n.y,w=l.y,_=c<d?c<p?c:p:d<p?d:p,T=g<v?g<w?g:w:v<w?v:w,E=c>d?c>p?c:p:d>p?d:p,A=g>v?g>w?g:w:v>w?v:w,R=na(_,T,i,e,s),U=na(E,A,i,e,s),C=t.prevZ,I=t.nextZ;C&&C.z>=R&&I&&I.z<=U;){if(C.x>=_&&C.x<=E&&C.y>=T&&C.y<=A&&C!==r&&C!==l&&fs(c,g,d,v,p,w,C.x,C.y)&&be(C.prev,C,C.next)>=0||(C=C.prevZ,I.x>=_&&I.x<=E&&I.y>=T&&I.y<=A&&I!==r&&I!==l&&fs(c,g,d,v,p,w,I.x,I.y)&&be(I.prev,I,I.next)>=0))return!1;I=I.nextZ}for(;C&&C.z>=R;){if(C.x>=_&&C.x<=E&&C.y>=T&&C.y<=A&&C!==r&&C!==l&&fs(c,g,d,v,p,w,C.x,C.y)&&be(C.prev,C,C.next)>=0)return!1;C=C.prevZ}for(;I&&I.z<=U;){if(I.x>=_&&I.x<=E&&I.y>=T&&I.y<=A&&I!==r&&I!==l&&fs(c,g,d,v,p,w,I.x,I.y)&&be(I.prev,I,I.next)>=0)return!1;I=I.nextZ}return!0}function Lu(t,i,e){var s=t;do{var r=s.prev,n=s.next.next;!dn(r,n)&&Uo(r,s,s.next,n)&&tr(r,n)&&tr(n,r)&&(i.push(r.i/e|0),i.push(s.i/e|0),i.push(n.i/e|0),ir(s),ir(s.next),s=t=n),s=s.next}while(s!==t);return rs(s)}function ku(t,i,e,s,r,n){var l=t;do{for(var c=l.next.next;c!==l.prev;){if(l.i!==c.i&&ju(l,c)){var d=zo(l,c);l=rs(l,l.next),d=rs(d,d.next),er(l,i,e,s,r,n,0),er(d,i,e,s,r,n,0);return}c=c.next}l=l.next}while(l!==t)}function Ou(t,i,e,s){var r=[],n,l,c,d,p;for(n=0,l=i.length;n<l;n++)c=i[n]*s,d=n<l-1?i[n+1]*s:t.length,p=Io(t,c,d,s,!1),p===p.next&&(p.steiner=!0),r.push(Hu(p));for(r.sort(Bu),n=0;n<r.length;n++)e=Nu(r[n],e);return e}function Bu(t,i){return t.x-i.x}function Nu(t,i){var e=Du(t,i);if(!e)return i;var s=zo(e,t);return rs(s,s.next),rs(e,e.next)}function Du(t,i){var e=i,s=t.x,r=t.y,n=-1/0,l;do{if(r<=e.y&&r>=e.next.y&&e.next.y!==e.y){var c=e.x+(r-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(c<=s&&c>n&&(n=c,l=e.x<e.next.x?e:e.next,c===s))return l}e=e.next}while(e!==i);if(!l)return null;var d=l,p=l.x,g=l.y,v=1/0,w;e=l;do s>=e.x&&e.x>=p&&s!==e.x&&fs(r<g?s:n,r,p,g,r<g?n:s,r,e.x,e.y)&&(w=Math.abs(r-e.y)/(s-e.x),tr(e,t)&&(w<v||w===v&&(e.x>l.x||e.x===l.x&&Gu(l,e)))&&(l=e,v=w)),e=e.next;while(e!==d);return l}function Gu(t,i){return be(t.prev,t,i.prev)<0&&be(i.next,t,t.next)<0}function $u(t,i,e,s){var r=t;do r.z===0&&(r.z=na(r.x,r.y,i,e,s)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next;while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,Vu(r)}function Vu(t){var i,e,s,r,n,l,c,d,p=1;do{for(e=t,t=null,n=null,l=0;e;){for(l++,s=e,c=0,i=0;i<p&&(c++,s=s.nextZ,!!s);i++);for(d=p;c>0||d>0&&s;)c!==0&&(d===0||!s||e.z<=s.z)?(r=e,e=e.nextZ,c--):(r=s,s=s.nextZ,d--),n?n.nextZ=r:t=r,r.prevZ=n,n=r;e=s}n.nextZ=null,p*=2}while(l>1);return t}function na(t,i,e,s,r){return t=(t-e)*r|0,i=(i-s)*r|0,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,i=(i|i<<8)&16711935,i=(i|i<<4)&252645135,i=(i|i<<2)&858993459,i=(i|i<<1)&1431655765,t|i<<1}function Hu(t){var i=t,e=t;do(i.x<e.x||i.x===e.x&&i.y<e.y)&&(e=i),i=i.next;while(i!==t);return e}function fs(t,i,e,s,r,n,l,c){return(r-l)*(i-c)>=(t-l)*(n-c)&&(t-l)*(s-c)>=(e-l)*(i-c)&&(e-l)*(n-c)>=(r-l)*(s-c)}function ju(t,i){return t.next.i!==i.i&&t.prev.i!==i.i&&!qu(t,i)&&(tr(t,i)&&tr(i,t)&&Zu(t,i)&&(be(t.prev,t,i.prev)||be(t,i.prev,i))||dn(t,i)&&be(t.prev,t,t.next)>0&&be(i.prev,i,i.next)>0)}function be(t,i,e){return(i.y-t.y)*(e.x-i.x)-(i.x-t.x)*(e.y-i.y)}function dn(t,i){return t.x===i.x&&t.y===i.y}function Uo(t,i,e,s){var r=jr(be(t,i,e)),n=jr(be(t,i,s)),l=jr(be(e,s,t)),c=jr(be(e,s,i));return!!(r!==n&&l!==c||r===0&&Hr(t,e,i)||n===0&&Hr(t,s,i)||l===0&&Hr(e,t,s)||c===0&&Hr(e,i,s))}function Hr(t,i,e){return i.x<=Math.max(t.x,e.x)&&i.x>=Math.min(t.x,e.x)&&i.y<=Math.max(t.y,e.y)&&i.y>=Math.min(t.y,e.y)}function jr(t){return t>0?1:t<0?-1:0}function qu(t,i){var e=t;do{if(e.i!==t.i&&e.next.i!==t.i&&e.i!==i.i&&e.next.i!==i.i&&Uo(e,e.next,t,i))return!0;e=e.next}while(e!==t);return!1}function tr(t,i){return be(t.prev,t,t.next)<0?be(t,i,t.next)>=0&&be(t,t.prev,i)>=0:be(t,i,t.prev)<0||be(t,t.next,i)<0}function Zu(t,i){var e=t,s=!1,r=(t.x+i.x)/2,n=(t.y+i.y)/2;do e.y>n!=e.next.y>n&&e.next.y!==e.y&&r<(e.next.x-e.x)*(n-e.y)/(e.next.y-e.y)+e.x&&(s=!s),e=e.next;while(e!==t);return s}function zo(t,i){var e=new aa(t.i,t.x,t.y),s=new aa(i.i,i.x,i.y),r=t.next,n=i.prev;return t.next=i,i.prev=t,e.next=r,r.prev=e,s.next=e,e.prev=s,n.next=s,s.prev=n,s}function zh(t,i,e,s){var r=new aa(t,i,e);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function ir(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function aa(t,i,e){this.i=t,this.x=i,this.y=e,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}fn.deviation=function(t,i,e,s){var r=i&&i.length,n=r?i[0]*e:t.length,l=Math.abs(ha(t,0,n,e));if(r)for(var c=0,d=i.length;c<d;c++){var p=i[c]*e,g=c<d-1?i[c+1]*e:t.length;l-=Math.abs(ha(t,p,g,e))}var v=0;for(c=0;c<s.length;c+=3){var w=s[c]*e,_=s[c+1]*e,T=s[c+2]*e;v+=Math.abs((t[w]-t[T])*(t[_+1]-t[w+1])-(t[w]-t[_])*(t[T+1]-t[w+1]))}return l===0&&v===0?0:Math.abs((v-l)/l)};function ha(t,i,e,s){for(var r=0,n=i,l=e-s;n<e;n+=s)r+=(t[l]-t[n])*(t[n+1]+t[l+1]),l=n;return r}fn.flatten=function(t){for(var i=t[0][0].length,e={vertices:[],holes:[],dimensions:i},s=0,r=0;r<t.length;r++){for(var n=0;n<t[r].length;n++)for(var l=0;l<i;l++)e.vertices.push(t[r][n][l]);r>0&&(s+=t[r-1].length,e.holes.push(s))}return e};var Wu=pa.exports;const qr=Yh(Wu);var Zr,Hn,oa;function ga(t,i){if(!Zr)Zr=i;else if(!Hn)Hn=i;else{var e="var sharedChunk = {}; ("+Zr+")(sharedChunk); ("+Hn+")(sharedChunk);",s={};Zr(s),oa=i(s),typeof window<"u"&&oa.setWorkerUrl(window.URL.createObjectURL(new Blob([e],{type:"text/javascript"})))}}ga(["exports"],function(t){function i(u,a,h){if(!u.length)return h(null,[]);let f=u.length;const m=new Array(u.length);let x=null;u.forEach((b,M)=>{a(b,(z,D)=>{z&&(x=z),m[M]=D,--f===0&&h(x,m)})})}function e(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}const s={};function r(u){s[u]||(typeof console<"u"&&console.warn(u),s[u]=!0)}function n(u){return typeof ImageBitmap<"u"&&u instanceof ImageBitmap}function l(u){return u&&typeof ArrayBuffer<"u"&&(u instanceof ArrayBuffer||u.constructor&&u.constructor.name==="ArrayBuffer")}let c=null;function d(u){if(c==null){const a=u.navigator?u.navigator.userAgent:null;c=!!u.safari||!!(a&&(/\b(iPad|iPhone|iPod)\b/.test(a)||a.match("Safari")&&!a.match("Chrome")))}return c}function p(){}const g={};function v(u="id"){g[u]=g[u]??0;const a=g[u]++;return`${u}-${a}`}function w(u){return Object.prototype.toString.call(u).slice(8,-1).toLowerCase()}function _(u){return w(u)==="function"}const T=e()?()=>self.worker&&self.worker.referrer:()=>(window.location.protocol==="blob:"?window.parent:window).location.href;function E(u,a){const h=new Blob([new Uint8Array(u)],{type:"image/png"});createImageBitmap(h).then(f=>{a(null,f)}).catch(f=>{a(new Error(`Could not load image because of ${f.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}const A="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function R(u,a){const h=new Image;h.onload=()=>{a(null,h),URL.revokeObjectURL(h.src),h.onload=null,window.requestAnimationFrame(()=>{h.src=A})},h.onerror=()=>a(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const f=new Blob([new Uint8Array(u)],{type:"image/png"});h.src=u.byteLength?URL.createObjectURL(f):A}function U(u,a){const{height:h,width:f}=a,m=[];for(let x=0;x<h;x++){const b=x*f,M=b+f;m.push(u.slice(b,M))}return m}function C(u){return u.split(",").map(f=>{const m=f.split(":");return{[m[0]]:isNaN(parseFloat(m[1]))?m[1]:parseFloat(m[1])}}).reduce((f,m)=>Object.assign({},f,m),{})}var I=Object.freeze({__proto__:null,arrayBufferToImage:R,arrayBufferToImageBitmap:E,asyncAll:i,getReferrer:T,isArrayBuffer:l,isFunction:_,isImageBitmap:n,isSafari:d,isWorker:e,nullFunction:p,parseMetedata:C,typeOf:w,uid:v,unflatten:U,warnOnce:r});function O(u,a,h){return a in u?Object.defineProperty(u,a,{value:h,enumerable:!0,configurable:!0,writable:!0}):u[a]=h,u}var V=typeof self<"u"?self:global;const Q=typeof navigator<"u",X=Q&&typeof HTMLImageElement>"u",se=!(typeof global>"u"||typeof process>"u"||!process.versions||!process.versions.node),ie=V.Buffer,W=V.BigInt,oe=!!ie,le=u=>_e(u)?void 0:u,q=u=>u!==void 0;function _e(u){return u===void 0||(u instanceof Map?u.size===0:Object.values(u).filter(q).length===0)}function Y(u){let a=new Error(u);throw delete a.stack,a}function me(u){return(u=function(a){for(;a.endsWith("\0");)a=a.slice(0,-1);return a}(u).trim())===""?void 0:u}function Ke(u){let a=function(h){let f=0;return h.ifd0.enabled&&(f+=1024),h.exif.enabled&&(f+=2048),h.makerNote&&(f+=2048),h.userComment&&(f+=1024),h.gps.enabled&&(f+=512),h.interop.enabled&&(f+=100),h.ifd1.enabled&&(f+=1024),f+2048}(u);return u.jfif.enabled&&(a+=50),u.xmp.enabled&&(a+=2e4),u.iptc.enabled&&(a+=14e3),u.icc.enabled&&(a+=6e3),a}const Zt=u=>String.fromCharCode.apply(null,u),Te=typeof TextDecoder<"u"?new TextDecoder("utf-8"):void 0;function Hs(u){return Te?Te.decode(u):oe?Buffer.from(u).toString("utf8"):decodeURIComponent(escape(Zt(u)))}class Ce{static from(a,h){return a instanceof this&&a.le===h?a:new Ce(a,void 0,void 0,h)}constructor(a,h=0,f,m){if(typeof m=="boolean"&&(this.le=m),Array.isArray(a)&&(a=new Uint8Array(a)),a===0)this.byteOffset=0,this.byteLength=0;else if(a instanceof ArrayBuffer){f===void 0&&(f=a.byteLength-h);let x=new DataView(a,h,f);this._swapDataView(x)}else if(a instanceof Uint8Array||a instanceof DataView||a instanceof Ce){f===void 0&&(f=a.byteLength-h),(h+=a.byteOffset)+f>a.byteOffset+a.byteLength&&Y("Creating view outside of available memory in ArrayBuffer");let x=new DataView(a.buffer,h,f);this._swapDataView(x)}else if(typeof a=="number"){let x=new DataView(new ArrayBuffer(a));this._swapDataView(x)}else Y("Invalid input argument for BufferView: "+a)}_swapArrayBuffer(a){this._swapDataView(new DataView(a))}_swapBuffer(a){this._swapDataView(new DataView(a.buffer,a.byteOffset,a.byteLength))}_swapDataView(a){this.dataView=a,this.buffer=a.buffer,this.byteOffset=a.byteOffset,this.byteLength=a.byteLength}_lengthToEnd(a){return this.byteLength-a}set(a,h,f=Ce){return a instanceof DataView||a instanceof Ce?a=new Uint8Array(a.buffer,a.byteOffset,a.byteLength):a instanceof ArrayBuffer&&(a=new Uint8Array(a)),a instanceof Uint8Array||Y("BufferView.set(): Invalid data argument."),this.toUint8().set(a,h),new f(this,h,a.byteLength)}subarray(a,h){return h=h||this._lengthToEnd(a),new Ce(this,a,h)}toUint8(){return new Uint8Array(this.buffer,this.byteOffset,this.byteLength)}getUint8Array(a,h){return new Uint8Array(this.buffer,this.byteOffset+a,h)}getString(a=0,h=this.byteLength){return Hs(this.getUint8Array(a,h))}getLatin1String(a=0,h=this.byteLength){let f=this.getUint8Array(a,h);return Zt(f)}getUnicodeString(a=0,h=this.byteLength){const f=[];for(let m=0;m<h&&a+m<this.byteLength;m+=2)f.push(this.getUint16(a+m));return Zt(f)}getInt8(a){return this.dataView.getInt8(a)}getUint8(a){return this.dataView.getUint8(a)}getInt16(a,h=this.le){return this.dataView.getInt16(a,h)}getInt32(a,h=this.le){return this.dataView.getInt32(a,h)}getUint16(a,h=this.le){return this.dataView.getUint16(a,h)}getUint32(a,h=this.le){return this.dataView.getUint32(a,h)}getFloat32(a,h=this.le){return this.dataView.getFloat32(a,h)}getFloat64(a,h=this.le){return this.dataView.getFloat64(a,h)}getFloat(a,h=this.le){return this.dataView.getFloat32(a,h)}getDouble(a,h=this.le){return this.dataView.getFloat64(a,h)}getUintBytes(a,h,f){switch(h){case 1:return this.getUint8(a,f);case 2:return this.getUint16(a,f);case 4:return this.getUint32(a,f);case 8:return this.getUint64&&this.getUint64(a,f)}}getUint(a,h,f){switch(h){case 8:return this.getUint8(a,f);case 16:return this.getUint16(a,f);case 32:return this.getUint32(a,f);case 64:return this.getUint64&&this.getUint64(a,f)}}toString(a){return this.dataView.toString(a,this.constructor.name)}ensureChunk(){}}function nt(u,a){Y(`${u} '${a}' was not loaded, try using full build of exifr.`)}class js extends Map{constructor(a){super(),this.kind=a}get(a,h){return this.has(a)||nt(this.kind,a),h&&(a in h||function(f,m){Y(`Unknown ${f} '${m}'.`)}(this.kind,a),h[a].enabled||nt(this.kind,a)),super.get(a)}keyList(){return Array.from(this.keys())}}var Dt=new js("file parser"),at=new js("segment parser"),Mr=new js("file reader");let ba=V.fetch;function wa(u,a){return(h=u).startsWith("data:")||h.length>1e4?mn(u,a,"base64"):se&&u.includes("://")?gn(u,a,"url",vn):se?mn(u,a,"fs"):Q?gn(u,a,"url",vn):void Y("Invalid input argument");var h}async function gn(u,a,h,f){return Mr.has(h)?mn(u,a,h):f?async function(m,x){let b=await x(m);return new Ce(b)}(u,f):void Y(`Parser ${h} is not loaded`)}async function mn(u,a,h){let f=new(Mr.get(h))(u,a);return await f.read(),f}const vn=u=>ba(u).then(a=>a.arrayBuffer()),xn=u=>new Promise((a,h)=>{let f=new FileReader;f.onloadend=()=>a(f.result||new ArrayBuffer),f.onerror=h,f.readAsArrayBuffer(u)});class Do extends Map{get tagKeys(){return this.allKeys||(this.allKeys=Array.from(this.keys())),this.allKeys}get tagValues(){return this.allValues||(this.allValues=Array.from(this.values())),this.allValues}}function Wt(u,a,h){let f=new Do;for(let[m,x]of h)f.set(m,x);if(Array.isArray(a))for(let m of a)u.set(m,f);else u.set(a,f);return f}const as=new Map,yn=new Map,Ar=new Map,Er=["chunked","firstChunkSize","firstChunkSizeNode","firstChunkSizeBrowser","chunkSize","chunkLimit"],_a=["jfif","xmp","icc","iptc","ihdr"],bn=["tiff",..._a],Ae=["ifd0","ifd1","exif","gps","interop"],Sr=[...bn,...Ae],Rr=["makerNote","userComment"],Ta=["translateKeys","translateValues","reviveValues","multiSegment"],Cr=[...Ta,"sanitize","mergeOutput","silentErrors"];class Ma{get translate(){return this.translateKeys||this.translateValues||this.reviveValues}}class qs extends Ma{get needed(){return this.enabled||this.deps.size>0}constructor(a,h,f,m){if(super(),O(this,"enabled",!1),O(this,"skip",new Set),O(this,"pick",new Set),O(this,"deps",new Set),O(this,"translateKeys",!1),O(this,"translateValues",!1),O(this,"reviveValues",!1),this.key=a,this.enabled=h,this.parse=this.enabled,this.applyInheritables(m),this.canBeFiltered=Ae.includes(a),this.canBeFiltered&&(this.dict=as.get(a)),f!==void 0)if(Array.isArray(f))this.parse=this.enabled=!0,this.canBeFiltered&&f.length>0&&this.translateTagSet(f,this.pick);else if(typeof f=="object"){if(this.enabled=!0,this.parse=f.parse!==!1,this.canBeFiltered){let{pick:x,skip:b}=f;x&&x.length>0&&this.translateTagSet(x,this.pick),b&&b.length>0&&this.translateTagSet(b,this.skip)}this.applyInheritables(f)}else f===!0||f===!1?this.parse=this.enabled=f:Y(`Invalid options argument: ${f}`)}applyInheritables(a){let h,f;for(h of Ta)f=a[h],f!==void 0&&(this[h]=f)}translateTagSet(a,h){if(this.dict){let f,m,{tagKeys:x,tagValues:b}=this.dict;for(f of a)typeof f=="string"?(m=b.indexOf(f),m===-1&&(m=x.indexOf(Number(f))),m!==-1&&h.add(Number(x[m]))):h.add(f)}else for(let f of a)h.add(f)}finalizeFilters(){!this.enabled&&this.deps.size>0?(this.enabled=!0,Fr(this.pick,this.deps)):this.enabled&&this.pick.size>0&&Fr(this.pick,this.deps)}}var Be={jfif:!1,tiff:!0,xmp:!1,icc:!1,iptc:!1,ifd0:!0,ifd1:!1,exif:!0,gps:!0,interop:!1,ihdr:void 0,makerNote:!1,userComment:!1,multiSegment:!1,skip:[],pick:[],translateKeys:!0,translateValues:!0,reviveValues:!0,sanitize:!0,mergeOutput:!0,silentErrors:!0,chunked:!0,firstChunkSize:void 0,firstChunkSizeNode:512,firstChunkSizeBrowser:65536,chunkSize:65536,chunkLimit:5},Aa=new Map;class wn extends Ma{static useCached(a){let h=Aa.get(a);return h!==void 0||(h=new this(a),Aa.set(a,h)),h}constructor(a){super(),a===!0?this.setupFromTrue():a===void 0?this.setupFromUndefined():Array.isArray(a)?this.setupFromArray(a):typeof a=="object"?this.setupFromObject(a):Y(`Invalid options argument ${a}`),this.firstChunkSize===void 0&&(this.firstChunkSize=Q?this.firstChunkSizeBrowser:this.firstChunkSizeNode),this.mergeOutput&&(this.ifd1.enabled=!1),this.filterNestedSegmentTags(),this.traverseTiffDependencyTree(),this.checkLoadedPlugins()}setupFromUndefined(){let a;for(a of Er)this[a]=Be[a];for(a of Cr)this[a]=Be[a];for(a of Rr)this[a]=Be[a];for(a of Sr)this[a]=new qs(a,Be[a],void 0,this)}setupFromTrue(){let a;for(a of Er)this[a]=Be[a];for(a of Cr)this[a]=Be[a];for(a of Rr)this[a]=!0;for(a of Sr)this[a]=new qs(a,!0,void 0,this)}setupFromArray(a){let h;for(h of Er)this[h]=Be[h];for(h of Cr)this[h]=Be[h];for(h of Rr)this[h]=Be[h];for(h of Sr)this[h]=new qs(h,!1,void 0,this);this.setupGlobalFilters(a,void 0,Ae)}setupFromObject(a){let h;for(h of(Ae.ifd0=Ae.ifd0||Ae.image,Ae.ifd1=Ae.ifd1||Ae.thumbnail,Object.assign(this,a),Er))this[h]=_n(a[h],Be[h]);for(h of Cr)this[h]=_n(a[h],Be[h]);for(h of Rr)this[h]=_n(a[h],Be[h]);for(h of bn)this[h]=new qs(h,Be[h],a[h],this);for(h of Ae)this[h]=new qs(h,Be[h],a[h],this.tiff);this.setupGlobalFilters(a.pick,a.skip,Ae,Sr),a.tiff===!0?this.batchEnableWithBool(Ae,!0):a.tiff===!1?this.batchEnableWithUserValue(Ae,a):Array.isArray(a.tiff)?this.setupGlobalFilters(a.tiff,void 0,Ae):typeof a.tiff=="object"&&this.setupGlobalFilters(a.tiff.pick,a.tiff.skip,Ae)}batchEnableWithBool(a,h){for(let f of a)this[f].enabled=h}batchEnableWithUserValue(a,h){for(let f of a){let m=h[f];this[f].enabled=m!==!1&&m!==void 0}}setupGlobalFilters(a,h,f,m=f){if(a&&a.length){for(let b of m)this[b].enabled=!1;let x=Ea(a,f);for(let[b,M]of x)Fr(this[b].pick,M),this[b].enabled=!0}else if(h&&h.length){let x=Ea(h,f);for(let[b,M]of x)Fr(this[b].skip,M)}}filterNestedSegmentTags(){let{ifd0:a,exif:h,xmp:f,iptc:m,icc:x}=this;this.makerNote?h.deps.add(37500):h.skip.add(37500),this.userComment?h.deps.add(37510):h.skip.add(37510),f.enabled||a.skip.add(700),m.enabled||a.skip.add(33723),x.enabled||a.skip.add(34675)}traverseTiffDependencyTree(){let{ifd0:a,exif:h,gps:f,interop:m}=this;m.needed&&(h.deps.add(40965),a.deps.add(40965)),h.needed&&a.deps.add(34665),f.needed&&a.deps.add(34853),this.tiff.enabled=Ae.some(x=>this[x].enabled===!0)||this.makerNote||this.userComment;for(let x of Ae)this[x].finalizeFilters()}get onlyTiff(){return!_a.map(a=>this[a].enabled).some(a=>a===!0)&&this.tiff.enabled}checkLoadedPlugins(){for(let a of bn)this[a].enabled&&!at.has(a)&&nt("segment parser",a)}}function Ea(u,a){let h,f,m,x,b=[];for(m of a){for(x of(h=as.get(m),f=[],h))(u.includes(x[0])||u.includes(x[1]))&&f.push(x[0]);f.length&&b.push([m,f])}return b}function _n(u,a){return u!==void 0?u:a!==void 0?a:void 0}function Fr(u,a){for(let h of a)u.add(h)}O(wn,"default",Be);class Go{constructor(a){O(this,"parsers",{}),O(this,"output",{}),O(this,"errors",[]),O(this,"pushToErrors",h=>this.errors.push(h)),this.options=wn.useCached(a)}async read(a){this.file=await function(h,f){return typeof h=="string"?wa(h,f):Q&&!X&&h instanceof HTMLImageElement?wa(h.src,f):h instanceof Uint8Array||h instanceof ArrayBuffer||h instanceof DataView?new Ce(h):Q&&h instanceof Blob?gn(h,f,"blob",xn):void Y("Invalid input argument")}(a,this.options)}setup(){if(this.fileParser)return;let{file:a}=this,h=a.getUint16(0);for(let[f,m]of Dt)if(m.canHandle(a,h))return this.fileParser=new m(this.options,this.file,this.parsers),a[f]=!0;this.file.close&&this.file.close(),Y("Unknown file format")}async parse(){let{output:a,errors:h}=this;return this.setup(),this.options.silentErrors?(await this.executeParsers().catch(this.pushToErrors),h.push(...this.fileParser.errors)):await this.executeParsers(),this.file.close&&this.file.close(),this.options.silentErrors&&h.length>0&&(a.errors=h),le(a)}async executeParsers(){let{output:a}=this;await this.fileParser.parse();let h=Object.values(this.parsers).map(async f=>{let m=await f.parse();f.assignToOutput(a,m)});this.options.silentErrors&&(h=h.map(f=>f.catch(this.pushToErrors))),await Promise.all(h)}async extractThumbnail(){this.setup();let{options:a,file:h}=this,f=at.get("tiff",a);var m;if(h.tiff?m={start:0,type:"tiff"}:h.jpeg&&(m=await this.fileParser.getOrFindSegment("tiff")),m===void 0)return;let x=await this.fileParser.ensureSegmentChunk(m),b=this.parsers.tiff=new f(x,a,h),M=await b.extractThumbnail();return h.close&&h.close(),M}}async function $o(u,a){let h=new Go(a);return await h.read(u),h.parse()}class Sa{constructor(a,h,f){O(this,"errors",[]),O(this,"ensureSegmentChunk",async m=>{let x=m.start,b=m.size||65536;if(this.file.chunked)if(this.file.available(x,b))m.chunk=this.file.subarray(x,b);else try{m.chunk=await this.file.readChunk(x,b)}catch(M){Y(`Couldn't read segment: ${JSON.stringify(m)}. ${M.message}`)}else this.file.byteLength>x+b?m.chunk=this.file.subarray(x,b):m.size===void 0?m.chunk=this.file.subarray(x):Y("Segment unreachable: "+JSON.stringify(m));return m.chunk}),this.extendOptions&&this.extendOptions(a),this.options=a,this.file=h,this.parsers=f}injectSegment(a,h){this.options[a].enabled&&this.createParser(a,h)}createParser(a,h){let f=new(at.get(a))(h,this.options,this.file);return this.parsers[a]=f}createParsers(a){for(let h of a){let{type:f,chunk:m}=h,x=this.options[f];if(x&&x.enabled){let b=this.parsers[f];b&&b.append||b||this.createParser(f,m)}}}async readSegments(a){let h=a.map(this.ensureSegmentChunk);await Promise.all(h)}}class zi{static findPosition(a,h){let f=a.getUint16(h+2)+2,m=typeof this.headerLength=="function"?this.headerLength(a,h,f):this.headerLength,x=h+m,b=f-m;return{offset:h,length:f,headerLength:m,start:x,size:b,end:x+b}}static parse(a,h={}){return new this(a,new wn({[this.type]:h}),a).parse()}normalizeInput(a){return a instanceof Ce?a:new Ce(a)}constructor(a,h={},f){O(this,"errors",[]),O(this,"raw",new Map),O(this,"handleError",m=>{if(!this.options.silentErrors)throw m;this.errors.push(m.message)}),this.chunk=this.normalizeInput(a),this.file=f,this.type=this.constructor.type,this.globalOptions=this.options=h,this.localOptions=h[this.type],this.canTranslate=this.localOptions&&this.localOptions.translate}translate(){this.canTranslate&&(this.translated=this.translateBlock(this.raw,this.type))}get output(){return this.translated?this.translated:this.raw?Object.fromEntries(this.raw):void 0}translateBlock(a,h){let f=Ar.get(h),m=yn.get(h),x=as.get(h),b=this.options[h],M=b.reviveValues&&!!f,z=b.translateValues&&!!m,D=b.translateKeys&&!!x,F={};for(let[B,L]of a)M&&f.has(B)?L=f.get(B)(L):z&&m.has(B)&&(L=this.translateValue(L,m.get(B))),D&&x.has(B)&&(B=x.get(B)||B),F[B]=L;return F}translateValue(a,h){return h[a]||h.DEFAULT||a}assignToOutput(a,h){this.assignObjectToOutput(a,this.constructor.type,h)}assignObjectToOutput(a,h,f){if(this.globalOptions.mergeOutput)return Object.assign(a,f);a[h]?Object.assign(a[h],f):a[h]=f}}O(zi,"headerLength",4),O(zi,"type",void 0),O(zi,"multiSegment",!1),O(zi,"canHandle",()=>!1);function Vo(u){return u===192||u===194||u===196||u===219||u===221||u===218||u===254}function Ho(u){return u>=224&&u<=239}function jo(u,a,h){for(let[f,m]of at)if(m.canHandle(u,a,h))return f}class Ra extends Sa{constructor(...a){super(...a),O(this,"appSegments",[]),O(this,"jpegSegments",[]),O(this,"unknownSegments",[])}static canHandle(a,h){return h===65496}async parse(){await this.findAppSegments(),await this.readSegments(this.appSegments),this.mergeMultiSegments(),this.createParsers(this.mergedAppSegments||this.appSegments)}setupSegmentFinderArgs(a){a===!0?(this.findAll=!0,this.wanted=new Set(at.keyList())):(a=a===void 0?at.keyList().filter(h=>this.options[h].enabled):a.filter(h=>this.options[h].enabled&&at.has(h)),this.findAll=!1,this.remaining=new Set(a),this.wanted=new Set(a)),this.unfinishedMultiSegment=!1}async findAppSegments(a=0,h){this.setupSegmentFinderArgs(h);let{file:f,findAll:m,wanted:x,remaining:b}=this;if(!m&&this.file.chunked&&(m=Array.from(x).some(M=>{let z=at.get(M),D=this.options[M];return z.multiSegment&&D.multiSegment}),m&&await this.file.readWhole()),a=this.findAppSegmentsInRange(a,f.byteLength),!this.options.onlyTiff&&f.chunked){let M=!1;for(;b.size>0&&!M&&(f.canReadNextChunk||this.unfinishedMultiSegment);){let{nextChunkOffset:z}=f,D=this.appSegments.some(F=>!this.file.available(F.offset||F.start,F.length||F.size));if(M=a>z&&!D?!await f.readNextChunk(a):!await f.readNextChunk(z),(a=this.findAppSegmentsInRange(a,f.byteLength))===void 0)return}}}findAppSegmentsInRange(a,h){h-=2;let f,m,x,b,M,z,{file:D,findAll:F,wanted:B,remaining:L,options:P}=this;for(;a<h;a++)if(D.getUint8(a)===255){if(f=D.getUint8(a+1),Ho(f)){if(m=D.getUint16(a+2),x=jo(D,a,m),x&&B.has(x)&&(b=at.get(x),M=b.findPosition(D,a),z=P[x],M.type=x,this.appSegments.push(M),!F&&(b.multiSegment&&z.multiSegment?(this.unfinishedMultiSegment=M.chunkNumber<M.chunkCount,this.unfinishedMultiSegment||L.delete(x)):L.delete(x),L.size===0)))break;P.recordUnknownSegments&&(M=zi.findPosition(D,a),M.marker=f,this.unknownSegments.push(M)),a+=m+1}else if(Vo(f)){if(m=D.getUint16(a+2),f===218&&P.stopAfterSos!==!1)return;P.recordJpegSegments&&this.jpegSegments.push({offset:a,length:m,marker:f}),a+=m+1}}return a}mergeMultiSegments(){if(!this.appSegments.some(h=>h.multiSegment))return;let a=function(h,f){let m,x,b,M=new Map;for(let z=0;z<h.length;z++)m=h[z],x=m[f],M.has(x)?b=M.get(x):M.set(x,b=[]),b.push(m);return Array.from(M)}(this.appSegments,"type");this.mergedAppSegments=a.map(([h,f])=>{let m=at.get(h,this.options);return m.handleMultiSegments?{type:h,chunk:m.handleMultiSegments(f)}:f[0]})}getSegment(a){return this.appSegments.find(h=>h.type===a)}async getOrFindSegment(a){let h=this.getSegment(a);return h===void 0&&(await this.findAppSegments(0,[a]),h=this.getSegment(a)),h}}O(Ra,"type","jpeg"),Dt.set("jpeg",Ra);const qo=[void 0,1,1,2,4,8,1,1,2,4,8,4,8,4];class Zo extends zi{parseHeader(){var a=this.chunk.getUint16();a===18761?this.le=!0:a===19789&&(this.le=!1),this.chunk.le=this.le,this.headerParsed=!0}parseTags(a,h,f=new Map){let{pick:m,skip:x}=this.options[h];m=new Set(m);let b=m.size>0,M=x.size===0,z=this.chunk.getUint16(a);a+=2;for(let D=0;D<z;D++){let F=this.chunk.getUint16(a);if(b){if(m.has(F)&&(f.set(F,this.parseTag(a,F,h)),m.delete(F),m.size===0))break}else!M&&x.has(F)||f.set(F,this.parseTag(a,F,h));a+=12}return f}parseTag(a,h,f){let{chunk:m}=this,x=m.getUint16(a+2),b=m.getUint32(a+4),M=qo[x];if(M*b<=4?a+=8:a=m.getUint32(a+8),(x<1||x>13)&&Y(`Invalid TIFF value type. block: ${f.toUpperCase()}, tag: ${h.toString(16)}, type: ${x}, offset ${a}`),a>m.byteLength&&Y(`Invalid TIFF value offset. block: ${f.toUpperCase()}, tag: ${h.toString(16)}, type: ${x}, offset ${a} is outside of chunk size ${m.byteLength}`),x===1)return m.getUint8Array(a,b);if(x===2)return me(m.getString(a,b));if(x===7)return m.getUint8Array(a,b);if(b===1)return this.parseTagValue(x,a);{let z=new(function(F){switch(F){case 1:return Uint8Array;case 3:return Uint16Array;case 4:return Uint32Array;case 5:return Array;case 6:return Int8Array;case 8:return Int16Array;case 9:return Int32Array;case 10:return Array;case 11:return Float32Array;case 12:return Float64Array;default:return Array}}(x))(b),D=M;for(let F=0;F<b;F++)z[F]=this.parseTagValue(x,a),a+=D;return z}}parseTagValue(a,h){let{chunk:f}=this;switch(a){case 1:return f.getUint8(h);case 3:return f.getUint16(h);case 4:return f.getUint32(h);case 5:return f.getUint32(h)/f.getUint32(h+4);case 6:return f.getInt8(h);case 8:return f.getInt16(h);case 9:return f.getInt32(h);case 10:return f.getInt32(h)/f.getInt32(h+4);case 11:return f.getFloat(h);case 12:return f.getDouble(h);case 13:return f.getUint32(h);default:Y(`Invalid tiff type ${a}`)}}}class Tn extends Zo{static canHandle(a,h){return a.getUint8(h+1)===225&&a.getUint32(h+4)===1165519206&&a.getUint16(h+8)===0}async parse(){this.parseHeader();let{options:a}=this;return a.ifd0.enabled&&await this.parseIfd0Block(),a.exif.enabled&&await this.safeParse("parseExifBlock"),a.gps.enabled&&await this.safeParse("parseGpsBlock"),a.interop.enabled&&await this.safeParse("parseInteropBlock"),a.ifd1.enabled&&await this.safeParse("parseThumbnailBlock"),this.createOutput()}safeParse(a){let h=this[a]();return h.catch!==void 0&&(h=h.catch(this.handleError)),h}findIfd0Offset(){this.ifd0Offset===void 0&&(this.ifd0Offset=this.chunk.getUint32(4))}findIfd1Offset(){if(this.ifd1Offset===void 0){this.findIfd0Offset();let a=this.chunk.getUint16(this.ifd0Offset),h=this.ifd0Offset+2+12*a;this.ifd1Offset=this.chunk.getUint32(h)}}parseBlock(a,h){let f=new Map;return this[h]=f,this.parseTags(a,h,f),f}async parseIfd0Block(){if(this.ifd0)return;let{file:a}=this;this.findIfd0Offset(),this.ifd0Offset<8&&Y("Malformed EXIF data"),!a.chunked&&this.ifd0Offset>a.byteLength&&Y(`IFD0 offset points to outside of file.
this.ifd0Offset: ${this.ifd0Offset}, file.byteLength: ${a.byteLength}`),a.tiff&&await a.ensureChunk(this.ifd0Offset,Ke(this.options));let h=this.parseBlock(this.ifd0Offset,"ifd0");return h.size!==0?(this.exifOffset=h.get(34665),this.interopOffset=h.get(40965),this.gpsOffset=h.get(34853),this.xmp=h.get(700),this.iptc=h.get(33723),this.icc=h.get(34675),this.options.sanitize&&(h.delete(34665),h.delete(40965),h.delete(34853),h.delete(700),h.delete(33723),h.delete(34675)),h):void 0}async parseExifBlock(){if(this.exif||(this.ifd0||await this.parseIfd0Block(),this.exifOffset===void 0))return;this.file.tiff&&await this.file.ensureChunk(this.exifOffset,Ke(this.options));let a=this.parseBlock(this.exifOffset,"exif");return this.interopOffset||(this.interopOffset=a.get(40965)),this.makerNote=a.get(37500),this.userComment=a.get(37510),this.options.sanitize&&(a.delete(40965),a.delete(37500),a.delete(37510)),this.unpack(a,41728),this.unpack(a,41729),a}unpack(a,h){let f=a.get(h);f&&f.length===1&&a.set(h,f[0])}async parseGpsBlock(){if(this.gps||(this.ifd0||await this.parseIfd0Block(),this.gpsOffset===void 0))return;let a=this.parseBlock(this.gpsOffset,"gps");return a&&a.has(2)&&a.has(4)&&(a.set("latitude",Ca(...a.get(2),a.get(1))),a.set("longitude",Ca(...a.get(4),a.get(3)))),a}async parseInteropBlock(){if(!this.interop&&(this.ifd0||await this.parseIfd0Block(),this.interopOffset!==void 0||this.exif||await this.parseExifBlock(),this.interopOffset!==void 0))return this.parseBlock(this.interopOffset,"interop")}async parseThumbnailBlock(a=!1){if(!this.ifd1&&!this.ifd1Parsed&&(!this.options.mergeOutput||a))return this.findIfd1Offset(),this.ifd1Offset>0&&(this.parseBlock(this.ifd1Offset,"ifd1"),this.ifd1Parsed=!0),this.ifd1}async extractThumbnail(){if(this.headerParsed||this.parseHeader(),this.ifd1Parsed||await this.parseThumbnailBlock(!0),this.ifd1===void 0)return;let a=this.ifd1.get(513),h=this.ifd1.get(514);return this.chunk.getUint8Array(a,h)}get image(){return this.ifd0}get thumbnail(){return this.ifd1}createOutput(){let a,h,f,m={};for(h of Ae)if(a=this[h],!_e(a))if(f=this.canTranslate?this.translateBlock(a,h):Object.fromEntries(a),this.options.mergeOutput){if(h==="ifd1")continue;Object.assign(m,f)}else m[h]=f;return this.makerNote&&(m.makerNote=this.makerNote),this.userComment&&(m.userComment=this.userComment),m}assignToOutput(a,h){if(this.globalOptions.mergeOutput)Object.assign(a,h);else for(let[f,m]of Object.entries(h))this.assignObjectToOutput(a,f,m)}}function Ca(u,a,h,f){var m=u+a/60+h/3600;return f!=="S"&&f!=="W"||(m*=-1),m}O(Tn,"type","tiff"),O(Tn,"headerLength",10),at.set("tiff",Tn);const Mn={ifd0:!1,ifd1:!1,exif:!1,gps:!1,interop:!1,sanitize:!1,reviveValues:!0,translateKeys:!1,translateValues:!1,mergeOutput:!1};if(Object.assign({},Mn,{firstChunkSize:4e4,gps:[1,2,3,4]}),Object.assign({},Mn,{tiff:!1,ifd1:!0,mergeOutput:!1}),Object.assign({},Mn,{firstChunkSize:4e4,ifd0:[274]}),typeof navigator=="object"){let u=navigator.userAgent;u.includes("iPad")||u.includes("iPhone")?u.match(/OS (\d+)_(\d+)/):u.includes("OS X 10")&&u.match(/OS X 10[_.](\d+)/),u.includes("Chrome/")?u.match(/Chrome\/(\d+)/):u.includes("Firefox/")&&u.match(/Firefox\/(\d+)/)}class Wo extends Ce{constructor(...a){super(...a),O(this,"ranges",new Yo),this.byteLength!==0&&this.ranges.add(0,this.byteLength)}_tryExtend(a,h,f){if(a===0&&this.byteLength===0&&f){let m=new DataView(f.buffer||f,f.byteOffset,f.byteLength);this._swapDataView(m)}else{let m=a+h;if(m>this.byteLength){let{dataView:x}=this._extend(m);this._swapDataView(x)}}}_extend(a){let h;h=oe?ie.allocUnsafe(a):new Uint8Array(a);let f=new DataView(h.buffer,h.byteOffset,h.byteLength);return h.set(new Uint8Array(this.buffer,this.byteOffset,this.byteLength),0),{uintView:h,dataView:f}}subarray(a,h,f=!1){return h=h||this._lengthToEnd(a),f&&this._tryExtend(a,h),this.ranges.add(a,h),super.subarray(a,h)}set(a,h,f=!1){f&&this._tryExtend(h,a.byteLength,a);let m=super.set(a,h);return this.ranges.add(h,m.byteLength),m}async ensureChunk(a,h){this.chunked&&(this.ranges.available(a,h)||await this.readChunk(a,h))}available(a,h){return this.ranges.available(a,h)}}class Yo{constructor(){O(this,"list",[])}get length(){return this.list.length}add(a,h,f=0){let m=a+h,x=this.list.filter(b=>Fa(a,b.offset,m)||Fa(a,b.end,m));if(x.length>0){a=Math.min(a,...x.map(M=>M.offset)),m=Math.max(m,...x.map(M=>M.end)),h=m-a;let b=x.shift();b.offset=a,b.length=h,b.end=m,this.list=this.list.filter(M=>!x.includes(M))}else this.list.push({offset:a,length:h,end:m})}available(a,h){let f=a+h;return this.list.some(m=>m.offset<=a&&f<=m.end)}}function Fa(u,a,h){return u<=a&&a<=h}class Pa extends Wo{constructor(a,h){super(0),O(this,"chunksRead",0),this.input=a,this.options=h}async readWhole(){this.chunked=!1,await this.readChunk(this.nextChunkOffset)}async readChunked(){this.chunked=!0,await this.readChunk(0,this.options.firstChunkSize)}async readNextChunk(a=this.nextChunkOffset){if(this.fullyRead)return this.chunksRead++,!1;let h=this.options.chunkSize,f=await this.readChunk(a,h);return!!f&&f.byteLength===h}async readChunk(a,h){if(this.chunksRead++,(h=this.safeWrapAddress(a,h))!==0)return this._readChunk(a,h)}safeWrapAddress(a,h){return this.size!==void 0&&a+h>this.size?Math.max(0,this.size-a):h}get nextChunkOffset(){if(this.ranges.list.length!==0)return this.ranges.list[0].length}get canReadNextChunk(){return this.chunksRead<this.options.chunkLimit}get fullyRead(){return this.size!==void 0&&this.nextChunkOffset===this.size}read(){return this.options.chunked?this.readChunked():this.readWhole()}close(){}}Mr.set("blob",class extends Pa{async readWhole(){this.chunked=!1;let u=await xn(this.input);this._swapArrayBuffer(u)}readChunked(){return this.chunked=!0,this.size=this.input.size,super.readChunked()}async _readChunk(u,a){let h=a?u+a:void 0,f=this.input.slice(u,h),m=await xn(f);return this.set(m,u,!0)}}),Mr.set("url",class extends Pa{async readWhole(){this.chunked=!1;let u=await vn(this.input);u instanceof ArrayBuffer?this._swapArrayBuffer(u):u instanceof Uint8Array&&this._swapBuffer(u)}async _readChunk(u,a){let h=a?u+a-1:void 0,f=this.options.httpHeaders||{};(u||h)&&(f.range=`bytes=${[u,h].join("-")}`);let m=await ba(this.input,{headers:f}),x=await m.arrayBuffer(),b=x.byteLength;if(m.status!==416)return b!==a&&(this.size=u+b),this.set(x,u,!0)}}),Ce.prototype.getUint64=function(u){let a=this.getUint32(u),h=this.getUint32(u+4);return a<1048575?a<<32|h:typeof W!==void 0?(console.warn("Using BigInt because of type 64uint but JS can only handle 53b numbers."),W(a)<<W(32)|W(h)):void Y("Trying to read 64b value but JS can only handle 53b numbers.")};class Ko extends Sa{parseBoxes(a=0){let h=[];for(;a<this.file.byteLength-4;){let f=this.parseBoxHead(a);if(h.push(f),f.length===0)break;a+=f.length}return h}parseSubBoxes(a){a.boxes=this.parseBoxes(a.start)}findBox(a,h){return a.boxes===void 0&&this.parseSubBoxes(a),a.boxes.find(f=>f.kind===h)}parseBoxHead(a){let h=this.file.getUint32(a),f=this.file.getString(a+4,4),m=a+8;return h===1&&(h=this.file.getUint64(a+8),m+=8),{offset:a,length:h,kind:f,start:m}}parseBoxFullHead(a){if(a.version!==void 0)return;let h=this.file.getUint32(a.start);a.version=h>>24,a.start+=4}}class Ia extends Ko{static canHandle(a,h){if(h!==0)return!1;let f=a.getUint16(2);if(f>50)return!1;let m=16,x=[];for(;m<f;)x.push(a.getString(m,4)),m+=4;return x.includes(this.type)}async parse(){let a=this.file.getUint32(0),h=this.parseBoxHead(a);for(;h.kind!=="meta";)a+=h.length,await this.file.ensureChunk(a,16),h=this.parseBoxHead(a);await this.file.ensureChunk(h.offset,h.length),this.parseBoxFullHead(h),this.parseSubBoxes(h),this.options.icc.enabled&&await this.findIcc(h),this.options.tiff.enabled&&await this.findExif(h)}async registerSegment(a,h,f){await this.file.ensureChunk(h,f);let m=this.file.subarray(h,f);this.createParser(a,m)}async findIcc(a){let h=this.findBox(a,"iprp");if(h===void 0)return;let f=this.findBox(h,"ipco");if(f===void 0)return;let m=this.findBox(f,"colr");m!==void 0&&await this.registerSegment("icc",m.offset+12,m.length)}async findExif(a){let h=this.findBox(a,"iinf");if(h===void 0)return;let f=this.findBox(a,"iloc");if(f===void 0)return;let m=this.findExifLocIdInIinf(h),x=this.findExtentInIloc(f,m);if(x===void 0)return;let[b,M]=x;await this.file.ensureChunk(b,M);let z=4+this.file.getUint32(b);b+=z,M-=z,await this.registerSegment("tiff",b,M)}findExifLocIdInIinf(a){this.parseBoxFullHead(a);let h,f,m,x,b=a.start,M=this.file.getUint16(b);for(b+=2;M--;){if(h=this.parseBoxHead(b),this.parseBoxFullHead(h),f=h.start,h.version>=2&&(m=h.version===3?4:2,x=this.file.getString(f+m+2,4),x==="Exif"))return this.file.getUintBytes(f,m);b+=h.length}}get8bits(a){let h=this.file.getUint8(a);return[h>>4,15&h]}findExtentInIloc(a,h){this.parseBoxFullHead(a);let f=a.start,[m,x]=this.get8bits(f++),[b,M]=this.get8bits(f++),z=a.version===2?4:2,D=a.version===1||a.version===2?2:0,F=M+m+x,B=a.version===2?4:2,L=this.file.getUintBytes(f,B);for(f+=B;L--;){let P=this.file.getUintBytes(f,z);f+=z+D+2+b;let $=this.file.getUint16(f);if(f+=2,P===h)return $>1&&console.warn(`ILOC box has more than one extent but we're only processing one
Please create an issue at https://github.com/MikeKovarik/exifr with this file`),[this.file.getUintBytes(f+M,m),this.file.getUintBytes(f+M+m,x)];f+=$*F}}}class Ua extends Ia{}O(Ua,"type","heic");class za extends Ia{}O(za,"type","avif"),Dt.set("heic",Ua),Dt.set("avif",za),Wt(as,["ifd0","ifd1"],[[256,"ImageWidth"],[257,"ImageHeight"],[258,"BitsPerSample"],[259,"Compression"],[262,"PhotometricInterpretation"],[270,"ImageDescription"],[271,"Make"],[272,"Model"],[273,"StripOffsets"],[274,"Orientation"],[277,"SamplesPerPixel"],[278,"RowsPerStrip"],[279,"StripByteCounts"],[282,"XResolution"],[283,"YResolution"],[284,"PlanarConfiguration"],[296,"ResolutionUnit"],[301,"TransferFunction"],[305,"Software"],[306,"ModifyDate"],[315,"Artist"],[316,"HostComputer"],[317,"Predictor"],[318,"WhitePoint"],[319,"PrimaryChromaticities"],[513,"ThumbnailOffset"],[514,"ThumbnailLength"],[529,"YCbCrCoefficients"],[530,"YCbCrSubSampling"],[531,"YCbCrPositioning"],[532,"ReferenceBlackWhite"],[700,"ApplicationNotes"],[33432,"Copyright"],[33723,"IPTC"],[34665,"ExifIFD"],[34675,"ICC"],[34853,"GpsIFD"],[330,"SubIFD"],[40965,"InteropIFD"],[40091,"XPTitle"],[40092,"XPComment"],[40093,"XPAuthor"],[40094,"XPKeywords"],[40095,"XPSubject"]]),Wt(as,"exif",[[33434,"ExposureTime"],[33437,"FNumber"],[34850,"ExposureProgram"],[34852,"SpectralSensitivity"],[34855,"ISO"],[34858,"TimeZoneOffset"],[34859,"SelfTimerMode"],[34864,"SensitivityType"],[34865,"StandardOutputSensitivity"],[34866,"RecommendedExposureIndex"],[34867,"ISOSpeed"],[34868,"ISOSpeedLatitudeyyy"],[34869,"ISOSpeedLatitudezzz"],[36864,"ExifVersion"],[36867,"DateTimeOriginal"],[36868,"CreateDate"],[36873,"GooglePlusUploadCode"],[36880,"OffsetTime"],[36881,"OffsetTimeOriginal"],[36882,"OffsetTimeDigitized"],[37121,"ComponentsConfiguration"],[37122,"CompressedBitsPerPixel"],[37377,"ShutterSpeedValue"],[37378,"ApertureValue"],[37379,"BrightnessValue"],[37380,"ExposureCompensation"],[37381,"MaxApertureValue"],[37382,"SubjectDistance"],[37383,"MeteringMode"],[37384,"LightSource"],[37385,"Flash"],[37386,"FocalLength"],[37393,"ImageNumber"],[37394,"SecurityClassification"],[37395,"ImageHistory"],[37396,"SubjectArea"],[37500,"MakerNote"],[37510,"UserComment"],[37520,"SubSecTime"],[37521,"SubSecTimeOriginal"],[37522,"SubSecTimeDigitized"],[37888,"AmbientTemperature"],[37889,"Humidity"],[37890,"Pressure"],[37891,"WaterDepth"],[37892,"Acceleration"],[37893,"CameraElevationAngle"],[40960,"FlashpixVersion"],[40961,"ColorSpace"],[40962,"ExifImageWidth"],[40963,"ExifImageHeight"],[40964,"RelatedSoundFile"],[41483,"FlashEnergy"],[41486,"FocalPlaneXResolution"],[41487,"FocalPlaneYResolution"],[41488,"FocalPlaneResolutionUnit"],[41492,"SubjectLocation"],[41493,"ExposureIndex"],[41495,"SensingMethod"],[41728,"FileSource"],[41729,"SceneType"],[41730,"CFAPattern"],[41985,"CustomRendered"],[41986,"ExposureMode"],[41987,"WhiteBalance"],[41988,"DigitalZoomRatio"],[41989,"FocalLengthIn35mmFormat"],[41990,"SceneCaptureType"],[41991,"GainControl"],[41992,"Contrast"],[41993,"Saturation"],[41994,"Sharpness"],[41996,"SubjectDistanceRange"],[42016,"ImageUniqueID"],[42032,"OwnerName"],[42033,"SerialNumber"],[42034,"LensInfo"],[42035,"LensMake"],[42036,"LensModel"],[42037,"LensSerialNumber"],[42080,"CompositeImage"],[42081,"CompositeImageCount"],[42082,"CompositeImageExposureTimes"],[42240,"Gamma"],[59932,"Padding"],[59933,"OffsetSchema"],[65e3,"OwnerName"],[65001,"SerialNumber"],[65002,"Lens"],[65100,"RawFile"],[65101,"Converter"],[65102,"WhiteBalance"],[65105,"Exposure"],[65106,"Shadows"],[65107,"Brightness"],[65108,"Contrast"],[65109,"Saturation"],[65110,"Sharpness"],[65111,"Smoothness"],[65112,"MoireFilter"],[40965,"InteropIFD"]]),Wt(as,"gps",[[0,"GPSVersionID"],[1,"GPSLatitudeRef"],[2,"GPSLatitude"],[3,"GPSLongitudeRef"],[4,"GPSLongitude"],[5,"GPSAltitudeRef"],[6,"GPSAltitude"],[7,"GPSTimeStamp"],[8,"GPSSatellites"],[9,"GPSStatus"],[10,"GPSMeasureMode"],[11,"GPSDOP"],[12,"GPSSpeedRef"],[13,"GPSSpeed"],[14,"GPSTrackRef"],[15,"GPSTrack"],[16,"GPSImgDirectionRef"],[17,"GPSImgDirection"],[18,"GPSMapDatum"],[19,"GPSDestLatitudeRef"],[20,"GPSDestLatitude"],[21,"GPSDestLongitudeRef"],[22,"GPSDestLongitude"],[23,"GPSDestBearingRef"],[24,"GPSDestBearing"],[25,"GPSDestDistanceRef"],[26,"GPSDestDistance"],[27,"GPSProcessingMethod"],[28,"GPSAreaInformation"],[29,"GPSDateStamp"],[30,"GPSDifferential"],[31,"GPSHPositioningError"]]),Wt(yn,["ifd0","ifd1"],[[274,{1:"Horizontal (normal)",2:"Mirror horizontal",3:"Rotate 180",4:"Mirror vertical",5:"Mirror horizontal and rotate 270 CW",6:"Rotate 90 CW",7:"Mirror horizontal and rotate 90 CW",8:"Rotate 270 CW"}],[296,{1:"None",2:"inches",3:"cm"}]]);let Zs=Wt(yn,"exif",[[34850,{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"}],[37121,{0:"-",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}],[37383,{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"}],[37384,{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"}],[37385,{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"}],[41495,{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"}],[41728,{1:"Film Scanner",2:"Reflection Print Scanner",3:"Digital Camera"}],[41729,{1:"Directly photographed"}],[41985,{0:"Normal",1:"Custom",2:"HDR (no original saved)",3:"HDR (original saved)",4:"Original (for HDR)",6:"Panorama",7:"Portrait HDR",8:"Portrait"}],[41986,{0:"Auto",1:"Manual",2:"Auto bracket"}],[41987,{0:"Auto",1:"Manual"}],[41990,{0:"Standard",1:"Landscape",2:"Portrait",3:"Night",4:"Other"}],[41991,{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"}],[41996,{0:"Unknown",1:"Macro",2:"Close",3:"Distant"}],[42080,{0:"Unknown",1:"Not a Composite Image",2:"General Composite Image",3:"Composite Image Captured While Shooting"}]]);const La={1:"No absolute unit of measurement",2:"Inch",3:"Centimeter"};Zs.set(37392,La),Zs.set(41488,La);const An={0:"Normal",1:"Low",2:"High"};function ka(u){return typeof u=="object"&&u.length!==void 0?u[0]:u}function Oa(u){let a=Array.from(u).slice(1);return a[1]>15&&(a=a.map(h=>String.fromCharCode(h))),a[2]!=="0"&&a[2]!==0||a.pop(),a.join(".")}function En(u){if(typeof u=="string"){var[a,h,f,m,x,b]=u.trim().split(/[-: ]/g).map(Number),M=new Date(a,h-1,f);return Number.isNaN(m)||Number.isNaN(x)||Number.isNaN(b)||(M.setHours(m),M.setMinutes(x),M.setSeconds(b)),Number.isNaN(+M)?u:M}}function Ws(u){if(typeof u=="string")return u;let a=[];if(u[1]===0&&u[u.length-1]===0)for(let h=0;h<u.length;h+=2)a.push(Ba(u[h+1],u[h]));else for(let h=0;h<u.length;h+=2)a.push(Ba(u[h],u[h+1]));return me(String.fromCodePoint(...a))}function Ba(u,a){return u<<8|a}Zs.set(41992,An),Zs.set(41993,An),Zs.set(41994,An),Wt(Ar,["ifd0","ifd1"],[[50827,function(u){return typeof u!="string"?Hs(u):u}],[306,En],[40091,Ws],[40092,Ws],[40093,Ws],[40094,Ws],[40095,Ws]]),Wt(Ar,"exif",[[40960,Oa],[36864,Oa],[36867,En],[36868,En],[40962,ka],[40963,ka]]),Wt(Ar,"gps",[[0,u=>Array.from(u).join(".")],[7,u=>Array.from(u).join(":")]]);class Sn extends zi{static canHandle(a,h){return a.getUint8(h+1)===225&&a.getUint32(h+4)===1752462448&&a.getString(h+4,20)==="http://ns.adobe.com/"}static headerLength(a,h){return a.getString(h+4,34)==="http://ns.adobe.com/xmp/extension/"?79:33}static findPosition(a,h){let f=super.findPosition(a,h);return f.multiSegment=f.extended=f.headerLength===79,f.multiSegment?(f.chunkCount=a.getUint8(h+72),f.chunkNumber=a.getUint8(h+76),a.getUint8(h+77)!==0&&f.chunkNumber++):(f.chunkCount=1/0,f.chunkNumber=-1),f}static handleMultiSegments(a){return a.map(h=>h.chunk.getString()).join("")}normalizeInput(a){return typeof a=="string"?a:Ce.from(a).getString()}parse(a=this.chunk){if(!this.localOptions.parse)return a;a=function(x){let b={},M={};for(let z of $a)b[z]=[],M[z]=0;return x.replace(el,(z,D,F)=>{if(D==="<"){let B=++M[F];return b[F].push(B),`${z}#${B}`}return`${z}#${b[F].pop()}`})}(a);let h=hs.findAll(a,"rdf","Description");h.length===0&&h.push(new hs("rdf","Description",void 0,a));let f,m={};for(let x of h)for(let b of x.properties)f=Jo(b.ns,m),Na(b,f);return function(x){let b;for(let M in x)b=x[M]=le(x[M]),b===void 0&&delete x[M];return le(x)}(m)}assignToOutput(a,h){if(this.localOptions.parse)for(let[f,m]of Object.entries(h))switch(f){case"tiff":this.assignObjectToOutput(a,"ifd0",m);break;case"exif":this.assignObjectToOutput(a,"exif",m);break;case"xmlns":break;default:this.assignObjectToOutput(a,f,m)}else a.xmp=h}}O(Sn,"type","xmp"),O(Sn,"multiSegment",!0),at.set("xmp",Sn);class Pr{static findAll(a){return Da(a,/([a-zA-Z0-9-]+):([a-zA-Z0-9-]+)=("[^"]*"|'[^']*')/gm).map(Pr.unpackMatch)}static unpackMatch(a){let h=a[1],f=a[2],m=a[3].slice(1,-1);return m=Ga(m),new Pr(h,f,m)}constructor(a,h,f){this.ns=a,this.name=h,this.value=f}serialize(){return this.value}}class hs{static findAll(a,h,f){if(h!==void 0||f!==void 0){h=h||"[\\w\\d-]+",f=f||"[\\w\\d-]+";var m=new RegExp(`<(${h}):(${f})(#\\d+)?((\\s+?[\\w\\d-:]+=("[^"]*"|'[^']*'))*\\s*)(\\/>|>([\\s\\S]*?)<\\/\\1:\\2\\3>)`,"gm")}else m=/<([\w\d-]+):([\w\d-]+)(#\d+)?((\s+?[\w\d-:]+=("[^"]*"|'[^']*'))*\s*)(\/>|>([\s\S]*?)<\/\1:\2\3>)/gm;return Da(a,m).map(hs.unpackMatch)}static unpackMatch(a){let h=a[1],f=a[2],m=a[4],x=a[8];return new hs(h,f,m,x)}constructor(a,h,f,m){this.ns=a,this.name=h,this.attrString=f,this.innerXml=m,this.attrs=Pr.findAll(f),this.children=hs.findAll(m),this.value=this.children.length===0?Ga(m):void 0,this.properties=[...this.attrs,...this.children]}get isPrimitive(){return this.value!==void 0&&this.attrs.length===0&&this.children.length===0}get isListContainer(){return this.children.length===1&&this.children[0].isList}get isList(){let{ns:a,name:h}=this;return a==="rdf"&&(h==="Seq"||h==="Bag"||h==="Alt")}get isListItem(){return this.ns==="rdf"&&this.name==="li"}serialize(){if(this.properties.length===0&&this.value===void 0)return;if(this.isPrimitive)return this.value;if(this.isListContainer)return this.children[0].serialize();if(this.isList)return Qo(this.children.map(Xo));if(this.isListItem&&this.children.length===1&&this.attrs.length===0)return this.children[0].serialize();let a={};for(let h of this.properties)Na(h,a);return this.value!==void 0&&(a.value=this.value),le(a)}}function Na(u,a){let h=u.serialize();h!==void 0&&(a[u.name]=h)}var Xo=u=>u.serialize(),Qo=u=>u.length===1?u[0]:u,Jo=(u,a)=>a[u]?a[u]:a[u]={};function Da(u,a){let h,f=[];if(!u)return f;for(;(h=a.exec(u))!==null;)f.push(h);return f}function Ga(u){if(function(f){return f==null||f==="null"||f==="undefined"||f===""||f.trim()===""}(u))return;let a=Number(u);if(!Number.isNaN(a))return a;let h=u.toLowerCase();return h==="true"||h!=="false"&&u.trim()}const $a=["rdf:li","rdf:Seq","rdf:Bag","rdf:Alt","rdf:Description"],el=new RegExp(`(<|\\/)(${$a.join("|")})`,"g"),tl={maxRequests:6};class Va{constructor(a){this.options={...tl,...a},this.requestQueue=[],this.executing=new Set}remove(a){this.executing.delete(a),a.cancelled||(a.completed=!0,this.enqueue())}enqueue(){for(let a=this.executing.size;a<this.options.maxRequests&&this.requestQueue.length>0;a++){const h=this.requestQueue.shift();if(h.cancelled){this.remove(h);continue}const f=Promise.resolve().then(()=>{const m=h.ref();return h.request=m,m});this.executing.add(h),f.then(()=>{this.remove(h)}).catch(()=>{this.remove(h)})}}scheduleRequest(a){const h={ref:a,cancelled:!1,completed:!1,request:null,cancel:()=>{!h.completed&&!h.cancelled&&(h.cancelled=!0,h.request&&h.request.cancel(),this.enqueue())}};return this.requestQueue.push(h),this.enqueue(),h}}var os={nextZero:function(u,a){for(;u[a]!=0;)a++;return a},readUshort:function(u,a){return u[a]<<8|u[a+1]},writeUshort:function(u,a,h){u[a]=h>>8&255,u[a+1]=h&255},readUint:function(u,a){return u[a]*(256*256*256)+(u[a+1]<<16|u[a+2]<<8|u[a+3])},writeUint:function(u,a,h){u[a]=h>>24&255,u[a+1]=h>>16&255,u[a+2]=h>>8&255,u[a+3]=h&255},readASCII:function(u,a,h){for(var f="",m=0;m<h;m++)f+=String.fromCharCode(u[a+m]);return f},writeASCII:function(u,a,h){for(var f=0;f<h.length;f++)u[a+f]=h.charCodeAt(f)},readBytes:function(u,a,h){for(var f=[],m=0;m<h;m++)f.push(u[a+m]);return f},pad:function(u){return u.length<2?"0"+u:u},readUTF8:function(u,a,h){for(var f="",m,x=0;x<h;x++)f+="%"+os.pad(u[a+x].toString(16));try{m=decodeURIComponent(f)}catch{return os.readASCII(u,a,h)}return m}};function il(u){var a=u.width,h=u.height;if(u.tabs.acTL==null)return[Ha(u.data,a,h,u).buffer];var f=[];u.frames[0].data==null&&(u.frames[0].data=u.data);for(var m=a*h*4,x=new Uint8Array(m),b=new Uint8Array(m),M=new Uint8Array(m),z=0;z<u.frames.length;z++){var D=u.frames[z],F=D.rect.x,B=D.rect.y,L=D.rect.width,P=D.rect.height,$=Ha(D.data,L,P,u);if(z!=0)for(var G=0;G<m;G++)M[G]=x[G];if(D.blend==0?Fn($,L,P,x,a,h,F,B,0):D.blend==1&&Fn($,L,P,x,a,h,F,B,1),f.push(x.buffer.slice(0)),D.dispose!=0){if(D.dispose==1)Fn(b,L,P,x,a,h,F,B,0);else if(D.dispose==2)for(var G=0;G<m;G++)x[G]=M[G]}}return f}function Ha(u,a,h,f){var m=a*h,x=Ur(f),b=Math.ceil(a*x/8),M=new Uint8Array(m*4),z=new Uint32Array(M.buffer),D=f.ctype,F=f.depth,B=os.readUshort;if(D==6){var L=m<<2;if(F==8)for(var P=0;P<L;P+=4)M[P]=u[P],M[P+1]=u[P+1],M[P+2]=u[P+2],M[P+3]=u[P+3];if(F==16)for(var P=0;P<L;P++)M[P]=u[P<<1]}else if(D==2){var $=f.tabs.tRNS;if($==null){if(F==8)for(var P=0;P<m;P++){var G=P*3;z[P]=255<<24|u[G+2]<<16|u[G+1]<<8|u[G]}if(F==16)for(var P=0;P<m;P++){var G=P*6;z[P]=255<<24|u[G+4]<<16|u[G+2]<<8|u[G]}}else{var ne=$[0],pe=$[1],ge=$[2];if(F==8)for(var P=0;P<m;P++){var j=P<<2,G=P*3;z[P]=255<<24|u[G+2]<<16|u[G+1]<<8|u[G],u[G]==ne&&u[G+1]==pe&&u[G+2]==ge&&(M[j+3]=0)}if(F==16)for(var P=0;P<m;P++){var j=P<<2,G=P*6;z[P]=255<<24|u[G+4]<<16|u[G+2]<<8|u[G],B(u,G)==ne&&B(u,G+2)==pe&&B(u,G+4)==ge&&(M[j+3]=0)}}}else if(D==3){var re=f.tabs.PLTE,ve=f.tabs.tRNS,H=ve?ve.length:0;if(F==1)for(var Z=0;Z<h;Z++)for(var ce=Z*b,ae=Z*a,P=0;P<a;P++){var j=ae+P<<2,fe=u[ce+(P>>3)]>>7-((P&7)<<0)&1,he=3*fe;M[j]=re[he],M[j+1]=re[he+1],M[j+2]=re[he+2],M[j+3]=fe<H?ve[fe]:255}if(F==2)for(var Z=0;Z<h;Z++)for(var ce=Z*b,ae=Z*a,P=0;P<a;P++){var j=ae+P<<2,fe=u[ce+(P>>2)]>>6-((P&3)<<1)&3,he=3*fe;M[j]=re[he],M[j+1]=re[he+1],M[j+2]=re[he+2],M[j+3]=fe<H?ve[fe]:255}if(F==4)for(var Z=0;Z<h;Z++)for(var ce=Z*b,ae=Z*a,P=0;P<a;P++){var j=ae+P<<2,fe=u[ce+(P>>1)]>>4-((P&1)<<2)&15,he=3*fe;M[j]=re[he],M[j+1]=re[he+1],M[j+2]=re[he+2],M[j+3]=fe<H?ve[fe]:255}if(F==8)for(var P=0;P<m;P++){var j=P<<2,fe=u[P],he=3*fe;M[j]=re[he],M[j+1]=re[he+1],M[j+2]=re[he+2],M[j+3]=fe<H?ve[fe]:255}}else if(D==4){if(F==8)for(var P=0;P<m;P++){var j=P<<2,mt=P<<1,J=u[mt];M[j]=J,M[j+1]=J,M[j+2]=J,M[j+3]=u[mt+1]}if(F==16)for(var P=0;P<m;P++){var j=P<<2,mt=P<<2,J=u[mt];M[j]=J,M[j+1]=J,M[j+2]=J,M[j+3]=u[mt+2]}}else if(D==0)for(var ne=f.tabs.tRNS?f.tabs.tRNS:-1,Z=0;Z<h;Z++){var Pt=Z*b,Kt=Z*a;if(F==1)for(var te=0;te<a;te++){var J=255*(u[Pt+(te>>>3)]>>>7-(te&7)&1),Xe=J==ne*255?0:255;z[Kt+te]=Xe<<24|J<<16|J<<8|J}else if(F==2)for(var te=0;te<a;te++){var J=85*(u[Pt+(te>>>2)]>>>6-((te&3)<<1)&3),Xe=J==ne*85?0:255;z[Kt+te]=Xe<<24|J<<16|J<<8|J}else if(F==4)for(var te=0;te<a;te++){var J=17*(u[Pt+(te>>>1)]>>>4-((te&1)<<2)&15),Xe=J==ne*17?0:255;z[Kt+te]=Xe<<24|J<<16|J<<8|J}else if(F==8)for(var te=0;te<a;te++){var J=u[Pt+te],Xe=J==ne?0:255;z[Kt+te]=Xe<<24|J<<16|J<<8|J}else if(F==16)for(var te=0;te<a;te++){var J=u[Pt+(te<<1)],Xe=B(u,Pt+(te<<1))==ne?0:255;z[Kt+te]=Xe<<24|J<<16|J<<8|J}}return M}function sl(u){for(var a=new Uint8Array(u),h=8,f=os,m=f.readUshort,x=f.readUint,b={tabs:{},frames:[]},M=new Uint8Array(a.length),z=0,D,F=0,B=[137,80,78,71,13,10,26,10],L=0;L<8;L++)if(a[L]!=B[L])throw"The input is not a PNG file!";for(;h<a.length;){var P=f.readUint(a,h);h+=4;var $=f.readASCII(a,h,4);if(h+=4,$=="IHDR")nl(a,h,b);else if($=="iCCP"){for(var G=h;a[G]!=0;)G++;f.readASCII(a,h,G-h),a[G+1];var ne=a.slice(G+2,h+P),pe=null;try{pe=Ir(ne)}catch{pe=Cn(ne)}b.tabs[$]=pe}else if($=="CgBI")b.tabs[$]=a.slice(h,h+4);else if($=="IDAT"){for(var L=0;L<P;L++)M[z+L]=a[h+L];z+=P}else if($=="acTL")b.tabs[$]={num_frames:x(a,h),num_plays:x(a,h+4)},D=new Uint8Array(a.length);else if($=="fcTL"){if(F!=0){var ge=b.frames[b.frames.length-1];ge.data=Rn(b,D.slice(0,F),ge.rect.width,ge.rect.height),F=0}var j={x:x(a,h+12),y:x(a,h+16),width:x(a,h+4),height:x(a,h+8)},re=m(a,h+22);re=m(a,h+20)/(re==0?100:re);var ve={rect:j,delay:Math.round(re*1e3),dispose:a[h+24],blend:a[h+25]};b.frames.push(ve)}else if($=="fdAT"){for(var L=0;L<P-4;L++)D[F+L]=a[h+L+4];F+=P-4}else if($=="pHYs")b.tabs[$]=[f.readUint(a,h),f.readUint(a,h+4),a[h+8]];else if($=="cHRM"){b.tabs[$]=[];for(var L=0;L<8;L++)b.tabs[$].push(f.readUint(a,h+L*4))}else if($=="tEXt"||$=="zTXt"){b.tabs[$]==null&&(b.tabs[$]={});var H=f.nextZero(a,h),Z=f.readASCII(a,h,H-h),ce,ae=h+P-H-1;if($=="tEXt")ce=f.readASCII(a,H+1,ae);else{var fe=Ir(a.slice(H+2,H+2+ae));ce=f.readUTF8(fe,0,fe.length)}b.tabs[$][Z]=ce}else if($=="iTXt"){b.tabs[$]==null&&(b.tabs[$]={});var H=0,G=h;H=f.nextZero(a,G);var Z=f.readASCII(a,G,H-G);G=H+1;var he=a[G];a[G+1],G+=2,H=f.nextZero(a,G),f.readASCII(a,G,H-G),G=H+1,H=f.nextZero(a,G),f.readUTF8(a,G,H-G),G=H+1;var ce,ae=P-(G-h);if(he==0)ce=f.readUTF8(a,G,ae);else{var fe=Ir(a.slice(G,G+ae));ce=f.readUTF8(fe,0,fe.length)}b.tabs[$][Z]=ce}else if($=="PLTE")b.tabs[$]=f.readBytes(a,h,P);else if($=="hIST"){var mt=b.tabs.PLTE.length/3;b.tabs[$]=[];for(var L=0;L<mt;L++)b.tabs[$].push(m(a,h+L*2))}else if($=="tRNS")b.ctype==3?b.tabs[$]=f.readBytes(a,h,P):b.ctype==0?b.tabs[$]=m(a,h):b.ctype==2&&(b.tabs[$]=[m(a,h),m(a,h+2),m(a,h+4)]);else if($=="gAMA")b.tabs[$]=f.readUint(a,h)/1e5;else if($=="sRGB")b.tabs[$]=a[h];else if($=="bKGD")b.ctype==0||b.ctype==4?b.tabs[$]=[m(a,h)]:b.ctype==2||b.ctype==6?b.tabs[$]=[m(a,h),m(a,h+2),m(a,h+4)]:b.ctype==3&&(b.tabs[$]=a[h]);else if($=="IEND")break;h+=P,f.readUint(a,h),h+=4}if(F!=0){var ge=b.frames[b.frames.length-1];ge.data=Rn(b,D.slice(0,F),ge.rect.width,ge.rect.height)}return b.data=Rn(b,M,b.width,b.height),delete b.compress,delete b.interlace,delete b.filter,b}function Rn(u,a,h,f){var m=Ur(u),x=Math.ceil(h*m/8),b=new Uint8Array((x+1+u.interlace)*f);return u.tabs.CgBI?a=Cn(a,b):a=Ir(a,b),u.interlace==0?a=ja(a,u,0,h,f):u.interlace==1&&(a=rl(a,u)),a}function Ir(u,a){var h=Cn(new Uint8Array(u.buffer,2,u.length-6),a);return h}var Cn=function(){var u={};return u.H={},u.H.N=function(a,h){var f=Uint8Array,m=0,x=0,b=0,M=0,z=0,D=0,F=0,B=0,L=0,P,$;if(a[0]==3&&a[1]==0)return h||new f(0);var G=u.H,ne=G.b,pe=G.e,ge=G.R,j=G.n,re=G.A,ve=G.Z,H=G.m,Z=h==null;for(Z&&(h=new f(a.length>>>2<<5));m==0;){if(m=ne(a,L,1),x=ne(a,L+1,2),L+=3,x==0){L&7&&(L+=8-(L&7));var ce=(L>>>3)+4,ae=a[ce-4]|a[ce-3]<<8;Z&&(h=u.H.W(h,B+ae)),h.set(new f(a.buffer,a.byteOffset+ce,ae),B),L=ce+ae<<3,B+=ae;continue}if(Z&&(h=u.H.W(h,B+(1<<17))),x==1&&(P=H.J,$=H.h,D=511,F=31),x==2){b=pe(a,L,5)+257,M=pe(a,L+5,5)+1,z=pe(a,L+10,4)+4,L+=14;for(var fe=1,he=0;he<38;he+=2)H.Q[he]=0,H.Q[he+1]=0;for(var he=0;he<z;he++){var mt=pe(a,L+he*3,3);H.Q[(H.X[he]<<1)+1]=mt,mt>fe&&(fe=mt)}L+=3*z,j(H.Q,fe),re(H.Q,fe,H.u),P=H.w,$=H.d,L=ge(H.u,(1<<fe)-1,b+M,a,L,H.v);var J=G.V(H.v,0,b,H.C);D=(1<<J)-1;var Pt=G.V(H.v,b,M,H.D);F=(1<<Pt)-1,j(H.C,J),re(H.C,J,P),j(H.D,Pt),re(H.D,Pt,$)}for(;;){var Kt=P[ve(a,L)&D];L+=Kt&15;var te=Kt>>>4;if(!(te>>>8))h[B++]=te;else{if(te==256)break;var Xe=B+te-254;if(te>264){var zn=H.q[te-257];Xe=B+(zn>>>3)+pe(a,L,zn&7),L+=zn&7}var Ka=$[ve(a,L)&F];L+=Ka&15;var fl=Ka>>>4,Ln=H.c[fl],Lr=(Ln>>>4)+ne(a,L,Ln&15);for(L+=Ln&15;B<Xe;)h[B]=h[B++-Lr],h[B]=h[B++-Lr],h[B]=h[B++-Lr],h[B]=h[B++-Lr];B=Xe}}}return h.length==B?h:h.slice(0,B)},u.H.W=function(a,h){var f=a.length;if(h<=f)return a;var m=new Uint8Array(f<<1);return m.set(a,0),m},u.H.R=function(a,h,f,m,x,b){for(var M=u.H.e,z=u.H.Z,D=0;D<f;){var F=a[z(m,x)&h];x+=F&15;var B=F>>>4;if(B<=15)b[D]=B,D++;else{var L=0,P=0;B==16?(P=3+M(m,x,2),x+=2,L=b[D-1]):B==17?(P=3+M(m,x,3),x+=3):B==18&&(P=11+M(m,x,7),x+=7);for(var $=D+P;D<$;)b[D]=L,D++}}return x},u.H.V=function(a,h,f,m){for(var x=0,b=0,M=m.length>>>1;b<f;){var z=a[b+h];m[b<<1]=0,m[(b<<1)+1]=z,z>x&&(x=z),b++}for(;b<M;)m[b<<1]=0,m[(b<<1)+1]=0,b++;return x},u.H.n=function(a,h){for(var f=u.H.m,m=a.length,x,b,M,z,D,F=f.j,z=0;z<=h;z++)F[z]=0;for(z=1;z<m;z+=2)F[a[z]]++;var B=f.K;for(x=0,F[0]=0,b=1;b<=h;b++)x=x+F[b-1]<<1,B[b]=x;for(M=0;M<m;M+=2)D=a[M+1],D!=0&&(a[M]=B[D],B[D]++)},u.H.A=function(a,h,f){for(var m=a.length,x=u.H.m,b=x.r,M=0;M<m;M+=2)if(a[M+1]!=0)for(var z=M>>1,D=a[M+1],F=z<<4|D,B=h-D,L=a[M]<<B,P=L+(1<<B);L!=P;){var $=b[L]>>>15-h;f[$]=F,L++}},u.H.l=function(a,h){for(var f=u.H.m.r,m=15-h,x=0;x<a.length;x+=2){var b=a[x]<<h-a[x+1];a[x]=f[b]>>>m}},u.H.M=function(a,h,f){f=f<<(h&7);var m=h>>>3;a[m]|=f,a[m+1]|=f>>>8},u.H.I=function(a,h,f){f=f<<(h&7);var m=h>>>3;a[m]|=f,a[m+1]|=f>>>8,a[m+2]|=f>>>16},u.H.e=function(a,h,f){return(a[h>>>3]|a[(h>>>3)+1]<<8)>>>(h&7)&(1<<f)-1},u.H.b=function(a,h,f){return(a[h>>>3]|a[(h>>>3)+1]<<8|a[(h>>>3)+2]<<16)>>>(h&7)&(1<<f)-1},u.H.Z=function(a,h){return(a[h>>>3]|a[(h>>>3)+1]<<8|a[(h>>>3)+2]<<16)>>>(h&7)},u.H.i=function(a,h){return(a[h>>>3]|a[(h>>>3)+1]<<8|a[(h>>>3)+2]<<16|a[(h>>>3)+3]<<24)>>>(h&7)},u.H.m=function(){var a=Uint16Array,h=Uint32Array;return{K:new a(16),j:new a(16),X:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],S:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,999,999,999],T:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0],q:new a(32),p:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,65535,65535],z:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0],c:new h(32),J:new a(512),_:[],h:new a(32),$:[],w:new a(32768),C:[],v:[],d:new a(32768),D:[],u:new a(512),Q:[],r:new a(32768),s:new h(286),Y:new h(30),a:new h(19),t:new h(15e3),k:new a(65536),g:new a(32768)}}(),function(){for(var a=u.H.m,h=32768,f=0;f<h;f++){var m=f;m=(m&2863311530)>>>1|(m&1431655765)<<1,m=(m&3435973836)>>>2|(m&858993459)<<2,m=(m&4042322160)>>>4|(m&252645135)<<4,m=(m&4278255360)>>>8|(m&16711935)<<8,a.r[f]=(m>>>16|m<<16)>>>17}function x(b,M,z){for(;M--!=0;)b.push(0,z)}for(var f=0;f<32;f++)a.q[f]=a.S[f]<<3|a.T[f],a.c[f]=a.p[f]<<4|a.z[f];x(a._,144,8),x(a._,112,9),x(a._,24,7),x(a._,8,8),u.H.n(a._,9),u.H.A(a._,9,a.J),u.H.l(a._,9),x(a.$,32,5),u.H.n(a.$,5),u.H.A(a.$,5,a.h),u.H.l(a.$,5),x(a.Q,19,0),x(a.C,286,0),x(a.D,30,0),x(a.v,320,0)}(),u.H.N}();function rl(u,a){for(var h=a.width,f=a.height,m=Ur(a),x=m>>3,b=Math.ceil(h*m/8),M=new Uint8Array(f*b),z=0,D=[0,0,4,0,2,0,1],F=[0,4,0,2,0,1,0],B=[8,8,8,4,4,2,2],L=[8,8,4,4,2,2,1],P=0;P<7;){for(var $=B[P],G=L[P],ne=0,pe=0,ge=D[P];ge<f;)ge+=$,pe++;for(var j=F[P];j<h;)j+=G,ne++;var re=Math.ceil(ne*m/8);ja(u,a,z,ne,pe);for(var ve=0,H=D[P];H<f;){for(var Z=F[P],ce=z+ve*re<<3;Z<h;){if(m==1){var ae=u[ce>>3];ae=ae>>7-(ce&7)&1,M[H*b+(Z>>3)]|=ae<<7-((Z&7)<<0)}if(m==2){var ae=u[ce>>3];ae=ae>>6-(ce&7)&3,M[H*b+(Z>>2)]|=ae<<6-((Z&3)<<1)}if(m==4){var ae=u[ce>>3];ae=ae>>4-(ce&7)&15,M[H*b+(Z>>1)]|=ae<<4-((Z&1)<<2)}if(m>=8)for(var fe=H*b+Z*x,he=0;he<x;he++)M[fe+he]=u[(ce>>3)+he];ce+=m,Z+=G}ve++,H+=$}ne*pe!=0&&(z+=pe*(1+re)),P=P+1}return M}function Ur(u){var a=[1,null,3,1,2,null,4][u.ctype];return a*u.depth}function ja(u,a,h,f,m){var x=Ur(a),b=Math.ceil(f*x/8);x=Math.ceil(x/8);var M,z,D=u[h],F=0;if(D>1&&(u[h]=[0,0,1][D-2]),D==3)for(F=x;F<b;F++)u[F+1]=u[F+1]+(u[F+1-x]>>>1)&255;for(var B=0;B<m;B++)if(M=h+B*b,z=M+B+1,D=u[z-1],F=0,D==0)for(;F<b;F++)u[M+F]=u[z+F];else if(D==1){for(;F<x;F++)u[M+F]=u[z+F];for(;F<b;F++)u[M+F]=u[z+F]+u[M+F-x]}else if(D==2)for(;F<b;F++)u[M+F]=u[z+F]+u[M+F-b];else if(D==3){for(;F<x;F++)u[M+F]=u[z+F]+(u[M+F-b]>>>1);for(;F<b;F++)u[M+F]=u[z+F]+(u[M+F-b]+u[M+F-x]>>>1)}else{for(;F<x;F++)u[M+F]=u[z+F]+qa(0,u[M+F-b],0);for(;F<b;F++)u[M+F]=u[z+F]+qa(u[M+F-x],u[M+F-b],u[M+F-x-b])}return u}function qa(u,a,h){var f=u+a-h,m=f-u,x=f-a,b=f-h;return m*m<=x*x&&m*m<=b*b?u:x*x<=b*b?a:h}function nl(u,a,h){h.width=os.readUint(u,a),a+=4,h.height=os.readUint(u,a),a+=4,h.depth=u[a],a++,h.ctype=u[a],a++,h.compress=u[a],a++,h.filter=u[a],a++,h.interlace=u[a],a++}function Fn(u,a,h,f,m,x,b,M,z){for(var D=Math.min(a,m),F=Math.min(h,x),B=0,L=0,P=0;P<F;P++)for(var $=0;$<D;$++)if(b>=0&&M>=0?(B=P*a+$<<2,L=(M+P)*m+b+$<<2):(B=(-M+P)*a-b+$<<2,L=P*m+$<<2),z==0)f[L]=u[B],f[L+1]=u[B+1],f[L+2]=u[B+2],f[L+3]=u[B+3];else if(z==1){var G=u[B+3]*.00392156862745098,ne=u[B]*G,pe=u[B+1]*G,ge=u[B+2]*G,j=f[L+3]*(1/255),re=f[L]*j,ve=f[L+1]*j,H=f[L+2]*j,Z=1-G,ce=G+j*Z,ae=ce==0?0:1/ce;f[L+3]=255*ce,f[L+0]=(ne+re*Z)*ae,f[L+1]=(pe+ve*Z)*ae,f[L+2]=(ge+H*Z)*ae}else if(z==2){var G=u[B+3],ne=u[B],pe=u[B+1],ge=u[B+2],j=f[L+3],re=f[L],ve=f[L+1],H=f[L+2];G==j&&ne==re&&pe==ve&&ge==H?(f[L]=0,f[L+1]=0,f[L+2]=0,f[L+3]=0):(f[L]=ne,f[L+1]=pe,f[L+2]=ge,f[L+3]=G)}else if(z==3){var G=u[B+3],ne=u[B],pe=u[B+1],ge=u[B+2],j=f[L+3],re=f[L],ve=f[L+1],H=f[L+2];if(G==j&&ne==re&&pe==ve&&ge==H)continue;if(G<220&&j>20)return!1}return!0}class Pn extends Error{constructor(a,h,f,m){super(`AJAXError: ${h} (${a}): ${f}`),this.status=a,this.statusText=h,this.url=f,this.body=m}}const al=u=>/^file:/.test(u)||/^file:/.test(T())&&!/^\w+:/.test(u);function Za(u,a){const h=new AbortController,f=new Request(u.url,{method:u.method||"GET",body:u.body,credentials:u.credentials,headers:u.headers,referrer:T(),signal:h.signal});let m=!1,x=!1;u.type==="json"&&f.headers.set("Accept","application/json");const b=(z,D,F)=>{if(!x){if(z&&z.message!=="SecurityError"&&r(z),D&&F)return M(D);fetch(f).then(B=>B.ok?M(B):B.blob().then(L=>a(new Pn(B.status,B.statusText,u.url,L)))).catch(B=>{B.code,a(new Error(B.message))})}},M=z=>{(u.type==="arrayBuffer"?z.arrayBuffer():u.type==="json"?z.json():z.text()).then(D=>{x||(m=!0,a(null,D,z.headers.get("Cache-Control"),z.headers.get("Expires")))}).catch(D=>{x||a(new Error(D.message))})};return b(null,null),{cancel:()=>{x=!0,m||h.abort()}}}function hl(u,a){const h=new XMLHttpRequest;h.open(u.method||"GET",u.url,!0),u.type==="arrayBuffer"&&(h.responseType="arraybuffer");for(const f in u.headers)h.setRequestHeader(f,u.headers[f]);return u.type==="json"&&(h.responseType="text",h.setRequestHeader("Accept","application/json")),h.withCredentials=u.credentials==="include",h.onerror=()=>{a(new Error(h.statusText))},h.onload=()=>{if((h.status>=200&&h.status<300||h.status===0)&&h.response!==null){let f=h.response;if(u.type==="json")try{f=JSON.parse(h.response)}catch(m){return a(m)}a(null,f,h.getResponseHeader("Cache-Control"),h.getResponseHeader("Expires"))}else{const f=new Blob([h.response],{type:h.getResponseHeader("Content-Type")});a(new Pn(h.status,h.statusText,u.url,f))}},h.send(u.body),{cancel:()=>h.abort()}}const Wa=function(u,a){if(/:\/\//.test(u.url)&&!/^https?:|^file:/.test(u.url)){if(e()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",u,a);if(!e())return Za(u,a)}if(!al(u.url)){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return Za(u,a);if(e()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",u,a,void 0,!0)}return hl(u,a)};let In;function ol(){return In||(In=new self.GeoTIFF.Pool),In}class ll{constructor(a){this.requestScheduler=new Va(a)}getResource(a,h,f){return Wa(h,f)}arrayBuffer2unit8(a,h){const f=sl(a),m=il(f);h(null,{data:new Uint8Array(m[0]),width:f.width,height:f.height})}arrayBuffer2Image(a,h){typeof createImageBitmap=="function"?E(a,h):this.arrayBuffer2unit8(a,h)}arrayBuffer2tiff(a,h){if(!self.GeoTIFF)throw new Error("Must config [geotiff](https://github.com/geotiffjs/geotiff.js) dep use `configDeps`");self.GeoTIFF.fromArrayBuffer(a).then(f=>{f.getImage().then(m=>{const x={},b=m.fileDirectory,{GeographicTypeGeoKey:M,ProjectedCSTypeGeoKey:z}=m.getGeoKeys();x.projection=z||M;const D=m.getHeight();x.height=D;const F=m.getWidth();x.width=F;const[B,L]=m.getResolution();x.pixelHeight=Math.abs(L),x.pixelWidth=Math.abs(B);const[P,$]=m.getOrigin();x.xmin=P,x.xmax=x.xmin+F*x.pixelWidth,x.ymax=$,x.ymin=x.ymax-D*x.pixelHeight,x.noDataValue=b.GDAL_NODATA?parseFloat(b.GDAL_NODATA):null,x.numberOfRasters=b.SamplesPerPixel,m.readRasters({pool:ol()}).then(G=>{x.rasters=G;const ne=G[0];if(ne){let ge=0;const j=G.length,re=new ne.constructor(ne.length*j);for(;ge<ne.length;ge++)for(let ve=0;ve<j;ve++)re[ge+ve]=G[ve][ge];x.data=re}x.metadata=m.getGDALMetadata();const pe=C(b.ImageDescription||"");x.min=pe.min,x.max=pe.max,x.isTiff=!0,h(null,x)}).catch(G=>{h(G)})}).catch(m=>{h(m)})}).catch(f=>{h(f)})}parseExif(a,h){$o(a).then(f=>{this.arrayBuffer2Image(a,(m,x)=>{m?h(m):h(null,{data:n(x)?x:x.data,width:x.width,height:x.height,exif:f,withExif:!0})})}).catch(f=>{h(f)})}fetch(a,h){let f=!1;const m=this.requestScheduler.scheduleRequest(()=>{const x=new Promise(b=>{const M=Wa(a,(...z)=>{if(f){b(!1);return}h(...z),b(z)});x.cancel=()=>{M.cancel()}});return x});return{cancel:()=>{f=!0,m.cancel()}}}}let Un=null;function cl(u={},a=!1){return(!Un||a)&&(Un=new ll(u)),Un}const Yt={};function zr(u,a,h={}){if(Yt[u])throw new Error(`${u} is already registered.`);Object.defineProperty(a,"_classRegistryKey",{value:u,writeable:!1}),Yt[u]={klass:a,omit:h.omit||[],shallow:h.shallow||[]}}zr("Object",Object),zr("Error",Error),zr("AJAXError",Pn);function Ys(u,a){if(u==null||typeof u=="boolean"||typeof u=="number"||typeof u=="string"||u instanceof Boolean||u instanceof Number||u instanceof String||u instanceof Date||u instanceof RegExp||u instanceof Blob)return u;if(l(u)||n(u))return a&&a.push(u),u;if(ArrayBuffer.isView(u)){const h=u;return a&&a.push(h.buffer),h}if(u instanceof ImageData)return a&&a.push(u.data.buffer),u;if(Array.isArray(u)){const h=[];for(const f of u)h.push(Ys(f,a));return h}if(typeof u=="object"){const h=u.constructor,f=h._classRegistryKey;if(!f)throw new Error("can't serialize object of unregistered class");if(!Yt[f])throw new Error(`${f} is not registered.`);const m=h.serialize?h.serialize(u,a):{};if(h.serialize){if(a&&m===a[a.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const x in u){if(!u.hasOwnProperty(x)||Yt[f].omit.indexOf(x)>=0)continue;const b=u[x];m[x]=Yt[f].shallow.indexOf(x)>=0?b:Ys(b,a)}u instanceof Error&&(m.message=u.message)}if(m.$name)throw new Error("$name property is reserved for worker serialization logic.");return f!=="Object"&&(m.$name=f),m}throw new Error(`can't serialize object of type ${typeof u}`)}function Ks(u){if(u==null||typeof u=="boolean"||typeof u=="number"||typeof u=="string"||u instanceof Boolean||u instanceof Number||u instanceof String||u instanceof Date||u instanceof RegExp||u instanceof Blob||l(u)||n(u)||ArrayBuffer.isView(u)||u instanceof ImageData)return u;if(Array.isArray(u))return u.map(Ks);if(typeof u=="object"){const a=u.$name||"Object";if(!Yt[a])throw new Error(`can't deserialize unregistered class ${a}`);const{klass:h}=Yt[a];if(!h)throw new Error(`can't deserialize unregistered class ${a}`);if(h.deserialize)return h.deserialize(u);const f=Object.create(h.prototype);for(const m of Object.keys(u)){if(m==="$name")continue;const x=u[m];f[m]=Yt[a].shallow.indexOf(m)>=0?x:Ks(x)}return f}throw new Error(`can't deserialize object of type ${typeof u}`)}class Ya{constructor(a){this.callback=a,this.triggered=!1,typeof MessageChannel<"u"&&(this.channel=new MessageChannel,this.channel.port2.onmessage=()=>{this.triggered=!1,this.callback()})}trigger(){this.triggered||(this.triggered=!0,this.channel?this.channel.port1.postMessage(!0):setTimeout(()=>{this.triggered=!1,this.callback()},0))}remove(){this.channel=null,this.callback=p}}class ul{constructor(a,h,f){this.target=a,this.parent=h,this.id=v("actor"),this.dispatcherId=f,this.callbacks={},this.tasks={},this.taskQueue=[],this.cancelCallbacks={},this.receive=this.receive.bind(this),this.process=this.process.bind(this),this.invoker=new Ya(this.process),this.target.addEventListener("message",this.receive,!1),this.globalScope=e()?a:window}send(a,h,f,m,x=!1){const b=Math.round(Math.random()*1e18).toString(36).substring(0,10);f&&(this.callbacks[b]=f);const M=d(this.globalScope)?void 0:[];return this.target.postMessage({id:b,type:a,hasCallback:!!f,targetId:m,mustQueue:x,dispatcherId:this.dispatcherId,data:Ys(h,M)},M),{cancel:()=>{f&&delete this.callbacks[b],this.target.postMessage({id:b,type:"<cancel>",targetId:m,dispatcherId:this.dispatcherId})}}}receive(a){const{data:h}=a,{id:f}=h;if(f&&!(h.targetId&&this.dispatcherId!==h.targetId))if(h.type==="<cancel>"){delete this.tasks[f];const m=this.cancelCallbacks[f];delete this.cancelCallbacks[f],m&&m()}else e()||h.mustQueue?(this.tasks[f]=h,this.taskQueue.push(f),this.invoker.trigger()):this.processTask(f,h)}process(){if(!this.taskQueue.length)return;const a=this.taskQueue.shift();if(a===void 0)return;const h=this.tasks[a];delete this.tasks[a],this.taskQueue.length&&this.invoker.trigger(),h&&this.processTask(a,h)}processTask(a,h){var f,m;if(h.type==="<response>"){const x=this.callbacks[a];delete this.callbacks[a],x&&(h.error?x(Ks(h.error)):x(null,Ks(h.data)))}else{let x=!1;const b=d(this.globalScope)?void 0:[],M=h.hasCallback?(F,B)=>{x=!0,delete this.cancelCallbacks[a],this.target.postMessage({id:a,type:"<response>",dispatcherId:this.dispatcherId,error:F?Ys(F):null,data:Ys(B,b)},b)}:()=>{x=!0};let z=null;const D=Ks(h.data);this.parent[h.type]?z=(m=(f=this.parent)[h.type])==null?void 0:m.call(f,h.dispatcherId,D,M):M(new Error(`Could not find function ${h.type}`)),!x&&z&&z.cancel&&(this.cancelCallbacks[a]=z.cancel)}}remove(){this.invoker.remove(),this.target.removeEventListener("message",this.receive,!1)}}t.Actor=ul,t.RequestScheduler=Va,t.ThrottledInvoker=Ya,t.asyncAll=i,t.getReferrer=T,t.getRequest=cl,t.isWorker=e,t.nullFunction=p,t.register=zr,t.uid=v,t.utils=I});ga(["./shared"],function(t){class i{constructor(s){this.cancelMap=new Map,this.self=s,this.actor=new t.Actor(s,this),this.request=t.getRequest()}setReferrer(s,r){this.referrer=r}configDeps(s,r,n){if(r&&Array.isArray(r)&&r.length>0)try{self.importScripts(...r),n(null,!0)}catch{t.asyncAll(r,(c,d)=>{this.request.fetch({url:c,type:"arrayBuffer"},(p,g)=>{if(p)return d(p,!1),console.error(p);const v=URL.createObjectURL(new Blob([g],{type:"application/javascript"}));self.importScripts(v),setTimeout(()=>{URL.revokeObjectURL(v)}),d(null,!0)})},n)}else n(null,!0)}loadData(s,r,n){const l=r==null?void 0:r.cancelId,{cancel:c}=this.request.fetch(r,(d,p)=>{this.cancelMap.delete(l),d?n(d):(r==null?void 0:r.decodeType)===0?this.request.arrayBuffer2Image(p,n):(r==null?void 0:r.decodeType)===1?this.request.arrayBuffer2unit8(p,n):(r==null?void 0:r.decodeType)===2?this.request.arrayBuffer2tiff(p,n):(r==null?void 0:r.decodeType)===3&&this.request.parseExif(p,n)});this.cancelMap.set(l,c)}cancel(s,r,n){const l=r==null?void 0:r.cancelId,c=this.cancelMap.get(l);c?(c(),n(null,!0)):n(new Error("无相关的可取消请求！"))}}return t.isWorker()&&(self.worker=new i(self)),i});ga(["./shared"],function(t){let i="";function e(R){i=R}function s(){return i}let r=[];function n(R){r=R}function l(){return r}function c(){return new Worker(s())}const d="__wind_layer_preloaded_worker_pool__";class p{constructor(){this.active={}}acquire(U){if(!this.workers){this.workers=[];for(let C=0;C<p.workerCount;C++){const I=c();I&&this.workers.push(I)}}return this.active[U]=!0,this.workers.slice()}release(U){delete this.active[U],this.numActive()===0&&this.workers&&(this.workers.forEach(C=>{C.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[d]}numActive(){return Object.keys(this.active).length}}const g=typeof navigator<"u"&&navigator.hardwareConcurrency||4,v=Math.floor(g/2);p.workerCount=Math.max(Math.min(v,6),1);class w{constructor(U,C,I){this.workerPool=U,this.actors=[],this.currentActor=0,this.id=t.uid("dispatcher"),this.dispatcherId=I;const O=this.workerPool.acquire(this.dispatcherId);for(let V=0;V<O.length;V++){const Q=O[V],X=new t.Actor(Q,C,this.dispatcherId);X.name=`Worker ${V}`,this.actors.push(X)}if(!this.actors.length)throw new Error("No actors found")}broadcast(U,C,I){I=I||t.nullFunction,t.asyncAll(this.actors,(O,V)=>{O.send(U,C,V)},I)}send(U,C,I,O){const V=this.getActor(O);V&&V.send(U,C,I)}getActor(U){if(U!==void 0){const C=this.actors.findIndex(I=>I.id===U);C>-1?this.currentActor=C:this.currentActor=(this.currentActor+1)%this.actors.length}else this.currentActor=(this.currentActor+1)%this.actors.length;return this.actors[this.currentActor]}remove(U=!0){this.actors.forEach(C=>{C.remove()}),this.actors=[],U&&this.workerPool.release(this.id)}}let _;function T(){return _||(_=new p),_}function E(){T().acquire(d)}return{utils:t.utils,request:t.getRequest,register:t.register,configDeps:n,getConfigDeps:l,prewarm:E,getReferrer:t.getReferrer,setWorkerUrl:e,getGlobalWorkerPool:T,Actor:t.Actor,WorkerPool:p,Dispatcher:w,RequestScheduler:t.RequestScheduler,ThrottledInvoker:t.ThrottledInvoker}});var en=oa,De;class Yu{constructor(i){S(this,De,[]);this.enabled=!0,this.renderer=i}get passes(){return o(this,De)}get length(){return this.passes.length}resize(i,e){var r;const s=o(this,De).length;for(let n=0;n<s;n++){const l=o(this,De)[n];(r=l.resize)==null||r.call(l,i,e)}}addPass(i){o(this,De).push(i)}removePass(i){o(this,De).indexOf(i)>-1&&(o(this,De).splice(i,1),i.destroy())}removePasses(){o(this,De).forEach(i=>i.destroy()),y(this,De,[])}getPass(i){return o(this,De).find(e=>e.id===i)}prerender(i,e){const s=o(this,De).filter(r=>r.enabled&&r.prerender===!0);if(s.length>0){const r=s.length;for(let n=0;n<r;n++)s[n].render(i,e);this.renderer.resetState()}}render(i,e){const s=o(this,De).filter(r=>r.enabled&&r.prerender!==!0);if(s.length>0){const r=s.length;for(let n=0;n<r;n++)s[n].render(i,e);this.renderer.resetState()}}destroy(){o(this,De).forEach(i=>i.destroy())}}De=new WeakMap;const Lh="Pass subclass must define virtual methods";var cr;class Ct{constructor(i,e,s={}){S(this,cr,!0);this.id=i,this.renderer=e,this.options=s,this.setMaskPass(this.options.maskPass)}get enabled(){return o(this,cr)}set enabled(i){y(this,cr,i)}setMaskPass(i){this.maskPass=i}render(i,e,s){throw new Error(Lh)}destroy(){throw new Error(Lh)}}cr=new WeakMap;var Lo=`#define GLSLIFY 1
attribute vec2 uv;attribute vec3 position;uniform vec3 cameraPosition;uniform mat4 viewMatrix;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;varying vec2 vUv;void main(){vUv=vec2(uv.x,1.0-uv.y);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,ko=`#defines
precision highp float;
#define GLSLIFY 1
varying vec2 vUv;uniform sampler2D u_image0;uniform sampler2D u_image1;
#include <decodeFloat>
#if RENDER_TYPE == 1
uniform vec4 dataRange;vec4 getColor(const vec2 uv){vec2 rg=texture2D(u_image0,uv).rg;vec2 data=rg*(dataRange.yw-dataRange.xz)+dataRange.xz;return vec4(data.xy,0.0,1.0);}
#elif RENDER_TYPE == 0
uniform vec2 dataRange;vec4 getColor(const vec2 uv){float r=texture2D(u_image0,uv).r;float rf=r*(dataRange.y-dataRange.x)+dataRange.x;return vec4(rf,0.0,0.0,1.0);}
#elif RENDER_TYPE == 2
vec4 getColor(const vec2 uv){vec4 rgba=texture2D(u_image0,uv).rgba;float r=decode_float(rgba,LITTLE_ENDIAN);return vec4(r,0.0,0.0,1.0);}
#else
vec4 getColor(const vec2 uv){return texture2D(u_image0,uv).rgba;}
#endif
void main(){gl_FragColor=getColor(vUv);}`,Ku=`#define GLSLIFY 1
highp float rand(vec2 co){highp float a=12.9898;highp float b=78.233;highp float c=43758.5453;highp float dt=dot(co.xy,vec2(a,b));highp float sn=mod(dt,3.14);return fract(sin(sn)*c);}`,Xu=`#define GLSLIFY 1
const vec2 bitEnc=vec2(1.0,255.0);const vec2 bitDec=1.0/bitEnc;vec4 toRGBA(const vec2 pos){vec2 rg=bitEnc*pos.x;rg=fract(rg);rg-=rg.yy*vec2(1.0/255.0,0.0);vec2 ba=bitEnc*pos.y;ba=fract(ba);ba-=ba.yy*vec2(1.0/255.0,0.0);return vec4(rg,ba);}`,Qu=`#define GLSLIFY 1
#define FLOAT_MAX 1.70141184e38
#define FLOAT_MIN 1.17549435e-38
lowp vec4 encode_float(highp float v){highp float av=abs(v);if(av<FLOAT_MIN){return vec4(0.0,0.0,0.0,0.0);}else if(v>FLOAT_MAX){return vec4(127.0,128.0,0.0,0.0)/255.0;}else if(v<-FLOAT_MAX){return vec4(255.0,128.0,0.0,0.0)/255.0;}highp vec4 c=vec4(0,0,0,0);highp float e=floor(log2(av));highp float m=av*pow(2.0,-e)-1.0;c[1]=floor(128.0*m);m-=c[1]/128.0;c[2]=floor(32768.0*m);m-=c[2]/32768.0;c[3]=floor(8388608.0*m);highp float ebias=e+127.0;c[0]=floor(ebias/2.0);ebias-=c[0]*2.0;c[1]+=floor(ebias)*128.0;c[0]+=128.0*step(0.0,-v);return c/255.0;}`,Ju=`#define GLSLIFY 1
const vec2 bitEnc=vec2(1.0,255.0);const vec2 bitDec=1.0/bitEnc;vec2 fromRGBA(const vec4 color){vec4 rounded_color=floor(color*255.0+0.5)/255.0;float x=dot(rounded_color.rg,bitDec);float y=dot(rounded_color.ba,bitDec);return vec2(x,y);}`,ef=`#define GLSLIFY 1
vec4 floatsToBytes(vec4 inputFloats,bool littleEndian){vec4 bytes=vec4(inputFloats*255.0);return(littleEndian? bytes.abgr: bytes);}float decode_float(vec4 v,bool littleEndian){vec4 bits=floatsToBytes(v,littleEndian);float sign=mix(-1.0,1.0,step(bits[3],128.0));float expo=floor(mod(bits[3]+0.2,128.0))*2.0+floor((bits[2]+0.2)/128.0)-127.0;float sig=bits[0]+bits[1]*256.0+floor(mod(bits[2]+0.2,128.0))*256.0*256.0;return sign*(1.0+sig/8388607.0)*pow(2.0,expo);}`,Ft=Object.freeze({__proto__:null,decode:Ju,decodeFloat:ef,encode:Xu,encodeFloat:Qu,random:Ku});function la(t){return Me.typeOf(t)==="function"}function tf(t,i){const e=t.length-1;let s=0,r=e,n=0,l,c;for(;s<=r;)if(n=Math.floor((s+r)/2),l=t[n],c=t[n+1],l<=i){if(n===e||i<c)return n;s=n+1}else if(l>i)r=n-1;else throw new Error("Input is not a number.");return 0}let Wr;function ma(t){return Wr||(Wr=document.createElement("a")),Wr.href=t,Wr.href}const ns=function(){const i=new Uint8Array([170,187]);return new Uint16Array(i.buffer)[0]===48042}();function sf(t){return typeof ImageBitmap<"u"&&t instanceof ImageBitmap}function rf(t){return((t==null?void 0:t.ImageDescription)||"").split(";").filter(r=>r!=="").map(r=>r.split(",").map(n=>parseFloat(n)))}function nf(t,i){const e=[];for(const s in t)s in i||e.push(s);return e}function af(t,i){return t[0]<=i[2]&&t[2]>=i[0]&&t[1]<=i[3]&&t[3]>=i[1]}function hf(t,i){return t[0]<=i[0]&&i[2]<=t[2]&&t[1]<=i[1]&&i[3]<=t[3]}function of(t,i){return hf(t,i)||af(t,i)}function ed(t){const i=t.length;let e=0;const s=[];for(;e<i;e++){const r=t[e],n=r.geometry.coordinates,l=r.geometry.type;if(l==="Polygon"){const c=qr.flatten(r.geometry.coordinates),d=new Float32Array(c.vertices),p=qr(c.vertices,c.holes,c.dimensions);s.push({index:{data:p.length<65536?new Uint16Array(p):new Uint32Array(p)},position:{data:d,size:2}})}else if(l==="MultiPolygon")for(let c=0;c<n.length;c++){const d=n[c],p=qr.flatten(d),g=new Float32Array(p.vertices),v=qr(p.vertices,p.holes,p.dimensions);s.push({index:{data:v.length<65536?new Uint16Array(v):new Uint32Array(v)},position:{data:g,size:2}})}}return s}var li,et,tt,ur,Wh;let lf=(Wh=class extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,li,void 0);S(this,et,void 0);S(this,tt,void 0);S(this,ur,void 0);this.prerender=!0,y(this,ur,Me.uid("ColorComposePass")),y(this,li,new Rt(s,{vertexShader:Lo,fragmentShader:ko,uniforms:{u_image0:{value:void 0},dataRange:{value:void 0}},defines:[`RENDER_TYPE ${this.options.bandType}`,`LITTLE_ENDIAN ${ns}`],includes:Ft}));const n={width:this.renderer.width,height:this.renderer.height,minFilter:s.gl.NEAREST,magFilter:s.gl.NEAREST,type:this.renderer.gl.FLOAT,format:this.renderer.gl.RGBA,internalFormat:this.renderer.isWebGL2?this.renderer.gl.RGBA32F:this.renderer.gl.RGBA,stencil:!0};y(this,et,new St(s,{...n,name:"currentRenderTargetTexture"})),y(this,tt,new St(s,{...n,name:"nextRenderTargetTexture"}))}resize(e,s){var r,n;(r=o(this,et))==null||r.resize(e,s),(n=o(this,tt))==null||n.resize(e,s)}get renderTarget(){return{current:o(this,et),next:o(this,tt)}}get textures(){var e,s;return{current:(e=o(this,et))==null?void 0:e.texture,next:(s=o(this,tt))==null?void 0:s.texture}}renderTexture(e,s,r,n){var d,p,g,v,w,_;e&&(e.clear(),e.bind(),this.renderer.attributes.depth&&e.depth&&(this.renderer.state.enable(this.renderer.gl.DEPTH_TEST),this.renderer.state.setDepthMask(!0)),this.renderer.setViewport(e.width,e.height));const{stencilConfigForOverlap:l}=this.options,c=s.cameras.camera;if(n){const E=n.getVisibleCoordinates().slice().reverse();if(!E.length)return;let A;this.maskPass&&(A=this.maskPass.render(s,r));const[R,U]=l(E);for(let C=0;C<U.length;C++){const I=U[C],O=n.getTile(I);if(!(O&&O.hasData()))continue;const V=I.getTileProjBounds();if(!V)continue;const X=O.createMesh(o(this,ur),V,this.renderer,o(this,li)).getMesh(),se=[];for(const[ie,W]of O.textures)(d=W.userData)!=null&&d.dataRange&&Array.isArray((p=W.userData)==null?void 0:p.dataRange)&&se.push(...W.userData.dataRange),(v=(g=this.options).isRasterize)!=null&&v.call(g)&&(W.options.minFilter!==this.renderer.gl.NEAREST||W.options.magFilter!==this.renderer.gl.NEAREST)&&W.setOptions({minFilter:this.renderer.gl.NEAREST,magFilter:this.renderer.gl.NEAREST}),X.program.setUniform(`u_image${ie}`,W);if(se.length>0&&X.program.setUniform("dataRange",se),X.updateMatrix(),X.worldMatrixNeedsUpdate=!1,X.worldMatrix.multiply(s.scene.worldMatrix,X.localMatrix),R[I.overscaledZ],X.draw({...s,camera:c}),(_=(w=this.options).isRasterize)!=null&&_.call(w))for(const[ie,W]of O.textures)W.setOptions({minFilter:this.renderer.gl.LINEAR,magFilter:this.renderer.gl.LINEAR})}this.renderer.clear(!1,!1,!0),A||this.renderer.state.disable(this.renderer.gl.STENCIL_TEST)}e&&e.unbind()}render(e,s){const{source:r}=this.options,n=r.sourceCache;Array.isArray(n)?n.length===2?(this.renderTexture(o(this,et),e,s,n[0]),this.renderTexture(o(this,tt),e,s,n[1])):(this.renderTexture(o(this,et),e,s,n[0]),this.renderTexture(o(this,tt),e,s,n[0])):(this.renderTexture(o(this,et),e,s,n),this.renderTexture(o(this,tt),e,s,n))}destroy(){o(this,li)&&(o(this,li).destroy(),y(this,li,null)),o(this,et)&&(o(this,et).destroy(),y(this,et,null)),o(this,tt)&&(o(this,tt).destroy(),y(this,tt,null))}},li=new WeakMap,et=new WeakMap,tt=new WeakMap,ur=new WeakMap,Wh);var Tr=`#define GLSLIFY 1
#defines
attribute vec2 uv;attribute vec3 position;uniform vec2 resolution;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,cf=`#defines
precision highp float;
#define GLSLIFY 1
uniform sampler2D u_texture;uniform sampler2D u_textureNext;uniform sampler2D colorRampTexture;uniform float u_fade_t;uniform vec2 u_image_res;uniform vec2 colorRange;uniform bool useDisplayRange;uniform vec2 displayRange;uniform float opacity;varying vec2 vUv;
#include <decodeFloat>
vec4 calcTexture(const vec2 puv){vec4 color0=texture2D(u_texture,puv);vec4 color1=texture2D(u_textureNext,puv);return mix(color0,color1,u_fade_t);}
#if RENDER_TYPE == 1
vec2 decodeValue(const vec2 vc){vec4 rgba=calcTexture(vc);return rgba.rg;}
#else
float decodeValue(const vec2 vc){return calcTexture(vc).r;}
#endif
#if RENDER_TYPE == 1
vec2 bilinear(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);vec2 tl=decodeValue(vc);vec2 tr=decodeValue(vc+vec2(px.x,0));vec2 bl=decodeValue(vc+vec2(0,px.y));vec2 br=decodeValue(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}
#else
float bilinear(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=decodeValue(vc);float tr=decodeValue(vc+vec2(px.x,0));float bl=decodeValue(vc+vec2(0,px.y));float br=decodeValue(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}
#endif
#if RENDER_TYPE == 1
float getValue(const vec2 uv){vec2 rg=bilinear(uv);return length(rg);}
#else
float getValue(const vec2 uv){return bilinear(uv);}
#endif
void main(){vec2 uv=vUv;if(calcTexture(uv).a==0.0){discard;}float value=getValue(uv);float value_t=(value-colorRange.x)/(colorRange.y-colorRange.x);vec2 ramp_pos=vec2(value_t,0.5);vec4 color=texture2D(colorRampTexture,ramp_pos);bool display=true;if(useDisplayRange){display=value<=displayRange.y&&value>=displayRange.x;}if(display){gl_FragColor=vec4(floor(255.0*color*opacity)/255.0);}else{gl_FragColor=vec4(0.0,0.0,0.0,0.0);}}`,ci,ze,ui;class uf extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,ci,void 0);S(this,ze,void 0);S(this,ui,void 0);this.prerender=!1,y(this,ci,new Rt(s,{vertexShader:Tr,fragmentShader:cf,uniforms:{opacity:{value:1},u_fade_t:{value:0},displayRange:{value:new st(-1/0,1/0)},u_texture:{value:this.options.texture},u_textureNext:{value:this.options.textureNext},colorRampTexture:{value:null}},defines:[`RENDER_TYPE ${this.options.bandType}`,`LITTLE_ENDIAN ${ns}`],includes:Ft,transparent:!0})),y(this,ui,new Ye(s,{position:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},uv:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},index:{size:1,data:new Uint16Array([0,1,2,2,1,3])}})),y(this,ze,new gt(s,{mode:s.gl.TRIANGLES,program:o(this,ci),geometry:o(this,ui)}))}render(e,s){var l,c;const r=this.renderer.attributes;this.renderer.setViewport(this.renderer.width*r.dpr,this.renderer.height*r.dpr);const n=e.cameras.planeCamera;if(s&&o(this,ze)){const d=Me.pick(s,["opacity","colorRange","dataRange","colorRampTexture","useDisplayRange","displayRange"]);Object.keys(d).forEach(g=>{var v;d[g]!==void 0&&((v=o(this,ze))==null||v.program.setUniform(g,d[g]))});const p=((c=(l=this.options.source)==null?void 0:l.getFadeTime)==null?void 0:c.call(l))||0;o(this,ze).program.setUniform("u_image_res",new st(this.options.texture.width,this.options.texture.height)),o(this,ze).program.setUniform("u_fade_t",p),o(this,ze).updateMatrix(),o(this,ze).worldMatrixNeedsUpdate=!1,o(this,ze).worldMatrix.multiply(n.worldMatrix,o(this,ze).localMatrix),o(this,ze).draw({...e,camera:n})}}destroy(){o(this,ze)&&(o(this,ze).destroy(),y(this,ze,null)),o(this,ci)&&(o(this,ci).destroy(),y(this,ci,null)),o(this,ui)&&(o(this,ui).destroy(),y(this,ui,null))}}ci=new WeakMap,ze=new WeakMap,ui=new WeakMap;var ff=`precision highp float;
#define GLSLIFY 1
uniform sampler2D u_texture;uniform sampler2D u_textureNext;uniform float u_fade_t;uniform float opacity;varying vec2 vUv;void main(){vec2 uv=vUv;vec4 color0=texture2D(u_texture,vUv);vec4 color1=texture2D(u_textureNext,vUv);vec4 color=mix(color0,color1,u_fade_t);gl_FragColor=vec4(floor(255.0*color*opacity)/255.0);}`,fi,Ge,di;class df extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,fi,void 0);S(this,Ge,void 0);S(this,di,void 0);this.prerender=!1,y(this,fi,new Rt(s,{vertexShader:Tr,fragmentShader:ff,uniforms:{opacity:{value:1},u_fade_t:{value:0},u_texture:{value:this.options.texture},u_textureNext:{value:this.options.textureNext}},includes:Ft,transparent:!0})),y(this,di,new Ye(s,{position:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},uv:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},index:{size:1,data:new Uint16Array([0,1,2,2,1,3])}})),y(this,Ge,new gt(s,{mode:s.gl.TRIANGLES,program:o(this,fi),geometry:o(this,di)}))}render(e,s){var l,c;const r=this.renderer.attributes;this.renderer.setViewport(this.renderer.width*r.dpr,this.renderer.height*r.dpr);const n=e.cameras.planeCamera;if(s&&o(this,Ge)){const d=((c=(l=this.options.source)==null?void 0:l.getFadeTime)==null?void 0:c.call(l))||0,p=Me.pick(s,["opacity"]);Object.keys(p).forEach(g=>{var v;p[g]!==void 0&&((v=o(this,Ge))==null||v.program.setUniform(g,p[g]))}),o(this,Ge).program.setUniform("u_fade_t",d),o(this,Ge).updateMatrix(),o(this,Ge).worldMatrixNeedsUpdate=!1,o(this,Ge).worldMatrix.multiply(n.worldMatrix,o(this,Ge).localMatrix),o(this,Ge).draw({...e,camera:n})}}destroy(){o(this,Ge)&&(o(this,Ge).destroy(),y(this,Ge,null)),o(this,fi)&&(o(this,fi).destroy(),y(this,fi,null)),o(this,di)&&(o(this,di).destroy(),y(this,di,null))}}fi=new WeakMap,Ge=new WeakMap,di=new WeakMap;var pf=`precision highp float;
#define GLSLIFY 1
varying vec2 vUv;uniform sampler2D u_image0;vec4 getColor(const vec2 uv){return texture2D(u_image0,uv).rgba;}void main(){gl_FragColor=getColor(vUv);}`,pi,lt,kt,fr;class gf extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,pi,void 0);S(this,lt,void 0);S(this,kt,void 0);S(this,fr,void 0);this.prerender=!0,y(this,fr,Me.uid("ComposePass")),y(this,pi,new Rt(s,{vertexShader:Lo,fragmentShader:pf,uniforms:{u_image0:{value:void 0}},includes:Ft}));const n={width:this.renderer.width,height:this.renderer.height,minFilter:s.gl.NEAREST,magFilter:s.gl.NEAREST,type:this.renderer.gl.UNSIGNED_BYTE,format:this.renderer.gl.RGBA,generateMipmaps:!0,internalFormat:this.renderer.gl.RGBA,stencil:!0};y(this,lt,new St(s,{...n,name:"currentRenderTargetTexture"})),y(this,kt,new St(s,{...n,name:"nextRenderTargetTexture"}))}resize(e,s){var r,n;(r=o(this,lt))==null||r.resize(e,s),(n=o(this,kt))==null||n.resize(e,s)}get textures(){var e,s;return{current:(e=o(this,lt))==null?void 0:e.texture,next:(s=o(this,kt))==null?void 0:s.texture}}renderTexture(e,s,r,n){e&&(e.clear(),e.bind(),this.renderer.attributes.depth&&e.depth&&(this.renderer.state.enable(this.renderer.gl.DEPTH_TEST),this.renderer.state.setDepthMask(!0)),this.renderer.setViewport(e.width,e.height));const{stencilConfigForOverlap:l}=this.options,c=s.cameras.camera;if(n){const p=n.getVisibleCoordinates().slice().reverse();if(!p.length)return;let g;this.maskPass&&(g=this.maskPass.render(s,r));const[v,w]=l(p);for(let _=0;_<w.length;_++){const T=w[_],E=n.getTile(T);if(!(E&&E.hasData()))continue;const A=T.getTileProjBounds();if(!A)continue;const U=E.createMesh(o(this,fr),A,this.renderer,o(this,pi)).getMesh();for(const[C,I]of E.textures)U.program.setUniform(`u_image${C}`,I);U.updateMatrix(),U.worldMatrixNeedsUpdate=!1,U.worldMatrix.multiply(s.scene.worldMatrix,U.localMatrix),v[T.overscaledZ],U.draw({...s,camera:c})}this.renderer.clear(!1,!1,!0),g||this.renderer.state.disable(this.renderer.gl.STENCIL_TEST)}e&&e.unbind()}render(e,s){const{source:r}=this.options,n=r.sourceCache;Array.isArray(n)?n.length===2?(this.renderTexture(o(this,lt),e,s,n[0]),this.renderTexture(o(this,kt),e,s,n[1])):this.renderTexture(o(this,lt),e,s,n[0]):this.renderTexture(o(this,lt),e,s,n)}destroy(){o(this,lt)&&(o(this,lt).destroy(),y(this,lt,null)),o(this,kt)&&(o(this,kt).destroy(),y(this,kt,null)),o(this,pi)&&(o(this,pi).destroy(),y(this,pi,null))}}pi=new WeakMap,lt=new WeakMap,kt=new WeakMap,fr=new WeakMap;const Yr=256;var gi,ct,ut,dr,Wi,Yi;class Oo extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,gi,void 0);S(this,ct,void 0);S(this,ut,void 0);S(this,dr,void 0);S(this,Wi,void 0);S(this,Yi,void 0);this.prerender=!0,y(this,Wi,Yr),y(this,Yi,Yr),y(this,dr,r.id),y(this,gi,new Rt(s,{vertexShader:Tr,fragmentShader:ko,uniforms:{u_image0:{value:void 0},dataRange:{value:void 0}},defines:[`RENDER_TYPE ${this.options.bandType}`,`LITTLE_ENDIAN ${ns}`],includes:Ft}));const n={width:o(this,Wi),height:o(this,Yi),minFilter:s.gl.NEAREST,magFilter:s.gl.NEAREST,type:this.renderer.gl.FLOAT,format:this.renderer.gl.RGBA,internalFormat:this.renderer.isWebGL2?this.renderer.gl.RGBA32F:this.renderer.gl.RGBA,stencil:!0};y(this,ct,new St(s,{...n,name:"currentRenderTargetTexture"})),y(this,ut,new St(s,{...n,name:"nextRenderTargetTexture"}))}resize(e,s){var r,n;(e!==o(this,Wi)||s!==o(this,Yi))&&((r=o(this,ct))==null||r.resize(e,s),(n=o(this,ut))==null||n.resize(e,s),y(this,Wi,e),y(this,Yi,s))}get textures(){var e,s;return{current:(e=o(this,ct))==null?void 0:e.texture,next:(s=o(this,ut))==null?void 0:s.texture}}renderTexture(e,s,r,n){var Q,X,se,ie,W,oe,le,q;if(!n)return;const{stencilConfigForOverlap:l}=this.options,c=s.cameras.planeCamera,p=n.getVisibleCoordinates().slice().reverse();if(!p.length)return;let g=1/0,v=1/0,w=-1/0,_=-1/0,T=1/0,E=-1/0;for(let _e=0;_e<p.length;_e++){const Y=p[_e],me=Y.getTileProjBounds();g=Math.min(me.left,g),w=Math.max(me.right,w),T=Math.min(Y.z,T),E=Math.max(Y.z,E),r.u_flip_y?(v=Math.min(me.bottom,v),_=Math.max(me.top,_)):(v=Math.min(me.top,v),_=Math.max(me.bottom,_))}const A=this.options.getTileProjSize(E,p),R=w-g,U=_-v,C=R/A[0],I=U/A[1];if(r.sharedState.u_data_bbox=[g,v,w,_],r.sharedState.u_data_zooms=[T,E],e){e.clear(),e.bind(),this.renderer.attributes.depth&&e.depth&&(this.renderer.state.enable(this.renderer.gl.DEPTH_TEST),this.renderer.state.setDepthMask(!0));let Y=C*(this.options.source.tileSize??Yr),me=I*(this.options.source.tileSize??Yr);r.sharedState.u_tiles_size=[Y,me];const Ke=this.renderer.gl.getParameter(this.renderer.gl.MAX_TEXTURE_SIZE)*.5,Zt=this.renderer.gl.getParameter(this.renderer.gl.MAX_RENDERBUFFER_SIZE)*.5,Te=Math.max(Y,me);Te>Ke?(Y=Ke/Te*Y,me=Ke/Te*me):Te>Zt&&(Y=Zt/Te*Y,me=Zt/Te*me),this.resize(Y,me),this.renderer.setViewport(Y,me)}const[O,V]=l(p);for(let _e=0;_e<V.length;_e++){const Y=V[_e];if(Y){const me=n.getTile(Y);if(!(me&&me.hasData()))continue;const Ke=Y.getTileProjBounds();if(!Ke)continue;const Te=me.createMesh(o(this,dr),Ke,this.renderer,o(this,gi)).planeMesh,Hs=Math.pow(2,E-Y.z);Te.scale.set(1/C*Hs,1/I*Hs,1),r.u_flip_y?Te.position.set((Ke.left-g)/R,1-(Ke.top-v)/U,0):Te.position.set((Ke.left-g)/R,(Ke.top-v)/U,0);const Ce=[];for(const[js,Dt]of me.textures)(Q=Dt.userData)!=null&&Q.dataRange&&Array.isArray((X=Dt.userData)==null?void 0:X.dataRange)&&Ce.push(...Dt.userData.dataRange),Te.program.setUniform(`u_image${js}`,Dt);Ce.length>0&&Te.program.setUniform("dataRange",Ce),Te.updateMatrix(),Te.worldMatrixNeedsUpdate=!1,Te.worldMatrix.multiply(c.worldMatrix,Te.localMatrix);const nt=O[Y.overscaledZ];nt&&(nt.stencil?(this.renderer.state.enable(this.renderer.gl.STENCIL_TEST),this.renderer.state.setStencilFunc((se=nt.func)==null?void 0:se.cmp,(ie=nt.func)==null?void 0:ie.ref,(W=nt.func)==null?void 0:W.mask),this.renderer.state.setStencilOp((oe=nt.op)==null?void 0:oe.fail,(le=nt.op)==null?void 0:le.zfail,(q=nt.op)==null?void 0:q.zpass)):this.renderer.state.disable(this.renderer.gl.STENCIL_TEST)),Te.draw({...s,camera:c})}}e&&e.unbind()}render(e,s){const{source:r}=this.options,n=r.sourceCache;Array.isArray(n)?n.length===2?(this.renderTexture(o(this,ct),e,s,n[0]),this.renderTexture(o(this,ut),e,s,n[1])):(this.renderTexture(o(this,ct),e,s,n[0]),this.renderTexture(o(this,ut),e,s,n[0])):(this.renderTexture(o(this,ct),e,s,n),this.renderTexture(o(this,ut),e,s,n))}destroy(){o(this,gi)&&(o(this,gi).destroy(),y(this,gi,null)),o(this,ct)&&(o(this,ct).destroy(),y(this,ct,null)),o(this,ut)&&(o(this,ut).destroy(),y(this,ut,null))}}gi=new WeakMap,ct=new WeakMap,ut=new WeakMap,dr=new WeakMap,Wi=new WeakMap,Yi=new WeakMap;var mf=`#defines
precision highp float;
#define GLSLIFY 1
uniform sampler2D u_texture;uniform sampler2D u_textureNext;uniform sampler2D u_particles;uniform float u_fade_t;uniform vec2 u_image_res;uniform vec4 u_bbox;uniform vec4 u_data_bbox;uniform float u_rand_seed;uniform float u_drop_rate;uniform float u_drop_rate_bump;uniform float u_speed_factor;uniform bool u_initialize;uniform bool u_flip_y;uniform float u_gl_scale;varying vec2 vUv;
#include <random>
vec4 calcTexture(const vec2 puv){vec4 color0=texture2D(u_texture,puv);vec4 color1=texture2D(u_textureNext,puv);return mix(color0,color1,u_fade_t);}vec2 decodeValue(const vec2 vc){vec4 rgba=calcTexture(vc);return rgba.rg;}vec2 bilinear(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);vec2 tl=decodeValue(vc);vec2 tr=decodeValue(vc+vec2(px.x,0));vec2 bl=decodeValue(vc+vec2(0,px.y));vec2 br=decodeValue(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}vec2 randomPosToGlobePos(vec2 pos){vec2 min_bbox=u_bbox.xy;vec2 max_bbox=u_bbox.zw;return mix(min_bbox,max_bbox,pos);}bool containsXY(vec2 pos,vec4 bbox){float x=pos.x;return(bbox.x<=x&&x<=bbox.z&&bbox.y<=pos.y&&pos.y<=bbox.w);}vec2 update(vec2 pos){vec2 uv=(pos.xy-u_data_bbox.xy)/(u_data_bbox.zw-u_data_bbox.xy);if(u_flip_y){uv=vec2(uv.x,1.0-uv.y);}vec2 velocity=bilinear(uv);float speed=length(velocity);vec2 v=vec2(velocity.x,-velocity.y);if(u_flip_y){v=vec2(velocity.x,velocity.y);}vec2 offset=v*0.0001*u_speed_factor*u_gl_scale;pos=pos+offset;vec2 seed=(pos.xy+vUv)*u_rand_seed;float drop_rate=u_drop_rate+speed*u_drop_rate_bump;float drop=step(1.0-drop_rate,rand(seed));vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));random_pos=randomPosToGlobePos(random_pos);if(!containsXY(pos.xy,u_data_bbox)||!containsXY(pos.xy,u_bbox)||calcTexture(uv).a==0.0){drop=1.0;}pos=mix(pos,random_pos,drop);return pos;}void main(){vec2 pos=texture2D(u_particles,vUv).xy;pos=update(pos);if(u_initialize){pos=randomPosToGlobePos(pos);for(int i=0;i<25;i++){pos=update(pos);}}gl_FragColor=vec4(pos.xy,0.0,1.0);}`,mi,we,vi,ft,Ee,Ki,As,Es,tn;class vf extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,Es);S(this,mi,void 0);S(this,we,void 0);S(this,vi,void 0);S(this,ft,void 0);S(this,Ee,void 0);S(this,Ki,void 0);S(this,As,void 0);this.prerender=!0,y(this,Ki,!0),this.initializeRenderTarget(),y(this,mi,new Rt(s,{vertexShader:Tr,fragmentShader:mf,uniforms:{u_fade_t:{value:0},displayRange:{value:new st(-1/0,1/0)},u_texture:{value:this.options.texture},u_textureNext:{value:this.options.textureNext},u_particles:{value:null}},defines:[`RENDER_TYPE ${this.options.bandType}`,`LITTLE_ENDIAN ${ns}`],includes:Ft,blending:Js.NoBlending,transparent:!0})),y(this,vi,new Ye(s,{position:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},uv:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},index:{size:1,data:new Uint16Array([0,1,2,2,1,3])}})),y(this,we,new gt(s,{mode:s.gl.TRIANGLES,program:o(this,mi),geometry:o(this,vi)}))}resize(){var s,r;const e=ls(this,Es,tn).call(this);(s=o(this,ft))==null||s.resize(e,e),(r=o(this,Ee))==null||r.resize(e,e)}get textures(){var e,s;return{currentParticles:(e=o(this,ft))==null?void 0:e.texture,nextParticles:(s=o(this,Ee))==null?void 0:s.texture}}setInitialize(e){y(this,Ki,e)}initializeRenderTarget(){const e=ls(this,Es,tn).call(this),s=new Float32Array(e**2*4),r=this.options.glScale;for(let l=0;l<s.length;l++)s[l]=Math.random()*r;const n={data:s,width:e,height:e,minFilter:this.renderer.gl.NEAREST,magFilter:this.renderer.gl.NEAREST,type:this.renderer.gl.FLOAT,format:this.renderer.gl.RGBA,internalFormat:this.renderer.isWebGL2?this.renderer.gl.RGBA32F:this.renderer.gl.RGBA,stencil:!1};y(this,ft,new St(this.renderer,{...n,name:"currentUpdateTexture"})),y(this,Ee,new St(this.renderer,{...n,name:"nextUpdateTexture"}))}swapRenderTarget(){[Li(this,ft)._,Li(this,Ee)._]=[o(this,Ee),o(this,ft)]}render(e,s){var c,d,p;const r=this.renderer.attributes,n=e.cameras.planeCamera,l=ls(this,Es,tn).call(this);if((!o(this,As)||o(this,As)!==l)&&(y(this,As,l),this.initializeRenderTarget()),o(this,Ee)&&(o(this,Ee).bind(),r.depth&&o(this,Ee).depth&&(this.renderer.state.enable(this.renderer.gl.DEPTH_TEST),this.renderer.state.setDepthMask(!0)),this.renderer.setViewport(o(this,Ee).width,o(this,Ee).height)),s&&o(this,we)){const g=Me.pick(s,["dataRange","useDisplayRange","displayRange","u_drop_rate","u_drop_rate_bump","u_speed_factor","u_flip_y","u_gl_scale"]);Object.keys(g).forEach(w=>{var _;g[w]!==void 0&&((_=o(this,we))==null||_.program.setUniform(w,g[w]))});const v=((d=(c=this.options.source)==null?void 0:c.getFadeTime)==null?void 0:d.call(c))||0;o(this,we).program.setUniform("u_image_res",new st(this.options.texture.width,this.options.texture.height)),o(this,we).program.setUniform("u_fade_t",v),o(this,we).program.setUniform("u_rand_seed",Math.random()),o(this,we).program.setUniform("u_particles",(p=o(this,ft))==null?void 0:p.texture),o(this,we).program.setUniform("u_bbox",s.extent),o(this,we).program.setUniform("u_initialize",o(this,Ki)),o(this,we).program.setUniform("u_data_bbox",s.sharedState.u_data_bbox),o(this,we).updateMatrix(),o(this,we).worldMatrixNeedsUpdate=!1,o(this,we).worldMatrix.multiply(n.worldMatrix,o(this,we).localMatrix),o(this,we).draw({...e,camera:n})}o(this,Ee)&&o(this,Ee).unbind(),y(this,Ki,!1),this.swapRenderTarget()}destroy(){o(this,we)&&(o(this,we).destroy(),y(this,we,null)),o(this,mi)&&(o(this,mi).destroy(),y(this,mi,null)),o(this,vi)&&(o(this,vi).destroy(),y(this,vi,null)),o(this,ft)&&(o(this,ft).destroy(),y(this,ft,null)),o(this,Ee)&&(o(this,Ee).destroy(),y(this,Ee,null))}}mi=new WeakMap,we=new WeakMap,vi=new WeakMap,ft=new WeakMap,Ee=new WeakMap,Ki=new WeakMap,As=new WeakMap,Es=new WeakSet,tn=function(){return Math.ceil(Math.sqrt(this.options.getParticleNumber()))};var xf=`precision highp float;
#define GLSLIFY 1
uniform sampler2D u_screen;uniform float u_opacity;uniform float u_fade;varying vec2 vUv;void main(){vec4 color=texture2D(u_screen,vUv);gl_FragColor=vec4(floor(255.0*color*u_opacity*u_fade)/255.0);}`,xi,Le,yi;class kh extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,xi,void 0);S(this,Le,void 0);S(this,yi,void 0);this.prerender=!!r.prerender,y(this,xi,new Rt(s,{vertexShader:Tr,fragmentShader:xf,uniforms:{opacity:{value:1},u_fade:{value:1},u_screen:{value:null}},defines:[`RENDER_TYPE ${this.options.bandType}`,`LITTLE_ENDIAN ${ns}`],includes:Ft,transparent:!0,blending:r.enableBlend?Js.CustomBlending:Js.NoBlending,blendFunc:{src:this.renderer.gl.ONE,dst:this.renderer.gl.ONE_MINUS_SRC_ALPHA},blendEquation:{modeAlpha:this.renderer.gl.FUNC_ADD,modeRGB:this.renderer.gl.FUNC_ADD}})),y(this,yi,new Ye(s,{position:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},uv:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},index:{size:1,data:new Uint16Array([0,1,2,2,1,3])}})),y(this,Le,new gt(s,{mode:s.gl.TRIANGLES,program:o(this,xi),geometry:o(this,yi)}))}get renderTarget(){if(this.options.particlesPass&&this.prerender)return this.options.particlesPass.renderTarget}render(e,s){var r,n,l;if(this.renderTarget)this.renderTarget.bind(),this.renderer.setViewport(this.renderTarget.width,this.renderTarget.height);else{const c=this.renderer.attributes;this.renderer.setViewport(this.renderer.width*c.dpr,this.renderer.height*c.dpr)}if(s&&o(this,Le)){const c=e.cameras.planeCamera;o(this,Le).program.setUniform("u_fade",1),o(this,Le).program.setUniform("u_opacity",this.prerender?s.fadeOpacity:s.opacity),o(this,Le).program.setUniform("u_screen",this.prerender?(r=this.options.particlesPass)==null?void 0:r.textures.backgroundTexture:(n=this.options.particlesPass)==null?void 0:n.textures.screenTexture),o(this,Le).updateMatrix(),o(this,Le).worldMatrixNeedsUpdate=!1,o(this,Le).worldMatrix.multiply(c.worldMatrix,o(this,Le).localMatrix),o(this,Le).draw({...e,camera:c})}this.renderTarget&&this.renderTarget.unbind(),this.options.particlesPass&&!this.prerender&&((l=this.options.particlesPass)==null||l.swapRenderTarget())}destroy(){o(this,Le)&&(o(this,Le).destroy(),y(this,Le,null)),o(this,xi)&&(o(this,xi).destroy(),y(this,xi,null)),o(this,yi)&&(o(this,yi).destroy(),y(this,yi,null))}}xi=new WeakMap,Le=new WeakMap,yi=new WeakMap;var yf=`#define GLSLIFY 1
attribute vec2 reference;attribute float a_index;uniform vec2 resolution;uniform mat4 modelViewMatrix;uniform mat4 viewMatrix;uniform mat4 modelMatrix;uniform mat4 projectionMatrix;uniform sampler2D u_particles;uniform sampler2D u_particles_next;uniform float u_particleSize;uniform float u_particlesRes;varying vec2 v_particle_pos;void main(){float v_index=floor(a_index/6.0);vec2 uv=reference;vec4 color=texture2D(u_particles,uv);vec4 color1=texture2D(u_particles_next,uv);v_particle_pos=mix(color.rg,color1.rg,0.0);gl_PointSize=u_particleSize;gl_Position=projectionMatrix*modelViewMatrix*vec4(v_particle_pos,0.0,1.0);}`,bf=`#defines
precision highp float;
#define GLSLIFY 1
uniform sampler2D u_texture;uniform sampler2D u_textureNext;uniform vec2 u_colorRange;uniform sampler2D u_colorRamp;uniform vec4 u_bbox;uniform vec4 u_data_bbox;uniform float u_fade_t;uniform vec2 u_image_res;varying vec2 v_particle_pos;vec4 calcTexture(const vec2 puv){vec4 color0=texture2D(u_texture,puv);vec4 color1=texture2D(u_textureNext,puv);return mix(color0,color1,u_fade_t);}
#if RENDER_TYPE == 1
vec2 decodeValue(const vec2 vc){vec4 rgba=calcTexture(vc);return rgba.rg;}
#else
float decodeValue(const vec2 vc){return calcTexture(vc).r;}
#endif
vec2 bilinear(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);vec2 tl=decodeValue(vc);vec2 tr=decodeValue(vc+vec2(px.x,0));vec2 bl=decodeValue(vc+vec2(0,px.y));vec2 br=decodeValue(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}bool containsXY(vec2 pos,vec4 bbox){float x=pos.x;return(bbox.x<x&&x<bbox.z&&bbox.y<pos.y&&pos.y<bbox.w);}void main(){vec2 pos=v_particle_pos;if(!containsXY(pos.xy,u_data_bbox)||!containsXY(pos.xy,u_bbox)||calcTexture(pos).a==0.0){discard;}vec2 velocity=bilinear(pos);float value=length(velocity);float value_t=(value-u_colorRange.x)/(u_colorRange.y-u_colorRange.x);vec2 ramp_pos=vec2(value_t,0.5);vec4 color=texture2D(u_colorRamp,ramp_pos);float distance=length(2.0*gl_PointCoord-1.0);if(distance>1.0){discard;}gl_FragColor=vec4(floor(255.0*color*color.a)/255.0);}`,Ss,Rs,bi,ye,wi,dt,_t;class wf extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,Ss,!0);S(this,Rs,void 0);S(this,bi,void 0);S(this,ye,void 0);S(this,wi,void 0);S(this,dt,void 0);S(this,_t,void 0);this.initializeRenderTarget(),y(this,bi,new Rt(s,{vertexShader:yf,fragmentShader:bf,uniforms:{u_fade_t:{value:0},displayRange:{value:new st(-1/0,1/0)},u_texture:{value:this.options.texture},u_textureNext:{value:this.options.textureNext},u_particles:{value:null},u_particleSize:{value:2},u_particlesRes:{value:0}},defines:[`RENDER_TYPE ${this.options.bandType}`,`LITTLE_ENDIAN ${ns}`],includes:Ft,transparent:!0,blending:Js.NoBlending,blendFunc:{src:this.renderer.gl.ONE,dst:this.renderer.gl.ONE_MINUS_SRC_ALPHA},blendEquation:{modeAlpha:this.renderer.gl.FUNC_ADD,modeRGB:this.renderer.gl.FUNC_ADD}}));const{particleIndices:n,particleReferences:l}=this.getParticleBuffer();y(this,wi,new Ye(s,{a_index:{size:1,data:n},reference:{size:2,data:l}})),y(this,ye,new gt(s,{mode:s.gl.POINTS,program:o(this,bi),geometry:o(this,wi)}))}get prerender(){return o(this,Ss)}set prerender(e){y(this,Ss,e)}get textures(){var e,s;return{screenTexture:(e=o(this,dt))==null?void 0:e.texture,backgroundTexture:(s=o(this,_t))==null?void 0:s.texture}}get renderTarget(){return o(this,Ss)&&o(this,dt)}resetParticles(){var e,s;(e=o(this,dt))==null||e.clear(),(s=o(this,_t))==null||s.clear()}getParticleBuffer(){const e=Math.ceil(Math.sqrt(this.options.getParticleNumber()));this.particleStateResolution=e,y(this,Rs,e*e);const s=o(this,Rs),r=new Float32Array(s),n=new Float32Array(s*2);for(let l=0;l<s;l++){const c=l%e/e,d=Math.trunc(l/e)/e;n.set([c,d],2*l),r[l]=l}return{particleIndices:r,particleReferences:n}}initializeRenderTarget(){const e={width:this.renderer.width,height:this.renderer.height,minFilter:this.renderer.gl.LINEAR,magFilter:this.renderer.gl.LINEAR,type:this.renderer.gl.UNSIGNED_BYTE,format:this.renderer.gl.RGBA,stencil:!0,premultipliedAlpha:!1};y(this,dt,new St(this.renderer,{...e,name:"screenTexture"})),y(this,_t,new St(this.renderer,{...e,name:"backgroundTexture"}))}swapRenderTarget(){[Li(this,dt)._,Li(this,_t)._]=[o(this,_t),o(this,dt)]}render(e,s){var l,c;if(this.renderTarget)this.renderTarget.bind(),this.renderer.setViewport(this.renderTarget.width,this.renderTarget.height);else{const d=this.renderer.attributes;this.renderer.setViewport(this.renderer.width*d.dpr,this.renderer.height*d.dpr)}const{camera:r}=e.cameras;let n;if(this.maskPass&&(n=this.maskPass.render(e,s)),s&&o(this,ye)){o(this,ye).program.setUniform("u_image_res",new st(this.options.texture.width,this.options.texture.height));const d=((c=(l=this.options.source)==null?void 0:l.getFadeTime)==null?void 0:c.call(l))||0;o(this,ye).program.setUniform("u_fade_t",d),o(this,ye).program.setUniform("u_colorRamp",s.colorRampTexture),o(this,ye).program.setUniform("u_colorRange",s.colorRange);const p=this.options.getParticles();o(this,ye).program.setUniform("u_particles",p.currentParticles),o(this,ye).program.setUniform("u_particles_next",p.nextParticles),o(this,ye).program.setUniform("u_particlesRes",o(this,Rs));const g=s.sharedState;o(this,ye).program.setUniform("u_bbox",s.extent),o(this,ye).program.setUniform("u_data_bbox",g.u_data_bbox),o(this,ye).program.setUniform("u_flip_y",s.u_flip_y),o(this,ye).program.setUniform("u_gl_scale",s.u_gl_scale),o(this,ye).updateMatrix(),o(this,ye).worldMatrixNeedsUpdate=!1,o(this,ye).worldMatrix.multiply(e.scene.worldMatrix,o(this,ye).localMatrix),o(this,ye).draw({...e,camera:r})}n||this.renderer.state.disable(this.renderer.gl.STENCIL_TEST),this.renderTarget&&this.renderTarget.unbind()}destroy(){o(this,ye)&&(o(this,ye).destroy(),y(this,ye,null)),o(this,bi)&&(o(this,bi).destroy(),y(this,bi,null)),o(this,wi)&&(o(this,wi).destroy(),y(this,wi,null)),o(this,dt)&&(o(this,dt).destroy(),y(this,dt,null)),o(this,_t)&&(o(this,_t).destroy(),y(this,_t,null))}}Ss=new WeakMap,Rs=new WeakMap,bi=new WeakMap,ye=new WeakMap,wi=new WeakMap,dt=new WeakMap,_t=new WeakMap;var _f=`#define GLSLIFY 1
#defines
attribute vec2 uv;attribute vec3 position;uniform vec2 resolution;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;varying vec2 vUv;void main(){vUv=vec2(uv.x,1.0-uv.y);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,Tf=`precision highp float;
#define GLSLIFY 1
uniform sampler2D u_texture;uniform sampler2D u_textureNext;uniform float u_fade_t;varying vec2 vUv;void main(){vec2 uv=vUv;vec4 color0=texture2D(u_texture,vUv);vec4 color1=texture2D(u_textureNext,vUv);vec4 color=mix(color0,color1,u_fade_t);gl_FragColor=color;}`,_i,qe,Ti,Ze,Xi,Qi;class Oh extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,_i,void 0);S(this,qe,void 0);S(this,Ti,void 0);S(this,Ze,void 0);S(this,Xi,void 0);S(this,Qi,void 0);this.prerender=!0,y(this,_i,new Rt(s,{vertexShader:_f,fragmentShader:Tf,uniforms:{u_fade_t:{value:0},u_texture:{value:this.options.texture},u_textureNext:{value:this.options.textureNext}},includes:Ft,transparent:!0})),y(this,Ti,new Ye(s,{position:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},uv:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},index:{size:1,data:new Uint16Array([0,1,2,2,1,3])}})),y(this,qe,new gt(s,{mode:s.gl.TRIANGLES,program:o(this,_i),geometry:o(this,Ti)}));const n={width:this.renderer.width,height:this.renderer.height,minFilter:s.gl.NEAREST,magFilter:s.gl.NEAREST,type:this.renderer.gl.UNSIGNED_BYTE,format:this.renderer.gl.RGBA,generateMipmaps:!0,internalFormat:this.renderer.gl.RGBA,stencil:!1};r.useFloatTexture&&(n.type=this.renderer.gl.FLOAT,n.internalFormat=this.renderer.isWebGL2?this.renderer.gl.RGBA32F:this.renderer.gl.RGBA),y(this,Ze,new St(s,{...n,name:"pickerRenderTargetTexture"}))}resize(e,s){var r;(r=o(this,Ze))==null||r.resize(e,s)}render(e=o(this,Xi),s=o(this,Qi),r){return new Promise(n=>{var c,d;if(!o(this,Ze)||!o(this,qe))return n(null);y(this,Xi,o(this,Xi)!==e?e:o(this,Xi)),y(this,Qi,o(this,Qi)!==s?s:o(this,Qi));const l=e.cameras.planeCamera;if(o(this,Ze).clear(),o(this,Ze).bind(),this.renderer.setViewport(o(this,Ze).width,o(this,Ze).height),s){const p=((d=(c=this.options.source)==null?void 0:c.getFadeTime)==null?void 0:d.call(c))||0;if(o(this,qe).program.setUniform("u_fade_t",p),o(this,qe).updateMatrix(),o(this,qe).worldMatrixNeedsUpdate=!1,o(this,qe).worldMatrix.multiply(l.worldMatrix,o(this,qe).localMatrix),o(this,qe).draw({...e,camera:l}),r){const g=this.options.useFloatTexture?new Float32Array(4):new Uint8Array(4);this.renderer.gl.readPixels(r[0],r[1],1,1,this.renderer.gl.RGBA,this.options.useFloatTexture?this.renderer.gl.FLOAT:this.renderer.gl.UNSIGNED_BYTE,g),n(g)}else n(null)}else n(null);o(this,Ze).unbind()})}destroy(){o(this,qe)&&(o(this,qe).destroy(),y(this,qe,null)),o(this,_i)&&(o(this,_i).destroy(),y(this,_i,null)),o(this,Ti)&&(o(this,Ti).destroy(),y(this,Ti,null)),o(this,Ze)&&(o(this,Ze).destroy(),y(this,Ze,null))}}_i=new WeakMap,qe=new WeakMap,Ti=new WeakMap,Ze=new WeakMap,Xi=new WeakMap,Qi=new WeakMap;function Mf(t){if(Array.isArray(t)&&t.length>3){const i=t[0],e=t[1],s=[];for(let r=3;r<t.length;r+=2){const n=t[r],l=t[r+1];s.push({key:n,value:l})}return{operator:i,interpolation:{name:e[0],base:e[1]},input:s}}else return console.warn("[wind-core]: style-parser style config invalid"),{}}function Af(t){if(Array.isArray(t)&&t.length>3){const i=t[0],e=t[1],s=[];for(let r=3;r<t.length;r+=2){const n=t[r],l=t[r+1];s.push({key:n,value:l})}return{operator:i,interpolation:{name:e[0],base:e[1]},input:s}}else return console.warn("[wind-core]: style-parser style config invalid"),{}}function Bh(t,i,e,s,r,n,l){for(let c=0;c<t.length;c+=1){const d=t[c].key,p=t[c].value;n.addColorStop((d-i)/(e-i),p)}l.fillStyle=n,l.fillRect(0,0,s,r)}function Ef(t,i,e,s,r,n){for(let l=0;l<t.length;l+=1){const c=t[l].key;let d=c;l<t.length-1?d=t[l+1].key:d=e;const p=t[l].value,g=(c-i)/(e-i)*s,v=(d-i)/(e-i)*s;n.fillStyle=p,n.fillRect(g,0,v-g,1)}}function Sf(t,i){const e=document.createElement("canvas"),s=e.getContext("2d",{willReadFrequently:!0}),{input:r,interpolation:n}=Mf(i);if(s&&r&&Array.isArray(r)){const l=r.map(_=>parseFloat(_.key)),c=[Math.min(...l),Math.max(...l)],[d,p]=[t[0]||c[0],t[1]||c[1]],g=256,v=1;e.width=g,e.height=v;const w=s.createLinearGradient(0,0,g,0);if((n==null?void 0:n.name)==="linear")Bh(r,d,p,g,v,w,s);else if((n==null?void 0:n.name)==="step")if((n==null?void 0:n.base)===!0||Me.isNumber(n==null?void 0:n.base)){const _=Number(n==null?void 0:n.base);Bh(r,d,p,g,v,w,s);const T=Math.round((p-d)/_),E=document.createElement("canvas"),A=E.getContext("2d",{willReadFrequently:!0});E.width=g,E.height=v;for(let R=0;R<T;R++){let U=R;R<T-1?U=R+1:U=T;const C=Math.round(R/T*g),I=s.getImageData(C,0,1,1).data,O=Math.round(U/T*g);A.fillStyle=`rgba(${I[0]}, ${I[1]}, ${I[2]}, ${I[3]/255})`,A.fillRect(C,0,O-C,v)}return{data:new Uint8Array(A.getImageData(0,0,g,v).data),colorRange:c}}else(n==null?void 0:n.base)===!1&&Ef(r,d,p,g,v,s);else console.warn(`[wind-core]: invalid action type: ${n}`);return{data:new Uint8Array(s.getImageData(0,0,g,v).data),colorRange:c}}else return{}}function Nh(t,i,e,s){const r=s-e,n=t-e;return r===0?0:i===1?n/r:(Math.pow(i,n)-1)/(Math.pow(i,r)-1)}function Rf(t,i,e,s){let r=0;return t.name==="exponential"?r=Nh(i,t.base,e,s):t.name==="linear"?r=Nh(i,1,e,s):t.name==="cubic-bezier"&&console.warn("interpolationFactor"),r}function Cf(t,i,e){return t*(1-e)+i*e}const cs={};function Ff(t){return Array.isArray(t)&&t.length>3?t[0]==="rasterize":(console.warn("[wind-core]: style-parser style config invalid"),!1)}function ki(t,i,e,s,r){const n=`${t}_${e}`,l=s[e];if(Me.isNumber(l))return cs[n]&&delete cs[n],l;if(l&&Array.isArray(l)&&(!cs[n]||r)&&(cs[n]=Af(l)),cs[n]){const{input:c,interpolation:d}=cs[n]||{};if(c&&Array.isArray(c)){const p=c.map(C=>C.key),g=c.map(C=>C.value);if(i<=p[0])return g[0];const v=p.length;if(i>=p[v-1])return g[v-1];const w=tf(p,i),_=p.length-1,T=p[w],E=p[w>=_?_:w+1],A=Rf(d,i,T,E),R=g[w],U=g[w>=_?_:w+1];return Cf(R,U,A)}else return 1}return 1}var Ut=(t=>(t[t.image=0]="image",t[t.colorize=1]="colorize",t[t.particles=2]="particles",t[t.arrow=3]="arrow",t[t.barb=4]="barb",t[t.wave=5]="wave",t))(Ut||{}),Et=(t=>(t.r="r",t.rg="rg",t.rgba="rgba",t.float="float",t))(Et||{});function Pf(t){return t==="rg"?1:t==="rgba"?2:t==="float"?3:0}var pn=(t=>(t[t.image=0]="image",t[t.unit8=1]="unit8",t[t.tiff=2]="tiff",t[t.imageWithExif=3]="imageWithExif",t))(pn||{}),Bi=(t=>(t.image="image",t.tile="tile",t.timeline="timeline",t))(Bi||{}),ee=(t=>(t.loading="0",t.loaded="1",t.errored="2",t.unloaded="3",t.reloading="4",t))(ee||{}),Bo=(t=>(t[t.outside=0]="outside",t[t.inside=1]="inside",t))(Bo||{}),If=`#define GLSLIFY 1
attribute vec3 position;uniform vec3 cameraPosition;uniform mat4 viewMatrix;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform float u_offset;void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position+vec3(u_offset,0.0,0.0),1.0);}`,Uf=`#defines
precision mediump float;
#define GLSLIFY 1
void main(){gl_FragColor=vec4(0.0,0.0,0.0,0.0);}`,pr,Ot;class Dh extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,pr,void 0);S(this,Ot,void 0);this.prerender=!0,y(this,pr,new Rt(s,{vertexShader:If,fragmentShader:Uf,includes:Ft,transparent:!0})),y(this,Ot,[]),this.updateGeometry()}updateGeometry(){const{mask:e}=this.options;if(!e||e.data.length===0)return;const s=e.data.length;let r=0;for(let n=0;n<o(this,Ot).length;n++){const l=o(this,Ot)[n];l.geometry&&l.geometry.destroy()}for(y(this,Ot,[]);r<s;r++){const n=e.data[r];o(this,Ot).push(new gt(this.renderer,{mode:this.renderer.gl.TRIANGLES,program:o(this,pr),geometry:new Ye(this.renderer,n)}))}}render(e,s){var d;const r=this.renderer.attributes;this.renderer.setViewport(this.renderer.width*r.dpr,this.renderer.height*r.dpr);const{worlds:n=[0]}=e.cameras,l=this.renderer.gl.getParameter(this.renderer.gl.STENCIL_TEST);l||this.renderer.state.enable(this.renderer.gl.STENCIL_TEST),this.renderer.gl.stencilFunc(this.renderer.gl.ALWAYS,1,255),this.renderer.gl.stencilOp(this.renderer.gl.REPLACE,this.renderer.gl.REPLACE,this.renderer.gl.REPLACE),this.renderer.gl.stencilMask(255),this.renderer.gl.clearStencil(0),this.renderer.gl.clear(this.renderer.gl.STENCIL_BUFFER_BIT);for(let p=0;p<o(this,Ot).length;p++){const g=o(this,Ot)[p];for(let v=0;v<n.length;v++)g.program.setUniform("u_offset",n[v]),g.updateMatrix(),g.worldMatrixNeedsUpdate=!1,g.worldMatrix.multiply(e.scene.worldMatrix,g.localMatrix),g.draw({...e,camera:e.cameras.camera})}const c=((d=this.options.mask)==null?void 0:d.type)===Bo.outside?0:1;return this.renderer.gl.stencilFunc(this.renderer.gl.EQUAL,c,255),this.renderer.gl.stencilOp(this.renderer.gl.KEEP,this.renderer.gl.KEEP,this.renderer.gl.KEEP),l}}pr=new WeakMap,Ot=new WeakMap;class zf extends Oo{}var Lf=`#define GLSLIFY 1
#defines
attribute vec2 uv;attribute vec2 position;attribute vec2 coords;uniform vec2 arrowSize;uniform float u_head;uniform vec2 resolution;uniform float u_devicePixelRatio;uniform vec2 pixelsToProjUnit;uniform vec3 cameraPosition;uniform mat4 viewMatrix;uniform mat4 modelMatrix;uniform mat4 projectionMatrix;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform sampler2D u_texture;uniform sampler2D u_textureNext;uniform sampler2D colorRampTexture;uniform float u_fade_t;uniform vec2 u_image_res;uniform vec2 colorRange;uniform bool useDisplayRange;uniform bool u_flip_y;uniform float u_zoomScale;uniform vec2 displayRange;uniform vec4 u_bbox;uniform vec4 u_data_bbox;uniform vec4 u_tile_bbox;varying vec2 vUv;varying float v_speed;varying float v_speed_t;varying float v_head;varying float v_body;varying float v_antialias;varying float v_linewidth;vec4 calcTexture(const vec2 puv){vec4 color0=texture2D(u_texture,puv);vec4 color1=texture2D(u_textureNext,puv);return mix(color0,color1,u_fade_t);}vec2 decodeValue(const vec2 vc){vec4 rgba=calcTexture(vc);return rgba.rg;}vec2 bilinear(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);vec2 tl=decodeValue(vc);vec2 tr=decodeValue(vc+vec2(px.x,0.0));vec2 bl=decodeValue(vc+vec2(0.0,px.y));vec2 br=decodeValue(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float getValue(vec2 rg){return length(rg);}float getAngle(vec2 rg){float angle=atan(rg.y,rg.x);return angle;}void rotate2d(inout vec2 v,float a){mat2 m=mat2(cos(a),-sin(a),sin(a),cos(a));v=m*v;}void main(){vUv=uv;vec2 pos=u_tile_bbox.xy+coords.xy*(u_tile_bbox.zw-u_tile_bbox.xy);vec2 size=arrowSize*u_zoomScale*pixelsToProjUnit*u_devicePixelRatio;vec2 halfSize=size/2.0;vec2 worldPosition=vec2(-halfSize.x,-halfSize.y);if(position.x==1.0){worldPosition.x=halfSize.x;}if(position.y==1.0){worldPosition.y=halfSize.y;}worldPosition+=halfSize*vec2(1.0,0);vec2 textureCoord=(pos.xy-u_data_bbox.xy)/(u_data_bbox.zw-u_data_bbox.xy);if(u_flip_y){textureCoord=vec2(textureCoord.x,1.0-textureCoord.y);}vec2 rg=bilinear(textureCoord);float value=getValue(rg);float angle=getAngle(rg);angle=u_flip_y ? angle*-1. : angle;rotate2d(worldPosition,angle);worldPosition+=pos;v_speed=value;v_speed_t=(value-colorRange.x)/(colorRange.y-colorRange.x);v_linewidth=mix(0.18,0.12,v_speed_t);v_head=u_head;v_antialias=1.0/min(arrowSize.x,arrowSize.y);v_body=mix(0.15,4.0,v_speed_t)*3.0;gl_Position=projectionMatrix*viewMatrix*modelMatrix*vec4(worldPosition,0.0,1.0);}`,kf=`#defines
precision highp float;
#define GLSLIFY 1
uniform sampler2D u_texture;uniform sampler2D u_textureNext;uniform sampler2D colorRampTexture;uniform float u_fade_t;uniform vec2 u_image_res;uniform vec2 colorRange;uniform bool useDisplayRange;uniform vec2 displayRange;uniform float opacity;varying vec2 vUv;varying float v_speed;varying float v_speed_t;varying float v_head;varying float v_body;varying float v_antialias;varying float v_linewidth;vec4 calcTexture(const vec2 puv){vec4 color0=texture2D(u_texture,puv);vec4 color1=texture2D(u_textureNext,puv);return mix(color0,color1,u_fade_t);}float disc(vec2 pos,float size){return length(pos)-size/2.0;}vec4 filled(float distance,float linewidth,float antialias,vec4 fill){vec4 frag_color=vec4(0.0);float t=linewidth/2.0-antialias;float signed_distance=distance;float border_distance=abs(signed_distance)-t;float alpha=border_distance/antialias;alpha=exp(-alpha*alpha);if(border_distance<0.0){frag_color=fill;}else if(signed_distance<0.0){frag_color=fill;}return frag_color;}float line_distance(vec2 p,vec2 p1,vec2 p2){vec2 center=(p1+p2)*0.5;float len=length(p2-p1);vec2 dir=(p2-p1)/len;vec2 rel_p=p-center;return dot(rel_p,vec2(dir.y,-dir.x));}float segment_distance(vec2 p,vec2 p1,vec2 p2){vec2 center=(p1+p2)*0.5;float len=length(p2-p1);vec2 dir=(p2-p1)/len;vec2 rel_p=p-center;float dist1=abs(dot(rel_p,vec2(dir.y,-dir.x)));float dist2=abs(dot(rel_p,dir))-0.5*len;return max(dist1,dist2);}float arrow_stealth(vec2 texcoord,float body,float head,float linewidth,float antialias){float w=linewidth/2.0+antialias;vec2 start=-vec2(body/2.0,0.0);vec2 end=+vec2(body/2.0,0.0);float height=0.5;float d1=line_distance(texcoord,end-head*vec2(+1.0,-height),end);float d2=line_distance(texcoord,end-head*vec2(+1.0,-height),end-vec2(3.0*head/4.0,0.0));float d3=line_distance(texcoord,end-head*vec2(+1.0,+height),end);float d4=line_distance(texcoord,end-head*vec2(+1.0,+0.5),end-vec2(3.0*head/4.0,0.0));float d5=segment_distance(texcoord,start,end-vec2(linewidth,0.0));return min(d5,max(max(-d1,d3),-max(-d2,d4)));}void main(){vec2 uv=vUv;if(calcTexture(uv).a==0.0||v_speed<0.0){discard;}vec2 pos=vUv-vec2(0.0,0.5);vec2 ramp_pos=vec2(v_speed_t,0.5);vec4 color=texture2D(colorRampTexture,ramp_pos);bool display=true;if(useDisplayRange){display=v_speed<=displayRange.y&&v_speed>=displayRange.x;}if(display){if(v_speed>0.2){float d=arrow_stealth(pos.xy,v_body,v_head,v_linewidth,v_antialias);vec4 rc=filled(d,0.15,0.01,color);gl_FragColor=vec4(floor(255.0*rc*opacity)/255.0);}else{float d=disc(pos,0.15);vec4 rc=filled(d,0.01,0.01,color);gl_FragColor=vec4(floor(255.0*rc*opacity)/255.0);}}else{gl_FragColor=vec4(0.0,0.0,0.0,0.0);}}`;const us=4096;var de,Mi,Cs,qt,gr,mr;class Of extends Ct{constructor(e,s,r={}){super(e,s,r);S(this,de,void 0);S(this,Mi,void 0);S(this,Cs,void 0);S(this,qt,void 0);S(this,gr,void 0);S(this,mr,void 0);this.prerender=!1,y(this,Mi,new Rt(s,{vertexShader:Lf,fragmentShader:kf,uniforms:{opacity:{value:1},u_fade_t:{value:0},displayRange:{value:new st(-1/0,1/0)},u_texture:{value:this.options.texture},u_textureNext:{value:this.options.textureNext},colorRampTexture:{value:null}},defines:[`RENDER_TYPE ${this.options.bandType}`,`LITTLE_ENDIAN ${ns}`],includes:Ft,transparent:!0})),y(this,de,new gt(this.renderer,{mode:this.renderer.gl.TRIANGLES,program:o(this,Mi),geometry:new Ye(this.renderer,{index:{size:1,data:new Uint16Array([0,1,2,0,2,3])},position:{size:2,data:new Float32Array([0,1,0,0,1,0,1,1])},uv:{size:2,data:new Float32Array([0,1,0,0,1,0,1,1])},coords:{divisor:1,data:new Float32Array(2),offset:0,size:2,stride:8}})}))}createTileVertexArray(e,s=20){if(!o(this,qt)||e!==o(this,gr)||s!==o(this,mr)){y(this,gr,e),y(this,mr,s);const r=Math.round(e/s),n=1/r,l=n/2,c=[];for(let p=0;p<r;p++)for(let g=0;g<r;g++)c.push({x:us*(l+g*n),y:us*(l+p*n)});y(this,qt,new Float32Array(c.length*2));for(let p=0;p<c.length;p++){const g=c[p],v={x:Math.round(g.x),y:Math.round(g.y)};v.x<0||v.x>=us||v.y<0||v.y>=us||(o(this,qt)[2*p]=v.x/us,o(this,qt)[2*p+1]=v.y/us)}const d=new Ye(this.renderer,{index:{size:1,data:new Uint16Array([0,1,2,0,2,3])},position:{size:2,data:new Float32Array([0,1,0,0,1,0,1,1])},uv:{size:2,data:new Float32Array([0,1,0,0,1,0,1,1])},coords:{divisor:1,data:o(this,qt),offset:0,size:2,stride:8}});o(this,de)&&o(this,de).updateGeometry(d,!0)}return o(this,qt)}render(e,s){var p,g;const r=this.renderer.attributes;this.renderer.setViewport(this.renderer.width*r.dpr,this.renderer.height*r.dpr);const n=e.cameras.camera,l=this.options.source.tileSize??256,c=this.options.getGridTiles(this.options.source);let d;if(this.maskPass&&(d=this.maskPass.render(e,s)),s&&o(this,de)&&c&&c.length>0){const v=Me.pick(s,["opacity","colorRange","dataRange","colorRampTexture","useDisplayRange","displayRange"]),w=s.zoom,_=s.sharedState.u_data_bbox;this.createTileVertexArray(l,s.symbolSpace);for(let T=0;T<c.length;T++){const E=c[T],A=E.getTileProjBounds(),R=Math.pow(2,w-E.overscaledZ),C=1/Math.max(A.right-A.left,A.bottom-A.top),I=1/(l*R)/C;Object.keys(v).forEach(V=>{var Q;v[V]!==void 0&&((Q=o(this,de))==null||Q.program.setUniform(V,v[V]))});const O=((g=(p=this.options.source)==null?void 0:p.getFadeTime)==null?void 0:g.call(p))||0;o(this,de).program.setUniform("u_image_res",new st(this.options.texture.width,this.options.texture.height)),o(this,de).program.setUniform("u_fade_t",O),o(this,de).program.setUniform("arrowSize",s.symbolSize),o(this,de).program.setUniform("pixelsToProjUnit",new st(I,I)),o(this,de).program.setUniform("u_bbox",s.extent),o(this,de).program.setUniform("u_data_bbox",_),o(this,de).program.setUniform("u_tile_bbox",s.u_flip_y?[A.left,A.bottom,A.right,A.top]:[A.left,A.top,A.right,A.bottom]),o(this,de).program.setUniform("u_head",.1),o(this,de).program.setUniform("u_devicePixelRatio",r.dpr),o(this,de).program.setUniform("u_texture",this.options.texture),o(this,de).program.setUniform("u_textureNext",this.options.textureNext),o(this,de).program.setUniform("u_flip_y",s.u_flip_y),o(this,de).program.setUniform("u_zoomScale",s.u_zoomScale),o(this,de).updateMatrix(),o(this,de).worldMatrixNeedsUpdate=!1,o(this,de).worldMatrix.multiply(e.scene.worldMatrix,o(this,de).localMatrix),o(this,de).draw({...e,camera:n})}}d||this.renderer.state.disable(this.renderer.gl.STENCIL_TEST)}destroy(){o(this,de)&&(o(this,de).destroy(),y(this,de,null)),o(this,Mi)&&(o(this,Mi).destroy(),y(this,Mi,null)),o(this,Cs)&&(o(this,Cs).destroy(),y(this,Cs,null))}}de=new WeakMap,Mi=new WeakMap,Cs=new WeakMap,qt=new WeakMap,gr=new WeakMap,mr=new WeakMap;const Gh={getViewTiles:()=>[],getGridTiles:()=>[],getTileProjSize:t=>[256,256],getPixelsToUnits:()=>[1,1],getPixelsToProjUnit:()=>[1,1],renderType:Ut.colorize,renderFrom:Et.r,styleSpec:{"fill-color":["interpolate",["linear"],["get","value"],0,"#3288bd",10,"#66c2a5",20,"#abdda4",30,"#e6f598",40,"#fee08b",50,"#fdae61",60,"#f46d43",100,"#d53e4f"],opacity:1,numParticles:65535,speedFactor:1,fadeOpacity:.93,dropRate:.003,dropRateBump:.002,space:20,size:[16,16]},displayRange:[1/0,1/0],widthSegments:1,heightSegments:1,wireframe:!1,flipY:!1,glScale:()=>1,zoomScale:()=>1,onInit:()=>{}};let $h=!1;var Ji,Ai,Fs,Ps,Is,Us,zs,Ls,ks,Os,Ei,$e,vr;class id{constructor(i,e,s){S(this,Ji,void 0);S(this,Ai,void 0);S(this,Fs,void 0);S(this,Ps,void 0);S(this,Is,void 0);S(this,Us,void 0);S(this,zs,void 0);S(this,Ls,void 0);S(this,ks,void 0);S(this,Os,void 0);S(this,Ei,void 0);S(this,$e,void 0);S(this,vr,void 0);if(this.renderer=e.renderer,this.scene=e.scene,this.source=i,!this.renderer)throw new Error("initialize error");if(this.uid=Me.uid("ScalarFill"),s||(s={}),this.options={...Gh,...s,styleSpec:{...Gh.styleSpec,...s.styleSpec}},y(this,Ji,1),y(this,Ei,1),this.dispatcher=new en.Dispatcher(en.getGlobalWorkerPool(),this,this.uid),!$h){const r=en.getConfigDeps();this.dispatcher.broadcast("configDeps",r.map(n=>ma(n)),(n,l)=>{var c,d;(d=(c=this.options).onInit)==null||d.call(c,n,l)}),$h=!0}this.update=this.update.bind(this),this.onTileLoaded=this.onTileLoaded.bind(this),this.source.prepare(this.renderer,this.dispatcher,{renderFrom:this.options.renderFrom??Et.r}),this.source.onAdd(this),Array.isArray(this.source.sourceCache)?this.source.sourceCache.forEach(r=>{r.on("update",this.update),r.on("tileLoaded",this.onTileLoaded)}):(this.source.sourceCache.on("update",this.update),this.source.sourceCache.on("tileLoaded",this.onTileLoaded)),this.initialize()}initialize(){var e,s,r,n,l,c,d,p,g,v,w,_,T,E,A;this.updateOptions({}),this.sharedState={u_bbox:[0,0,1,1],u_data_bbox:[0,0,1,1],u_scale:[1,1]},this.renderPipeline=new Yu(this.renderer);const i=Pf(this.options.renderFrom??Et.r);if(this.options.mask&&y(this,$e,new Dh("MaskPass",this.renderer,{mask:this.options.mask})),this.options.renderType===Ut.image){const R=new gf("RasterComposePass",this.renderer,{bandType:i,source:this.source,renderFrom:this.options.renderFrom??Et.r,maskPass:o(this,$e),stencilConfigForOverlap:this.stencilConfigForOverlap.bind(this)}),U=new df("RasterPass",this.renderer,{bandType:i,source:this.source,texture:R.textures.current,textureNext:R.textures.next});if((e=this.renderPipeline)==null||e.addPass(R),this.options.picking){const C=new Oh("PickerPass",this.renderer,{source:this.source,texture:R.textures.current,textureNext:R.textures.next,useFloatTexture:!1});(s=this.renderPipeline)==null||s.addPass(C)}(r=this.renderPipeline)==null||r.addPass(U)}else if(this.options.renderType===Ut.colorize){const R=new lf("ColorizeComposePass",this.renderer,{bandType:i,source:this.source,renderFrom:this.options.renderFrom??Et.r,maskPass:o(this,$e),stencilConfigForOverlap:this.stencilConfigForOverlap.bind(this),isRasterize:()=>o(this,vr)}),U=new uf("ColorizePass",this.renderer,{bandType:i,source:this.source,texture:R.textures.current,textureNext:R.textures.next});if((n=this.renderPipeline)==null||n.addPass(R),this.options.picking){const C=new Oh("PickerPass",this.renderer,{source:this.source,texture:R.textures.current,textureNext:R.textures.next,useFloatTexture:!0});(l=this.renderPipeline)==null||l.addPass(C)}(c=this.renderPipeline)==null||c.addPass(U)}else if(this.options.renderType===Ut.particles){const R=new Oo("ParticlesComposePass",this.renderer,{id:Me.uid("ParticlesComposePass"),bandType:i,source:this.source,renderFrom:this.options.renderFrom??Et.r,stencilConfigForOverlap:this.stencilConfigForOverlap.bind(this),getTileProjSize:this.options.getTileProjSize});(d=this.renderPipeline)==null||d.addPass(R);const U=new vf("UpdatePass",this.renderer,{bandType:i,source:this.source,texture:R.textures.current,textureNext:R.textures.next,getParticleNumber:()=>o(this,Ai),glScale:(g=(p=this.options).glScale)==null?void 0:g.call(p)});(v=this.renderPipeline)==null||v.addPass(U);const C=new wf("ParticlesPass",this.renderer,{bandType:i,source:this.source,texture:R.textures.current,textureNext:R.textures.next,getParticles:()=>U.textures,getParticleNumber:()=>o(this,Ai),maskPass:o(this,$e)}),I=new kh("ParticlesTexturePass",this.renderer,{bandType:i,source:this.source,prerender:!0,enableBlend:!1,particlesPass:C});(w=this.renderPipeline)==null||w.addPass(I),(_=this.renderPipeline)==null||_.addPass(C);const O=new kh("ScreenPass",this.renderer,{bandType:i,source:this.source,prerender:!1,enableBlend:!0,particlesPass:C});(T=this.renderPipeline)==null||T.addPass(O),this.raf=new Ao(()=>{this.options.triggerRepaint&&this.options.triggerRepaint()},{autoStart:!0})}else if(this.options.renderType===Ut.arrow){const R=new zf("ArrowComposePass",this.renderer,{id:Me.uid("ArrowComposePass"),bandType:i,source:this.source,renderFrom:this.options.renderFrom??Et.r,stencilConfigForOverlap:this.stencilConfigForOverlap.bind(this),getTileProjSize:this.options.getTileProjSize}),U=new Of("ArrowPass",this.renderer,{bandType:i,source:this.source,texture:R.textures.current,textureNext:R.textures.next,getPixelsToUnits:this.options.getPixelsToUnits,getGridTiles:this.options.getGridTiles,maskPass:o(this,$e)});(E=this.renderPipeline)==null||E.addPass(R),(A=this.renderPipeline)==null||A.addPass(U)}}updateOptions(i){var e,s;this.options={...this.options,...i,styleSpec:{...this.options.styleSpec,...i==null?void 0:i.styleSpec}},this.buildColorRamp(),this.parseStyleSpec(!0),(s=(e=this.options)==null?void 0:e.triggerRepaint)==null||s.call(e)}resize(i,e){this.renderPipeline&&this.renderPipeline.resize(i,e)}setFillColor(){this.buildColorRamp()}setOpacity(i){y(this,Ji,i)}setNumParticles(i){y(this,Ai,i)}setSpeedFactor(i){y(this,Fs,i)}setFadeOpacity(i){y(this,Ps,i)}setDropRate(i){y(this,Is,i)}setDropRateBump(i){y(this,Us,i)}setSymbolSpace(i){y(this,zs,i)}setSymbolSize(i){y(this,Ls,i)}parseStyleSpec(i){var e;if(la(this.options.getZoom)){const s=this.options.getZoom();this.setOpacity(ki(this.uid,s,"opacity",this.options.styleSpec,i)),this.options.renderType===Ut.particles&&(this.setNumParticles(ki(this.uid,s,"numParticles",this.options.styleSpec,i)),this.setFadeOpacity(ki(this.uid,s,"fadeOpacity",this.options.styleSpec,i)),this.setSpeedFactor(ki(this.uid,s,"speedFactor",this.options.styleSpec,i)),this.setDropRate(ki(this.uid,s,"dropRate",this.options.styleSpec,i)),this.setDropRateBump(ki(this.uid,s,"dropRateBump",this.options.styleSpec,i))),this.options.renderType===Ut.arrow&&(this.setSymbolSize((e=this.options.styleSpec)==null?void 0:e.size),this.setSymbolSpace(ki(this.uid,s,"space",this.options.styleSpec,i)))}}handleZoom(){this.parseStyleSpec(!1)}buildColorRamp(){var s,r,n;if(!((s=this.options.styleSpec)!=null&&s["fill-color"]))return;const{data:i,colorRange:e}=Sf([],(r=this.options.styleSpec)==null?void 0:r["fill-color"]);y(this,vr,Ff((n=this.options.styleSpec)==null?void 0:n["fill-color"])),e&&y(this,ks,new st(...e)),i&&y(this,Os,new So(this.renderer,{data:i,name:"colorRampTexture",magFilter:this.renderer.gl.NEAREST,minFilter:this.renderer.gl.NEAREST,width:255,height:1}))}clearStencil(){y(this,Ei,1)}stencilConfigForOverlap(i){const e=i.sort((n,l)=>l.overscaledZ-n.overscaledZ),s=e[e.length-1].overscaledZ,r=e[0].overscaledZ-s+1;if(r>1){o(this,Ei)+r>256&&this.clearStencil();const n={};for(let l=0;l<r;l++)n[l+s]={stencil:!0,mask:255,func:{cmp:this.renderer.gl.GEQUAL,ref:l+o(this,Ei),mask:255},op:{fail:this.renderer.gl.KEEP,zfail:this.renderer.gl.KEEP,zpass:this.renderer.gl.REPLACE}};return y(this,Ei,o(this,Ei)+r),[n,e]}return[{[s]:{stencil:!1,mask:0,func:{cmp:this.renderer.gl.ALWAYS,ref:0,mask:0},op:{fail:this.renderer.gl.KEEP,zfail:this.renderer.gl.KEEP,zpass:this.renderer.gl.KEEP}}},e]}moveStart(){if(this.renderPipeline&&this.options.renderType===Ut.particles){const i=this.renderPipeline.getPass("ParticlesPass");i&&i.resetParticles(),this.renderPipeline.passes.forEach(e=>{(e.id==="ParticlesTexturePass"||e.id==="ScreenPass")&&(e.enabled=!1),e.id==="ParticlesPass"&&(e.prerender=!1)})}}moveEnd(){if(this.renderPipeline&&this.options.renderType===Ut.particles){const i=this.renderPipeline.getPass("UpdatePass");i&&i.setInitialize(!0),this.renderPipeline.passes.forEach(e=>{(e.id==="ParticlesTexturePass"||e.id==="ScreenPass")&&(e.enabled=!0),e.id==="ParticlesPass"&&(e.prerender=!0)})}}update(){var e;const i=this.options.getViewTiles(this.source,this.options.renderType);Array.isArray(this.source.sourceCache)?this.source.sourceCache.forEach(s=>{s==null||s.update(i)}):(e=this.source.sourceCache)==null||e.update(i)}onTileLoaded(){this.options.triggerRepaint&&la(this.options.triggerRepaint)&&this.options.triggerRepaint()}setMask(i){var e,s,r,n,l,c;if(this.options.mask=i,this.options.mask){if(!o(this,$e)){y(this,$e,new Dh("MaskPass",this.renderer,{mask:this.options.mask}));const d=(e=this.renderPipeline)==null?void 0:e.getPass("RasterComposePass");d&&d.setMaskPass(o(this,$e));const p=(s=this.renderPipeline)==null?void 0:s.getPass("ColorizeComposePass");p&&p.setMaskPass(o(this,$e));const g=(r=this.renderPipeline)==null?void 0:r.getPass("ParticlesPass");g&&g.setMaskPass(o(this,$e));const v=(n=this.renderPipeline)==null?void 0:n.getPass("ArrowPass");v&&v.setMaskPass(o(this,$e))}o(this,$e).updateGeometry(),(c=(l=this.options)==null?void 0:l.triggerRepaint)==null||c.call(l)}}async picker(i=[0,0]){if(!this.renderPipeline)return null;const e=this.renderPipeline.getPass("PickerPass");return e?e.render(void 0,void 0,i):null}prerender(i,e){var s,r,n,l,c,d,p,g;this.renderPipeline&&this.renderPipeline.prerender({scene:this.scene,cameras:i,...e?{target:e}:{}},{zoom:((r=(s=this.options)==null?void 0:s.getZoom)==null?void 0:r.call(s))??0,extent:(l=(n=this.options)==null?void 0:n.getExtent)==null?void 0:l.call(n),opacity:o(this,Ji),fadeOpacity:o(this,Ps),numParticles:o(this,Ai),colorRange:o(this,ks),colorRampTexture:o(this,Os),sharedState:this.sharedState,u_drop_rate:o(this,Is),u_drop_rate_bump:o(this,Us),u_speed_factor:o(this,Fs),u_flip_y:this.options.flipY,u_gl_scale:(d=(c=this.options).glScale)==null?void 0:d.call(c),u_zoomScale:(g=(p=this.options).zoomScale)==null?void 0:g.call(p),symbolSize:o(this,Ls),symbolSpace:o(this,zs),pixelsToProjUnit:this.options.getPixelsToProjUnit()})}render(i,e){var s,r,n,l,c,d,p,g;if(this.renderPipeline){const v={zoom:((r=(s=this.options)==null?void 0:s.getZoom)==null?void 0:r.call(s))??0,extent:(l=(n=this.options)==null?void 0:n.getExtent)==null?void 0:l.call(n),opacity:o(this,Ji),fadeOpacity:o(this,Ps),numParticles:o(this,Ai),colorRange:o(this,ks),colorRampTexture:o(this,Os),displayRange:this.options.displayRange,useDisplayRange:!!this.options.displayRange,sharedState:this.sharedState,u_drop_rate:o(this,Is),u_drop_rate_bump:o(this,Us),u_speed_factor:o(this,Fs),u_flip_y:this.options.flipY,u_gl_scale:(d=(c=this.options).glScale)==null?void 0:d.call(c),u_zoomScale:(g=(p=this.options).zoomScale)==null?void 0:g.call(p),symbolSize:o(this,Ls),symbolSpace:o(this,zs),pixelsToProjUnit:this.options.getPixelsToProjUnit()};this.renderPipeline.render({scene:this.scene,cameras:i,...e?{target:e}:{}},v)}}destroy(){this.raf&&this.raf.stop(),this.renderPipeline&&(this.renderPipeline.destroy(),this.renderPipeline=null),this.source&&(Array.isArray(this.source.sourceCache)?this.source.sourceCache.forEach(i=>{i.off("update",this.update),i.off("tileLoaded",this.onTileLoaded)}):(this.source.sourceCache.off("update",this.update),this.source.sourceCache.off("tileLoaded",this.onTileLoaded)),this.source.destroy())}}Ji=new WeakMap,Ai=new WeakMap,Fs=new WeakMap,Ps=new WeakMap,Is=new WeakMap,Us=new WeakMap,zs=new WeakMap,Ls=new WeakMap,ks=new WeakMap,Os=new WeakMap,Ei=new WeakMap,$e=new WeakMap,vr=new WeakMap;class ht{constructor(i,e=0,s,r,n,l={}){this.x=r,this.y=n,this.z=s,this.wrap=e,this.tileKey=`${s}_${r}_${n}-${e}`,this.unWrappedTileKey=`${s}_${r}_${n}`;const c=Math.pow(2,this.z);this.wrapedX=c*e+this.x,this.wrapedY=this.y,this.overscaledZ=i,this.options=l,this.getTileBounds()}getTileBounds(i=this){return la(this.options.getTileBounds)?this.tileBounds=this.options.getTileBounds(i):console.error("[TileID]: projection function must be provided"),this.tileBounds}getTileProjBounds(i=this,e){var s,r;return(!this.projTileBounds||e)&&(this.projTileBounds=(r=(s=this.options).getTileProjBounds)==null?void 0:r.call(s,i)),this.projTileBounds}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.z)}scaledTo(i){const e=this.z-i;return i>this.z?new ht(i,this.wrap,this.z,this.x,this.y,this.options):new ht(i,this.wrap,i,this.x>>e,this.y>>e,this.options)}parent(){return this.z>0?new ht(this.z-1,this.wrap,this.z-1,this.x>>1,this.y>>1,this.options):new ht(this.z,this.wrap,this.z,this.x,this.y,this.options)}children(i){if(this.overscaledZ>=i)return[new ht(this.overscaledZ+1,this.wrap,this.z,this.x,this.y,this.options)];const e=this.z+1,s=this.x*2,r=this.y*2;return[new ht(e,this.wrap,e,s,r,this.options),new ht(e,this.wrap,e,s+1,r,this.options),new ht(e,this.wrap,e,s,r+1,this.options),new ht(e,this.wrap,e,s+1,r+1,this.options)]}siblings(){return this.z===0?[]:this.parent().children(this.overscaledZ).filter(i=>!this.isEqual(i))}neighbor(i,e=0){if(this.z===0)return new ht(this.overscaledZ,this.wrap+i,this.z,this.x,this.y,this.options);const s=Math.pow(2,this.z),r=this.x+i,n=Math.floor(r/s),l=this.wrap+n;return new ht(this.overscaledZ,l,this.z,(this.x+i-s*n)%s,(this.y+e+s)%s,this.options)}isEqual(i){return i.tileKey===this.tileKey}isRoot(){return this.z===0}}class Bf{constructor(i,e,s,r){this.id=i,this.program=s,this.mesh=new gt(e,{program:s,geometry:r}),this.planeMesh=new gt(e,{program:s,geometry:new Ye(e,{position:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},uv:{size:2,data:new Float32Array([0,0,1,0,0,1,1,1])},index:{size:1,data:new Uint16Array([0,1,2,2,1,3])}})})}setCenter(i){this.mesh.position.set(i[0],i[1],i[2]||0)}getMesh(){return this.mesh}destroy(){this.mesh.destroy(),this.planeMesh.destroy()}}var Bt;class Nf{constructor(i,e={}){S(this,Bt,void 0);this.errorCount=0,this.maxErrorCount=3,this.uses=0,this.tileMeshs=new Map,this.geometries=new Map,y(this,Bt,new Map),this.tileID=i,this.tileSize=e.tileSize,this.request=new Map,this.state=ee.loading}hasData(){return this.state===ee.loaded||this.state===ee.reloading}wasRequested(){return this.state===ee.errored||this.state===ee.loaded}isLoaded(){return this.state===ee.loaded||this.state===ee.reloading||this.state===ee.errored}getMesh(i){return this.tileMeshs.get(i)}get textures(){return o(this,Bt)}get tileCenter(){return[(this.tileBounds.left+this.tileBounds.right)/2,(this.tileBounds.top+this.tileBounds.bottom)/2,0]}updateGeometry(i,e,s,r){if(this.tileBounds=e,!this.geometries.get(i)||r){const n=[this.tileBounds.left,this.tileBounds.top,0,this.tileBounds.right,this.tileBounds.top,0,this.tileBounds.left,this.tileBounds.bottom,0,this.tileBounds.right,this.tileBounds.bottom,0];let l=0;const c=n.length;for(;l<c;l+=3)n[l]=n[l]-this.tileCenter[0],n[l+1]=n[l+1]-this.tileCenter[1],n[l+2]=n[l+2]-this.tileCenter[2];this.geometries.set(i,new Ye(s,{position:{size:3,data:new Float32Array(n)},normal:{size:3,data:new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1])},uv:{size:2,data:new Float32Array([0,1,1,1,0,0,1,0])},index:{data:new Uint16Array([0,2,1,2,3,1])}}))}return this.geometries.get(i)}createMesh(i,e,s,r,n){const l=this.updateGeometry(i,e,s,n);if(!this.tileMeshs.get(i)||n){this.uses++;const c=i+"_"+this.tileID.tileKey,d=new Bf(c,s,r,l);d.setCenter(this.tileCenter),this.tileMeshs.set(i,d)}return this.tileMeshs.get(i)}setTextures(i,e,s,r,n){const l=o(this,Bt).get(e),c=sf(s)||s instanceof Image;let d;n!=null&&n.dataRange?d=n==null?void 0:n.dataRange:s.withExif&&(d=rf(s.exif)),l?(l.userData&&(l.userData.dataRange=d),l.setData(c?s:s.data)):o(this,Bt).set(e,new ss(i,{userData:d?{dataRange:d}:void 0,image:c?s:s.data,width:s.width,height:s.height,minFilter:i.gl.LINEAR,magFilter:i.gl.LINEAR,wrapS:i.gl.CLAMP_TO_EDGE,wrapT:i.gl.CLAMP_TO_EDGE,flipY:!1,premultiplyAlpha:!1,type:r.renderFrom===Et.float?i.gl.FLOAT:i.gl.UNSIGNED_BYTE,format:r.renderFrom===Et.float?i.isWebGL2?i.gl.RED:i.gl.LUMINANCE:i.gl.RGBA,internalFormat:r.renderFrom===Et.float?i.isWebGL2?i.gl.R32F:i.gl.LUMINANCE:i.gl.RGBA}))}getBounds(){return this.tileBounds}copy(i){return y(this,Bt,i.textures),this.actor=i.actor,this.state=i.state!==ee.errored?ee.loaded:ee.errored,this.request=i.request,this.reloadCallback=i.reloadCallback,this}destroy(){for(const[,i]of o(this,Bt))i&&(i==null||i.destroy());o(this,Bt).clear();for(const[,i]of this.geometries)i&&(i==null||i.destroy());for(const[,i]of this.tileMeshs)i&&(i==null||i.destroy());this.tileMeshs.clear()}}Bt=new WeakMap;class jn{constructor(i,e){this.key=i,this.val=e}}class Df{constructor(i,e){this.max=i,this.onRemove=e,this.reset()}get size(){return this.map.size}reset(){if(this.map){const i=this.map.entries();for(let e=0;e<this.map.size;e++){const[,s]=i.next().value;this.onRemove(s.val)}}return this.map=new Map,this.head=new jn(0,0),this.tail=new jn(0,0),this.head.next=this.tail,this}clear(){this.reset(),this.onRemove=()=>{}}has(i){return this.map.get(i)!==void 0}get(i){const e=this.map.get(i);return e===void 0?null:(this.moveToHead(e),e.val)}getAndRemove(i){return this.has(i)?this.remove(i):null}add(i,e){let s;const r=this.map.get(i);if(r===void 0){this.eliminate();const n=new jn(i,e),l=this.head.next;this.head.next=n,n.next=l,n.pre=this.head,l.pre=n,this.map.set(i,n),s=null}else this.moveToHead(r),s=r.val,r.val=e;return s}remove(i){const e=this.map.get(i);return e===void 0?null:(e.pre.next=e.next,e.next.pre=e.pre,this.onRemove(e.val),this.map.delete(i),e.val)}setMaxSize(i){for(this.max=i;this.size>this.max;)this.eliminate()}moveToHead(i){i.pre.next=i.next,i.next.pre=i.pre;const e=this.head.next;this.head.next=i,i.next=e,i.pre=this.head,e.pre=i}eliminate(){if(this.size<this.max)return;const i=this.tail.pre;this.onRemove(i.val),this.map.delete(i.key),i.pre.next=this.tail,this.tail.pre=i.pre}}function Gf(t,i){const e=Math.abs(t.wrap*2)-+(t.wrap<0),s=Math.abs(i.wrap*2)-+(i.wrap<0);return t.overscaledZ-i.overscaledZ||s-e||i.y-t.y||i.x-t.x}var Tt;const Oi=class Oi extends yr{constructor(e,s){super();S(this,Tt,void 0);this.id=e,this.source=s,this.cacheTiles={},this.coveredTiles={},this.loadedParentTiles={},y(this,Tt,new Df(0,this.unloadTile.bind(this)))}loaded(){if(!this.source.loaded())return!1;for(const e in this.cacheTiles){const s=this.cacheTiles[e];if(s.state!==ee.loaded&&s.state!==ee.errored)return!1}return!0}loadTile(e,s){return this.source.loadTile(e,s)}unloadTile(e){if(this.source.unloadTile)return this.source.unloadTile(e,()=>{})}abortTile(e){if(this.source.abortTile)return this.source.abortTile(e,()=>{})}getRenderableIds(){const e=[];for(const s in this.cacheTiles)this._isIdRenderable(s)&&e.push(this.cacheTiles[s]);return e.map(s=>s.tileID).sort(Gf).map(s=>s.tileKey)}_isIdRenderable(e){return this.cacheTiles[e]&&this.cacheTiles[e].hasData()&&!this.coveredTiles[e]}getVisibleCoordinates(){return this.getRenderableIds().map(e=>this.cacheTiles[e].tileID)}tileLoaded(e,s,r,n,l=!1){if(n){e.state=ee.errored,n.status!==404||this.emit("update");return}e.timeAdded=Date.now(),l||this.emit("update"),this.emit("tileLoaded"),this.loaded()&&this.emit("tilesLoadEnd")}_addTile(e){let s=this.cacheTiles[e.tileKey];return s||(s=o(this,Tt).getAndRemove(e.tileKey),s&&(s.tileID=e),!!s||(s=new Nf(e,{tileSize:this.source.tileSize*e.overscaleFactor()}),this.loadTile(s,this.tileLoaded.bind(this,s,e.tileKey,s.state))),s?(s.uses++,this.cacheTiles[e.tileKey]=s,s):null)}_removeTile(e){const s=this.cacheTiles[e];s&&(s.uses--,delete this.cacheTiles[e],!(s.uses>0)&&(s.hasData()&&s.state!==ee.reloading?o(this,Tt).add(s.tileID.tileKey,s):(s.aborted=!0,this.abortTile(s),this.unloadTile(s))))}getTile(e){return this.cacheTiles[e==null?void 0:e.tileKey]}retainLoadedChildren(e,s,r,n){for(const l in this.cacheTiles){let c=this.cacheTiles[l];if(n[l]||!c.hasData()||c.tileID.overscaledZ<=s||c.tileID.overscaledZ>r)continue;let d=c.tileID;for(;c&&c.tileID.overscaledZ>s+1;){const g=c.tileID.scaledTo(c.tileID.overscaledZ-1);c=this.cacheTiles[g.tileKey],c&&c.hasData()&&(d=g)}let p=d;for(;p.overscaledZ>s;)if(p=p.scaledTo(p.overscaledZ-1),e[p.tileKey]){n[d.tileKey]=d;break}}}updateLoadedParentTileCache(){this.loadedParentTiles={};for(const e in this.cacheTiles){const s=[];let r,n=this.cacheTiles[e].tileID;for(;n.overscaledZ>0;){if(n.tileKey in this.loadedParentTiles){r=this.loadedParentTiles[n.tileKey];break}s.push(n.tileKey);const l=n.scaledTo(n.overscaledZ-1);if(r=this.getLoadedTile(l),r)break;n=l}for(const l of s)this.loadedParentTiles[l]=r}}updateRetainedTiles(e){const s={};if(e.length===0)return s;const r={},n=e.reduce((g,v)=>Math.min(g,v.overscaledZ),1/0),l=e[0].overscaledZ;console.assert(n<=l);const c=Math.max(l-Oi.maxOverzooming,this.source.minZoom),d=Math.max(l+Oi.maxUnderzooming,this.source.minZoom),p={};for(const g of e){const v=this._addTile(g);s[g.tileKey]=g,!(v!=null&&v.hasData())&&n<this.source.maxZoom&&(p[g.tileKey]=g)}this.retainLoadedChildren(p,n,d,s);for(const g of e){let v=this.cacheTiles[g.tileKey];if(v.hasData())continue;if(g.z>=this.source.maxZoom){const _=g.children(this.source.maxZoom)[0],T=this.getTile(_);if(T&&T.hasData()){s[_.tileKey]=_;continue}}else{const _=g.children(this.source.maxZoom);if(s[_[0].tileKey]&&s[_[1].tileKey]&&s[_[2].tileKey]&&s[_[3].tileKey])continue}let w=v.wasRequested();for(let _=g.overscaledZ-1;_>=c;--_){const T=g.scaledTo(_);if(r[T.tileKey]||(r[T.tileKey]=!0,v=this.getTile(T),!v&&w&&(v=this._addTile(T)),v&&(s[T.tileKey]=T,w=v.wasRequested(),v.hasData())))break}}return s}getLoadedTile(e){const s=this.cacheTiles[e.tileKey];return s&&s.hasData()?s:o(this,Tt).get(e.tileKey)}findLoadedParent(e,s){if(e.tileKey in this.loadedParentTiles){const r=this.loadedParentTiles[e.tileKey];return r&&r.tileID.overscaledZ>=s?r:null}for(let r=e.overscaledZ-1;r>=s;r--){const n=e.scaledTo(r),l=this.getLoadedTile(n);if(l)return l}}updateCacheSize(){const e=this.source.tileSize,{width:s,height:r}=this.source.renderer.size,n=Math.ceil((s||4*e)/e)+1,l=Math.ceil((r||4*e)/e)+1,c=n*l,p=Math.floor(c*5),g=typeof this.source.options.maxTileCacheSize=="number"?Math.max(this.source.options.maxTileCacheSize,p):p;o(this,Tt).setMaxSize(g)}update(e){this.coveredTiles={};let s=e;this.updateCacheSize(),this.source.hasTile&&(s=e.filter(d=>this.source.hasTile(d)));const r=this.updateRetainedTiles(s);if(s.length!==0){const d={},p=Object.keys(r);for(const g of p){const v=r[g];if(!this.cacheTiles[g])continue;const _=this.findLoadedParent(v,Math.max(v.overscaledZ-Oi.maxOverzooming,this.source.minZoom));_&&(this._addTile(_.tileID),d[_.tileID.tileKey]=_.tileID)}for(const g in d)r[g]||(this.coveredTiles[g]=!0,r[g]=d[g])}this.emit("tilesLoadStart",{retain:r});const n=nf(this.cacheTiles,r);for(const d of n)this._removeTile(d);this.updateLoadedParentTileCache();const l=Object.keys(this.cacheTiles).filter(d=>{var p;return(p=this.cacheTiles[d])==null?void 0:p.wasRequested()}).length,c=Object.keys(r).length;l<c&&this.emit("tilesLoading",{progress:l/c})}reload(){o(this,Tt).reset();for(const e in this.cacheTiles)this._reloadTile(e,ee.reloading)}_reloadTile(e,s){const r=this.cacheTiles[e];r&&(r.state!==ee.loading&&(r.state=s),this.loadTile(r,this.tileLoaded.bind(this,r,e,s)))}clearTiles(){for(const e in this.cacheTiles)this._removeTile(e);o(this,Tt).reset()}tilesIn(e){const s=[];for(const r in this.cacheTiles){const n=this.cacheTiles[r],l=[0];for(const c of l){const d=e.containsTile(this.source,n,c);d&&s.push(d)}}return s}destroy(){for(const e in this.cacheTiles)this._removeTile(e);o(this,Tt).reset()}};Tt=new WeakMap,Oi.maxOverzooming=10,Oi.maxUnderzooming=3;let hn=Oi;const $f=/\{ *([\w_]+) *\}/g;function Vh(t,i){return t.replace($f,(e,s)=>{let r=i[s];if(r===void 0)throw new Error(`No value provided for variable ${e}`);return typeof r=="function"&&(r=r(i)),r})}var Si,Ri,Ci;class Vf extends yr{constructor(e,s){super();S(this,Si,void 0);S(this,Ri,void 0);S(this,Ci,void 0);this.roundZoom=!1,y(this,Si,!1),y(this,Ci,new Map),this.id=e,this.type=Bi.tile,this.minZoom=s.minZoom??0,this.maxZoom=s.maxZoom??22,this.roundZoom=!!s.roundZoom,this.scheme=s.scheme||"xyz",this.tileSize=s.tileSize||512,this.tileBounds=s.tileBounds,this.wrapX=!!s.wrapX;const r=s.decodeType||pn.image,n=s.maxTileCacheSize;this.options={...s,decodeType:r,maxTileCacheSize:n,type:this.type},y(this,Ri,new hn(this.id,this))}get sourceCache(){return o(this,Ri)}onAdd(e,s){this.layer=e,this.load(s)}update(e,s=!0){return this.options.url=e.url,this.reload(s),this}prepare(e,s,r){this.renderer=e,this.dispatcher=s,this.parseOptions=r}load(e){y(this,Si,!0),this.url=this.options.url,e&&e(null)}loaded(){return o(this,Si)}reload(e){y(this,Si,!1),this.load(()=>{var s;e?o(this,Ri).clearTiles():o(this,Ri).reload(),(s=this.layer)==null||s.update()})}hasTile(e){return!this.tileBounds||of(this.tileBounds,e.getTileBounds())}getFadeTime(){return 0}getUrl(e,s,r){const{subdomains:n}=this.options;let l="";if(n&&Array.isArray(n)&&n.length>0){const{length:d}=n;let p=(e+s)%d;p<0&&(p=0),l=n[p]}const c={x:e,y:s,z:r,s:l};return Array.isArray(this.url)?(this.url.length>2&&console.warn(`[TileSource]: Only supports up to two urls, Now there are more than two urls-${this.url.toString()}, and only the first two are selected by default`),this.url.filter((d,p)=>p<2).map(d=>Vh(d,c))):Vh(this.url,c)}asyncActor(e,s){return new Promise((r,n)=>{const l=`${e.tileID.tileKey}-${s}`;e.actor.send("loadData",{url:ma(s),cancelId:l,type:"arrayBuffer",decodeType:this.options.decodeType},(c,d)=>{if(c)return n(c);r(d)}),e.request.set(l,s)})}getTileUrl(e){const s=e.z,r=e.x,n=this.scheme==="tms"?Math.pow(2,e.z)-e.y-1:e.y,l=this.getUrl(r,n,s);let c=l;return Me.isString(l)&&(c=[l]),c}loadTile(e,s){try{if(!e.actor||e.state===ee.reloading){const r=this.getTileUrl(e.tileID),n=r.join(",");o(this,Ci).set(n,o(this,Ci).get(n)||this.dispatcher.getActor()),e.actor=o(this,Ci).get(n);const l=[];for(let c=0;c<r.length;c++)l.push(this.asyncActor(e,r[c]));Promise.all(l).then(c=>{if(e.request.clear(),e.aborted)return e.state=ee.unloaded,s(null);if(!c)return s(null);c.forEach((d,p)=>{e.setTextures(this.renderer,p,d,this.parseOptions,this.options)}),e.state=ee.loaded,s(null)}).catch(c=>{e.state=ee.errored,console.log(c)})}else e.state===ee.loading&&(e.reloadCallback=s)}catch(r){return e.state=ee.errored,s(r)}}abortTile(e,s){if(e.request){if(e.request.size>0&&e.actor){const r=e.request.entries();for(let n=0;n<e.request.size;n++){const[l,c]=r.next().value;l&&e.actor.send("cancel",{url:c,cancelId:l},d=>{d&&(e.state=ee.unloaded)})}}e.request.clear()}else e.state=ee.unloaded;s()}unloadTile(e,s){e.actor}destroy(){this.layer=null,y(this,Si,!1),o(this,Ci).clear(),o(this,Ri).clear()}}Si=new WeakMap,Ri=new WeakMap,Ci=new WeakMap;var Fi,Pi,Ii;class Hf extends yr{constructor(e,s){super();S(this,Fi,void 0);S(this,Pi,void 0);S(this,Ii,void 0);this.roundZoom=!1,y(this,Fi,!1),y(this,Ii,new Map),this.id=e,this.type=Bi.image,this.minZoom=0,this.maxZoom=22,this.roundZoom=!1,this.tileSize=512,this.coordinates=s.coordinates,this.wrapX=!!s.wrapX,this.url=s.url;const r=s.decodeType||pn.image;this.options={...s,decodeType:r,type:this.type},y(this,Pi,new hn(this.id,this))}get sourceCache(){return o(this,Pi)}onAdd(e,s){this.layer=e,this.load(s)}prepare(e,s,r){this.renderer=e,this.dispatcher=s,this.parseOptions=r}update(e,s=!0){this.options.url=e.url,this.reload(s)}updateImage(e,s=!0){this.options={...this.options,...e},this.reload(s)}setCoordinates(e){this.coordinates=e,this.reload(!1)}asyncActor(e,s){return new Promise((r,n)=>{const l=`${e.tileID.tileKey}-${s}`;e.actor.send("loadData",{url:ma(s),cancelId:l,type:"arrayBuffer",decodeType:this.options.decodeType},(c,d)=>{if(c)return n(c);r(d)}),e.request.set(l,s)})}load(e){y(this,Fi,!0),this.url=this.options.url,e&&e(null)}loaded(){return o(this,Fi)}reload(e){y(this,Fi,!1),this.load(()=>{var s;e?o(this,Pi).clearTiles():o(this,Pi).reload(),(s=this.layer)==null||s.update()})}getTileUrl(e){let s=this.url;return Me.isString(this.url)&&(s=[this.url]),s}loadTile(e,s){try{if(!e.actor||e.state===ee.reloading){const r=this.getTileUrl(e.tileID),n=r.join(",");o(this,Ii).set(n,o(this,Ii).get(n)||this.dispatcher.getActor()),e.actor=o(this,Ii).get(n);const l=[];for(let c=0;c<r.length;c++)l.push(this.asyncActor(e,r[c]));Promise.all(l).then(c=>{if(e.request.clear(),e.aborted)return e.state=ee.unloaded,s(null);if(!c)return s(null);c.forEach((d,p)=>{e.setTextures(this.renderer,p,d,this.parseOptions,this.options)}),e.state=ee.loaded,s(null)}).catch(c=>{e.state=ee.errored,console.log(c)})}else e.state===ee.loading&&(e.reloadCallback=s)}catch(r){return e.state=ee.errored,s(r)}}hasTile(e){return!0}getFadeTime(){return 0}abortTile(e,s){if(e.request){if(e.request.size>0&&e.actor){const r=e.request.entries();for(let n=0;n<e.request.size;n++){const[l,c]=r.next().value;l&&e.actor.send("cancel",{url:c,cancelId:l},d=>{d&&(e.state=ee.unloaded)})}}e.request.clear()}else e.state=ee.unloaded;s()}unloadTile(e,s){}destroy(){this.layer=null,y(this,Fi,!1),o(this,Ii).clear(),o(this,Pi).clear()}}Fi=new WeakMap,Pi=new WeakMap,Ii=new WeakMap;class jf{constructor(){this.tracks=new Set,this.run=this.run.bind(this),this.raf=new Ao(this.run)}add(i){this.tracks.has(i)||(this.tracks.add(i),this.raf.start())}run(i){this.tracks.forEach(e=>{e.tick(i)})}remove(i){this.tracks.has(i)&&this.tracks.delete(i),this.tracks.size===0&&this.raf.stop()}}let qn=null;function qf(){return qn||(qn=new jf),qn}const No={duration:1e3,autoplay:!0,repeat:!0,delay:0,endDelay:0,track:t=>{}},Zn=qf();var Bs,We,it,es,Fe;class Zf extends yr{constructor(e){super();S(this,Bs,!1);S(this,We,0);S(this,it,-1);S(this,es,-1);S(this,Fe,void 0);y(this,Fe,{...No,...e}),o(this,Fe).autoplay&&this.play()}get state(){return o(this,We)}get totalDuration(){return o(this,Fe).delay+o(this,Fe).duration+o(this,Fe).endDelay}get elapsedTime(){return o(this,it)}get totalPosition(){return Math.max(0,Math.min(1,o(this,it)/this.totalDuration))}get isPlaying(){return o(this,We)===1}get isPaused(){return o(this,We)===2}get isActive(){return this.isPlaying||this.isPaused}get position(){return o(this,it)<o(this,Fe).delay?0:o(this,it)>=o(this,Fe).delay+o(this,Fe).duration?1:Math.max(0,Math.min(1,(o(this,it)-o(this,Fe).delay)/o(this,Fe).duration))}play(){y(this,Bs,!0),y(this,We,1),this.advance(0),Zn.add(this)}pause(){o(this,We)===1&&y(this,We,2)}resume(){o(this,We)===2&&y(this,We,1)}stop(){y(this,Bs,!1),y(this,We,3),Zn.remove(this)}restart(){y(this,it,0),Zn.add(this)}reset(){o(this,We)===1?this.stop():this.advance(0)}toggle(){o(this,Bs)&&(this.isPlaying?this.pause():this.resume())}advance(e,s=!0){var n,l;const r=Me.clamp(e,0,1);y(this,it,s?this.totalDuration*r:o(this,Fe).delay+o(this,Fe).duration*r),(l=(n=o(this,Fe))==null?void 0:n.track)==null||l.call(n,this.position),this.emit("track",{position:this.position})}tick(e){o(this,es)<0&&y(this,es,e);const s=o(this,es);if(y(this,es,e),o(this,We)!==1)return;const r=e-s;y(this,it,o(this,it)+r),y(this,it,Math.min(o(this,it),this.totalDuration)),this.totalPosition===1?(this.advance(this.totalPosition),o(this,Fe).repeat?this.restart():this.stop()):this.advance(this.totalPosition)}}Bs=new WeakMap,We=new WeakMap,it=new WeakMap,es=new WeakMap,Fe=new WeakMap;const Hh={tile:Vf,image:Hf};function jh(t){let i=[];return Me.isString(t)&&(i=[t]),i.join(",")}var ts,Ns,ke,Pe,Mt,is,Se,At;class sd extends yr{constructor(e,s){super();S(this,ts,void 0);S(this,Ns,void 0);S(this,ke,void 0);S(this,Pe,void 0);S(this,Mt,void 0);S(this,is,void 0);S(this,Se,void 0);S(this,At,void 0);this.roundZoom=!1,y(this,ts,!1),y(this,is,0),y(this,At,new Map),this.id=e,this.type=Bi.timeline,this.minZoom=s.minZoom??0,this.maxZoom=s.maxZoom??22,this.roundZoom=!!s.roundZoom;const r=s.scheme||"xyz";if(this.tileSize=s.tileSize||512,this.tileBounds=s.tileBounds,this.wrapX=!!s.wrapX,s.sourceType===Bi.image&&!s.coordinates)throw new Error("ImageSource must provide `coordinates`");this.coordinates=s.coordinates,this.intervals=s.intervals;const n=s.decodeType||pn.image,l=s.maxTileCacheSize;this.options={...No,...s,decodeType:n,maxTileCacheSize:l,wrapX:this.wrapX,type:this.type};const c=this.intervals[0];y(this,Mt,0),this.animate=this.animate.bind(this),this.tilesLoadEnd=this.tilesLoadEnd.bind(this);const d={};if(s.sourceType===Bi.image)Object.assign(d,{url:c.url,coordinates:this.coordinates,maxTileCacheSize:this.options.maxTileCacheSize,minZoom:this.minZoom,maxZoom:this.maxZoom,decodeType:n});else if(s.sourceType===Bi.tile)Object.assign(d,{url:c.url,subdomains:this.options.subdomains,minZoom:this.minZoom,maxZoom:this.maxZoom,tileSize:this.tileSize,roundZoom:this.roundZoom,tileBounds:this.tileBounds,maxTileCacheSize:this.options.maxTileCacheSize,scheme:r,decodeType:n});else throw new Error("不支持的数据源类型！");y(this,ke,new Hh[s.sourceType](`${this.id}_current`,d)),y(this,Pe,new Hh[s.sourceType](`${this.id}_next`,d));const p=o(this,ke).loadTile,g=o(this,Pe).loadTile,v=this;function w(T,E){const A=`${T.tileID.tileKey}-${jh(this.url)}`,R=o(v,At).get(A);R?(T.copy(R),E(null,!0)):p.call(this,T,(U,C)=>{!U&&!o(v,At).has(A)&&T.state===ee.loaded&&o(v,At).set(A,T),E(U,C)})}function _(T,E){const A=`${T.tileID.tileKey}-${jh(this.url)}`,R=o(v,At).get(A);R?(T.copy(R),E(null,!0)):g.call(this,T,(U,C)=>{!U&&!o(v,At).has(A)&&T.state===ee.loaded&&o(v,At).set(A,T),E(U,C)})}o(this,ke).loadTile=w,o(this,Pe).loadTile=_,o(this,ke).sourceCache.on("tilesLoadEnd",this.tilesLoadEnd),o(this,Pe).sourceCache.on("tilesLoadEnd",this.tilesLoadEnd)}get track(){return o(this,Se)}get privateType(){return this.options.sourceType}get cache(){return o(this,At)}get source(){return[o(this,ke),o(this,Pe)]}get sourceCache(){var e,s;return[(e=o(this,ke))==null?void 0:e.sourceCache,(s=o(this,Pe))==null?void 0:s.sourceCache].filter(Boolean)}onAdd(e){this.layer=e,o(this,ke)&&o(this,ke).onAdd(this.layer,s=>{s||o(this,Pe)&&o(this,Pe).onAdd(this.layer,r=>{r||this.load()})})}prepare(e,s,r){this.renderer=e,this.dispatcher=s,this.parseOptions=r,o(this,ke)&&o(this,ke).prepare(e,s,r),o(this,Pe)&&o(this,Pe).prepare(e,s,r)}getFadeTime(){return o(this,is)}tilesLoadEnd(){this.resume()}animate({position:e}){var l,c;const s=this.intervals.length,r=o(this,Mt);y(this,Mt,e*Me.clamp(s-1,0,1/0));const n=Math.floor(o(this,Mt))-Math.floor(r);if(n>0||n<0)if(!((l=o(this,ke))!=null&&l.sourceCache.loaded())||!((c=o(this,Pe))!=null&&c.sourceCache.loaded()))this.pause();else{y(this,is,0),[Li(this,ke)._,Li(this,Pe)._]=[o(this,Pe),o(this,ke)],this.pause();const d=this.intervals[Me.clamp(Math.floor(o(this,Mt)),0,s-1)];o(this,Pe).update(d,!0)}else y(this,is,o(this,Mt)%1);this.layer&&this.layer.onTileLoaded(),this.emit("update",{position:e,index:o(this,Mt),clampIndex:Me.clamp(Math.floor(o(this,Mt)),0,s-1)})}play(){o(this,Se).play(),this.emit("play",{position:o(this,Se).position})}pause(){o(this,Se).pause(),this.emit("pause",{position:o(this,Se).position})}resume(){o(this,Se).resume(),this.emit("resume",{position:o(this,Se).position})}stop(){o(this,Se).stop(),this.emit("stop",{position:o(this,Se).position})}restart(){o(this,Se).restart(),this.emit("restart",{position:o(this,Se).position})}load(e){var s;y(this,ts,!0),y(this,Se,new Zf({duration:this.options.duration*Me.clamp(this.intervals.length-1,0,1/0),endDelay:this.options.endDelay,repeat:this.options.repeat,autoplay:this.options.autoplay})),o(this,Se).on("track",this.animate),(s=this.layer)==null||s.update(),e&&e(null),this.emit("loaded",{position:o(this,Se).position})}loaded(){return o(this,ts)}destroy(){this.layer=null,y(this,ts,!1),o(this,Se).off("track",this.animate),o(this,Ns)&&Array.isArray(o(this,Ns))&&o(this,Ns).forEach(e=>{e.clear()}),this.emit("destroy")}}ts=new WeakMap,Ns=new WeakMap,ke=new WeakMap,Pe=new WeakMap,Mt=new WeakMap,is=new WeakMap,Se=new WeakMap,At=new WeakMap;const rd=en.configDeps;var Wf=sn;function sn(t,i){var e=t&&t.type,s;if(e==="FeatureCollection")for(s=0;s<t.features.length;s++)sn(t.features[s],i);else if(e==="GeometryCollection")for(s=0;s<t.geometries.length;s++)sn(t.geometries[s],i);else if(e==="Feature")sn(t.geometry,i);else if(e==="Polygon")qh(t.coordinates,i);else if(e==="MultiPolygon")for(s=0;s<t.coordinates.length;s++)qh(t.coordinates[s],i);return t}function qh(t,i){if(t.length!==0){Zh(t[0],i);for(var e=1;e<t.length;e++)Zh(t[e],!i)}}function Zh(t,i){for(var e=0,s=0,r=0,n=t.length,l=n-1;r<n;l=r++){var c=(t[r][0]-t[l][0])*(t[l][1]+t[r][1]),d=e+c;s+=Math.abs(e)>=Math.abs(c)?e-d+c:c-d+e,e=d}e+s>=0!=!!i&&t.reverse()}const nd=Yh(Wf);export{id as B,pn as D,Hf as I,Bi as L,Ui as M,Jf as O,Qf as P,Et as R,Eo as S,Vf as T,xe as V,Ut as a,Xf as b,ht as c,an as d,Bo as e,St as f,sd as g,lu as h,Me as i,rd as j,ed as p,nd as r};
