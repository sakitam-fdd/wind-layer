import{a as n}from"./leaflet-src.Blu32DaZ.js";import{c as a,W as h,d as r,i as d,f as p,a as o}from"./wind-core.esm.BkKQCIS-.js";import{F as v}from"./wind-core.esm.BkKQCIS-.js";import"./commonjsHelpers.Cpj98o6Y.js";class _ extends n.Layer{constructor(t,i,s){super(t,i,s)}initialize(t,i,s){if(!t)throw Error("layer id must be specified");this._layerId=t,n.Util.setOptions(this,s),this.field=void 0,this.pickWindOptions(),this.devicePixelRatio=this.options.devicePixelRatio||window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI,i&&this.setData(i,s.fieldOptions)}_createCanvas(t,i){const s=n.DomUtil.create("div","leaflet-canvas-layer"),e=a(this._width,this._height,this.devicePixelRatio);return e.id=String(t),e.style.position="absolute",e.style.top=String(0),e.style.left=String(0),e.style.zIndex=String(i),e.style.willChange="transform",e.style.width=this._width+"px",e.style.height=this._height+"px",s.appendChild(e),this._map.getPanes().overlayPane.appendChild(s),{layer:s,canvas:e}}_reset(){const t=this._map.containerPointToLayerPoint([0,0]);n.DomUtil.setPosition(this.canvas,t)}_onResize(t){this.canvas.style.width=t.newSize.x+"px",this.canvas.style.height=t.newSize.y+"px",this._width=t.newSize.x,this._height=t.newSize.y,this._resizeCanvas(this.devicePixelRatio)}_zoomStart(){this._moveStart()}_moveStart(){this._updating||(this._updating=!0)}_animateZoom(t){const i=this._map.getZoomScale(t.zoom),s=this._map._latLngToNewLayerPoint(this._map.getBounds().getNorthWest(),t.zoom,t.center);n.DomUtil.setTransform(this.canvas,s,i)}_resizeCanvas(t){this.canvas.width=this._width*t,this.canvas.height=this._height*t}_render(){this._reset();const t=this.getWindOptions();if(!this.wind&&this._map){const i=this.canvas.getContext("2d"),s=this.getData();this.wind=new h(i,t,s),this.wind.project=this.project.bind(this),this.wind.unproject=this.unproject.bind(this),this.wind.intersectsCoordinate=this.intersectsCoordinate.bind(this),this.wind.postrender=()=>{}}this.wind.prerender(),this.wind.render()}project(t){const i=this._map.latLngToContainerPoint(new n.LatLng(t[1],t[0]));return[i.x*this.devicePixelRatio,i.y*this.devicePixelRatio]}unproject(t){const i=this._map.containerPointToLatLng(new n.Point(t[0],t[1]));return[i.lng,i.lat]}intersectsCoordinate(t){return this._map.getBounds().contains(n.latLng(t[1],t[0]))}onAdd(t){this._map=t,this._width=t.getSize().x,this._height=t.getSize().y;const{layer:i,canvas:s}=this._createCanvas(this._layerId,this.options.zIndex||1);this.layer=i,this.canvas=s;const e=this._map.options.zoomAnimation&&n.Browser.any3d;return n.DomUtil.addClass(this.canvas,"leaflet-zoom-"+(e?"animated":"hide")),this._map.on(this.getEvents(),this),this._render(),this}onRemove(){return this.wind&&this.wind.stop(),this._map.getPanes().overlayPane.removeChild(this.layer),this._map.off(this.getEvents(),this),this.canvas=null,this}getEvents(){const t={resize:this._onResize,viewreset:this._render,moveend:this._render,zoomEnd:this._render};return this._map.options.zoomAnimation&&n.Browser.any3d&&(t.zoomanim=this._animateZoom),t}pickWindOptions(){Object.keys(r).forEach(t=>{t in this.options&&(this.options.windOptions===void 0&&(this.options.windOptions={}),this.options.windOptions[t]=this.options[t])})}getData(){return this.field}setData(t,i={}){var s;return t&&t.checkFields&&t.checkFields()?this.field=t:d(t)?this.field=p(t,i):console.error("Illegal data"),this.field&&((s=this==null?void 0:this.wind)==null||s.updateData(this.field)),this}setWindOptions(t){const i=this.options.windOptions||{};if(this.options=o(this.options,{windOptions:o(i,t||{})}),this.wind){const s=this.options.windOptions;this.wind.setOptions(s),this.wind.prerender()}}getWindOptions(){return this.options.windOptions||{}}}export{v as Field,_ as WindLayer,_ as default};
