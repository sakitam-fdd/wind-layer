var I=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var M=(n,e,r)=>(I(n,e,"read from private field"),r?r.call(n):e.get(n)),z=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},F=(n,e,r,t)=>(I(n,e,"write to private field"),t?t.call(n,r):e.set(n,r),r);var k=(n,e,r)=>(I(n,e,"access private method"),r);import{i as K,b as Q,S as ee,P as te,O as re,f as se,r as ne,p as ie,B as oe,L as G,c as B,h as ae}from"./index.Y03mSbfw.js";import{D as ze,I as ke,e as Be,R as Ze,a as Ae,T as Ie,g as Fe,j as Ge}from"./index.Y03mSbfw.js";import{renderer as V,Coordinate as S,Point as $,CanvasLayer as he,Browser as le,Util as ce,TileLayer as H}from"./maptalks.es-bundler.jLZr5Ieh.js";import{W as de,a as U,d as pe,i as ge,f as me}from"./wind-core.esm.BkKQCIS-.js";import{F as Xe}from"./wind-core.esm.BkKQCIS-.js";import"./commonjsHelpers.Cpj98o6Y.js";import"./index.B6qUrsMJ.js";function ue(n,e){const r=e[0],t=e[1];return n[0]<=r&&r<=n[2]&&n[1]<=t&&t<=n[3]}function fe(n,e,r){const t=n.length,s=r>1?r:2;let o=e;o===void 0&&(s>2?o=n.slice():o=new Array(t));for(let i=0;i<t;i+=s)o[i]=180*n[i]/20037508342789244e-9,o[i+1]=360*Math.atan(Math.exp(n[i+1]/6378137))/Math.PI-90;return o}function ye(n,e,r,t,s){return s?(s[0]=n,s[1]=e,s[2]=r,s[3]=t,s):[n,e,r,t]}function we(n,e,r){const t=Math.min.apply(null,n),s=Math.min.apply(null,e),o=Math.max.apply(null,n),i=Math.max.apply(null,e);return ye(t,s,o,i,r)}function xe(n,e,r,t){let s=[];if(t>1){const h=n[2]-n[0],l=n[3]-n[1];for(let c=0;c<t;++c)s.push(n[0]+h*c/t,n[1],n[2],n[1]+l*c/t,n[2]-h*c/t,n[3],n[0],n[3]-l*c/t)}else s=[n[0],n[1],n[2],n[1],n[2],n[3],n[0],n[3]];e(s,s,2);const o=[],i=[];for(let h=0,l=s.length;h<l;h+=2)o.push(s[h]),i.push(s[h+1]);return we(o,i,r)}function ve(n,e){return xe(n,fe,void 0,e)}const Ce={renderer:"canvas",doubleBuffer:!1,animation:!1,windOptions:{}};class Te extends V.CanvasLayerRenderer{checkResources(){return[]}getDrawParams(){return[]}hitDetect(){return!1}draw(){this.prepareCanvas(),this.prepareDrawContext(),this.drawWind()}_redraw(){this.prepareRender(),this.draw()}drawWind(){const e=this.getMap();if(this.context){const r=this.layer,t=r.getWindOptions();if(!this.wind&&e){const s=r.getData();this.wind=new de(this.context,t,s),this.wind.project=this.project.bind(this),this.wind.unproject=this.unproject.bind(this),this.wind.intersectsCoordinate=this.intersectsCoordinate.bind(this),this.wind.postrender=()=>{this.setCanvasUpdated()},this.wind.prerender()}this.wind&&(this.wind.prerender(),this.wind.render())}this.completeRender()}project(e){const t=this.getMap().coordinateToContainerPoint(new S(e[0],e[1]));return[t.x,t.y]}unproject(e){return this.getMap().containerPointToCoordinate(new $(e[0],e[1])).toArray()}intersectsCoordinate(e){var h;if(!this.layer)return!1;const r=(h=this.layer)==null?void 0:h.getProjection();if(r&&r.code!=="EPSG:3857")return!0;const s=this.getMap().getProjExtent(),o=[s.xmin,s.ymin,s.xmax,s.ymax],i=ve(o,0);return ue(i,[e[0],e[1]])}drawOnInteracting(){}onZoomStart(...e){this.wind&&this.wind.stop(),super.onZoomStart.apply(this,e)}onZoomEnd(...e){this.wind&&this.wind.start(),super.onZoomEnd.apply(this,e)}onDragRotateStart(...e){this.wind&&this.wind.stop(),super.onDragRotateStart.apply(this,e)}onDragRotateEnd(...e){this.wind&&this.wind.start(),super.onDragRotateEnd.apply(this,e)}onMoveStart(...e){this.wind&&this.wind.stop(),super.onMoveStart.apply(this,e)}onMoveEnd(...e){this.wind&&this.wind.start(),super.onMoveEnd.apply(this,e)}remove(){this.wind&&this.wind.stop(),delete this._drawContext,super.remove()}getMap(){return super.getMap()}prepareCanvas(){return super.prepareCanvas()}prepareDrawContext(){super.prepareDrawContext()}prepareRender(){return super.prepareRender()}completeRender(){return super.completeRender()}}class Re extends he{constructor(e,r,t={}){super(e,U({},Ce,t)),this._map=null,this.pickWindOptions(),r&&this.setData(r,t.fieldOptions)}pickWindOptions(){Object.keys(pe).forEach(e=>{this.options&&e in this.options&&(this.options.windOptions===void 0&&(this.options.windOptions={}),this.options.windOptions[e]=this.options[e])})}getData(){return this.field}setData(e,r={}){e&&e.checkFields&&e.checkFields()?this.field=e:ge(e)?this.field=me(e,r):console.error("Illegal data");const t=this._getRenderer();return t&&t.wind&&this.field&&t.wind.updateData(this.field),this}setWindOptions(e){const r=this.options.windOptions||{};this.options=U(this.options,{windOptions:U(r,e||{})});const t=this._getRenderer();if(t&&t.wind){const s=this.options.windOptions;t.wind.setOptions(s)}}getWindOptions(){return this.options.windOptions||{}}draw(){return this._getRenderer()&&this._getRenderer()._redraw(),this}prepareToDraw(){return[]}drawOnInteracting(){this.draw()}_getRenderer(){return super._getRenderer()}}Re.registerRenderer("canvas",Te);ae(!0);function O(n){return n.getGLRes?n.getGLRes():n.getGLZoom()}function Me(n,e,r){return n>=e&&n<r}function b(n,e,r,t){return n.coordToPointAtRes?n.coordToPointAtRes(e,r,t):n.coordinateToPoint(e,r,t)}const Z=new $(0,0);var v,A,Y,D,X;class Se extends V.CanvasLayerRenderer{constructor(){super(...arguments);z(this,A);z(this,D);z(this,v,void 0)}getPrepareParams(){return[this.scene,this.camera]}getDrawParams(){return[this.scene,this.camera]}_drawLayer(...r){super._drawLayer.apply(this,r)}hitDetect(){return!1}createCanvas(){super.createCanvas(),this.createContext()}createContext(){var r;if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{const t=this.layer,s=t.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0};s.preserveDrawingBuffer=!0,this.gl=this.gl||K.getContext(this.canvas,s,(r=t.options)==null?void 0:r.requestWebGl2)}k(this,A,Y).call(this),this.layer.onCanvasCreate(this.context,this.scene,this.camera)}onCanvasCreate(){super.onCanvasCreate()}resizeCanvas(r){if(!this.canvas)return;let t;const s=this.getMap();r?t=r:t=s.getSize();const o=s.getDevicePixelRatio?s.getDevicePixelRatio():le.retina?2:1,i=this.canvas,{width:h,height:l,cssWidth:c,cssHeight:m}=ce.calCanvasSize(t,o);if(this.layer._canvas&&(i.style.width!==c||i.style.height!==m)&&(i.style.width=c,i.style.height=m),i.width===h&&i.height===l)return this;i.width=h,i.height=l,this.context.setSize(i.width,i.height)}clearCanvas(){this.canvas&&this.context.clear()}prepareCanvas(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null}renderScene(r){var t,s,o,i;if(this.scene.worldMatrixNeedsUpdate=!0,k(this,D,X).call(this),r&&r.renderTarget){const{width:h,height:l}=r.renderTarget.fbo;M(this,v)?M(this,v).resize(h,l):F(this,v,new se(this.context,{width:h,height:l,depth:!1})),(t=this.layer.layer)==null||t.prerender({camera:this.camera,planeCamera:this.planeCamera}),M(this,v).swapHandle(r.renderTarget.getFramebuffer(r.renderTarget.fbo)),(s=this.layer.layer)==null||s.render({camera:this.camera,planeCamera:this.planeCamera},M(this,v)),M(this,v).restoreHandle()}else(o=this.layer.layer)==null||o.prerender({camera:this.camera,planeCamera:this.planeCamera}),(i=this.layer.layer)==null||i.render({camera:this.camera,planeCamera:this.planeCamera});this.completeRender()}remove(){delete this._drawContext,M(this,v)&&(M(this,v).destroy(),F(this,v,void 0)),super.remove()}isTileCachedOrLoading(){return!1}}v=new WeakMap,A=new WeakSet,Y=function(){const r=new Q(this.gl,{autoClear:!1,extensions:["OES_texture_float","OES_texture_float_linear","WEBGL_color_buffer_float","EXT_color_buffer_float"]});r.setSize(this.canvas.width,this.canvas.height),this.context=r,this.context.state.setClearColor({r:0,g:0,b:0,a:0}),this.scene=new ee;const t=this.layer.getMap(),s=t.getFov()*Math.PI/180;this.camera=new te(s,t.width/t.height,t.cameraNear,t.cameraFar),this.planeCamera=new re(0,1,1,0,0,1),this.camera.matrixAutoUpdate=!1,k(this,D,X).call(this)},D=new WeakSet,X=function(){const r=this.getMap(),t=this.camera;t.localMatrix.fromArray(r.cameraWorldMatrix),t.projectionMatrix.fromArray(r.projMatrix),t.worldMatrixNeedsUpdate=!0,t.updateMatrixWorld()};const je={renderer:"gl",doubleBuffer:!1,glOptions:void 0,forceRenderOnZooming:!0};class q extends H{constructor(e,r,t){super(e,{...t,urlTemplate:"custom",tileSize:r.tileSize,repeatWorld:r.wrapX?"x":!1}),this._needsUpdate=!0,this._coordCache={},this.tempLayer=new H(e+"_temp",{...t,minZoom:r.minZoom,maxZoom:r.maxZoom,urlTemplate:"custom",tileSize:r.tileSize,repeatWorld:r.wrapX?"x":!1}),this.tempLayer.on("renderercreate",s=>{s.renderer.loadTile=function(i){return i},s.renderer.deleteTile=o=>{!o||!o.image||(o.image.onload=null,o.image.onerror=null)},s.renderer.loadTileImage=(o,i,h)=>{}}),this.source=r,this.type="VeLayer"}onMoveStart(){this.layer&&(this.layer.update(),this.layer.moveStart())}onMoving(){var e;(e=this.layer)==null||e.update()}onMoveEnd(){this.layer&&(this.layer.update(),this.layer.moveEnd())}onDragRotateStart(){this.layer&&this.layer.moveStart()}onDragRotateEnd(){this.layer&&this.layer.moveEnd()}onResize(){this.update()}onZoomStart(){var e;(e=this.layer)==null||e.update()}onZooming(){this.layer&&(this.layer.update(),this.layer.handleZoom())}onZoomEnd(){var e;(e=this.layer)==null||e.update()}update(){this.layer&&this.layer.update()}getWorlds(){const e=this.getMap(),r=e.getProjection().fullExtent,t=[r.left,r.bottom,r.right,r.top],s=e.getProjExtent(),o=[s.xmin,s.ymin,s.xmax,s.ymax],i=t[2]-t[0],h=O(e),l=e._prjToPointAtRes(new S([t[0],t[3]]),h),c=e._prjToPointAtRes(new S([t[2],t[1]]),h),m=Math.abs(l.x-c.x);let p=t[0],a=0;const g=[{world:0,offset:0,xmin:l.x,xmax:c.x}];for(;p>o[0];)--a,g.push({world:a,offset:a*m,xmin:l.x+a*m,xmax:c.x+a*m}),p-=i;for(a=0,p=t[2];p<o[2];)++a,g.push({world:a,offset:a*m,xmin:l.x+a*m,xmax:c.x+a*m}),p+=i;return this.projWorldWidth=m,g.sort((d,y)=>d.world-y.world)}calcWitchWorld(e,r){var t;for(let s=0;s<r.length;s++)if(Me(e[0],r[s].xmin,r[s].xmax))return r[s].world;return(t=r.find(s=>s.world===0))==null?void 0:t.world}getClipMask(){return this.options.mask}processMask(){const e=this.getMap();if(e&&this.options.mask){const r=O(e),t=this.options.mask,s=t.data;ne(s,!0);const o=m=>{const p=[];for(let a=0;a<m.length;a++){const g=m[a],d=b(e,new S(g),r);p.push([d.x,d.y])}return p},i=s.features,h=i.length;let l=0;const c=[];for(;l<h;l++){const m=i[l],p=m.geometry.coordinates,a=m.geometry.type;if(a==="Polygon")c.push({type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:m.geometry.coordinates.map(g=>o(g))}});else if(a==="MultiPolygon"){const g=[];for(let d=0;d<p.length;d++){const y=p[d],C=[];for(let u=0;u<y.length;u++)C.push(o(p[d][u]));g.push(C)}c.push({type:"Feature",properties:{},geometry:{type:"MultiPolygon",coordinates:g}})}}return{data:ie(c),type:t.type}}}setClipMask(e){this.options.mask=Object.assign({},this.options.mask,e),this.layer&&this.layer.setMask(this.processMask())}prepareToDraw(e,r){const t=this.options,s=this.getMap(),o=this._getRenderer();if(!s||!o)return!1;this.getWorlds(),this.layer=new oe(this.source,{renderer:o.context,scene:o.scene},{renderType:t.renderType,renderFrom:t.renderFrom,styleSpec:t.styleSpec,displayRange:t.displayRange,widthSegments:t.widthSegments,heightSegments:t.heightSegments,wireframe:t.wireframe,picking:t.picking,mask:this.processMask(),getZoom:()=>s.getZoom(),triggerRepaint:()=>{o.setToRedraw()},flipY:!0,glScale:()=>this.projWorldWidth,zoomScale:()=>2,getTileProjSize:(i,h)=>{const l=h.find(c=>c.z===i);return l?[l.projTileBounds.right-l.projTileBounds.left,l.projTileBounds.top-l.projTileBounds.bottom]:[this.projWorldWidth,this.projWorldWidth]},getViewTiles:i=>{let{type:h}=i;const l=this.getWorlds();h=h!==G.timeline?h:i.privateType;const c=[],m=O(s);if(h===G.image){const{coordinates:p}=i,[a,g]=[[p[0][0],p[2][1]],[p[1][0],p[0][1]]],d=b(s,new S([a[0],g[1]]),m),y=b(s,new S([g[0],a[1]]),m),C=0,u=0,w=0;if(this.source.wrapX)for(let f=0;f<l.length;f++){const{world:T,offset:x}=l[f];c.push(new B(w,T,w,C,u,{getTileBounds:()=>[a[0],a[1],g[0],g[1]],getTileProjBounds:()=>({left:d.x+x,top:d.y,right:y.x+x,bottom:y.y})}))}else c.push(new B(w,0,w,C,u,{getTileBounds:()=>[a[0],a[1],g[0],g[1]],getTileProjBounds:()=>({left:d.x,top:d.y,right:y.x,bottom:y.y})}))}else if(h===G.tile){const{tileGrids:p}=this.tempLayer.getTiles(),{tiles:a}=p[0];for(let g=0;g<a.length;g++){const d=a[g],y=s._getResolution(d.z),u=this._getTileConfig().getTilePrjExtent(d.x,d.y,y);let w=u.getMax(),f=u.getMin();const T=s.getProjection();f=T.unproject(f),w=T.unproject(w);const{extent2d:x,offset:j}=d,R=d._glScale=d._glScale||d.res/s.getGLRes(),_=Z.set(x.xmin-j[0],x.ymax-j[1]),P=_.x*R,W=_.y*R,E=Z.set(x.xmax-j[0],x.ymin-j[1]),L=E.x*R,N=E.y*R,J=this.calcWitchWorld([(L-P)/2+P,(N-W)/2+W],l);c.push(new B(d.z,J,d.z,d.x,d.y,{getTileBounds:()=>[f.x,f.y,w.x,w.y],getTileProjBounds:()=>({left:P,top:W,right:L,bottom:N})}))}}return c},getExtent:()=>{const i=s.getProjExtent()._scale(1/O(s)),h=O(s),l=b(s,new S([0,-90]),h),c=b(s,new S([0,90]),h);return[i.xmin,i.ymin<l.y?l.y:i.ymin,i.xmax,i.ymax>c.y?c.y:i.ymax]},getGridTiles:i=>{const{tileGrids:h}=this.getTiles(),{tiles:l}=h[0],c=[],m=this.getWorlds();for(let p=0;p<l.length;p++){const a=l[p],g=s._getResolution(a.z),y=this._getTileConfig().getTilePrjExtent(a.x,a.y,g);let C=y.getMax(),u=y.getMin();const w=s.getProjection();u=w.unproject(u),C=w.unproject(C);const{extent2d:f,offset:T}=a,x=a._glScale=a._glScale||a.res/s.getGLRes(),j=Z.set(f.xmin-T[0],f.ymax-T[1]),R=j.x*x,_=j.y*x,P=Z.set(f.xmax-T[0],f.ymin-T[1]),W=P.x*x,E=P.y*x,L=this.calcWitchWorld([(W-R)/2+R,(E-_)/2+_],m);c.push(new B(a.z,L,a.z,a.x,a.y,{getTileBounds:()=>[u.x,u.y,C.x,C.y],getTileProjBounds:()=>({left:R,top:_,right:W,bottom:E})}))}return c}}),s.on("viewchange",this.update,this),this.update()}isRendering(){const e=this.getMap();return e?e.isInteracting()||e.isAnimating():!1}draw(e,r,t,s,o,i){this.renderScene(i,this)}drawOnInteracting(e,r,t,s,o,i,h){this.renderScene(h,this)}getObjects(){const e=this.getScene();if(!e)return[];const r=[];for(let t=0,s=e.children.length;t<s;t++){const o=e.children[t];o&&r.push(o)}return r}clear(){return this.clearObject()}clearObject(){const e=this.getScene();if(!e)return this;for(let r=e.children.length-1;r>=0;r--){const t=e.children[r];t&&e.remove(t)}return this}getCamera(){const e=this._getRenderer();return e?e.camera:null}getScene(){const e=this._getRenderer();return e?e.scene:null}renderScene(e,r){const t=this._getRenderer();return t&&(t.clearCanvas(),t.renderScene(e),r||t.setToRedraw()),this}onAdd(){super.onAdd();const e=this.map||this.getMap();return e?(e.addLayer(this.tempLayer),this._needsUpdate=!0,this):this}onRemove(){super.onRemove();const e=this.map||this.getMap();return e?(e==null||e.off("viewchange",this.update,this),this.clear(),this.layer&&(this.layer=null),this):this}getEvents(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotateend:this.onDragRotateEnd}}}q.mergeOptions(je);q.registerRenderer("gl",Se);export{ze as DecodeType,Xe as Field,ke as ImageSource,q as Layer,G as LayerSourceType,Be as MaskType,Ze as RenderFrom,Ae as RenderType,B as TileID,Ie as TileSource,Fe as TimelineSource,de as WindCore,Re as WindLayer,Ge as configDeps,me as formatData};
