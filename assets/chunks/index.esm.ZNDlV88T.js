import{q as y}from"./index.cI_fw6Fh.js";function d(s,t){return s.minX=Math.min(s.minX,t.minX),s.minY=Math.min(s.minY,t.minY),s.maxX=Math.max(s.maxX,t.maxX),s.maxY=Math.max(s.maxY,t.maxY),s}function N(s,t){return s.minX-t.minX}function S(s,t){return s.minY-t.minY}function X(s){return(s.maxX-s.minX)*(s.maxY-s.minY)}function g(s){return s.maxX-s.minX+(s.maxY-s.minY)}function w(s,t){return(Math.max(t.maxX,s.maxX)-Math.min(t.minX,s.minX))*(Math.max(t.maxY,s.maxY)-Math.min(t.minY,s.minY))}function E(s,t){const n=Math.max(s.minX,t.minX),i=Math.max(s.minY,t.minY),h=Math.min(s.maxX,t.maxX),e=Math.min(s.maxY,t.maxY);return Math.max(0,h-n)*Math.max(0,e-i)}function Y(s,t){return s.minX<=t.minX&&s.minY<=t.minY&&t.maxX<=s.maxX&&t.maxY<=s.maxY}function M(s,t){return t.minX<=s.maxX&&t.minY<=s.maxY&&t.maxX>=s.minX&&t.maxY>=s.minY}function u(s){return{children:s,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function _(s,t,n,i,h){const e=[t,n];for(;e.length;){if(n=e.pop(),t=e.pop(),n-t<=i)continue;const r=t+Math.ceil((n-t)/i/2)*i;y(s,r,t,n,h),e.push(t,r,r,n)}}function A(s,t,n){if(!n)return t.indexOf(s);for(let i=0;i<t.length;i++)if(n(s,t[i]))return i;return-1}function B(s,t,n,i,h){let e=h;e||(e=u([])),e.minX=1/0,e.minY=1/0,e.maxX=-1/0,e.maxY=-1/0;for(let r=t;r<n;r++){const o=s.children[r];d(e,s.leaf?i(o):o)}return e}function x(s,t){B(s,0,s.children.length,t,s)}class R{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t,n){let i=this.data;const h=[],e=n&&n.intersects?n.intersects:M,r=n&&n.contains?n.contains:Y;if(!e(t,i))return h;const o=this.toBBox,c=[];for(;i;){for(let l=0;l<i.children.length;l++){const a=i.children[l],m=i.leaf?o(a):a;e(t,m)&&(i.leaf?h.push(a):r(t,m)?this._all(a,h):c.push(a))}i=c.pop()}return h}collides(t,n){let i=this.data;const h=n&&n.intersects?n.intersects:M,e=n&&n.contains?n.contains:Y;if(!h(t,i))return!1;const r=[];for(;i;){for(let o=0;o<i.children.length;o++){const c=i.children[o],l=i.leaf?this.toBBox(c):c;if(h(t,l)){if(i.leaf||e(t,l))return!0;r.push(c)}}i=r.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const i=this.data;this.data=n,n=i}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=u([]),this}remove(t,n){if(!t)return this;let i=this.data;const h=this.toBBox(t),e=[],r=[];let o,c,l;for(;i||e.length;){if(i||(i=e.pop(),c=e[e.length-1],o=r.pop(),l=!0),i&&i.leaf){const a=A(t,i.children,n);if(a!==-1)return i.children.splice(a,1),e.push(i),this._condense(e),this}!l&&!i.leaf&&Y(i,h)?(e.push(i),r.push(o),o=0,c=i,i=i.children[0]):c?(o++,i=c.children[o],l=!1):i=void 0}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n=[]){const i=[];let h=t;for(;h;)h.leaf?n.push(...h.children):i.push(...h.children),h=i.pop();return n}_build(t,n,i,h){let e=h;const r=i-n+1;let o=this._maxEntries,c;if(r<=o)return c=u(t.slice(n,i+1)),x(c,this.toBBox),c;e||(e=Math.ceil(Math.log(r)/Math.log(o)),o=Math.ceil(r/Math.pow(o,e-1))),c=u([]),c.leaf=!1,c.height=e;const l=Math.ceil(r/o),a=l*Math.ceil(Math.sqrt(o));_(t,n,i,a,this.compareMinX);for(let m=n;m<=i;m+=a){const f=Math.min(m+a-1,i);_(t,m,f,l,this.compareMinY);for(let p=m;p<=f;p+=l){const I=Math.min(p+l-1,f);c.children.push(this._build(t,p,I,e-1))}}return x(c,this.toBBox),c}_chooseSubtree(t,n,i,h){let e=n;for(;h.push(e),!(e.leaf||h.length-1===i);){let r=1/0,o=1/0,c;for(let l=0;l<e.children.length;l++){const a=e.children[l],m=X(a),f=w(t,a)-m;f<o?(o=f,r=m<r?m:r,c=a):f===o&&m<r&&(r=m,c=a)}e=c||e.children[0]}return e}_insert(t,n,i){const h=i?t:this.toBBox(t),e=[],r=this._chooseSubtree(h,this.data,n,e);for(r.children.push(t),d(r,h);n>=0&&e[n].children.length>this._maxEntries;)this._split(e,n),n--;this._adjustParentBBoxes(h,e,n)}_split(t,n){const i=t[n],h=i.children.length,e=this._minEntries;this._chooseSplitAxis(i,e,h);const r=this._chooseSplitIndex(i,e,h),o=u(i.children.splice(r,i.children.length-r));o.height=i.height,o.leaf=i.leaf,x(i,this.toBBox),x(o,this.toBBox),n?t[n-1].children.push(o):this._splitRoot(i,o)}_splitRoot(t,n){this.data=u([t,n]),this.data.height=t.height+1,this.data.leaf=!1,x(this.data,this.toBBox)}_chooseSplitIndex(t,n,i){let h,e=1/0,r=1/0;for(let o=n;o<=i-n;o++){const c=B(t,0,o,this.toBBox),l=B(t,o,i,this.toBBox),a=E(c,l),m=X(c)+X(l);a<e?(e=a,h=o,r=m<r?m:r):a===e&&m<r&&(r=m,h=o)}return h||i-n}_chooseSplitAxis(t,n,i){const h=t.leaf?this.compareMinX:N,e=t.leaf?this.compareMinY:S,r=this._allDistMargin(t,n,i,h),o=this._allDistMargin(t,n,i,e);r<o&&t.children.sort(h)}_allDistMargin(t,n,i,h){t.children.sort(h);const e=this.toBBox,r=B(t,0,n,e),o=B(t,i-n,i,e);let c=g(r)+g(o);for(let l=n;l<i-n;l++){const a=t.children[l];d(r,t.leaf?e(a):a),c+=g(r)}for(let l=i-n-1;l>=n;l--){const a=t.children[l];d(o,t.leaf?e(a):a),c+=g(o)}return c}_adjustParentBBoxes(t,n,i){for(let h=i;h>=0;h--)d(n[h],t)}_condense(t){for(let n=t.length-1,i;n>=0;n--)t[n].children.length===0?n>0?(i=t[n-1].children,i.splice(i.indexOf(t[n]),1)):this.clear():x(t[n],this.toBBox)}}export{R};
