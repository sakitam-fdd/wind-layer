import{C as w,a as x}from"./Collection.Dt_lAS1Y.js";import{p as g,V as A,B as G,l as F,E as O,O as D,u as R,h as L,g as U,T as b}from"./Object.DdgBWT7D.js";import{R as X}from"./index.C4-A-GQb.js";import{c as d,h as T,a4 as K,b as m,ak as V,Q as Y}from"./proj.BNE8J585.js";import{S as N}from"./Source.D9yXulch.js";import"./index.cI_fw6Fh.js";import"./Projection.Bg0YEavu.js";var I=function(){function u(n){this.rbush_=new X(n),this.items_={}}return u.prototype.insert=function(n,t){var e={minX:n[0],minY:n[1],maxX:n[2],maxY:n[3],value:t};this.rbush_.insert(e),this.items_[d(t)]=e},u.prototype.load=function(n,t){for(var e=new Array(t.length),r=0,i=t.length;r<i;r++){var a=n[r],s=t[r],o={minX:a[0],minY:a[1],maxX:a[2],maxY:a[3],value:s};e[r]=o,this.items_[d(s)]=o}this.rbush_.load(e)},u.prototype.remove=function(n){var t=d(n),e=this.items_[t];return delete this.items_[t],this.rbush_.remove(e)!==null},u.prototype.update=function(n,t){var e=this.items_[d(t)],r=[e.minX,e.minY,e.maxX,e.maxY];T(r,n)||(this.remove(t),this.insert(n,t))},u.prototype.getAll=function(){var n=this.rbush_.all();return n.map(function(t){return t.value})},u.prototype.getInExtent=function(n){var t={minX:n[0],minY:n[1],maxX:n[2],maxY:n[3]},e=this.rbush_.search(t);return e.map(function(r){return r.value})},u.prototype.forEach=function(n){return this.forEach_(this.getAll(),n)},u.prototype.forEachInExtent=function(n,t){return this.forEach_(this.getInExtent(n),t)},u.prototype.forEach_=function(n,t){for(var e,r=0,i=n.length;r<i;r++)if(e=t(n[r]),e)return e;return e},u.prototype.isEmpty=function(){return g(this.items_)},u.prototype.clear=function(){this.rbush_.clear(),this.items_={}},u.prototype.getExtent=function(n){var t=this.rbush_.toJSON();return K(t.minX,t.minY,t.maxX,t.maxY,n)},u.prototype.concat=function(n){this.rbush_.load(n.rbush_.all());for(var t in n.items_)this.items_[t]=n.items_[t]},u}();const l={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};function P(u,n){return[[-1/0,-1/0,1/0,1/0]]}var B=!1;function M(u,n,t,e,r,i,a){var s=new XMLHttpRequest;s.open("GET",typeof u=="function"?u(t,e,r):u,!0),n.getType()=="arraybuffer"&&(s.responseType="arraybuffer"),s.withCredentials=B,s.onload=function(o){if(!s.status||s.status>=200&&s.status<300){var f=n.getType(),h=void 0;f=="json"||f=="text"?h=s.responseText:f=="xml"?(h=s.responseXML,h||(h=new DOMParser().parseFromString(s.responseText,"application/xml"))):f=="arraybuffer"&&(h=s.response),h?i(n.readFeatures(h,{extent:t,featureProjection:r}),n.readProjection(h)):a()}else a()},s.onerror=a,s.send()}function C(u,n){return function(t,e,r,i,a){var s=this;M(u,n,t,e,r,function(o,f){s.addFeatures(o),i!==void 0&&i(o)},a||A)}}var S=function(){var u=function(n,t){return u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])},u(n,t)};return function(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");u(n,t);function e(){this.constructor=n}n.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}}(),p=function(u){S(n,u);function n(t,e,r){var i=u.call(this,t)||this;return i.feature=e,i.features=r,i}return n}(G),k=function(u){S(n,u);function n(t){var e=this,r=t||{};e=u.call(this,{attributions:r.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:r.wrapX!==void 0?r.wrapX:!0})||this,e.on,e.once,e.un,e.loader_=A,e.format_=r.format,e.overlaps_=r.overlaps===void 0?!0:r.overlaps,e.url_=r.url,r.loader!==void 0?e.loader_=r.loader:e.url_!==void 0&&(m(e.format_,7),e.loader_=C(e.url_,e.format_)),e.strategy_=r.strategy!==void 0?r.strategy:P;var i=r.useSpatialIndex!==void 0?r.useSpatialIndex:!0;e.featuresRtree_=i?new I:null,e.loadedExtentsRtree_=new I,e.loadingExtentsCount_=0,e.nullGeometryFeatures_={},e.idIndex_={},e.uidIndex_={},e.featureChangeKeys_={},e.featuresCollection_=null;var a,s;return Array.isArray(r.features)?s=r.features:r.features&&(a=r.features,s=a.getArray()),!i&&a===void 0&&(a=new w(s)),s!==void 0&&e.addFeaturesInternal(s),a!==void 0&&e.bindFeaturesCollection_(a),e}return n.prototype.addFeature=function(t){this.addFeatureInternal(t),this.changed()},n.prototype.addFeatureInternal=function(t){var e=d(t);if(!this.addToIndex_(e,t)){this.featuresCollection_&&this.featuresCollection_.remove(t);return}this.setupChangeEvents_(e,t);var r=t.getGeometry();if(r){var i=r.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(i,t)}else this.nullGeometryFeatures_[e]=t;this.dispatchEvent(new p(l.ADDFEATURE,t))},n.prototype.setupChangeEvents_=function(t,e){this.featureChangeKeys_[t]=[F(e,O.CHANGE,this.handleFeatureChange_,this),F(e,D.PROPERTYCHANGE,this.handleFeatureChange_,this)]},n.prototype.addToIndex_=function(t,e){var r=!0,i=e.getId();return i!==void 0&&(i.toString()in this.idIndex_?r=!1:this.idIndex_[i.toString()]=e),r&&(m(!(t in this.uidIndex_),30),this.uidIndex_[t]=e),r},n.prototype.addFeatures=function(t){this.addFeaturesInternal(t),this.changed()},n.prototype.addFeaturesInternal=function(t){for(var e=[],r=[],i=[],a=0,s=t.length;a<s;a++){var o=t[a],f=d(o);this.addToIndex_(f,o)&&r.push(o)}for(var a=0,h=r.length;a<h;a++){var o=r[a],f=d(o);this.setupChangeEvents_(f,o);var _=o.getGeometry();if(_){var E=_.getExtent();e.push(E),i.push(o)}else this.nullGeometryFeatures_[f]=o}if(this.featuresRtree_&&this.featuresRtree_.load(e,i),this.hasListener(l.ADDFEATURE))for(var a=0,c=r.length;a<c;a++)this.dispatchEvent(new p(l.ADDFEATURE,r[a]))},n.prototype.bindFeaturesCollection_=function(t){var e=!1;this.addEventListener(l.ADDFEATURE,function(r){e||(e=!0,t.push(r.feature),e=!1)}),this.addEventListener(l.REMOVEFEATURE,function(r){e||(e=!0,t.remove(r.feature),e=!1)}),t.addEventListener(x.ADD,(function(r){e||(e=!0,this.addFeature(r.element),e=!1)}).bind(this)),t.addEventListener(x.REMOVE,(function(r){e||(e=!0,this.removeFeature(r.element),e=!1)}).bind(this)),this.featuresCollection_=t},n.prototype.clear=function(t){if(t){for(var e in this.featureChangeKeys_){var r=this.featureChangeKeys_[e];r.forEach(R)}this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){var i=(function(o){this.removeFeatureInternal(o)}).bind(this);this.featuresRtree_.forEach(i);for(var a in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[a])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};var s=new p(l.CLEAR);this.dispatchEvent(s),this.changed()},n.prototype.forEachFeature=function(t){if(this.featuresRtree_)return this.featuresRtree_.forEach(t);this.featuresCollection_&&this.featuresCollection_.forEach(t)},n.prototype.forEachFeatureAtCoordinateDirect=function(t,e){var r=[t[0],t[1],t[0],t[1]];return this.forEachFeatureInExtent(r,function(i){var a=i.getGeometry();if(a.intersectsCoordinate(t))return e(i)})},n.prototype.forEachFeatureInExtent=function(t,e){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(t,e);this.featuresCollection_&&this.featuresCollection_.forEach(e)},n.prototype.forEachFeatureIntersectingExtent=function(t,e){return this.forEachFeatureInExtent(t,function(r){var i=r.getGeometry();if(i.intersectsExtent(t)){var a=e(r);if(a)return a}})},n.prototype.getFeaturesCollection=function(){return this.featuresCollection_},n.prototype.getFeatures=function(){var t;return this.featuresCollection_?t=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(t=this.featuresRtree_.getAll(),g(this.nullGeometryFeatures_)||L(t,U(this.nullGeometryFeatures_))),t},n.prototype.getFeaturesAtCoordinate=function(t){var e=[];return this.forEachFeatureAtCoordinateDirect(t,function(r){e.push(r)}),e},n.prototype.getFeaturesInExtent=function(t,e){var r=this;if(this.featuresRtree_){var i=e&&e.canWrapX()&&this.getWrapX();if(!i)return this.featuresRtree_.getInExtent(t);var a=V(t,e);return[].concat.apply([],a.map(function(s){return r.featuresRtree_.getInExtent(s)}))}else return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]},n.prototype.getClosestFeatureToCoordinate=function(t,e){var r=t[0],i=t[1],a=null,s=[NaN,NaN],o=1/0,f=[-1/0,-1/0,1/0,1/0],h=e||b;return this.featuresRtree_.forEachInExtent(f,function(_){if(h(_)){var E=_.getGeometry(),c=o;if(o=E.closestPointXY(r,i,s,o),o<c){a=_;var v=Math.sqrt(o);f[0]=r-v,f[1]=i-v,f[2]=r+v,f[3]=i+v}}}),a},n.prototype.getExtent=function(t){return this.featuresRtree_.getExtent(t)},n.prototype.getFeatureById=function(t){var e=this.idIndex_[t.toString()];return e!==void 0?e:null},n.prototype.getFeatureByUid=function(t){var e=this.uidIndex_[t];return e!==void 0?e:null},n.prototype.getFormat=function(){return this.format_},n.prototype.getOverlaps=function(){return this.overlaps_},n.prototype.getUrl=function(){return this.url_},n.prototype.handleFeatureChange_=function(t){var e=t.target,r=d(e),i=e.getGeometry();if(!i)r in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(e),this.nullGeometryFeatures_[r]=e);else{var a=i.getExtent();r in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[r],this.featuresRtree_&&this.featuresRtree_.insert(a,e)):this.featuresRtree_&&this.featuresRtree_.update(a,e)}var s=e.getId();if(s!==void 0){var o=s.toString();this.idIndex_[o]!==e&&(this.removeFromIdIndex_(e),this.idIndex_[o]=e)}else this.removeFromIdIndex_(e),this.uidIndex_[r]=e;this.changed(),this.dispatchEvent(new p(l.CHANGEFEATURE,e))},n.prototype.hasFeature=function(t){var e=t.getId();return e!==void 0?e in this.idIndex_:d(t)in this.uidIndex_},n.prototype.isEmpty=function(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&g(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0},n.prototype.loadFeatures=function(t,e,r){for(var i=this.loadedExtentsRtree_,a=this.strategy_(t,e,r),s=function(_,E){var c=a[_],v=i.forEachInExtent(c,function(y){return Y(y.extent,c)});v||(++o.loadingExtentsCount_,o.dispatchEvent(new p(l.FEATURESLOADSTART)),o.loader_.call(o,c,e,r,(function(y){--this.loadingExtentsCount_,this.dispatchEvent(new p(l.FEATURESLOADEND,void 0,y))}).bind(o),(function(){--this.loadingExtentsCount_,this.dispatchEvent(new p(l.FEATURESLOADERROR))}).bind(o)),i.insert(c,{extent:c.slice()}))},o=this,f=0,h=a.length;f<h;++f)s(f);this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0},n.prototype.refresh=function(){this.clear(!0),this.loadedExtentsRtree_.clear(),u.prototype.refresh.call(this)},n.prototype.removeLoadedExtent=function(t){var e=this.loadedExtentsRtree_,r;e.forEachInExtent(t,function(i){if(T(i.extent,t))return r=i,!0}),r&&e.remove(r)},n.prototype.removeFeature=function(t){if(t){var e=d(t);e in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[e]:this.featuresRtree_&&this.featuresRtree_.remove(t);var r=this.removeFeatureInternal(t);r&&this.changed()}},n.prototype.removeFeatureInternal=function(t){var e=d(t),r=this.featureChangeKeys_[e];if(r){r.forEach(R),delete this.featureChangeKeys_[e];var i=t.getId();return i!==void 0&&delete this.idIndex_[i.toString()],delete this.uidIndex_[e],this.dispatchEvent(new p(l.REMOVEFEATURE,t)),t}},n.prototype.removeFromIdIndex_=function(t){var e=!1;for(var r in this.idIndex_)if(this.idIndex_[r]===t){delete this.idIndex_[r],e=!0;break}return e},n.prototype.setLoader=function(t){this.loader_=t},n.prototype.setUrl=function(t){m(this.format_,7),this.url_=t,this.setLoader(C(t,this.format_))},n}(N);export{p as VectorSourceEvent,k as default};
