import{L as Ie}from"./Event.BTHd1TaF.js";import{a as b,n as Ce}from"./Object.DdgBWT7D.js";import{C as Le}from"./Layer.Bev_0Xed.js";import{T as Pe,I as je,R as Ae,a as De,b as Me}from"./TileRange.BZS1LfrN.js";import{T as A}from"./TileState.DENk7BAX.js";import{b as he,c as ge,t as Se,m as Fe}from"./transform.CU9krZJA.js";import{H as Ue,S as Ne,g as Be,m as Ke,q as Te,d as Ge,T as ye,c as F,U as Ye,P as ke,h as qe}from"./proj.BNE8J585.js";import{t as ze}from"./size.DSor2vHC.js";import"./ImageState.BQAwWc_S.js";import"./dom.i4NIYYs1.js";import"./has.DEIyT5tI.js";import"./Image.C3dCXgkY.js";import"./easing.vFiYzKl6.js";import"./Projection.Bg0YEavu.js";const H={PRELOAD:"preload",USE_INTERIM_TILES_ON_ERROR:"useInterimTilesOnError"};var He=function(){var a=function(i,e){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])},a(i,e)};return function(i,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");a(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),Xe=function(a){He(i,a);function i(e){var t=this,r=e||{},n=b({},r);return delete n.preload,delete n.useInterimTilesOnError,t=a.call(this,n)||this,t.on,t.once,t.un,t.setPreload(r.preload!==void 0?r.preload:0),t.setUseInterimTilesOnError(r.useInterimTilesOnError!==void 0?r.useInterimTilesOnError:!0),t}return i.prototype.getPreload=function(){return this.get(H.PRELOAD)},i.prototype.setPreload=function(e){this.set(H.PRELOAD,e)},i.prototype.getUseInterimTilesOnError=function(){return this.get(H.USE_INTERIM_TILES_ON_ERROR)},i.prototype.setUseInterimTilesOnError=function(e){this.set(H.USE_INTERIM_TILES_ON_ERROR,e)},i.prototype.getData=function(e){return a.prototype.getData.call(this,e)},i}(Ie);const $e=Xe;var Qe=function(){var a=function(i,e){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])},a(i,e)};return function(i,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");a(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),Ve=function(a){Qe(i,a);function i(e){var t=a.call(this,e)||this;return t.extentChanged=!0,t.renderedExtent_=null,t.renderedPixelRatio,t.renderedProjection=null,t.renderedRevision,t.renderedTiles=[],t.newTiles_=!1,t.tmpExtent=Ue(),t.tmpTileRange_=new Pe(0,0,0,0),t}return i.prototype.isDrawableTile=function(e){var t=this.getLayer(),r=e.getState(),n=t.getUseInterimTilesOnError();return r==A.LOADED||r==A.EMPTY||r==A.ERROR&&!n},i.prototype.getTile=function(e,t,r,n){var v=n.pixelRatio,R=n.viewState.projection,s=this.getLayer(),T=s.getSource(),o=T.getTile(e,t,r,v,R);return o.getState()==A.ERROR&&(s.getUseInterimTilesOnError()?s.getPreload()>0&&(this.newTiles_=!0):o.setState(A.LOADED)),this.isDrawableTile(o)||(o=o.getInterimTile()),o},i.prototype.getData=function(e){var t=this.frameState;if(!t)return null;var r=this.getLayer(),n=he(t.pixelToCoordinateTransform,e.slice()),v=r.getExtent();if(v&&!Ne(v,n))return null;for(var R=t.pixelRatio,s=t.viewState.projection,T=t.viewState,o=r.getRenderSource(),d=o.getTileGridForProjection(T.projection),l=o.getTilePixelRatio(t.pixelRatio),g=d.getZForResolution(T.resolution);g>=d.getMinZoom();--g){var p=d.getTileCoordForCoordAndZ(n,g),c=o.getTile(g,p[1],p[2],R,s);if(!(c instanceof je||c instanceof Ae))return null;if(c.getState()===A.LOADED){var _=d.getOrigin(g),w=ze(d.getTileSize(g)),m=d.getResolution(g),y=Math.floor(l*((n[0]-_[0])/m-p[1]*w[0])),O=Math.floor(l*((_[1]-n[1])/m-p[2]*w[1])),f=Math.round(l*o.getGutterForProjection(T.projection));return this.getImageData(c.getImage(),y+f,O+f)}}return null},i.prototype.loadedTileCallback=function(e,t,r){return this.isDrawableTile(r)?a.prototype.loadedTileCallback.call(this,e,t,r):!1},i.prototype.prepareFrame=function(e){return!!this.getLayer().getSource()},i.prototype.renderFrame=function(e,t){var r=e.layerStatesArray[e.layerIndex],n=e.viewState,v=n.projection,R=n.resolution,s=n.center,T=n.rotation,o=e.pixelRatio,d=this.getLayer(),l=d.getSource(),g=l.getRevision(),p=l.getTileGridForProjection(v),c=p.getZForResolution(R,l.zDirection),_=p.getResolution(c),w=e.extent,m=e.viewState.resolution,y=l.getTilePixelRatio(o),O=Math.round(Be(w)/m*o),f=Math.round(Ke(w)/m*o),L=r.extent&&Te(r.extent,v);L&&(w=Ge(w,Te(r.extent,v)));var I=_*O/2/y,J=_*f/2/y,U=[s[0]-I,s[1]-J,s[0]+I,s[1]+J],Y=p.getTileRangeForExtentAndZ(w,c),N={};N[c]={};var ee=this.createLoadedTileFinder(l,v,N),te=this.tmpExtent,re=this.tmpTileRange_;this.newTiles_=!1;for(var Re=T?ye(n.center,m,T,e.size):void 0,x=Y.minX;x<=Y.maxX;++x)for(var E=Y.minY;E<=Y.maxY;++E)if(!(T&&!p.tileCoordIntersectsViewport([c,x,E],Re))){var h=this.getTile(c,x,E,e);if(this.isDrawableTile(h)){var X=F(this);if(h.getState()==A.LOADED){N[c][h.tileCoord.toString()]=h;var D=h.inTransition(X);D&&r.opacity!==1&&(h.endTransition(X),D=!1),!this.newTiles_&&(D||this.renderedTiles.indexOf(h)===-1)&&(this.newTiles_=!0)}if(h.getAlpha(X,e.time)===1)continue}var ie=p.getTileCoordChildTileRange(h.tileCoord,re,te),ne=!1;ie&&(ne=ee(c+1,ie)),ne||p.forEachTileCoordParentTileRange(h.tileCoord,ee,re,te)}var k=_/R*o/y;ge(this.pixelTransform,e.size[0]/2,e.size[1]/2,1/o,1/o,T,-O/2,-f/2);var $=Se(this.pixelTransform);this.useContainer(t,$,this.getBackground(e));var u=this.context,M=u.canvas;Fe(this.inversePixelTransform,this.pixelTransform),ge(this.tempTransform,O/2,f/2,k,k,0,-O/2,-f/2),M.width!=O||M.height!=f?(M.width=O,M.height=f):this.containerReused||u.clearRect(0,0,O,f),L&&this.clipUnrotated(u,e,L),l.getInterpolate()||b(u,De),this.preRender(u,e),this.renderedTiles.length=0;var B=Object.keys(N).map(Number);B.sort(Ce);var S,Q,P;r.opacity===1&&(!this.containerReused||l.getOpaque(e.viewState.projection))?B=B.reverse():(S=[],Q=[]);for(var V=B.length-1;V>=0;--V){var j=B[V],oe=l.getTilePixelSize(j,o,v),me=p.getResolution(j),ae=me/_,se=oe[0]*ae*k,le=oe[1]*ae*k,Z=p.getTileCoordForCoordAndZ(Ye(U),j),ue=p.getTileCoordExtent(Z),q=he(this.tempTransform,[y*(ue[0]-U[0])/_,y*(U[3]-ue[3])/_]),xe=y*l.getGutterForProjection(v),ve=N[j];for(var Ee in ve){var h=ve[Ee],pe=h.tileCoord,ce=Z[1]-pe[1],_e=Math.round(q[0]-(ce-1)*se),de=Z[2]-pe[2],we=Math.round(q[1]-(de-1)*le),x=Math.round(q[0]-ce*se),E=Math.round(q[1]-de*le),K=_e-x,G=we-E,fe=c===j,D=fe&&h.getAlpha(F(this),e.time)!==1,W=!1;if(!D)if(S){P=[x,E,x+K,E,x+K,E+G,x,E+G];for(var z=0,Oe=S.length;z<Oe;++z)if(c!==j&&j<Q[z]){var C=S[z];ke([x,E,x+K,E+G],[C[0],C[3],C[4],C[7]])&&(W||(u.save(),W=!0),u.beginPath(),u.moveTo(P[0],P[1]),u.lineTo(P[2],P[3]),u.lineTo(P[4],P[5]),u.lineTo(P[6],P[7]),u.moveTo(C[6],C[7]),u.lineTo(C[4],C[5]),u.lineTo(C[2],C[3]),u.lineTo(C[0],C[1]),u.clip())}S.push(P),Q.push(j)}else u.clearRect(x,E,K,G);this.drawTileImage(h,e,x,E,K,G,xe,fe),S&&!D?(W&&u.restore(),this.renderedTiles.unshift(h)):this.renderedTiles.push(h),this.updateUsedTiles(e.usedTiles,l,h)}}return this.renderedRevision=g,this.renderedResolution=_,this.extentChanged=!this.renderedExtent_||!qe(this.renderedExtent_,U),this.renderedExtent_=U,this.renderedPixelRatio=o,this.renderedProjection=v,this.manageTilePyramid(e,l,p,o,v,w,c,d.getPreload()),this.scheduleExpireCache(e,l),this.postRender(u,e),r.extent&&u.restore(),b(u,Me),$!==M.style.transform&&(M.style.transform=$),this.container},i.prototype.drawTileImage=function(e,t,r,n,v,R,s,T){var o=this.getTileImage(e);if(o){var d=F(this),l=t.layerStatesArray[t.layerIndex],g=l.opacity*(T?e.getAlpha(d,t.time):1),p=g!==this.context.globalAlpha;p&&(this.context.save(),this.context.globalAlpha=g),this.context.drawImage(o,s,s,o.width-2*s,o.height-2*s,r,n,v,R),p&&this.context.restore(),g!==l.opacity?t.animate=!0:T&&e.endTransition(d)}},i.prototype.getImage=function(){var e=this.context;return e?e.canvas:null},i.prototype.getTileImage=function(e){return e.getImage()},i.prototype.scheduleExpireCache=function(e,t){if(t.canExpireCache()){var r=(function(n,v,R){var s=F(n);s in R.usedTiles&&n.expireCache(R.viewState.projection,R.usedTiles[s])}).bind(null,t);e.postRenderFunctions.push(r)}},i.prototype.updateUsedTiles=function(e,t,r){var n=F(t);n in e||(e[n]={}),e[n][r.getKey()]=!0},i.prototype.manageTilePyramid=function(e,t,r,n,v,R,s,T,o){var d=F(t);d in e.wantedTiles||(e.wantedTiles[d]={});var l=e.wantedTiles[d],g=e.tileQueue,p=r.getMinZoom(),c=e.viewState.rotation,_=c?ye(e.viewState.center,e.viewState.resolution,c,e.size):void 0,w=0,m,y,O,f,L,I;for(I=p;I<=s;++I)for(y=r.getTileRangeForExtentAndZ(R,I,y),O=r.getResolution(I),f=y.minX;f<=y.maxX;++f)for(L=y.minY;L<=y.maxY;++L)c&&!r.tileCoordIntersectsViewport([I,f,L],_)||(s-I<=T?(++w,m=t.getTile(I,f,L,n,v),m.getState()==A.IDLE&&(l[m.getKey()]=!0,g.isKeyQueued(m.getKey())||g.enqueue([m,d,r.getTileCoordCenter(m.tileCoord),O])),o!==void 0&&o(m)):t.useTile(I,f,L,v));t.updateCacheSize(w,v)},i}(Le);const Ze=Ve;var We=function(){var a=function(i,e){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])},a(i,e)};return function(i,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");a(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),ct=function(a){We(i,a);function i(e){return a.call(this,e)||this}return i.prototype.createRenderer=function(){return new Ze(this)},i}($e);export{ct as default};
