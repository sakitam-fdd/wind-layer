import{T as v}from"./TileState.DENk7BAX.js";import{d as V,e as mt}from"./dom.i4NIYYs1.js";import{l as dt}from"./Image.C3dCXgkY.js";import{E as ut,b as gt,a as b,l as pt,u as tt}from"./Object.DdgBWT7D.js";import{a as Tt,K as Et,g as P,U as ft,V as yt,W as xt,X as It,Y as Wt,Z as J,_ as it,P as Ot,u as K,$ as Q,H as lt,a0 as Xt,m as et,a1 as Dt,y as Yt,N as Lt,a2 as Mt,a3 as rt,S as Ct,d as $,l as nt}from"./proj.BNE8J585.js";import{a as Pt}from"./easing.vFiYzKl6.js";var Ft=function(){var s=function(t,i){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])},s(t,i)};return function(t,i){if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");s(t,i);function e(){this.constructor=t}t.prototype=i===null?Object.create(i):(e.prototype=i.prototype,new e)}}(),At=function(s){Ft(t,s);function t(i,e,n){var r=s.call(this)||this,u=n||{};return r.tileCoord=i,r.state=e,r.interimTile=null,r.key="",r.transition_=u.transition===void 0?250:u.transition,r.transitionStarts_={},r.interpolate=!!u.interpolate,r}return t.prototype.changed=function(){this.dispatchEvent(ut.CHANGE)},t.prototype.release=function(){},t.prototype.getKey=function(){return this.key+"/"+this.tileCoord},t.prototype.getInterimTile=function(){if(!this.interimTile)return this;var i=this.interimTile;do{if(i.getState()==v.LOADED)return this.transition_=0,i;i=i.interimTile}while(i);return this},t.prototype.refreshInterimChain=function(){if(this.interimTile){var i=this.interimTile,e=this;do{if(i.getState()==v.LOADED){i.interimTile=null;break}else i.getState()==v.LOADING?e=i:i.getState()==v.IDLE?e.interimTile=i.interimTile:e=i;i=e.interimTile}while(i)}},t.prototype.getTileCoord=function(){return this.tileCoord},t.prototype.getState=function(){return this.state},t.prototype.setState=function(i){if(this.state!==v.ERROR&&this.state>i)throw new Error("Tile load sequence violation");this.state=i,this.changed()},t.prototype.load=function(){Tt()},t.prototype.getAlpha=function(i,e){if(!this.transition_)return 1;var n=this.transitionStarts_[i];if(!n)n=e,this.transitionStarts_[i]=n;else if(n===-1)return 1;var r=e-n+1e3/60;return r>=this.transition_?1:Pt(r/this.transition_)},t.prototype.inTransition=function(i){return this.transition_?this.transitionStarts_[i]!==-1:!1},t.prototype.endTransition=function(i){this.transition_&&(this.transitionStarts_[i]=-1)},t}(gt);const _t=At;var wt=function(){var s=function(t,i){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])},s(t,i)};return function(t,i){if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");s(t,i);function e(){this.constructor=t}t.prototype=i===null?Object.create(i):(e.prototype=i.prototype,new e)}}(),jt=function(s){wt(t,s);function t(i,e,n,r,u,l){var _=s.call(this,i,e,l)||this;return _.crossOrigin_=r,_.src_=n,_.key=n,_.image_=new Image,r!==null&&(_.image_.crossOrigin=r),_.unlisten_=null,_.tileLoadFunction_=u,_}return t.prototype.getImage=function(){return this.image_},t.prototype.setImage=function(i){this.image_=i,this.state=v.LOADED,this.unlistenImage_(),this.changed()},t.prototype.handleImageError_=function(){this.state=v.ERROR,this.unlistenImage_(),this.image_=Gt(),this.changed()},t.prototype.handleImageLoad_=function(){var i=this.image_;i.naturalWidth&&i.naturalHeight?this.state=v.LOADED:this.state=v.EMPTY,this.unlistenImage_(),this.changed()},t.prototype.load=function(){this.state==v.ERROR&&(this.state=v.IDLE,this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)),this.state==v.IDLE&&(this.state=v.LOADING,this.changed(),this.tileLoadFunction_(this,this.src_),this.unlisten_=dt(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))},t.prototype.unlistenImage_=function(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)},t}(_t);function Gt(){var s=V(1,1);return s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,1,1),s.canvas}const bt=jt;var Nt=.5,Ht=10,st=.25,kt=function(){function s(t,i,e,n,r,u){this.sourceProj_=t,this.targetProj_=i;var l={},_=Et(this.targetProj_,this.sourceProj_);this.transformInv_=function(f){var o=f[0]+"/"+f[1];return l[o]||(l[o]=_(f)),l[o]},this.maxSourceExtent_=n,this.errorThresholdSquared_=r*r,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!n&&!!this.sourceProj_.getExtent()&&P(n)==P(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?P(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?P(this.targetProj_.getExtent()):null;var m=ft(e),p=yt(e),y=xt(e),h=It(e),T=this.transformInv_(m),a=this.transformInv_(p),Y=this.transformInv_(y),L=this.transformInv_(h),c=Ht+(u?Math.max(0,Math.ceil(Wt(J(e)/(u*u*256*256)))):0);if(this.addQuad_(m,p,y,h,T,a,Y,L,c),this.wrapsXInSource_){var E=1/0;this.triangles_.forEach(function(f,o,I){E=Math.min(E,f.source[0][0],f.source[1][0],f.source[2][0])}),this.triangles_.forEach((function(f){if(Math.max(f.source[0][0],f.source[1][0],f.source[2][0])-E>this.sourceWorldWidth_/2){var o=[[f.source[0][0],f.source[0][1]],[f.source[1][0],f.source[1][1]],[f.source[2][0],f.source[2][1]]];o[0][0]-E>this.sourceWorldWidth_/2&&(o[0][0]-=this.sourceWorldWidth_),o[1][0]-E>this.sourceWorldWidth_/2&&(o[1][0]-=this.sourceWorldWidth_),o[2][0]-E>this.sourceWorldWidth_/2&&(o[2][0]-=this.sourceWorldWidth_);var I=Math.min(o[0][0],o[1][0],o[2][0]),X=Math.max(o[0][0],o[1][0],o[2][0]);X-I<this.sourceWorldWidth_/2&&(f.source=o)}}).bind(this))}l={}}return s.prototype.addTriangle_=function(t,i,e,n,r,u){this.triangles_.push({source:[n,r,u],target:[t,i,e]})},s.prototype.addQuad_=function(t,i,e,n,r,u,l,_,m){var p=it([r,u,l,_]),y=this.sourceWorldWidth_?P(p)/this.sourceWorldWidth_:null,h=this.sourceWorldWidth_,T=this.sourceProj_.canWrapX()&&y>.5&&y<1,a=!1;if(m>0){if(this.targetProj_.isGlobal()&&this.targetWorldWidth_){var Y=it([t,i,e,n]),L=P(Y)/this.targetWorldWidth_;a=L>st||a}!T&&this.sourceProj_.isGlobal()&&y&&(a=y>st||a)}if(!(!a&&this.maxSourceExtent_&&isFinite(p[0])&&isFinite(p[1])&&isFinite(p[2])&&isFinite(p[3])&&!Ot(p,this.maxSourceExtent_))){var c=0;if(!a&&(!isFinite(r[0])||!isFinite(r[1])||!isFinite(u[0])||!isFinite(u[1])||!isFinite(l[0])||!isFinite(l[1])||!isFinite(_[0])||!isFinite(_[1]))){if(m>0)a=!0;else if(c=(!isFinite(r[0])||!isFinite(r[1])?8:0)+(!isFinite(u[0])||!isFinite(u[1])?4:0)+(!isFinite(l[0])||!isFinite(l[1])?2:0)+(!isFinite(_[0])||!isFinite(_[1])?1:0),c!=1&&c!=2&&c!=4&&c!=8)return}if(m>0){if(!a){var E=[(t[0]+e[0])/2,(t[1]+e[1])/2],f=this.transformInv_(E),o=void 0;if(T){var I=(K(r[0],h)+K(l[0],h))/2;o=I-K(f[0],h)}else o=(r[0]+l[0])/2-f[0];var X=(r[1]+l[1])/2-f[1],d=o*o+X*X;a=d>this.errorThresholdSquared_}if(a){if(Math.abs(t[0]-e[0])<=Math.abs(t[1]-e[1])){var g=[(i[0]+e[0])/2,(i[1]+e[1])/2],W=this.transformInv_(g),x=[(n[0]+t[0])/2,(n[1]+t[1])/2],O=this.transformInv_(x);this.addQuad_(t,i,g,x,r,u,W,O,m-1),this.addQuad_(x,g,e,n,O,W,l,_,m-1)}else{var D=[(t[0]+i[0])/2,(t[1]+i[1])/2],M=this.transformInv_(D),F=[(e[0]+n[0])/2,(e[1]+n[1])/2],C=this.transformInv_(F);this.addQuad_(t,D,F,n,r,M,C,_,m-1),this.addQuad_(D,i,e,F,M,u,l,C,m-1)}return}}if(T){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}c&11||this.addTriangle_(t,e,n,r,l,_),c&14||this.addTriangle_(t,e,i,r,l,u),c&&(c&13||this.addTriangle_(i,n,t,u,_,r),c&7||this.addTriangle_(i,n,e,u,_,l))}},s.prototype.calculateSourceExtent=function(){var t=lt();return this.triangles_.forEach(function(i,e,n){var r=i.source;Q(t,r[0]),Q(t,r[1]),Q(t,r[2])}),t},s.prototype.getTriangles=function(){return this.triangles_},s}(),at={imageSmoothingEnabled:!1,msImageSmoothingEnabled:!1},ti={imageSmoothingEnabled:!0,msImageSmoothingEnabled:!0},S,vt=[];function ot(s,t,i,e,n){s.beginPath(),s.moveTo(0,0),s.lineTo(t,i),s.lineTo(e,n),s.closePath(),s.save(),s.clip(),s.fillRect(0,0,Math.max(t,e)+1,Math.max(i,n)),s.restore()}function q(s,t){return Math.abs(s[t*4]-210)>2||Math.abs(s[t*4+3]-.75*255)>2}function Ut(){if(S===void 0){var s=document.createElement("canvas").getContext("2d");s.globalCompositeOperation="lighter",s.fillStyle="rgba(210, 0, 0, 0.75)",ot(s,4,5,4,0),ot(s,4,5,0,5);var t=s.getImageData(0,0,3,3).data;S=q(t,0)||q(t,4)||q(t,8)}return S}function ht(s,t,i,e){var n=Mt(i,t,s),r=rt(t,e,i),u=t.getMetersPerUnit();u!==void 0&&(r*=u);var l=s.getMetersPerUnit();l!==void 0&&(r/=l);var _=s.getExtent();if(!_||Ct(_,n)){var m=rt(s,r,n)/r;isFinite(m)&&m>0&&(r/=m)}return r}function Bt(s,t,i,e){var n=Yt(i),r=ht(s,t,n,e);return(!isFinite(r)||r<=0)&&Lt(i,function(u){return r=ht(s,t,u,e),isFinite(r)&&r>0}),r}function Zt(s,t,i,e,n,r,u,l,_,m,p,y){var h=V(Math.round(i*s),Math.round(i*t),vt);if(y||b(h,at),_.length===0)return h.canvas;h.scale(i,i);function T(o){return Math.round(o*i)/i}h.globalCompositeOperation="lighter";var a=lt();_.forEach(function(o,I,X){Xt(a,o.extent)});var Y=P(a),L=et(a),c=V(Math.round(i*Y/e),Math.round(i*L/e));y||b(c,at);var E=i/e;_.forEach(function(o,I,X){var d=o.extent[0]-a[0],g=-(o.extent[3]-a[3]),W=P(o.extent),x=et(o.extent);o.image.width>0&&o.image.height>0&&c.drawImage(o.image,m,m,o.image.width-2*m,o.image.height-2*m,d*E,g*E,W*E,x*E)});var f=ft(u);return l.getTriangles().forEach(function(o,I,X){var d=o.source,g=o.target,W=d[0][0],x=d[0][1],O=d[1][0],D=d[1][1],M=d[2][0],F=d[2][1],C=T((g[0][0]-f[0])/r),N=T(-(g[0][1]-f[1])/r),w=T((g[1][0]-f[0])/r),j=T(-(g[1][1]-f[1])/r),k=T((g[2][0]-f[0])/r),U=T(-(g[2][1]-f[1])/r),B=W,Z=x;W=0,x=0,O-=B,D-=Z,M-=B,F-=Z;var ct=[[O,D,0,0,w-C],[M,F,0,0,k-C],[0,0,O,D,j-N],[0,0,M,F,U-N]],H=Dt(ct);if(H){if(h.save(),h.beginPath(),Ut()||!y){h.moveTo(w,j);for(var G=4,R=C-w,z=N-j,A=0;A<G;A++)h.lineTo(w+T((A+1)*R/G),j+T(A*z/(G-1))),A!=G-1&&h.lineTo(w+T((A+1)*R/G),j+T((A+1)*z/(G-1)));h.lineTo(k,U)}else h.moveTo(w,j),h.lineTo(C,N),h.lineTo(k,U);h.clip(),h.transform(H[0],H[2],H[1],H[3],C,N),h.translate(a[0]-B,a[3]-Z),h.scale(e/i,-e/i),h.drawImage(c.canvas,0,0),h.restore()}}),p&&(h.save(),h.globalCompositeOperation="source-over",h.strokeStyle="black",h.lineWidth=1,l.getTriangles().forEach(function(o,I,X){var d=o.target,g=(d[0][0]-f[0])/r,W=-(d[0][1]-f[1])/r,x=(d[1][0]-f[0])/r,O=-(d[1][1]-f[1])/r,D=(d[2][0]-f[0])/r,M=-(d[2][1]-f[1])/r;h.beginPath(),h.moveTo(x,O),h.lineTo(g,W),h.lineTo(D,M),h.closePath(),h.stroke()}),h.restore()),h.canvas}var Kt=function(){var s=function(t,i){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])},s(t,i)};return function(t,i){if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");s(t,i);function e(){this.constructor=t}t.prototype=i===null?Object.create(i):(e.prototype=i.prototype,new e)}}(),Qt=function(s){Kt(t,s);function t(i,e,n,r,u,l,_,m,p,y,h,T){var a=s.call(this,u,v.IDLE,{interpolate:!!T})||this;a.renderEdges_=h!==void 0?h:!1,a.pixelRatio_=_,a.gutter_=m,a.canvas_=null,a.sourceTileGrid_=e,a.targetTileGrid_=r,a.wrappedTileCoord_=l||u,a.sourceTiles_=[],a.sourcesListenerKeys_=null,a.sourceZ_=0;var Y=r.getTileCoordExtent(a.wrappedTileCoord_),L=a.targetTileGrid_.getExtent(),c=a.sourceTileGrid_.getExtent(),E=L?$(Y,L):Y;if(J(E)===0)return a.state=v.EMPTY,a;var f=i.getExtent();f&&(c?c=$(c,f):c=f);var o=r.getResolution(a.wrappedTileCoord_[0]),I=Bt(i,n,E,o);if(!isFinite(I)||I<=0)return a.state=v.EMPTY,a;var X=y!==void 0?y:Nt;if(a.triangulation_=new kt(i,n,E,c,I*X,o),a.triangulation_.getTriangles().length===0)return a.state=v.EMPTY,a;a.sourceZ_=e.getZForResolution(I);var d=a.triangulation_.calculateSourceExtent();if(c&&(i.canWrapX()?(d[1]=nt(d[1],c[1],c[3]),d[3]=nt(d[3],c[1],c[3])):d=$(d,c)),!J(d))a.state=v.EMPTY;else{for(var g=e.getTileRangeForExtentAndZ(d,a.sourceZ_),W=g.minX;W<=g.maxX;W++)for(var x=g.minY;x<=g.maxY;x++){var O=p(a.sourceZ_,W,x,_);O&&a.sourceTiles_.push(O)}a.sourceTiles_.length===0&&(a.state=v.EMPTY)}return a}return t.prototype.getImage=function(){return this.canvas_},t.prototype.reproject_=function(){var i=[];if(this.sourceTiles_.forEach((function(p,y,h){p&&p.getState()==v.LOADED&&i.push({extent:this.sourceTileGrid_.getTileCoordExtent(p.tileCoord),image:p.getImage()})}).bind(this)),this.sourceTiles_.length=0,i.length===0)this.state=v.ERROR;else{var e=this.wrappedTileCoord_[0],n=this.targetTileGrid_.getTileSize(e),r=typeof n=="number"?n:n[0],u=typeof n=="number"?n:n[1],l=this.targetTileGrid_.getResolution(e),_=this.sourceTileGrid_.getResolution(this.sourceZ_),m=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);this.canvas_=Zt(r,u,this.pixelRatio_,_,this.sourceTileGrid_.getExtent(),l,m,this.triangulation_,i,this.gutter_,this.renderEdges_,this.interpolate),this.state=v.LOADED}this.changed()},t.prototype.load=function(){if(this.state==v.IDLE){this.state=v.LOADING,this.changed();var i=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach((function(e,n,r){var u=e.getState();if(u==v.IDLE||u==v.LOADING){i++;var l=pt(e,ut.CHANGE,function(_){var m=e.getState();(m==v.LOADED||m==v.ERROR||m==v.EMPTY)&&(tt(l),i--,i===0&&(this.unlistenSources_(),this.reproject_()))},this);this.sourcesListenerKeys_.push(l)}}).bind(this)),i===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function(e,n,r){var u=e.getState();u==v.IDLE&&e.load()})}},t.prototype.unlistenSources_=function(){this.sourcesListenerKeys_.forEach(tt),this.sourcesListenerKeys_=null},t.prototype.release=function(){this.canvas_&&(mt(this.canvas_.getContext("2d")),vt.push(this.canvas_),this.canvas_=null),s.prototype.release.call(this)},t}(_t);const ii=Qt;var $t=function(){function s(t,i,e,n){this.minX=t,this.maxX=i,this.minY=e,this.maxY=n}return s.prototype.contains=function(t){return this.containsXY(t[1],t[2])},s.prototype.containsTileRange=function(t){return this.minX<=t.minX&&t.maxX<=this.maxX&&this.minY<=t.minY&&t.maxY<=this.maxY},s.prototype.containsXY=function(t,i){return this.minX<=t&&t<=this.maxX&&this.minY<=i&&i<=this.maxY},s.prototype.equals=function(t){return this.minX==t.minX&&this.minY==t.minY&&this.maxX==t.maxX&&this.maxY==t.maxY},s.prototype.extend=function(t){t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY)},s.prototype.getHeight=function(){return this.maxY-this.minY+1},s.prototype.getSize=function(){return[this.getWidth(),this.getHeight()]},s.prototype.getWidth=function(){return this.maxX-this.minX+1},s.prototype.intersects=function(t){return this.minX<=t.maxX&&this.maxX>=t.minX&&this.minY<=t.maxY&&this.maxY>=t.minY},s}();function ei(s,t,i,e,n){return n!==void 0?(n.minX=s,n.maxX=t,n.minY=i,n.maxY=e,n):new $t(s,t,i,e)}export{bt as I,ii as R,$t as T,at as a,ti as b,ei as c};
